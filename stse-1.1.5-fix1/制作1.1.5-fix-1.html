<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>éŸ³æºç®¡ç†ç³»ç»Ÿ - ç¨³å®šä¿®å¤ç‰ˆ(Zip)</title>
  <style>
    /* æ ·å¼éƒ¨åˆ†ä¿æŒåŸæ ·ï¼Œæœªåšä»»ä½•æ”¹åŠ¨ */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Microsoft YaHei', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; min-height: 100vh; }
    .container { max-width: 1900px; margin: 0 auto; background: white; border-radius: 15px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    h1 { color: #333; margin-bottom: 10px; text-align: center; }
    .subtitle { text-align: center; color: #666; margin-bottom: 25px; font-size: 14px; }
    .toolbar { display: flex; gap: 10px; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; flex-wrap: wrap; align-items: center; }
    .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s; }
    .btn-primary { background: #667eea; color: white; }
    .btn-primary:hover { background: #5568d3; }
    .btn-success { background: #28a745; color: white; }
    .btn-success:hover { background: #218838; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-danger:hover { background: #c82333; }
    .btn-info { background: #17a2b8; color: white; }
    .btn-info:hover { background: #138496; }
    .btn-warning { background: #ffc107; color: #333; }
    .btn-warning:hover { background: #e0a800; }
    .filter-bar { display: flex; gap: 15px; margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; flex-wrap: wrap; align-items: center; }
    .filter-bar label { font-weight: bold; margin-right: 5px; }
    .filter-group { display: flex; gap: 10px; align-items: center; }
    .checkbox-label { display: flex; align-items: center; gap: 5px; padding: 5px 10px; background: white; border-radius: 5px; cursor: pointer; transition: all 0.3s; }
    .checkbox-label:hover { background: #e3f2fd; }
    .checkbox-label input { cursor: pointer; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .stat-card { padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; text-align: center; }
    .stat-number { font-size: 28px; font-weight: bold; margin-bottom: 5px; }
    .stat-label { font-size: 13px; opacity: 0.9; }
    table { width: 100%; border-collapse: collapse; box-shadow: 0 2px 8px rgba(0,0,0,0.1); background: white; }
    thead { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; position: sticky; top: 0; z-index: 10; }
    th { padding: 15px 10px; text-align: left; font-weight: bold; white-space: nowrap; }
    td { padding: 12px 10px; border-bottom: 1px solid #eee; vertical-align: top; }
    tr:hover { background: #f8f9fa; }
    .file-name { font-weight: 500; color: #667eea; font-family: 'Consolas', monospace; display: flex; align-items: center; gap: 8px; }
    .file-icon { font-size: 18px; }
    .file-status { font-size: 11px; color: #28a745; margin-left: 5px; }
    .no-file { color: #dc3545; }
    input[type="text"], select, textarea { padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; width: 100%; font-family: inherit; }
    textarea { min-height: 60px; resize: vertical; }
    .delete-btn, .download-btn, .sort-btn { color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin: 2px; }
    .delete-btn { background: #dc3545; }
    .delete-btn:hover { background: #c82333; }
    .download-btn { background: #28a745; }
    .download-btn:hover { background: #218838; }
    .sort-btn { background: #6c757d; padding: 4px 8px; font-size: 16px; line-height: 1; }
    .sort-btn:hover { background: #5a6268; }
    .sort-btn:disabled { background: #ccc; cursor: not-allowed; }
    .add-row-btn { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 20px; transition: all 0.3s; }
    .add-row-btn:hover { background: #218838; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); }
    .empty-state { text-align: center; padding: 60px 20px; color: #999; font-size: 16px; }
    .checkbox-group { display: flex; gap: 8px; flex-wrap: wrap; }
    .source-checkbox { display: flex; align-items: center; gap: 3px; }
    .source-checkbox input { width: 16px; height: 16px; cursor: pointer; }
    .source-checkbox label { font-size: 12px; cursor: pointer; user-select: none; }
    .search-box { padding: 10px 15px; border: 2px solid #667eea; border-radius: 5px; font-size: 14px; width: 300px; }
    .file-upload-cell { position: relative; }
    .upload-btn { background: #17a2b8; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; border: none; display: inline-block; }
    .upload-btn:hover { background: #138496; }
    .file-input { display: none; }
    .note-container { display: flex; flex-direction: column; gap: 8px; }
    .note-text { padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; width: 100%; min-height: 40px; }
    .links-container { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 5px; }
    .link-tag { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; font-size: 12px; text-decoration: none; transition: all 0.3s; max-width: 200px; }
    .link-tag:hover { transform: translateY(-2px); box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4); }
    .link-tag-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .link-tag-remove { background: rgba(255,255,255,0.3); border: none; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; flex-shrink: 0; }
    .link-tag-remove:hover { background: rgba(255,255,255,0.5); }
    .add-link-btn, .add-key-btn, .add-direct-btn { background: #17a2b8; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; align-self: flex-start; margin-right: 5px; }
    .add-link-btn:hover, .add-key-btn:hover, .add-direct-btn:hover { background: #138496; }
    .add-key-btn { background: #ffc107; color: #333; }
    .add-key-btn:hover { background: #e0a800; }
    .add-direct-btn { background: #28a745; color: white; }
    .add-direct-btn:hover { background: #218838; }
    .key-url-display { display: inline-block; padding: 4px 10px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 15px; font-size: 11px; color: #856404; margin-top: 5px; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .direct-url-display { display: inline-block; padding: 4px 10px; background: #d4edda; border: 1px solid #28a745; border-radius: 15px; font-size: 11px; color: #155724; margin-top: 5px; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .key-url-display .remove-key, .direct-url-display .remove-key { margin-left: 8px; cursor: pointer; color: #dc3545; font-weight: bold; }
    .key-url-display .remove-key:hover, .direct-url-display .remove-key:hover { color: #c82333; }
    .sort-buttons { display: flex; flex-direction: column; gap: 2px; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal-content { background-color: white; margin: 10% auto; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); animation: slideIn 0.3s; }
    @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #667eea; }
    .modal-header h2 { color: #333; margin: 0; }
    .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; }
    .close:hover { color: #000; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
    .form-group input, .form-group select { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
    .form-group small { display: block; margin-top: 5px; color: #666; font-size: 12px; }
    .radio-group { display: flex; gap: 20px; margin-bottom: 15px; }
    .radio-group label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal; }
    .radio-group input[type="radio"] { width: auto; cursor: pointer; }
    .modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px; }
    .btn-modal { padding: 10px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s; }
    .btn-modal-primary { background: #667eea; color: white; }
    .btn-modal-primary:hover { background: #5568d3; }
    .btn-modal-secondary { background: #6c757d; color: white; }
    .btn-modal-secondary:hover { background: #5a6268; }
    .mode-hint { padding: 10px; background: #e3f2fd; border-left: 4px solid #2196F3; border-radius: 4px; margin-top: 10px; font-size: 13px; color: #1976D2; }
  </style>
</head>
<body>

<div class="container">
  <h1>ğŸµ éŸ³æºç®¡ç†ç³»ç»Ÿï¼ˆç¨³å®šä¿®å¤ç‰ˆ + ZIPå¯¼å‡ºï¼‰</h1>
  <p class="subtitle">âœ¨ ä¿®å¤æŒ‰é”®æ— ååº” | ä¿®å¤è½¬æ¢æ ¼å¼é”™è¯¯ | å®Œç¾é€‚é… LX å¯¼å…¥ | è‡ªåŠ¨ZIPå‹ç¼©</p>
  
  <div class="toolbar">
    <button class="btn btn-success" onclick="addNewRow()">â• æ·»åŠ æ–‡ä»¶</button>
    <button class="btn btn-primary" onclick="exportToJSON()">ğŸ’¾ å¯¼å‡ºæ•°æ®</button>
    <button class="btn btn-warning" onclick="exportHTMLWithFiles()">ğŸ“¦ å¯¼å‡ºå®Œæ•´æŠ¥å‘Š(å«æ–‡ä»¶)</button>
    <button class="btn btn-info" onclick="exportToMarkdown()">ğŸ“ å¯¼å‡ºMarkdown</button>
    <button class="btn btn-success" onclick="downloadAllFiles()">â¬‡ï¸ æ‰“åŒ…ä¸‹è½½æ‰€æœ‰æ–‡ä»¶</button>
    <input type="file" id="importJSON" style="display:none" accept=".json" onchange="importFromJSON(event)">
    <button class="btn btn-primary" onclick="document.getElementById('importJSON').click()">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
    <button class="btn btn-danger" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
    <input type="text" class="search-box" placeholder="ğŸ” æœç´¢æ–‡ä»¶å..." oninput="filterTable()">
  </div>
  
  <div class="filter-bar">
    <div class="filter-group">
      <label>ğŸ” ç­›é€‰ä¸æ”¯æŒçš„æºï¼š</label>
      <label class="checkbox-label"><input type="checkbox" onchange="filterTable()" id="filter-kw"> é…·æˆ‘(KW)</label>
      <label class="checkbox-label"><input type="checkbox" onchange="filterTable()" id="filter-kg"> é…·ç‹—(KG)</label>
      <label class="checkbox-label"><input type="checkbox" onchange="filterTable()" id="filter-tx"> è…¾è®¯(TX)</label>
      <label class="checkbox-label"><input type="checkbox" onchange="filterTable()" id="filter-wy"> ç½‘æ˜“(WY)</label>
      <label class="checkbox-label"><input type="checkbox" onchange="filterTable()" id="filter-mg"> å’ªå’•(MG)</label>
      <button class="btn btn-info" onclick="clearFilters()">æ¸…é™¤ç­›é€‰</button>
    </div>
  </div>
  
  <div class="stats">
    <div class="stat-card">
      <div class="stat-number" id="totalFiles">0</div>
      <div class="stat-label">æ€»æ–‡ä»¶æ•°</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="uploadedCount">0</div>
      <div class="stat-label">å·²ä¸Šä¼ æ–‡ä»¶</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="flacCount">0</div>
      <div class="stat-label">FLAC/FLAC24éŸ³è´¨</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="fullSupportCount">0</div>
      <div class="stat-label">å…¨å¹³å°æ”¯æŒ</div>
    </div>
  </div>
  
  <div style="overflow-x: auto;">
    <table id="mainTable">
      <thead>
        <tr>
          <th width="80">æ’åº</th>
          <th width="60">åºå·</th>
          <th width="250">æ–‡ä»¶å</th>
          <th width="120">æœ€é«˜éŸ³è´¨</th>
          <th width="300">ä¸æ”¯æŒçš„æº</th>
          <th width="350">å¤‡æ³¨ & é“¾æ¥</th>
          <th width="150">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
  
  <button class="add-row-btn" onclick="addNewRow()">â• æ·»åŠ æ–°æ–‡ä»¶</button>
</div>

<!-- Modals -->
<div id="linkModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h2>ğŸ”— æ·»åŠ é“¾æ¥</h2><span class="close" onclick="closeLinkModal()">&times;</span></div>
    <div class="form-group"><label>é“¾æ¥æ–‡å­—ï¼š</label><input type="text" id="linkText" placeholder="ä¾‹å¦‚: å®˜æ–¹æ–‡æ¡£"></div>
    <div class="form-group"><label>é“¾æ¥åœ°å€ï¼š</label><input type="text" id="linkUrl" placeholder="ä¾‹å¦‚: https://example.com"></div>
    <div class="modal-footer"><button class="btn-modal btn-modal-secondary" onclick="closeLinkModal()">å–æ¶ˆ</button><button class="btn-modal btn-modal-primary" onclick="confirmAddLink()">ç¡®å®š</button></div>
  </div>
</div>
<div id="keyModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h2>ğŸ”‘ æ·»åŠ å¯†é’¥é…ç½®</h2><span class="close" onclick="closeKeyModal()">&times;</span></div>
    <div class="form-group"><label>é€‰æ‹©å¯†é’¥æ¨¡å¼ï¼š</label><div class="radio-group"><label><input type="radio" name="keyMode" value="link" checked onchange="toggleKeyMode()">åœ¨çº¿å¯†é’¥é“¾æ¥</label><label><input type="radio" name="keyMode" value="local" onchange="toggleKeyMode()">æœ¬åœ°å¯†é’¥å¯¼å…¥</label></div></div>
    <div id="keyLinkMode"><div class="form-group"><label>å¯†é’¥é“¾æ¥æ¨¡æ¿ï¼š</label><input type="text" id="keyUrlTemplate" placeholder="ä¾‹å¦‚: https://api.ikunshare.com/script?key="><small>ğŸ’¡ é“¾æ¥æœ«å°¾ä¸éœ€è¦åŠ å¯†é’¥ï¼Œç”¨æˆ·åœ¨æŠ¥å‘Šä¸­è¾“å…¥å¯†é’¥åä¼šè‡ªåŠ¨æ‹¼æ¥</small></div><div class="form-group"><label>ç¤ºä¾‹å®Œæ•´é“¾æ¥ï¼š</label><input type="text" id="keyUrlExample" readonly style="background: #f8f9fa;"></div><div class="mode-hint">ğŸ“Œ <strong>åœ¨çº¿æ¨¡å¼ï¼š</strong>ç”¨æˆ·è¾“å…¥å¯†é’¥åï¼Œä»æŒ‡å®šURLä¸‹è½½æ–‡ä»¶</div></div>
    <div id="keyLocalMode" style="display:none;"><div class="form-group"><label>å¯†é’¥å˜é‡åï¼š</label><input type="text" id="keyVariableName" value="API_KEY" placeholder="ä¾‹å¦‚: API_KEY"><small>ğŸ’¡ æ–‡ä»¶ä¸­çš„å¯†é’¥å˜é‡åï¼Œé»˜è®¤ä¸º API_KEY</small></div><div class="mode-hint">ğŸ“Œ <strong>æœ¬åœ°æ¨¡å¼ï¼š</strong>ç”¨æˆ·è¾“å…¥å¯†é’¥åï¼Œè‡ªåŠ¨æ›¿æ¢æ–‡ä»¶ä¸­çš„ <code>const API_KEY = ""</code></div></div>
    <div class="modal-footer"><button class="btn-modal btn-modal-secondary" onclick="closeKeyModal()">å–æ¶ˆ</button><button class="btn-modal btn-modal-primary" onclick="confirmAddKeyUrl()">ç¡®å®š</button></div>
  </div>
</div>
<div id="directUrlModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h2>ğŸŒ æ·»åŠ å…è´¹åœ¨çº¿é“¾æ¥</h2><span class="close" onclick="closeDirectUrlModal()">&times;</span></div>
    <div class="form-group"><label>åœ¨çº¿ä¸‹è½½é“¾æ¥ï¼š</label><input type="text" id="directUrlInput" placeholder="ä¾‹å¦‚: https://cdn.example.com/music.js"><small>ğŸ’¡ ç”¨æˆ·ç‚¹å‡»ä¸‹è½½æ—¶å°†ç›´æ¥è®¿é—®æ­¤é“¾æ¥</small></div>
    <div class="form-group"><label>ç¤ºä¾‹ï¼š</label><input type="text" value="https://cdn.jsdelivr.net/gh/user/repo/file.js" readonly style="background: #f8f9fa;"></div>
    <div class="modal-footer"><button class="btn-modal btn-modal-secondary" onclick="closeDirectUrlModal()">å–æ¶ˆ</button><button class="btn-modal btn-modal-primary" onclick="confirmAddDirectUrl()">ç¡®å®š</button></div>
  </div>
</div>

<script>
// å…¨å±€å˜é‡
let fileList = [];
let currentEditingId = null;
const qualityOptions = ['128k', '192k', '230k', '320k', 'flac', 'flac24bit', 'æ‰©å±•éŸ³è´¨', 'å…¶ä»–'];
const sources = ['kw', 'kg', 'tx', 'wy', 'mg'];
const sourceNames = {'kw': 'é…·æˆ‘','kg': 'é…·ç‹—','tx': 'è…¾è®¯','wy': 'ç½‘æ˜“','mg': 'å’ªå’•'};

// æ ¸å¿ƒé€»è¾‘
function loadData() {
  const saved = localStorage.getItem('musicQualityData');
  if (saved) { try { fileList = JSON.parse(saved); renderTable(); updateStats(); } catch (e) { console.error(e); fileList = []; } }
}
function saveData() { try { localStorage.setItem('musicQualityData', JSON.stringify(fileList)); updateStats(); } catch (e) { alert('ä¿å­˜å¤±è´¥ï¼Œæ•°æ®å¯èƒ½è¿‡å¤§ï¼'); } }

function addNewRow() {
  const newFile = { id: Date.now(), fileName: '', quality: '320k', unsupportedSources: [], note: '', links: [], keyMode: '', keyUrl: '', keyVariable: '', directUrl: '', fileContent: null, fileSize: 0, addedTime: new Date().toLocaleString('zh-CN'), author: 'æœªçŸ¥ä½œè€…', version: '1.0.0' };
  fileList.push(newFile); saveData(); renderTable();
  setTimeout(() => { const lastInput = document.querySelector('#tableBody tr:last-child input[type="text"]'); if (lastInput) lastInput.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 100);
}
function moveUp(index) { if (index > 0) { [fileList[index], fileList[index - 1]] = [fileList[index - 1], fileList[index]]; saveData(); renderTable(); } }
function moveDown(index) { if (index < fileList.length - 1) { [fileList[index], fileList[index + 1]] = [fileList[index + 1], fileList[index]]; saveData(); renderTable(); } }
function deleteRow(id) { if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) { fileList = fileList.filter(file => file.id !== id); saveData(); renderTable(); } }
function updateFileName(id, value) { const file = fileList.find(f => f.id === id); if (file) { file.fileName = value; saveData(); } }
function updateQuality(id, value) { const file = fileList.find(f => f.id === id); if (file) { file.quality = value; saveData(); renderTable(); } }
function updateUnsupportedSources(id, source, checked) { const file = fileList.find(f => f.id === id); if (file) { if (checked) { if (!file.unsupportedSources.includes(source)) file.unsupportedSources.push(source); } else { file.unsupportedSources = file.unsupportedSources.filter(s => s !== source); } saveData(); renderTable(); } }
function updateNote(id, value) { const file = fileList.find(f => f.id === id); if (file) { file.note = value; saveData(); } }

function openLinkModal(id) { currentEditingId = id; document.getElementById('linkText').value = ''; document.getElementById('linkUrl').value = ''; document.getElementById('linkModal').style.display = 'block'; }
function closeLinkModal() { document.getElementById('linkModal').style.display = 'none'; currentEditingId = null; }
function confirmAddLink() {
  const text = document.getElementById('linkText').value.trim(); const url = document.getElementById('linkUrl').value.trim();
  if (!text || !url) return alert('è¯·å¡«å†™å®Œæ•´ï¼');
  const finalUrl = (!url.startsWith('http')) ? 'https://' + url : url;
  const file = fileList.find(f => f.id === currentEditingId);
  if (file) { if (!file.links) file.links = []; file.links.push({ text: text, url: finalUrl }); saveData(); renderTable(); }
  closeLinkModal();
}
function removeLink(fileId, linkIndex) { const file = fileList.find(f => f.id === fileId); if (file && file.links) { file.links.splice(linkIndex, 1); saveData(); renderTable(); } }
function openKeyModal(id) {
  currentEditingId = id; const file = fileList.find(f => f.id === id);
  if (file?.keyMode === 'local') { document.querySelector('input[name="keyMode"][value="local"]').checked = true; document.getElementById('keyVariableName').value = file.keyVariable || 'API_KEY'; } 
  else { document.querySelector('input[name="keyMode"][value="link"]').checked = true; document.getElementById('keyUrlTemplate').value = file?.keyUrl || ''; }
  toggleKeyMode(); document.getElementById('keyModal').style.display = 'block';
}
function closeKeyModal() { document.getElementById('keyModal').style.display = 'none'; currentEditingId = null; }
function toggleKeyMode() { const mode = document.querySelector('input[name="keyMode"]:checked').value; document.getElementById('keyLinkMode').style.display = mode === 'link' ? 'block' : 'none'; document.getElementById('keyLocalMode').style.display = mode === 'local' ? 'block' : 'none'; }
function confirmAddKeyUrl() {
  const mode = document.querySelector('input[name="keyMode"]:checked').value; const file = fileList.find(f => f.id === currentEditingId); if (!file) return;
  if (mode === 'link') {
    const keyUrl = document.getElementById('keyUrlTemplate').value.trim();
    if (!keyUrl) { if (confirm('æ¸…é™¤å¯†é’¥é…ç½®ï¼Ÿ')) { file.keyMode=''; file.keyUrl=''; file.keyVariable=''; saveData(); renderTable(); closeKeyModal(); } return; }
    file.keyMode='link'; file.keyUrl=keyUrl; file.keyVariable='';
  } else {
    const keyVar = document.getElementById('keyVariableName').value.trim() || 'API_KEY';
    if (!file.fileContent) return alert('æœ¬åœ°æ¨¡å¼éœ€å…ˆä¸Šä¼ æ–‡ä»¶');
    file.keyMode='local'; file.keyUrl=''; file.keyVariable=keyVar;
  }
  saveData(); renderTable(); closeKeyModal();
}
function removeKeyUrl(id) { const file=fileList.find(f=>f.id===id); if(file){file.keyMode='';file.keyUrl='';file.keyVariable='';saveData();renderTable();} }
function openDirectUrlModal(id) { currentEditingId = id; const file = fileList.find(f => f.id === id); document.getElementById('directUrlInput').value = file?.directUrl || ''; document.getElementById('directUrlModal').style.display = 'block'; }
function closeDirectUrlModal() { document.getElementById('directUrlModal').style.display = 'none'; currentEditingId = null; }
function confirmAddDirectUrl() { const url = document.getElementById('directUrlInput').value.trim(); const file = fileList.find(f => f.id === currentEditingId); if(file){ file.directUrl = url; saveData(); renderTable(); } closeDirectUrlModal(); }
function removeDirectUrl(id) { const file=fileList.find(f=>f.id===id); if(file){file.directUrl='';saveData();renderTable();} }
function uploadFile(id, event) {
  const file = event.target.files[0]; if (!file || !file.name.endsWith('.js')) return alert('ä»…æ”¯æŒ.jsæ–‡ä»¶');
  const reader = new FileReader();
  reader.onload = e => { const f = fileList.find(x => x.id === id); if(f){f.fileContent=e.target.result; f.fileName=file.name; f.fileSize=file.size; saveData(); renderTable();} };
  reader.readAsDataURL(file);
}
function downloadFile(id) { const f = fileList.find(x => x.id === id); if(f && f.fileContent) { const a = document.createElement('a'); a.href=f.fileContent; a.download=f.fileName; a.click(); } }
function formatFileSize(bytes) { if(!bytes) return ''; const i = Math.floor(Math.log(bytes)/Math.log(1024)); return ' (' + (bytes/Math.pow(1024,i)).toFixed(2) + ['B','KB','MB'][i] + ')'; }
function checkFilter(file) {
  const key = document.querySelector('.search-box').value.toLowerCase();
  if (key && !file.fileName.toLowerCase().includes(key) && !file.note.toLowerCase().includes(key)) return false;
  const active = sources.filter(s => document.getElementById('filter-'+s)?.checked);
  return active.length ? active.some(s => file.unsupportedSources.includes(s)) : true;
}
function filterTable() { renderTable(); }
function clearFilters() { sources.forEach(s => document.getElementById('filter-'+s).checked=false); document.querySelector('.search-box').value=''; renderTable(); }
function updateStats() {
  const total = fileList.length; const up = fileList.filter(f => f.fileContent).length;
  document.getElementById('totalFiles').textContent = total; document.getElementById('uploadedCount').textContent = up;
  document.getElementById('flacCount').textContent = fileList.filter(f => f.quality.includes('flac')).length;
  document.getElementById('fullSupportCount').textContent = fileList.filter(f => f.unsupportedSources.length === 0).length;
}
function clearAll() { if(confirm('æ¸…ç©ºæ‰€æœ‰ï¼Ÿ')) { fileList=[]; saveData(); renderTable(); } }
function exportToJSON() {
  const blob = new Blob([JSON.stringify(fileList,null,2)], {type: 'application/json'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='éŸ³æº_'+new Date().toISOString().slice(0,10)+'.json'; a.click();
}
function importFromJSON(e) {
  const f=e.target.files[0]; if(!f)return;
  const r=new FileReader(); r.onload=ev=>{ try{ fileList=JSON.parse(ev.target.result); saveData(); renderTable(); alert('å¯¼å…¥æˆåŠŸ'); }catch(ex){alert('æ ¼å¼é”™è¯¯');} };
  r.readAsText(f); e.target.value='';
}
function exportToMarkdown() {
  let md = '# éŸ³æºæŠ¥å‘Š\n\n| åºå· | æ–‡ä»¶å | éŸ³è´¨ | çŠ¶æ€ | å¤‡æ³¨ |\n|---|---|---|---|---|\n';
  fileList.forEach((f,i) => md += `| ${i+1} | ${f.fileName} | ${f.quality} | ${f.unsupportedSources.join(',')||'å…¨æ”¯æŒ'} | ${f.note} |\n`);
  const a = document.createElement('a'); a.href=URL.createObjectURL(new Blob([md],{type:'text/markdown'})); a.download='report.md'; a.click();
}

// ----------------------------------------------------------------------
// å¯¼å‡ºæ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨å‡½æ•°åºåˆ—åŒ–ï¼Œé˜²æ­¢æ¨¡æ¿å­—ç¬¦ä¸²è½¬ä¹‰å¯¼è‡´çš„ç®¡ç†ç«¯å´©æºƒ
// ----------------------------------------------------------------------

// è¿™æ˜¯ä¸€ä¸ªå®šä¹‰åœ¨ç®¡ç†ç«¯çš„å‡½æ•°ï¼Œç”¨æ¥ç”Ÿæˆå¯¼å‡ºæŠ¥å‘Šä¸­çš„ JS ä»£ç å­—ç¬¦ä¸²
// é€šè¿‡ .toString() æå–å‡½æ•°ä½“ï¼Œç»å¯¹å®‰å…¨ï¼Œä¸ä¼šå› ä¸ºåæ–œæ æŠ¥é”™
function getClientSideScript() {
  function clientSideLogic() {
    const INFO_LIMITS = { name: 24, description: 36, author: 56, homepage: 1024, version: 36 };

    function parseMetadata(script) {
        try {
            const meta = {};
            const lines = script.split('\n');
            let inComment = false;
            for (const line of lines) {
                if (line.includes('/*')) inComment = true;
                if (line.includes('*/')) inComment = false;
                if (inComment || line.trim().startsWith('//')) {
                    const match = line.match(/^\s*\*?\s*@(\w+)\s+(.+)/);
                    if (match) meta[match[1].trim()] = match[2].trim();
                }
            }
            return meta;
        } catch(e) { console.error(e); return {}; }
    }

    function truncateText(text, limit) {
      if (!text) return "";
      return text.length > limit ? text.substring(0, limit) + "..." : text;
    }

    function processFileContent(index, useKey) {
      var file = window.filesData[index];
      if (!file.fileContent) { alert("è¯¥æ–‡ä»¶æœªä¸Šä¼ ï¼"); return null; }
      try {
        var base64Data = file.fileContent.split(",")[1];
        var binaryString = atob(base64Data);
        var bytes = new Uint8Array(binaryString.length);
        for (var i = 0; i < binaryString.length; i++) { bytes[i] = binaryString.charCodeAt(i); }
        var decoder = new TextDecoder("utf-8");
        var decodedData = decoder.decode(bytes);
        
        if (useKey) {
            var keyInput = document.getElementById("localkey-" + index);
            var key = keyInput ? keyInput.value.trim() : "";
            if (!key) { alert("è¯·è¾“å…¥å¯†é’¥ï¼"); if(keyInput) keyInput.focus(); return null; }
            var keyVariable = file.keyVariable || "API_KEY";
            // ä½¿ç”¨ new RegExp åŠ¨æ€æ„å»ºæ­£åˆ™ï¼Œé¿å…å­—ç¬¦ä¸²è½¬ä¹‰é—®é¢˜
            var regex1 = new RegExp("const\\s+" + keyVariable + "\\s*=\\s*\"\"", "g");
            var regex2 = new RegExp("const\\s+" + keyVariable + "\\s*=\\s*\'\'", "g");
            decodedData = decodedData.replace(regex1, "const " + keyVariable + " = \"" + key + "\"");
            decodedData = decodedData.replace(regex2, "const " + keyVariable + " = \'" + key + "\'");
            decodedData = decodedData.replace(/\(å…¬ç›Šç‰ˆ\)/g, "").replace(/\(å…è´¹ç‰ˆ\)/g, "").replace(/ï¼ˆå…¬ç›Šç‰ˆï¼‰/g, "").replace(/ï¼ˆå…è´¹ç‰ˆï¼‰/g, "");
        }
        return decodedData;
      } catch (e) { alert("å¤„ç†æ–‡ä»¶å¤±è´¥ï¼š" + e.message); return null; }
    }

    window.downloadFile = function(index) {
       var content = processFileContent(index, false);
       if(!content) return;
       var blob = new Blob([content], {type: "text/javascript;charset=utf-8"});
       var link = document.createElement("a");
       link.href = URL.createObjectURL(blob);
       link.download = window.filesData[index].fileName || "download.js";
       link.click();
    };

    window.downloadWithLocalKey = function(index) {
       var content = processFileContent(index, true);
       if(!content) return;
       var blob = new Blob([content], {type: "text/javascript;charset=utf-8"});
       var link = document.createElement("a");
       link.href = URL.createObjectURL(blob);
       link.download = window.filesData[index].fileName || "download.js";
       link.click();
    };
    
    window.downloadWithOnlineKey = function(index){
        var file=window.filesData[index];
        var keyInput=document.getElementById("key-"+index);
        var key=keyInput.value.trim();
        if(!key){alert("è¯·è¾“å…¥å¯†é’¥ï¼");keyInput.focus();return;}
        if(!file.keyUrl){alert("è¯¥æ–‡ä»¶æ²¡æœ‰é…ç½®å¯†é’¥é“¾æ¥ï¼");return;}
        var downloadUrl=file.keyUrl+key;
        var link=document.createElement("a");
        link.href=downloadUrl;
        link.download=file.fileName||"download.js";
        link.click();
        alert("å¼€å§‹ä¸‹è½½ï¼Œå¦‚æœæ²¡æœ‰ååº”è¯·æ£€æŸ¥å¯†é’¥æ˜¯å¦æ­£ç¡®ï¼");
    };

    window.downloadAllFiles = function(){
        var validFiles=window.filesData.filter(function(f){return f.fileContent||f.directUrl;});
        if(validFiles.length===0){alert("æ²¡æœ‰å¯ä¸‹è½½çš„å…è´¹æ–‡ä»¶!");return;}
        if(!confirm("å°†ä¸‹è½½ "+validFiles.length+" ä¸ªæ–‡ä»¶ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ")){return;}
        validFiles.forEach(function(file,index){
            setTimeout(function(){
                if(file.directUrl){
                    var link=document.createElement("a");
                    link.href=file.directUrl;
                    link.download=file.fileName||"file_"+index+".js";
                    link.click();
                }else if(file.fileContent){
                    var content = window.filesData[index].fileContent; 
                    var base64Data = content.split(",")[1];
                    var binaryString = atob(base64Data);
                    var bytes = new Uint8Array(binaryString.length);
                    for (var i = 0; i < binaryString.length; i++) { bytes[i] = binaryString.charCodeAt(i); }
                    var blob = new Blob([bytes], {type: "text/javascript;charset=utf-8"});
                    var link=document.createElement("a");
                    link.href=URL.createObjectURL(blob);
                    link.download=file.fileName||"file_"+index+".js";
                    link.click();
                }
            },index*500);
        });
        alert("å¼€å§‹ä¸‹è½½ "+validFiles.length+" ä¸ªæ–‡ä»¶...");
    };

    window.generateImportScript = async function(index, useKey) {
      var scriptContent = processFileContent(index, useKey);
      if (!scriptContent) return;
      var file = window.filesData[index];
      var statusBtn = event.target;
      var originalText = statusBtn.innerText;
      statusBtn.innerText = "â³ å¤„ç†ä¸­...";
      statusBtn.disabled = true;

      try {
          var metadata = parseMetadata(scriptContent);
          
          // Zlib å‹ç¼©é€»è¾‘
          const encoder = new TextEncoder();
          const rawBytes = encoder.encode(scriptContent);
          const stream = new Blob([rawBytes]).stream();
          const compressedStream = stream.pipeThrough(new CompressionStream('deflate'));
          const response = await new Response(compressedStream).arrayBuffer();
          const compressedBytes = new Uint8Array(response);
          
          var binary = "";
          for (var i = 0; i < compressedBytes.byteLength; i++) { 
              binary += String.fromCharCode(compressedBytes[i]); 
          }
          var compressedBase64 = "gz_" + btoa(binary);

          var apiId = "user_api_" + Math.random().toString().substring(2, 5) + "_" + Date.now();
          var apiName = truncateText(metadata.name || file.fileName.replace(/\.js$/i,'') || "unknown", INFO_LIMITS.name);
          var apiDesc = truncateText(metadata.description || file.note || "Imported source", INFO_LIMITS.description);
          var apiAuthor = truncateText(metadata.author || file.author || "User", INFO_LIMITS.author);
          var apiVersion = truncateText(metadata.version || file.version || "1.0.0", INFO_LIMITS.version);
          var apiHomepage = truncateText(metadata.homepage || "", INFO_LIMITS.homepage);

          var userApiObj = {
              "id": apiId,
              "name": apiName,
              "description": apiDesc,
              "version": apiVersion,
              "author": apiAuthor,
              "homepage": apiHomepage,
              "allowShowUpdateAlert": true,
              "script": compressedBase64
          };
          
          var jsonStr = JSON.stringify(userApiObj);
          var jsonBase64 = btoa(unescape(encodeURIComponent(jsonStr)));

          var randId = Math.floor(Math.random() * 100000);
          var b64FileName = "lx_payload_" + randId + ".txt";
          var psFileName = "lx_importer_" + randId + ".ps1";
          
          var chunks = [];
          var chunkSize = 70; 
          for (var i = 0; i < jsonBase64.length; i += chunkSize) {
            chunks.push(jsonBase64.substring(i, i + chunkSize));
          }

          var psCode = [
            '$ErrorActionPreference = "Stop"',
            'try {',
            '    $targetDir = "$env:APPDATA\\lx-music-desktop\\LxDatas"',
            '    $targetFile = "$targetDir\\user_api.json"',
            '    $tempB64 = "$env:TEMP\\' + b64FileName + '"',
            '',
            '    if (-not (Test-Path $tempB64)) { throw "Data file lost." }',
            '    $b64 = Get-Content $tempB64 | Out-String',
            '    $b64 = $b64 -replace "[\\r\\n\\s]", ""',
            '    $jsonBytes = [System.Convert]::FromBase64String($b64)',
            '    $jsonStr = [System.Text.Encoding]::UTF8.GetString($jsonBytes)',
            '',
            '    if (-not (Test-Path $targetDir)) { New-Item -ItemType Directory -Path $targetDir | Out-Null }',
            '',
            '    if (-not (Test-Path $targetFile)) {',
            '        $finalJson = "{`"userApis`": [" + $jsonStr + "]}"',
            '        [System.IO.File]::WriteAllText($targetFile, $finalJson, [System.Text.UTF8Encoding]::new($false))',
            '    } else {',
            '        $raw = [System.IO.File]::ReadAllText($targetFile)',
            '        $start = $raw.IndexOf("{")',
            '        $end = $raw.LastIndexOf("}")',
            '        if ($start -ge 0 -and $end -gt $start) {',
            '            $raw = $raw.Substring($start, $end - $start + 1)',
            '        } else {',
            '             $raw = "{`"userApis`":[]}"',
            '        }',
            '',
            '        $lastBracket = $raw.LastIndexOf("]")',
            '        if ($lastBracket -gt 0) {',
            '             $prevChar = $raw.Substring($lastBracket-1, 1)',
            '             $prefix = ","',
            '             if ($prevChar -eq "[") { $prefix = "" }',
            '             $newContent = $raw.Insert($lastBracket, $prefix + $jsonStr)',
            '             [System.IO.File]::WriteAllText($targetFile, $newContent, [System.Text.UTF8Encoding]::new($false))',
            '        } else {',
            '             throw "Invalid JSON structure found."',
            '        }',
            '    }',
            '} catch {',
            '    Write-Host "Error: $_" -ForegroundColor Red',
            '    exit 1',
            '}'
          ].join('\r\n');

          var bat = '@echo off\r\n';
          bat += 'setlocal\r\n';
          bat += 'title LX Music Source Importer\r\n';
          bat += 'echo Initializing...\r\n';
          bat += 'set "B64_FILE=%TEMP%\\' + b64FileName + '"\r\n';
          bat += 'type nul > "%B64_FILE%"\r\n';
          for(var i=0; i<chunks.length; i++) {
             bat += 'echo ' + chunks[i] + '>> "%B64_FILE%"\r\n';
          }
          var psCodeBase64 = btoa(unescape(encodeURIComponent(psCode)));
          var psChunks = [];
          for (var k = 0; k < psCodeBase64.length; k += 70) {
            psChunks.push(psCodeBase64.substring(k, k + 70));
          }
          bat += 'set "PS_B64=%TEMP%\\ps_' + randId + '.b64"\r\n';
          bat += 'type nul > "%PS_B64%"\r\n';
          for(var m=0; m<psChunks.length; m++) {
             bat += 'echo ' + psChunks[m] + '>> "%PS_B64%"\r\n';
          }
          bat += 'certutil -decode "%PS_B64%" "%TEMP%\\' + psFileName + '" >nul\r\n';
          bat += 'echo Running installation script...\r\n';
          bat += 'powershell -NoProfile -ExecutionPolicy Bypass -File "%TEMP%\\' + psFileName + '"\r\n';
          bat += 'if %errorlevel% neq 0 ( color 4f & echo. & echo [ERROR] Installation Failed! & pause ) else ( \r\n';
          bat += '  del "%B64_FILE%"\r\n';
          bat += '  del "%PS_B64%"\r\n';
          bat += '  del "%TEMP%\\' + psFileName + '"\r\n';
          bat += '  echo. & echo [SUCCESS] Installation Complete! Please restart LX Music. & timeout /t 5 >nul \r\n';
          bat += ')\r\n';

          // --- START CHANGE: ä½¿ç”¨ JSZip å‹ç¼© .bat æ–‡ä»¶ ---
          var safeName = apiName.replace(/[\\/:*?"<>|]/g,'_');
          var batFileName = "ä¸€é”®å¯¼å…¥_" + safeName + ".bat";
          var zipFileName = "ä¸€é”®å¯¼å…¥åŒ…_" + safeName + ".zip";

          var zip = new JSZip();
          zip.file(batFileName, bat);
          
          var content = await zip.generateAsync({type:"blob"});
          var link = document.createElement("a");
          link.href = URL.createObjectURL(content);
          link.download = zipFileName;
          link.click();
          // --- END CHANGE ---
          
      } catch (e) {
          alert("ç”Ÿæˆè„šæœ¬å¤±è´¥: " + e.message);
          console.error(e);
      } finally {
          statusBtn.innerText = originalText;
          statusBtn.disabled = false;
      }
    };
  }
  
  // æå–å‡½æ•°ä½“å†…å®¹
  const fnStr = clientSideLogic.toString();
  return fnStr.substring(fnStr.indexOf("{") + 1, fnStr.lastIndexOf("}"));
}

function exportHTMLWithFiles() {
  const filesDataJSON = JSON.stringify(fileList.map(f => ({
    id: f.id,
    fileName: f.fileName,
    fileContent: f.fileContent,
    quality: f.quality,
    unsupportedSources: f.unsupportedSources,
    note: f.note,
    links: f.links,
    keyMode: f.keyMode,
    keyUrl: f.keyUrl,
    keyVariable: f.keyVariable,
    directUrl: f.directUrl,
    author: f.author || 'æœªçŸ¥ä½œè€…',
    version: f.version || '1.0.0'
  })));

  const reportHTML = [];
  reportHTML.push('<!DOCTYPE html><html><head><meta charset="UTF-8"><title>éŸ³æºç®¡ç†æŠ¥å‘Š</title>');
  // --- START CHANGE: å¼•å…¥ JSZip åº“ ---
  reportHTML.push('<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"><\/script>');
  // --- END CHANGE ---
  reportHTML.push('<style>body{font-family:Microsoft YaHei,Arial,sans-serif;max-width:1400px;margin:20px auto;padding:20px;background:#f5f5f5}h1{color:#333;border-bottom:3px solid #667eea;padding-bottom:10px}.info-box{background:#e3f2fd;padding:15px;border-radius:8px;margin:20px 0}table{width:100%;border-collapse:collapse;margin:20px 0;background:white;box-shadow:0 2px 8px rgba(0,0,0,0.1)}th{background:#667eea;color:white;padding:12px;text-align:left}td{padding:10px;border-bottom:1px solid #ddd;vertical-align:top}tr:hover{background:#f8f9fa}.btn{padding:6px 12px;border:none;border-radius:4px;cursor:pointer;font-size:12px;text-decoration:none;display:inline-block;margin:2px;color:white;transition:opacity 0.2s}.btn:hover{opacity:0.9}.btn:disabled{background:#ccc!important;cursor:not-allowed}.btn-green{background:#28a745}.btn-blue{background:#17a2b8}.btn-yellow{background:#ffc107;color:#333}.no-file{color:#999;font-style:italic}.quality{padding:4px 10px;border-radius:12px;font-size:12px;font-weight:bold;display:inline-block}.q-flac{background:#007bff;color:white}.q-320k{background:#28a745;color:white}.q-128k{background:#ffc107;color:#333}.unsupported{color:#dc3545;font-weight:bold}.supported{color:#28a745;font-weight:bold}.link-tag{display:inline-block;margin:3px;padding:4px 10px;background:#667eea;color:white;border-radius:15px;font-size:11px;text-decoration:none}.key-box{margin-top:10px;padding:10px;background:#fff3cd;border:1px solid #ffc107;border-radius:4px}.input-group{display:flex;gap:5px;margin-top:5px}.input-group input{flex:1;padding:5px;border:1px solid #ccc;border-radius:4px}</style></head><body>');
  
  reportHTML.push('<h1>ğŸµ éŸ³æºç®¡ç†æŠ¥å‘Š</h1>');
  reportHTML.push('<div class="info-box"><p><strong>ç”Ÿæˆæ—¶é—´:</strong> ' + new Date().toLocaleString('zh-CN') + '</p><p><strong>æ€»æ–‡ä»¶æ•°:</strong> ' + fileList.length + '</p><p><strong>è¯´æ˜:</strong> ç‚¹å‡»ã€ä¸€é”®å¯¼å…¥è„šæœ¬ã€‘ä¸‹è½½ .zip å‹ç¼©åŒ…ï¼Œè§£å‹(åˆ°ä»»æ„ä½ç½®)ååŒå‡» .bat æ–‡ä»¶å³å¯å°†éŸ³æºå®‰è£…åˆ° LX Musicã€‚</p></div>');
  reportHTML.push('<button class="btn btn-green" style="font-size:14px;padding:10px 20px" onclick="downloadAllFiles()">ğŸ“¦ æ‰“åŒ…ä¸‹è½½æ‰€æœ‰å…è´¹æ–‡ä»¶</button>');
  
  reportHTML.push('<table><thead><tr><th>åºå·</th><th>æ–‡ä»¶å</th><th>éŸ³è´¨</th><th>å¤‡æ³¨ & é“¾æ¥</th><th>ä¸‹è½½æ“ä½œ</th></tr></thead><tbody>');
  
  fileList.forEach((file, index) => {
    let qClass = file.quality.includes('flac') ? 'q-flac' : file.quality.includes('320') ? 'q-320k' : 'q-128k';
    let unsupported = file.unsupportedSources.length > 0 ? `<span class="unsupported">ä¸æ”¯æŒ: ${file.unsupportedSources.map(s => sourceNames[s]).join(',')}</span>` : '<span class="supported">å…¨æ”¯æŒ</span>';
    let actions = '';
    if (file.directUrl) actions += `<a href="${file.directUrl}" class="btn btn-green" download>â¬‡ï¸ åœ¨çº¿ä¸‹è½½</a><br>`;
    if (file.fileContent) actions += `<div style="margin:5px 0"><button class="btn btn-green" onclick="downloadFile(${index})">â¬‡ï¸ æœ¬åœ°ä¸‹è½½</button><button class="btn btn-blue" onclick="generateImportScript(${index}, false)">ğŸš€ ä¸€é”®å¯¼å…¥è„šæœ¬(Zip)</button></div>`;
    if (file.keyMode === 'link' && file.keyUrl) actions += `<div class="key-box"><label>ğŸ”‘ åœ¨çº¿å¯†é’¥:</label><div class="input-group"><input type="text" id="key-${index}" placeholder="è¾“å…¥å¯†é’¥"><button class="btn btn-yellow" onclick="downloadWithOnlineKey(${index})">ä¸‹è½½</button></div></div>`;
    if (file.keyMode === 'local' && file.keyVariable && file.fileContent) actions += `<div class="key-box"><label>ğŸ”‘ æœ¬åœ°å¯†é’¥å¯¼å…¥:</label><div class="input-group"><input type="text" id="localkey-${index}" placeholder="è¾“å…¥å¯†é’¥"><button class="btn btn-yellow" onclick="downloadWithLocalKey(${index})">ä¸‹è½½JS</button></div><div style="margin-top:5px"><button class="btn btn-blue" style="width:100%" onclick="generateImportScript(${index}, true)">ğŸš€ ä¸‹è½½ä¸€é”®å¯¼å…¥(Zip)</button></div></div>`;
    if (!actions) actions = '<span class="no-file">æ— ä¸‹è½½æ–¹å¼</span>';
    let links = (file.note || '') + '<br>';
    if (file.links) file.links.forEach(l => links += `<a href="${l.url}" target="_blank" class="link-tag">ğŸ”— ${l.text}</a> `);
    reportHTML.push(`<tr><td>${index + 1}</td><td>${file.fileName || '(æœªå‘½å)'}</td><td><span class="quality ${qClass}">${file.quality}</span><br><br>${unsupported}</td><td>${links}</td><td>${actions}</td></tr>`);
  });
  
  reportHTML.push('</tbody></table>');
  
  // æ³¨å…¥è„šæœ¬
  reportHTML.push('<script>');
  reportHTML.push('window.filesData = ' + filesDataJSON + ';');
  reportHTML.push(getClientSideScript()); // å®‰å…¨æ³¨å…¥å‡½æ•°ä½“
  reportHTML.push('<\/script></body></html>');
  
  const blob = new Blob([reportHTML.join('')], { type: 'text/html;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'éŸ³æºå®Œæ•´æŠ¥å‘Š(Zipç‰ˆ)_' + new Date().toISOString().slice(0,10) + '.html';
  a.click();
  URL.revokeObjectURL(url);
}

function renderTable() {
  const tbody = document.getElementById('tableBody');
  if (fileList.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="empty-state">æš‚æ— æ•°æ®ï¼Œç‚¹å‡»ä¸Šæ–¹"æ·»åŠ æ–‡ä»¶"æŒ‰é’®å¼€å§‹</td></tr>'; return; }
  let html = ''; let displayIndex = 1;
  fileList.forEach((file, index) => {
    if (!checkFilter(file)) return;
    const hasFile = !!file.fileContent;
    let linksHtml = ''; if (file.links) file.links.forEach((l, i) => linksHtml += `<a href="${l.url}" target="_blank" class="link-tag"><span class="link-tag-text">ğŸ”— ${l.text}</span><button class="link-tag-remove" onclick="event.preventDefault(); removeLink(${file.id}, ${i})">Ã—</button></a>`);
    let keyUrlHtml = '';
    if (file.keyMode === 'link' && file.keyUrl) keyUrlHtml = `<div class="key-url-display" title="${file.keyUrl}">ğŸ”‘ åœ¨çº¿å¯†é’¥: ${file.keyUrl}<span class="remove-key" onclick="removeKeyUrl(${file.id})">Ã—</span></div>`;
    else if (file.keyMode === 'local' && file.keyVariable) keyUrlHtml = `<div class="key-url-display">ğŸ”‘ æœ¬åœ°å¯†é’¥: ${file.keyVariable}<span class="remove-key" onclick="removeKeyUrl(${file.id})">Ã—</span></div>`;
    let directUrlHtml = file.directUrl ? `<div class="direct-url-display" title="${file.directUrl}">ğŸŒ åœ¨çº¿é“¾æ¥: ${file.directUrl}<span class="remove-key" onclick="removeDirectUrl(${file.id})">Ã—</span></div>` : '';
    html += `<tr>
      <td><div class="sort-buttons"><button class="sort-btn" onclick="moveUp(${index})" ${index===0?'disabled':''}>â–²</button><button class="sort-btn" onclick="moveDown(${index})" ${index===fileList.length-1?'disabled':''}>â–¼</button></div></td>
      <td style="text-align: center; font-weight: bold; color: #666;">${displayIndex}</td>
      <td class="file-upload-cell"><div class="file-name"><span class="file-icon">ğŸ“œ</span><div style="flex: 1;"><input type="text" value="${file.fileName}" onchange="updateFileName(${file.id}, this.value)" placeholder="è¾“å…¥æ–‡ä»¶å" style="border: ${file.fileName ? '1px solid #ddd' : '2px solid #ffc107'};">${hasFile ? `<span class="file-status">âœ… å·²ä¸Šä¼ ${formatFileSize(file.fileSize)}</span>` : '<span class="file-status no-file">âš ï¸ æœªä¸Šä¼ </span>'}</div></div></td>
      <td><select onchange="updateQuality(${file.id}, this.value)" style="width: 100%;">${qualityOptions.map(q=>`<option value="${q}" ${file.quality===q?'selected':''}>${q}</option>`).join('')}</select></td>
      <td><div class="checkbox-group">${sources.map(s=>`<div class="source-checkbox"><input type="checkbox" id="source-${file.id}-${s}" ${file.unsupportedSources.includes(s)?'checked':''} onchange="updateUnsupportedSources(${file.id}, '${s}', this.checked)"><label for="source-${file.id}-${s}">${sourceNames[s]}</label></div>`).join('')}${file.unsupportedSources.length===0?'<span style="color:#28a745;font-size:11px;font-weight:bold;">âœ“ å…¨æ”¯æŒ</span>':''}</div></td>
      <td><div class="note-container"><textarea class="note-text" onchange="updateNote(${file.id}, this.value)" placeholder="è¾“å…¥å¤‡æ³¨...">${file.note||''}</textarea><div><button class="add-link-btn" onclick="openLinkModal(${file.id})">â• æ·»åŠ é“¾æ¥</button><button class="add-direct-btn" onclick="openDirectUrlModal(${file.id})">ğŸŒ åœ¨çº¿é“¾æ¥</button><button class="add-key-btn" onclick="openKeyModal(${file.id})">ğŸ”‘ å¯†é’¥é…ç½®</button></div>${linksHtml}${directUrlHtml}${keyUrlHtml}</div></td>
      <td><input type="file" id="file-${file.id}" class="file-input" accept=".js" onchange="uploadFile(${file.id}, event)"><button class="upload-btn" onclick="document.getElementById('file-${file.id}').click()">${hasFile?'ğŸ“¤ é‡ä¼ ':'ğŸ“ ä¸Šä¼ '}</button>${hasFile?`<button class="download-btn" onclick="downloadFile(${file.id})">â¬‡ï¸ ä¸‹è½½</button>`:''}<button class="delete-btn" onclick="deleteRow(${file.id})">åˆ é™¤</button></td>
    </tr>`;
    displayIndex++;
  });
  tbody.innerHTML = html;
}

window.onload = function() {
  loadData();
  if (fileList.length === 0) {
    fileList = [{ id: Date.now(), fileName: 'example.js', quality: '320k', unsupportedSources: [], note: 'è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æ–‡ä»¶', links: [], keyMode: '', keyUrl: '', keyVariable: '', directUrl: '', fileContent: null, fileSize: 0, addedTime: new Date().toLocaleString('zh-CN'), author: 'æœªçŸ¥ä½œè€…', version: '1.0.0' }];
    saveData(); renderTable();
  }
  const tpl = document.getElementById('keyUrlTemplate');
  if(tpl) tpl.addEventListener('input', function(){ document.getElementById('keyUrlExample').value = this.value ? this.value + '123-456' : ''; });
  window.onclick = function(e) {
    if(e.target===document.getElementById('linkModal')) closeLinkModal();
    if(e.target===document.getElementById('keyModal')) closeKeyModal();
    if(e.target===document.getElementById('directUrlModal')) closeDirectUrlModal();
  };
};
</script>
</body>
</html>