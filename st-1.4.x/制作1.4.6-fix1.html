<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ’ä»¶åˆ—è¡¨ç®¡ç†å™¨ v1.4.6</title>
<style>
    /* åŸºç¡€å˜é‡ä¸é‡ç½® */
    :root { 
        --primary: #3b82f6; --primary-hover: #2563eb;
        --danger: #ef4444; --danger-hover: #dc2626;
        --success: #10b981; --success-hover: #059669;
        --text-main: #334155; --text-sub: #64748b;
        --bg: #f8fafc; --border: #e2e8f0; --white: #ffffff;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft YaHei", sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 20px; font-size: 14px; display: flex; justify-content: center; }
    * { box-sizing: border-box; outline: none; }
    
    /* ä¸»çª—å£ */
    .app-container { width: 100%; max-width: 1400px; background: var(--white); border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -2px rgba(0,0,0,0.025); display: flex; flex-direction: column; height: 92vh; border: 1px solid var(--border); overflow: hidden; }
    
    /* é¡¶éƒ¨å¯¼èˆª */
    .header { padding: 16px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff; }
    .app-title { font-size: 20px; font-weight: 700; color: #0f172a; display: flex; align-items: center; gap: 10px; }
    .version-badge { font-size: 12px; background: #eff6ff; color: var(--primary); padding: 2px 10px; border-radius: 99px; border: 1px solid #bfdbfe; font-weight: 600; }
    .status-text { color: #94a3b8; font-size: 12px; font-family: monospace; }
    .storage-warning { color: #ef4444; margin-left: 8px; font-weight: 600; animation: pulse 2s infinite; }
    @keyframes pulse {
        0% { opacity: 0.7; }
        50% { opacity: 1; }
        100% { opacity: 0.7; }
    }

    /* æ ‡ç­¾æ  */
    .tabs-container { display: flex; align-items: flex-end; padding: 0 20px; background: #f1f5f9; border-bottom: 1px solid var(--border); overflow-x: auto; gap: 6px; pt: 8px; }
    .tab-item { padding: 10px 24px; cursor: pointer; color: var(--text-sub); font-weight: 500; border: 1px solid transparent; border-bottom: none; border-radius: 8px 8px 0 0; transition: all 0.2s; position: relative; bottom: -1px; white-space: nowrap; font-size: 13px; }
    .tab-item:hover { color: var(--text-main); background: #e2e8f0; }
    .tab-item.active { background: var(--white); color: var(--primary); border-color: var(--border); border-bottom-color: var(--white); font-weight: 700; }
    .tab-close { margin-left: 8px; font-size: 14px; width: 18px; height: 18px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; color: #cbd5e1; transition: 0.2s; }
    .tab-close:hover { background: #fee2e2; color: var(--danger); }
    .tab-add-btn { padding: 10px 16px; cursor: pointer; color: var(--text-sub); font-size: 18px; font-weight: bold; line-height: 1; opacity: 0.6; transition: 0.2s; }
    .tab-add-btn:hover { opacity: 1; color: var(--primary); background: #e2e8f0; border-radius: 8px 8px 0 0; }

    /* å·¥å…·æ  */
    .toolbar { padding: 16px 24px; display: flex; gap: 12px; align-items: center; background: var(--white); border-bottom: 1px solid var(--border); flex-wrap: wrap; }
    .spacer { flex: 1; }
    .search-input { padding: 8px 14px; border: 1px solid var(--border); border-radius: 8px; width: 240px; font-size: 13px; transition: all 0.2s; background: #f8fafc; }
    .search-input:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }

    /* è¡¨æ ¼åŒºåŸŸ */
    .table-wrapper { flex: 1; overflow-y: auto; background: #fcfcfc; }
    table { width: 100%; border-collapse: collapse; min-width: 1000px; }
    th { position: sticky; top: 0; background: #f8fafc; z-index: 10; padding: 14px 16px; text-align: left; font-weight: 600; color: #475569; border-bottom: 1px solid var(--border); font-size: 13px; letter-spacing: 0.02em; }
    td { padding: 14px 16px; border-bottom: 1px solid #f1f5f9; vertical-align: top; background: #fff; }
    tr:hover td { background: #f8fafc; }
    
    /* æŒ‰é’®ç»„ä»¶ */
    .btn, .btn-xs { 
        padding: 8px 16px; border-radius: 8px; border: 1px solid transparent; 
        font-size: 13px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 6px; 
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); font-weight: 500; user-select: none; 
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }
    .btn:active, .btn-xs:active { transform: translateY(1px); box-shadow: none; }
    
    .btn-primary { background: var(--primary); border-color: var(--primary); color: #ffffff; } 
    .btn-primary:hover { background: var(--primary-hover); border-color: var(--primary-hover); }
    
    .btn-success { background: var(--success); border-color: var(--success); color: #ffffff; } 
    .btn-success:hover { background: var(--success-hover); border-color: var(--success-hover); }
    
    .btn-danger { background: var(--danger); border-color: var(--danger); color: #ffffff; } 
    .btn-danger:hover { background: var(--danger-hover); border-color: var(--danger-hover); }
    
    .btn-secondary { background: #fff; border: 1px solid var(--border); color: var(--text-main); box-shadow: 0 1px 2px 0 rgba(0,0,0,0.02); } 
    .btn-secondary:hover { background: #f8fafc; border-color: #cbd5e1; color: var(--primary); }
    
    .btn-xs { padding: 4px 12px; font-size: 12px; border-radius: 6px; line-height: 1.5; height: auto; }
    .btn-icon { width: 30px; height: 30px; padding: 0; display: inline-flex; justify-content: center; align-items: center; background: transparent; border: 1px solid transparent; border-radius: 6px; color: #94a3b8; cursor: pointer; font-size: 14px; transition: 0.2s; }
    .btn-icon:hover { background: #f1f5f9; color: var(--primary); }

    /* è¡¨å•æ§ä»¶ */
    input[type="text"], select, textarea { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; color: var(--text-main); transition: 0.2s; font-family: inherit; }
    input[type="text"]:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
    
    /* æ ‡ç­¾Tag */
    .tag-list { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .tag { font-size: 11px; padding: 2px 8px; border-radius: 4px; border: 1px solid; display: inline-flex; align-items: center; gap: 5px; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-weight: 500; }
    .tag-blue { background: #eff6ff; color: #1d4ed8; border-color: #dbeafe; }
    .tag-orange { background: #fff7ed; color: #c2410c; border-color: #ffedd5; }
    .tag-green { background: #f0fdf4; color: #15803d; border-color: #dcfce7; }
    .tag-del { cursor: pointer; opacity: 0.4; font-weight: bold; font-size: 14px; line-height: 1; }
    .tag-del:hover { opacity: 1; color: var(--danger); }

    /* å¼¹çª—é€šç”¨ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.4); z-index: 999; backdrop-filter: blur(4px); }
    .modal-box { position: absolute; top: 10%; left: 50%; transform: translateX(-50%); background: white; width: 480px; padding: 24px; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1); display: flex; flex-direction: column; max-height: 85vh; }
    .modal-box.large { width: 900px; top: 5%; }
    .modal-header { font-size: 18px; font-weight: 700; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; color: #1e293b; flex-shrink: 0; }
    .modal-body { overflow-y: auto; flex: 1; padding-right: 4px; }
    .modal-footer { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #f1f5f9; padding-top: 16px; flex-shrink: 0; }
    .form-item { margin-bottom: 16px; }
    .form-item label { display: block; margin-bottom: 8px; font-size: 13px; font-weight: 600; color: #475569; }
    
    /* å¤é€‰æ¡†è¡Œ */
    .check-row { display: flex; align-items: center; gap: 10px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: 0.15s; background: #fff; }
    .check-row:hover { border-color: var(--primary); background: #f8fafc; }
    .check-row input { width: 18px; height: 18px; accent-color: var(--primary); cursor: pointer; }
    .check-row.active { border-color: var(--primary); background: #eff6ff; }

    /* ä¸»é¢˜ä»£ç ç¼–è¾‘å™¨ */
    .code-editor { font-family: 'Menlo', 'Monaco', 'Courier New', monospace; font-size: 12px; line-height: 1.5; background: #1e293b; color: #e2e8f0; padding: 16px; border-radius: 8px; width: 100%; height: 400px; resize: vertical; border: 1px solid #334155; }
    .theme-list { 
        display: flex; 
        gap: 10px; 
        overflow-x: auto; 
        padding-bottom: 10px; 
        margin-bottom: 16px; 
        border-bottom: 1px solid #e2e8f0; 
        -webkit-overflow-scrolling: touch; /* iOS smooth scrolling */
        scrollbar-width: none; /* Firefox hide scrollbar */
    }
    .theme-list::-webkit-scrollbar {
        display: none; /* Chrome/Safari hide scrollbar */
    }
    .theme-card { 
        border: 1px solid #e2e8f0; 
        border-radius: 8px; 
        padding: 10px 16px; 
        cursor: pointer; 
        min-width: 130px; /* Adjusted minimum width */
        text-align: center; 
        font-weight: 500; 
        transition: 0.2s; 
        background: #f8fafc; 
        position: relative; 
        user-select: none; /* Prevent text selection on long press */
    }
    .theme-card:hover { border-color: #94a3b8; }
    .theme-card.active { border-color: var(--primary); background: #eff6ff; color: var(--primary); font-weight: 700; box-shadow: 0 0 0 1px var(--primary); }
    .theme-card.locked::after { content: 'ğŸ”’'; position: absolute; top: 5px; right: 5px; font-size: 10px; opacity: 0.6; }
    .theme-actions { position: absolute; bottom: 5px; right: 5px; display: flex; gap: 4px; }
    .theme-action-btn { width: 18px; height: 18px; padding: 0; display: inline-flex; justify-content: center; align-items: center; background: rgba(255,255,255,0.8); border: 1px solid transparent; border-radius: 3px; font-size: 10px; cursor: pointer; color: #64748b; transition: 0.2s; }
    .theme-action-btn:hover { background: #fff; color: var(--primary); }
    .theme-action-btn.delete:hover { color: var(--danger); }
    /* ä¿®æ”¹ï¼šå°†ç§»åŠ¨æŒ‰é’®ç§»åˆ°å·¦ä¸‹è§’ */
    .theme-move-btn { 
        position: absolute; 
        bottom: 5px; 
        left: 5px; 
        width: 24px; /* Increased width */
        height: 24px; /* Increased height */
        display: flex; 
        align-items: center; 
        justify-content: center; 
        background: rgba(255,255,255,0.9); 
        border-radius: 4px; 
        font-size: 12px; 
        cursor: pointer; 
        color: #64748b; 
        box-shadow: 0 1px 2px rgba(0,0,0,0.1); /* Added shadow for better visibility */
        z-index: 5;
    }
    .theme-move-btn:hover { background: #fff; color: var(--primary); }
    .theme-move-btn:nth-child(2) { left: 32px; } /* Adjusted spacing for the second button */
    .var-badge { background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 12px; border: 1px solid #e2e8f0; color: #db2777; }

    .empty-state { padding: 80px 0; text-align: center; color: #94a3b8; }
    .empty-state-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
    
    /* æ–°ä¸»é¢˜åˆ›å»ºè¡¨å• */
    .new-theme-form { background: #f8fafc; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 16px; }
    .form-row { display: flex; gap: 10px; margin-bottom: 12px; }
    .form-row input { flex: 1; }
    
    /* æ ‡ç­¾é¡µæ’åºåˆ—è¡¨ */
    .sortable-list { max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; background: #fff; }
    .sortable-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-bottom: 1px solid #f1f5f9; cursor: move; transition: 0.2s; }
    .sortable-item:hover { background: #f8fafc; }
    .sortable-item:last-child { border-bottom: none; }
    .sortable-handle { color: #94a3b8; cursor: move; font-size: 14px; margin-right: 8px; }
    .sortable-move-btn { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; background: #f1f5f9; border-radius: 4px; cursor: pointer; font-size: 10px; color: #64748b; }
    .sortable-move-btn:hover { background: #e2e8f0; color: var(--primary); }
    .sortable-move-btn:disabled { opacity: 0.3; cursor: not-allowed; }

    /* æ–°å¢ï¼šæ’åºåˆ—æ ·å¼ */
    .sort-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        width: 100%;
    }

    .position-number {
        min-width: 24px;
        text-align: center;
        font-size: 14px;
        font-weight: 600;
        color: #3b82f6;
        background: #eff6ff;
        padding: 2px 6px;
        border-radius: 4px;
        border: 1px solid #dbeafe;
    }

    .arrow-buttons {
        display: flex;
        flex-direction: column;
        gap: 2px;
        margin-left: 4px;
    }
</style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <div class="app-title">
            æ’ä»¶åˆ—è¡¨ç®¡ç†å™¨ 
            <span class="version-badge">v1.4.6</span>
        </div>
        <div class="status-text">
            <span id="statusText">System Ready</span>
            <span id="storageWarning" class="storage-warning" style="display: none;">âš ï¸ é€€å‡ºå°†ä¸¢å¤±æ•°æ®</span>
        </div>
    </div>

    <div class="tabs-container" id="tabsBar"></div>

    <div class="toolbar">
        <button class="btn btn-success" onclick="app.addItem()">
            <span style="font-size:16px;font-weight:bold">+</span> æ–‡ä»¶
        </button>
        <button class="btn btn-secondary" onclick="app.openThemeModal()">
            ğŸ¨ è‡ªå®šä¹‰ä¸»é¢˜
        </button>
        <button class="btn btn-primary" onclick="app.exportHtml()">
            <span style="font-size:14px">ğŸ“¤</span> å¯¼å‡ºåˆ—è¡¨HTML
        </button>
        <!-- æ–°å¢ï¼šå¯¼å‡ºä¸ºMarkdownæŒ‰é’® -->
        <button class="btn btn-secondary" onclick="app.exportMarkdown()">
            ğŸ“‹ å¯¼å‡ºä¸ºMarkdown
        </button>
        <button class="btn btn-secondary" onclick="app.exportJson()">
            ğŸ’¾ å¤‡ä»½æ•°æ®JSON
        </button>
        <div class="spacer"></div>
        <input type="file" id="importFile" hidden accept=".json" onchange="app.importJson(this)">
        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
            ğŸ“‚ å¯¼å…¥å¤‡ä»½/æ—§ç‰ˆ
        </button>
        <button class="btn btn-danger" onclick="app.clearTab()">
            ğŸ—‘ï¸ æ¸…ç©ºå½“å‰é¡µ
        </button>
        <input type="text" class="search-input" placeholder="ğŸ” æœç´¢æ–‡ä»¶å..." id="searchInput" oninput="app.render()">
    </div>

    <div class="table-wrapper">
        <table id="mainTable">
            <thead>
                <tr>
                    <th width="80" style="text-align:center">æ’åº</th>
                    <th width="25%">æ–‡ä»¶ä¿¡æ¯</th>
                    <th width="20%">éŸ³è´¨ & ç‰ˆæœ¬</th>
                    <th width="35%">é…ç½®ä¿¡æ¯ (å¤‡æ³¨ / é“¾æ¥ / Key)</th>
                    <th width="120">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div id="modalTheme" class="modal-overlay">
    <div class="modal-box large">
        <div class="modal-header">è‡ªå®šä¹‰å¯¼å‡ºä¸»é¢˜ <span style="cursor:pointer;color:#94a3b8" onclick="ui.close()">Ã—</span></div>
        <div class="modal-body">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <label class="check-row" style="margin:0; padding:8px 16px;">
                    <input type="checkbox" id="theme_enable" onchange="app.toggleThemeEnable()"> 
                    å¯ç”¨è‡ªå®šä¹‰ä¸»é¢˜
                </label>
                <div style="font-size:12px; color:#64748b;">
                    å¯ç”¨åå¯¼å‡ºHTMLå°†ä½¿ç”¨ä¸‹æ–¹é€‰ä¸­çš„æ¨¡æ¿
                </div>
            </div>

            <div id="themeArea" style="transition:0.3s">
                <label style="font-size:13px; font-weight:600; color:#475569; display:block; margin-bottom:8px;">ä¸»é¢˜é¢„è®¾:</label>
                
                <!-- æ–°ä¸»é¢˜åˆ›å»ºè¡¨å• -->
                <div class="new-theme-form">
                    <div class="form-row">
                        <input type="text" id="newThemeName" placeholder="ä¸»é¢˜åç§°...">
                        <button class="btn btn-primary btn-xs" onclick="app.createNewTheme()">åˆ›å»ºç©ºç™½ä¸»é¢˜</button>
                    </div>
                    <div style="font-size:11px; color:#64748b; line-height:1.4">
                        åˆ›å»ºç©ºç™½ä¸»é¢˜åï¼Œå¯ä»¥å¤åˆ¶é»˜è®¤ä¸»é¢˜çš„ä»£ç ï¼Œæˆ–è‡ªè¡Œç¼–å†™HTMLæ¨¡æ¿
                    </div>
                </div>
                
                <div class="theme-list" id="themeList"></div>

                <div class="form-item">
                    <label style="display:flex; justify-content:space-between;">
                        <span>æ¨¡æ¿ä»£ç  (HTML):</span>
                        <div style="font-weight:400; font-size:12px; color:#64748b">
                            å¯ç”¨å˜é‡: <span class="var-badge">{{DATA}}</span> <span class="var-badge">{{DATE}}</span> <span class="var-badge">{{TITLE}}</span>
                        </div>
                    </label>
                    <textarea id="themeCode" class="code-editor" spellcheck="false" placeholder="åœ¨æ­¤ç²˜è´´HTMLä»£ç ..."></textarea>
                </div>
                
<div style="background:#f8f6ff; padding:20px; border-radius:12px; border:1px solid #d9d6ff; margin:16px 0; font-size:13px; color:#4338ca; line-height:1.7; box-shadow:0 4px 6px -1px rgba(109, 40, 217, 0.1);">
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:16px; padding-bottom:12px; border-bottom:2px solid #e5e7eb;">
        <span style="font-size:20px; color:#7c3aed">ğŸ“š</span>
        <strong style="font-size:16px; color:#1e293b;">è‡ªå®šä¹‰ä¸»é¢˜ç¼–å†™æŒ‡å—</strong>
    </div>
    
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:20px;">
        <!-- å·¦ä¾§ï¼šæ ¸å¿ƒæ¦‚å¿µ -->
        <div style="background:#f0f9ff; padding:16px; border-radius:8px; border:1px solid #bae6fd;">
            <h4 style="margin:0 0 12px 0; color:#0369a1; font-size:14px;">ğŸ” æ ¸å¿ƒæ¦‚å¿µ</h4>
            <div style="font-size:12px; color:#475569; line-height:1.6;">
                <p><strong>ä»€ä¹ˆæ˜¯è‡ªå®šä¹‰ä¸»é¢˜ï¼Ÿ</strong><br>ä¸»é¢˜æ˜¯å¯¼å‡ºé¡µé¢çš„å®Œæ•´HTMLæ¨¡æ¿ï¼Œç³»ç»Ÿä¼šå°†å½“å‰æ•°æ®æ³¨å…¥å…¶ä¸­ç”Ÿæˆæœ€ç»ˆé¡µé¢ã€‚</p>
                <p><strong>å·¥ä½œåŸç†ï¼š</strong>é€šè¿‡å˜é‡æ›¿æ¢å°†åŠ¨æ€å†…å®¹æ’å…¥é™æ€æ¨¡æ¿ã€‚</p>
                <p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong>ä¸ªæ€§åŒ–å±•ç¤ºã€ç‰¹å®šå¹³å°é€‚é…ã€ç®€åŒ–/åŠŸèƒ½ã€‚</p>
            </div>
        </div>
        
        <!-- å³ä¾§ï¼šæ¨¡æ¿å˜é‡ -->
        <div style="background:#f0fdf4; padding:16px; border-radius:8px; border:1px solid #bbf7d0;">
            <h4 style="margin:0 0 12px 0; color:#15803d; font-size:14px;">ğŸ¯ æ¨¡æ¿å˜é‡</h4>
            <div style="display:flex; flex-direction:column; gap:8px;">
                <div>
                    <span class="var-badge" style="margin-right:8px">{{DATA}}</span>
                    <span style="font-size:12px; color:#475569;">JSONæ•°æ®å¯¹è±¡</span>
                </div>
                <div>
                    <span class="var-badge" style="margin-right:8px">{{DATE}}</span>
                    <span style="font-size:12px; color:#475569;">å¯¼å‡ºæ—¥æœŸ (YYYY-MM-DD)</span>
                </div>
                <div>
                    <span class="var-badge" style="margin-right:8px">{{TITLE}}</span>
                    <span style="font-size:12px; color:#475569;">é¡µé¢æ ‡é¢˜ (é»˜è®¤:æ’ä»¶åˆ—è¡¨)</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- è¯¦ç»†æ­¥éª¤ -->
    <div style="margin-bottom:20px;">
        <h4 style="margin:0 0 12px 0; color:#7c3aed; font-size:14px; display:flex; align-items:center; gap:8px;">
            <span>ğŸ“‹</span> è¯¦ç»†æ­¥éª¤
        </h4>
        
        <div style="background:#fff; border:1px solid #e5e7eb; border-radius:8px; overflow:hidden;">
            <!-- æ­¥éª¤1 -->
            <div style="padding:16px; border-bottom:1px solid #f1f5f9;">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                    <span style="background:#7c3aed; color:white; width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:bold;">1</span>
                    <strong style="color:#1e293b;">é€‰æ‹©åˆé€‚çš„èµ·ç‚¹</strong>
                </div>
                <div style="font-size:12px; color:#475569; padding-left:34px; line-height:1.6;">
                    â€¢ <strong>é»˜è®¤ä¸»é¢˜ï¼š</strong>åŠŸèƒ½å®Œæ•´ï¼Œé€‚åˆéœ€è¦å®Œæ•´åŠŸèƒ½çš„ç”¨æˆ·<br>
                    â€¢ <strong>æç®€ä¸»é¢˜ï¼š</strong>ç»“æ„ç®€å•ï¼Œé€‚åˆå¿«é€Ÿ<br>
                    â€¢ <strong>ç©ºä¸»é¢˜ï¼š</strong>ä»é›¶å¼€å§‹ï¼Œé€‚åˆé«˜çº§ç”¨æˆ·<br>
                    â€¢ <strong>å¯¼å…¥HTMLï¼š</strong>ä»å¤–éƒ¨HTMLæ–‡ä»¶å¼€å§‹
                </div>
            </div>
            
            <!-- æ­¥éª¤2 -->
            <div style="padding:16px; border-bottom:1px solid #f1f5f9;">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                    <span style="background:#7c3aed; color:white; width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:bold;">2</span>
                    <strong style="color:#1e293b;">ç†è§£æ•°æ®ç»“æ„</strong>
                </div>
                <div style="font-size:12px; color:#475569; padding-left:34px; line-height:1.6;">
                    <pre style="background:#f8fafc; padding:12px; border-radius:6px; border:1px solid #e2e8f0; margin:8px 0; overflow-x:auto; font-size:11px;">
// æ•°æ®å¯¹è±¡ç»“æ„ç¤ºä¾‹
{
  config: { showMF: false, showLY: false },    // æ ‡ç­¾é¡µé…ç½®
  customTabs: ["MyPlugin", "TestTab"],         // è‡ªå®šä¹‰æ ‡ç­¾é¡µ
  items: [                                     // æ’ä»¶åˆ—è¡¨
    {
      id: 1234567890,
      tab: "LX",                               // æ‰€å±æ ‡ç­¾é¡µ
      name: "ç¤ºä¾‹æ’ä»¶.js",                      // æ–‡ä»¶å
      ver: "1.2.3",                            // ç‰ˆæœ¬å·
      quality: "flac",                         // éŸ³è´¨
      note: "è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹å¤‡æ³¨",                 // å¤‡æ³¨
      file: {                                  // æ–‡ä»¶æ•°æ®ï¼ˆbase64ï¼‰
        content: "data:application/javascript;base64,...",
        size: 1024
      },
      links: [                                 // ç›¸å…³é“¾æ¥
        { text: "å®˜ç½‘", url: "https://example.com" }
      ],
      dlLink: "https://example.com/plugin.js", // ç›´é“¾åœ°å€
      keyConfig: {                             // Keyé…ç½®ï¼ˆLXä¸“ç”¨ï¼‰
        enableUrl: true,
        url: "https://api.example.com?key=",
        enableVar: true,
        var: "API_KEY"
      }
    }
  ]
}</pre>
                </div>
            </div>
            
            <!-- æ­¥éª¤3 -->
            <div style="padding:16px; border-bottom:1px solid #f1f5f9;">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                    <span style="background:#7c3aed; color:white; width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:bold;">3</span>
                    <strong style="color:#1e293b;">ç¼–å†™JavaScripté€»è¾‘</strong>
                </div>
                <div style="font-size:12px; color:#475569; padding-left:34px; line-height:1.6;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <div>
                            <strong>ğŸ”§ åŸºç¡€æ•°æ®è§£æ</strong>
                            <pre style="background:#f8fafc; padding:8px; border-radius:4px; font-size:10px; margin-top:4px;">
const data = {{DATA}};
const currentTab = "LX"; // è¦æ˜¾ç¤ºçš„æ ‡ç­¾é¡µ
const items = data.items.filter(
  item => (item.tab || "LX") === currentTab
);</pre>
                        </div>
                        <div>
                            <strong>ğŸ’¾ æ–‡ä»¶ä¸‹è½½å‡½æ•°</strong>
                            <pre style="background:#f8fafc; padding:8px; border-radius:4px; font-size:10px; margin-top:4px;">
function downloadFile(id) {
  const item = data.items.find(x => x.id == id);
  const a = document.createElement('a');
  a.href = item.file.content;
  a.download = item.name;
  a.click();
}</pre>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ­¥éª¤4 -->
            <div style="padding:16px;">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                    <span style="background:#7c3aed; color:white; width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:bold;">4</span>
                    <strong style="color:#1e293b;">è‡ªå®šä¹‰æ ·å¼ä¸å¸ƒå±€</strong>
                </div>
                <div style="font-size:12px; color:#475569; padding-left:34px; line-height:1.6;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                        <div>
                            <strong>ğŸ¨ CSSæ ·å¼</strong>
                            <ul style="margin:4px 0; padding-left:16px;">
                                <li>é¢œè‰²ã€å­—ä½“ã€é—´è·</li>
                                <li>åŠ¨ç”»æ•ˆæœ</li>
                                <li>å“åº”å¼è®¾è®¡</li>
                            </ul>
                        </div>
                        <div>
                            <strong>ğŸ—ï¸ HTMLç»“æ„</strong>
                            <ul style="margin:4px 0; padding-left:16px;">
                                <li>å…ƒç´ é¡ºåº</li>
                                <li>åŠŸèƒ½æ¨¡å—</li>
                                <li>å¸ƒå±€æ–¹å¼</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
<!-- é«˜çº§æŠ€å·§ä¸ç¤ºä¾‹ -->
<div style="margin-bottom:20px;">
    <h4 style="margin:0 0 12px 0; color:#1e293b; font-size:14px; display:flex; align-items:center; gap:8px;">
        <span>ğŸš€</span> é«˜çº§æŠ€å·§ä¸ç¤ºä¾‹
    </h4>
    
    <div style="display:grid; grid-template-columns:repeat(3, minmax(0, 1fr)); gap:12px;">
        <div style="background:white; padding:12px; border-radius:6px; border:1px solid #e5e7eb; min-width:0;">
            <strong style="font-size:12px; color:#1e293b; display:block; margin-bottom:6px;">æŒ‰éŸ³è´¨åˆ†ç»„</strong>
            <pre style="font-size:10px; background:#f8fafc; padding:8px; border-radius:4px; margin:0; white-space: pre-wrap; word-break: break-word; overflow-wrap: break-word;">
const grouped = {};
data.items.forEach(item => {
  const quality = item.quality || "æœªçŸ¥";
  if (!grouped[quality]) grouped[quality] = [];
  grouped[quality].push(item);
});</pre>
        </div>
        
        <div style="background:white; padding:12px; border-radius:6px; border:1px solid #e5e7eb; min-width:0;">
            <strong style="font-size:12px; color:#1e293b; display:block; margin-bottom:6px;">åŠ å…¥æœç´¢åŠŸèƒ½</strong>
            <pre style="font-size:10px; background:#f8fafc; padding:8px; border-radius:4px; margin:0; white-space: pre-wrap; word-break: break-word; overflow-wrap: break-word;">
&lt;input type="text" id="search" 
       placeholder="æœç´¢æ’ä»¶..." 
       oninput="searchPlugins(this.value)"&gt;

function searchPlugins(keyword) {
  // ç­›é€‰é€»è¾‘
}</pre>
        </div>
        
        <div style="background:white; padding:12px; border-radius:6px; border:1px solid #e5e7eb; min-width:0;">
            <strong style="font-size:12px; color:#1e293b; display:block; margin-bottom:6px;">æš—è‰²æ¨¡å¼åˆ‡æ¢</strong>
            <pre style="font-size:10px; background:#f8fafc; padding:8px; border-radius:4px; margin:0; white-space: pre-wrap; word-break: break-word; overflow-wrap: break-word;">
function toggleDarkMode() {
  document.body.classList.toggle('dark');
}
// CSS: .dark { background:#1e293b; color:#e2e8f0; }</pre>
        </div>
    </div>
</div>
    <!-- é‡è¦æ³¨æ„äº‹é¡¹ -->
    <div>
        <h4 style="margin:0 0 12px 0; color:#dc2626; font-size:14px; display:flex; align-items:center; gap:8px;">
            <span>âš ï¸</span> é‡è¦æ³¨æ„äº‹é¡¹
        </h4>
        <ul style="margin:0; padding-left:20px; font-size:12px; color:#991b1b; line-height:1.6;">
            <li><strong>å¿…é¡»åŒ…å«</strong>å¯¹ <code>{{DATA}}</code> å˜é‡çš„è§£æä»£ç </li>
            <li>ç¡®ä¿æ–‡ä»¶ä¸‹è½½åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼ˆå¦‚æœä½¿ç”¨ï¼‰</li>
            <li>æµ‹è¯•åœ¨ä¸åŒæ ‡ç­¾é¡µï¼ˆLX/Music Free/æ¾œéŸ³ï¼‰ä¸‹çš„è¡¨ç°</li>
            <li>å†…ç½®ä¸»é¢˜ï¼ˆğŸ”’æ ‡è®°ï¼‰ä¸å¯ç›´æ¥ä¿®æ”¹ï¼Œéœ€åˆ›å»ºå‰¯æœ¬</li>
            <li>å¯¼å…¥å¤–éƒ¨HTMLæ—¶ï¼Œç¡®ä¿æ²¡æœ‰å†²çªçš„JS/CSS</li>
            <li>å¯¼å‡ºå‰è¯·å…ˆé¢„è§ˆï¼Œç¡®ä¿åŠŸèƒ½æ­£å¸¸</li>
        </ul>
    </div>
</div>
            </div>
        </div>
        <div class="modal-footer">
            <input type="file" id="importThemeFile" hidden accept=".html,.htm" onchange="app.importThemeFromFile(this)">
            <button class="btn btn-secondary" onclick="document.getElementById('importThemeFile').click()">ğŸ“‚ å¯¼å…¥HTMLæ¨¡æ¿</button>
            <button class="btn btn-secondary" onclick="app.resetThemeToDefault()">â†º æ¢å¤é€‰ä¸­é¢„è®¾</button>
            <button class="btn btn-primary" onclick="app.saveThemeConfig()">ä¿å­˜é…ç½®</button>
        </div>
    </div>
</div>

<div id="modalTabs" class="modal-overlay">
    <div class="modal-box" style="width: 520px;">
        <div class="modal-header">æ ‡ç­¾é¡µç®¡ç† <span style="cursor:pointer;color:#94a3b8" onclick="ui.close()">Ã—</span></div>
        <div class="modal-body">
            <div class="form-item">
                <label>å†…ç½®æ ‡ç­¾é¡µå¼€å…³:</label>
                <div style="display:flex; gap:12px">
                    <label class="check-row" style="flex:1">
                        <input type="checkbox" id="chk_mf" onchange="app.toggleTabConfig('showMF', this.checked)"> 
                        Music Free
                    </label>
                    <label class="check-row" style="flex:1">
                        <input type="checkbox" id="chk_ly" onchange="app.toggleTabConfig('showLY', this.checked)"> 
                        æ¾œéŸ³
                    </label>
                </div>
                <div style="font-size:12px; color:#64748b; margin-top:8px;">
                    æç¤ºï¼šæ ‡ç­¾é¡µé¡ºåºæ ¹æ®å‹¾é€‰é¡ºåºè‡ªåŠ¨æ’åˆ—ï¼ˆåå‹¾é€‰çš„æ’åœ¨åé¢ï¼‰
                </div>
            </div>
            
            <div class="form-item" style="border-top:1px dashed #e2e8f0; margin-top:20px; padding-top:20px">
                <label>è‡ªå®šä¹‰æ ‡ç­¾é¡µ:</label>
                <div style="background:#f8fafc; padding:12px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:12px;">
                    <div id="hiddenTabsList" style="max-height:120px; overflow-y:auto; margin-bottom:10px;"></div>
                    <button class="btn btn-danger btn-xs" onclick="app.deleteAllHiddenTabs()" style="width:100%; margin-top:8px;">
                        ğŸ—‘ï¸ åˆ é™¤æ‰€æœ‰éšè—æ ‡ç­¾é¡µ
                    </button>
                    <div style="font-size:11px; color:#64748b; margin-top:8px; line-height:1.4">
                        æ³¨æ„ï¼šåˆ é™¤éšè—æ ‡ç­¾é¡µä¼šåŒæ—¶åˆ é™¤è¯¥æ ‡ç­¾é¡µä¸‹çš„æ‰€æœ‰æ•°æ®
                    </div>
                </div>
            </div>
            
            <!-- æ–°å¢è‡ªå®šä¹‰æ ‡ç­¾é¡µæ¨¡å— - ä¿æŒåŸä½ç½® -->
            <div class="form-item" style="border-top:1px dashed #e2e8f0; margin-top:20px; padding-top:20px">
                <label>æ·»åŠ æ ‡ç­¾é¡µ:</label>
                <div style="display:flex; gap:10px">
                    <input type="text" id="newTabName" placeholder="è¾“å…¥åç§° (å¦‚: MyPlugin)...">
                    <button class="btn btn-primary" onclick="app.addCustomTab()">æ·»åŠ </button>
                </div>
            </div>
            
            <!-- æ ‡ç­¾é¡µæ’åºæ¨¡å— - ç§»åˆ°æ–°å¢è‡ªå®šä¹‰æ ‡ç­¾é¡µä¸‹é¢ -->
            <div class="form-item" style="border-top:1px dashed #e2e8f0; margin-top:20px; padding-top:20px">
                <label>æ ‡ç­¾é¡µæ’åº:</label>
                <div style="background:#f8fafc; padding:12px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:12px;">
                    <div style="font-size:12px; color:#64748b; margin-bottom:8px;">
                        è°ƒæ•´æ ‡ç­¾é¡µæ˜¾ç¤ºé¡ºåºï¼ˆLXå›ºå®šç¬¬ä¸€ï¼Œä¸å¯ç§»åŠ¨ï¼‰ï¼š
                    </div>
                    <div class="sortable-list" id="tabSortList"></div>
                    <div style="font-size:11px; color:#64748b; margin-top:8px; line-height:1.4">
                        æç¤ºï¼šæ‹–åŠ¨é¡¹ç›®æˆ–ä½¿ç”¨ä¸Šä¸‹ç®­å¤´è°ƒæ•´é¡ºåº
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modalKey" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">é…ç½® Key (LXä¸“ç”¨) <span style="cursor:pointer;color:#94a3b8" onclick="ui.close()">Ã—</span></div>
        <div class="form-item p-3 border rounded bg-slate-50 mb-4" style="border:1px solid #e2e8f0; padding:16px; border-radius:8px; background:#f8fafc; margin-bottom:16px">
            <label class="check-row" style="margin-bottom:12px; border:none; padding:0; background:transparent">
                <input type="checkbox" id="k_enable_url"> 
                <span style="font-weight:600;color:#334155">å¯ç”¨åœ¨çº¿å¯¼å…¥ (URLæ‹¼æ¥)</span>
            </label>
            <input type="text" id="k_url" placeholder="ä¾‹å¦‚: https://api.example.com?key=" style="background:#fff">
        </div>
        <div class="form-item p-3 border rounded bg-slate-50" style="border:1px solid #e2e8f0; padding:16px; border-radius:8px; background:#f8fafc">
            <label class="check-row" style="margin-bottom:12px; border:none; padding:0; background:transparent">
                <input type="checkbox" id="k_enable_var"> 
                <span style="font-weight:600;color:#334155">å¯ç”¨æœ¬åœ°å¯¼å…¥ (å˜é‡æ›¿æ¢)</span>
            </label>
            <input type="text" id="k_var" placeholder="å˜é‡å, é»˜è®¤: API_KEY" style="background:#fff">
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="ui.close()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="app.saveKey()">ä¿å­˜é…ç½®</button>
        </div>
    </div>
</div>

<div id="modalLink" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">æ·»åŠ é“¾æ¥ <span style="cursor:pointer;color:#94a3b8" onclick="ui.close()">Ã—</span></div>
        <div class="form-item"><label>æ˜¾ç¤ºæ–‡æœ¬:</label><input type="text" id="l_text" placeholder="ä¾‹å¦‚: å®˜ç½‘ / è´­ä¹°é¡µ / ä½¿ç”¨è¯´æ˜"></div>
        <div class="form-item"><label>URLåœ°å€:</label><input type="text" id="l_url" placeholder="http://..."></div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="ui.close()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="app.saveLink()">ç¡®è®¤æ·»åŠ </button>
        </div>
    </div>
</div>

<div id="modalDl" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">é…ç½®ç›´é“¾ä¸‹è½½ <span style="cursor:pointer;color:#94a3b8" onclick="ui.close()">Ã—</span></div>
        <div class="form-item">
            <label>ç›´é“¾ URL:</label>
            <input type="text" id="d_url" placeholder="http://...">
            <div style="font-size:12px; color:#64748b; margin-top:8px; line-height:1.5; background:#f1f5f9; padding:10px; border-radius:6px">
                è®¾ç½®ç›´é“¾åï¼Œå¯¼å‡ºåˆ—è¡¨ä¸­å°†æ˜¾ç¤ºç‹¬ç«‹çš„"ç›´é“¾ä¸‹è½½"æŒ‰é’®ã€‚
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="ui.close()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="app.saveDl()">ä¿å­˜</button>
        </div>
    </div>
</div>

<script>
/**
 * Application Logic v1.4.6
 * æ–°å¢åŠŸèƒ½:
 * 1. å†…ç½®æ ‡ç­¾é¡µæ’åºï¼ˆæ ¹æ®å‹¾é€‰å…ˆåé¡ºåºï¼‰
 * 2. ä¸»é¢˜é¢„è®¾æ’åºåŠŸèƒ½
 * 3. è‡ªå®šä¹‰æ ‡ç­¾é¡µæ’åºåŠŸèƒ½
 * 4. å¯¼å‡ºä¸ºMarkdownåŠŸèƒ½
 */
const QUALITY_PRESETS = ['128k', '320k', 'flac', 'flac24bit', 'master', 'dolby', 'sky'];

// --- é»˜è®¤å¯¼å‡ºæ¨¡æ¿ (å·²ä¼˜åŒ–ç§»åŠ¨ç«¯é€‚é…) ---
const DEFAULT_THEME_TEMPLATE = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{TITLE}}</title>
<style>
body{font-family:-apple-system,"Segoe UI",Roboto,sans-serif;background:#f8fafc;color:#334155;padding:20px;margin:0}
.box{max-width:900px;margin:0 auto;background:#fff;border-radius:16px;box-shadow:0 10px 15px -3px rgba(0,0,0,0.05);overflow:hidden;border:1px solid #e2e8f0}
.h{padding:24px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;background:#fff}
.h h1{font-size:18px;margin:0;color:#0f172a}
.tabs{background:#f1f5f9;display:flex;gap:4px;padding:10px 20px 0;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}
.tab{padding:10px 20px;cursor:pointer;font-weight:600;color:#64748b;border-radius:8px 8px 0 0;font-size:14px;transition:0.2s;white-space:nowrap;flex-shrink:0}
.tab:hover{background:#e2e8f0;color:#334155}
.tab.active{background:#fff;color:#2563eb;box-shadow:0 -4px 6px -1px rgba(0,0,0,0.02)}
.list{padding:0}
table{width:100%;border-collapse:collapse}
td{padding:16px 24px;border-bottom:1px solid #f1f5f9;vertical-align:top}
tr:last-child td{border-bottom:none}
tr:hover{background:#f8fafc}
.tag{display:inline-block;padding:3px 8px;font-size:12px;border-radius:6px;margin-right:6px;background:#f1f5f9;color:#475569;font-weight:500;border:1px solid #e2e8f0}
.tag-ver{background:#eff6ff;color:#2563eb;border-color:#dbeafe}
.action-box { display: flex; flex-direction: column; gap: 8px; }
.btn-row { display: flex; gap: 8px; width: 100%; }
.btn{display:inline-flex;align-items:center;justify-content:center;padding:8px 12px;border-radius:8px;text-decoration:none;font-size:13px;cursor:pointer;border:none;font-weight:600;transition:0.2s;line-height:1.4}
.btn:hover{filter:brightness(0.95)}
.btn:active{transform:translateY(1px)}
.btn-dl{background:#2563eb;color:#fff;flex:1;text-align:center}
.btn-direct{background:#10b981;color:#fff;flex:1;text-align:center}
.btn-lnk{background:#fff;border:1px solid #cbd5e1;color:#475569;display:inline-block;margin-right:4px;margin-bottom:4px;font-size:12px;padding:4px 10px}
.btn-lnk:hover{border-color:#2563eb;color:#2563eb}
.key-box{margin-top:8px;display:flex;flex-direction:column;gap:8px;padding-top:8px;border-top:1px dashed #e2e8f0}
.key-row{display:flex;gap:6px}
.key-in{flex:1;border:1px solid #cbd5e1;padding:6px 10px;border-radius:6px;font-size:12px;outline:none}
.key-in:focus{border-color:#2563eb}
.key-btn{padding:0 12px;background:#f1f5f9;border:1px solid #cbd5e1;border-radius:6px;cursor:pointer;font-weight:bold;color:#475569}
.key-btn:hover{background:#e2e8f0;color:#2563eb}
.empty{padding:60px;text-align:center;color:#94a3b8}

/* ç§»åŠ¨ç«¯é€‚é… CSS */
@media (max-width: 640px) {
    body { padding: 12px; background: #f1f5f9; }
    .box { border: none; box-shadow: none; background: transparent; overflow: visible; }
    .h { padding: 16px; border-radius: 12px; margin-bottom: 12px; flex-direction: column; align-items: flex-start; gap: 8px; border: 1px solid #e2e8f0; }
    .tabs { padding: 0; background: transparent; gap: 8px; margin-bottom: 12px; }
    .tab { border-radius: 8px; border: 1px solid transparent; padding: 8px 16px; background: #e2e8f0; opacity: 0.7; }
    .tab.active { opacity: 1; border-color: #cbd5e1; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    
    /* è¡¨æ ¼è½¬å¡ç‰‡è§†å›¾ */
    table, thead, tbody, th, td, tr { display: block; }
    thead { display: none; }
    tr { background: #fff; margin-bottom: 12px; border-radius: 12px; padding: 16px; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.02); }
    td { padding: 0; border: none; margin-bottom: 12px; }
    td:last-child { margin-bottom: 0; }
    
    .btn-row { flex-direction: column; }
    .btn-lnk { display: flex; width: 100%; box-sizing: border-box; justify-content: center; margin-right: 0; margin-bottom: 6px; }
    .key-row { flex-direction: column; }
    .key-btn { padding: 8px; margin-top: 4px; width: 100%; }
}
</style>
</head>
<body>
<div class="box">
    <div class="h"><h1>ğŸ“¦ æ’ä»¶åˆ—è¡¨</h1><span style="font-size:12px;color:#94a3b8;font-family:monospace">{{DATE}}</span></div>
    <div class="tabs" id="t"></div>
    <div class="list" id="c"></div>
</div>
<script>
const DB={{DATA}};
let cur='LX';
function rT(){
    let ts=['LX'];
    if(DB.config.showMF) ts.push('Music Free');
    if(DB.config.showLY) ts.push('æ¾œéŸ³');
    ts = ts.concat(DB.customTabs);
    if(!ts.includes(cur)) cur='LX';
    document.getElementById('t').innerHTML = ts.map(t=>'<div class="tab '+(t===cur?'active':'')+'" onclick="sT(\\''+t+'\\')">'+t+'</div>').join('');
    rL();
}
function sT(t){cur=t;rT();}
function rL(){
    const l = DB.items.filter(i=>(i.tab||'LX')===cur);
    const b = document.getElementById('c');
    if(!l.length){b.innerHTML='<div class="empty">æš‚æ— å†…å®¹</div>';return;}
    let h='<table><thead><tr><th>ä¿¡æ¯</th><th>è¯¦æƒ…</th><th>æ“ä½œ</th></tr></thead><tbody>';
    h+=l.map(i=>{
        let meta='';
        if(i.quality) meta+='<span class="tag">'+i.quality+'</span>';
        if(i.ver) meta+='<span class="tag tag-ver">v'+i.ver+'</span>';
        let ls = (i.links||[]).map(k=>'<a href="'+k.url+'" target="_blank" class="btn btn-lnk">ğŸ”— '+k.text+'</a>').join('');
        
        let act = '<div class="action-box">';
        let btns = '';
        if(i.dlLink) btns += '<a href="'+i.dlLink+'" target="_blank" class="btn btn-direct">ğŸŒ ç›´é“¾ä¸‹è½½</a>';
        if(i.file && i.file.content) btns += '<button class="btn btn-dl" onclick="D('+i.id+')">â¬‡ï¸ ä¸‹è½½æ–‡ä»¶</button>';
        
        if(btns) act += '<div class="btn-row">' + btns + '</div>';
        
        if(i.file && i.file.content){
            const k = i.keyConfig||{};
            const su = (cur==='LX' && k.enableUrl && k.url);
            const sv = (cur==='LX' && k.enableVar && k.var);
            if(su || sv) {
                act += '<div class="key-box">';
                if(su) act += '<div class="key-row"><input class="key-in" id="ku_'+i.id+'" placeholder="è¾“å…¥Keyåœ¨çº¿å¯¼å…¥"><button class="key-btn" onclick="KU('+i.id+')">â¡ï¸ å¯¼å…¥</button></div>';
                if(sv) act += '<div class="key-row"><input class="key-in" id="kv_'+i.id+'" placeholder="è¾“å…¥Keyç”Ÿæˆæ–‡ä»¶"><button class="key-btn" onclick="KV('+i.id+')">â¬‡ï¸ ç”Ÿæˆ</button></div>';
                act += '</div>';
            }
        }
        act += '</div>';

        return '<tr><td><div style="font-weight:bold;font-size:16px;margin-bottom:8px;color:#1e293b">'+i.name+'</div>'+meta+'</td><td style="color:#64748b;font-size:13px;line-height:1.6">'+(i.note||'<span style="opacity:0.5">æ— å¤‡æ³¨</span>')+'<br><div style="margin-top:10px">'+ls+'</div></td><td width="260">'+act+'</td></tr>';
    }).join('');
    b.innerHTML = h+'</tbody></table>';
}
window.D=id=>{const i=DB.items.find(x=>x.id==id); save(i.file.content,i.name);};
window.KU=id=>{const i=DB.items.find(x=>x.id==id);const v=document.getElementById('ku_'+id).value; if(v)window.open(i.keyConfig.url+v);};
window.KV=id=>{
    const i=DB.items.find(x=>x.id==id);
    const v=document.getElementById('kv_'+id).value;
    if(!v)return alert('è¯·è¾“å…¥Key');
    try{
        const raw=atob(i.file.content.split(',')[1]);
        const u8=new Uint8Array(raw.length);
        for(let n=0;n<raw.length;n++)u8[n]=raw.charCodeAt(n);
        let txt=new TextDecoder().decode(u8);
        const vn=i.keyConfig.var;
        const re=new RegExp('((?:const|var|let)\\\\s+'+vn+'\\\\s*[:=]\\\\s*)[\\'\\"][\\'\\"]','g');
        if(re.test(txt)){
            txt=txt.replace(re,'$1"'+v+'"');
            const b=new Blob([txt],{type:'text/javascript'});
            const a=document.createElement('a');
            a.href=URL.createObjectURL(b);
            a.download=i.name;
            a.click();
        }else{alert('å˜é‡åæœªæ‰¾åˆ°: '+vn);}
    }catch(e){console.error(e);alert('ç”Ÿæˆå¤±è´¥');}
};
function save(u,n){const a=document.createElement('a');a.href=u;a.download=n;a.click();}
rT();
<\/script>
</body></html>`;

// --- å†…ç½®ï¼šæç®€åˆ—è¡¨ä¸»é¢˜ ---
const MINIMAL_THEME_TEMPLATE = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"><title>{{TITLE}}</title>
<style>
body{font-family:sans-serif;max-width:800px;margin:20px auto;line-height:1.6;color:#333}
h1{border-bottom:2px solid #333;padding-bottom:10px}
.item{border-bottom:1px solid #eee;padding:15px 0}
.name{font-weight:bold;font-size:1.1em}
.meta{font-size:0.9em;color:#666;margin:5px 0}
.btn{background:#333;color:#fff;text-decoration:none;padding:5px 10px;font-size:0.8em;border-radius:4px;display:inline-block}
</style>
</head>
<body>
<h1>ğŸ“‚ {{TITLE}} ({{DATE}})</h1>
<div id="list"></div>
<script>
const data = {{DATA}};
const items = data.items.filter(i => i.tab === 'LX');
document.getElementById('list').innerHTML = items.map(i => {
    let dlBtn = '';
    if(i.file) dlBtn = \`<a href="#" class="btn" onclick="downloadFile(\${i.id});return false">ä¸‹è½½æ–‡ä»¶</a>\`;
    if(i.dlLink) dlBtn += \` <a href="\${i.dlLink}" target="_blank" class="btn">ç›´é“¾</a>\`;
    return \`<div class="item">
        <div class="name">\${i.name} <span style="font-weight:normal;font-size:0.8em">v\${i.ver}</span></div>
        <div class="meta">\${i.note || ''} [\${i.quality}]</div>
        \${dlBtn}
    </div>\`;
}).join('') || 'æ— æ•°æ®';

function downloadFile(id) {
    const item = data.items.find(x => x.id == id);
    const a = document.createElement('a');
    a.href = item.file.content; a.download = item.name; a.click();
}
<\/script></body></html>`;

// --- ç©ºä¸»é¢˜æ¨¡æ¿ ---
const EMPTY_THEME_TEMPLATE = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{TITLE}}</title>
<style>
/* åœ¨æ­¤ç¼–å†™ä½ çš„CSSæ ·å¼ */
body { font-family: sans-serif; padding: 20px; }
.container { max-width: 800px; margin: 0 auto; }
.item { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
</style>
</head>
<body>
<div class="container">
    <h1>{{TITLE}} - {{DATE}}</h1>
    <div id="content"></div>
</div>

<script>
// åœ¨è¿™é‡Œç¼–å†™ä½ çš„JavaScriptä»£ç æ¥è§£ææ•°æ®
const data = {{DATA}};

function renderContent() {
    const container = document.getElementById('content');
    if (!data.items || data.items.length === 0) {
        container.innerHTML = '<p>æš‚æ— æ•°æ®</p>';
        return;
    }
    
    // ç¤ºä¾‹ï¼šç®€å•æ¸²æŸ“
    let html = '';
    data.items.forEach(item => {
        html += \`
        <div class="item">
            <h3>\${item.name}</h3>
            <p>\${item.note || ''}</p>
            <p>ç‰ˆæœ¬: \${item.ver || 'æœªçŸ¥'}</p>
            <p>éŸ³è´¨: \${item.quality || 'æœªçŸ¥'}</p>
        </div>
        \`;
    });
    
    container.innerHTML = html;
}

renderContent();
<\/script>
</body>
</html>`;

const app = {
    data: {
        config: { showMF: false, showLY: false },
        builtInTabOrder: [], // è®°å½•å†…ç½®æ ‡ç­¾é¡µçš„å‹¾é€‰é¡ºåº
        customTabs: [],
        tabOrder: [], // æ–°å¢ï¼šæ‰€æœ‰æ ‡ç­¾é¡µçš„æ˜¾ç¤ºé¡ºåºï¼ˆä¸åŒ…æ‹¬LXï¼‰
        hiddenTabs: [], // å­˜å‚¨è¢«éšè—çš„æ ‡ç­¾é¡µ
        items: [],
        activeTab: 'LX',
        themeConfig: {
            enabled: false,
            activeId: 'default',
            themes: [
                { id: 'default', name: 'é»˜è®¤ä¸»é¢˜', content: DEFAULT_THEME_TEMPLATE, locked: true },
                { id: 'simple', name: 'æç®€åˆ—è¡¨ (ç¤ºä¾‹)', content: MINIMAL_THEME_TEMPLATE, locked: true } // æ”¹ä¸ºå†…ç½®
            ]
        }
    },
    state: { 
        editId: null,
        draggingTab: null, // ç”¨äºæ ‡ç­¾é¡µæ‹–æ‹½æ’åº
        draggingTheme: null // ç”¨äºä¸»é¢˜æ‹–æ‹½æ’åº
    },
    storageWarning: false, // å­˜å‚¨è­¦å‘ŠçŠ¶æ€

    init() {
        this.load();
        this.renderTabs();
        this.render();
        
        // å®šæœŸè‡ªåŠ¨ä¿å­˜
        setInterval(() => {
            this.save();
        }, 30000); // æ¯30ç§’è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡
    },

    // --- æ•°æ®å­˜å‚¨ ---
    save() {
        try {
            // å‹ç¼©æ•°æ®ä»¥èŠ‚çœç©ºé—´
            const compressedData = {
                config: this.data.config,
                builtInTabOrder: this.data.builtInTabOrder,
                customTabs: this.data.customTabs,
                tabOrder: this.data.tabOrder, // ä¿å­˜æ ‡ç­¾é¡µæ’åº
                hiddenTabs: this.data.hiddenTabs,
                items: this.data.items.map(item => ({
                    id: item.id,
                    tab: item.tab,
                    name: item.name,
                    ver: item.ver,
                    quality: item.quality,
                    note: item.note,
                    file: item.file ? {
                        content: item.file.content,
                        size: item.file.size
                    } : null,
                    links: item.links || [],
                    dlLink: item.dlLink || '',
                    keyConfig: item.keyConfig || { enableUrl: false, url: '', enableVar: false, var: '' }
                })),
                activeTab: this.data.activeTab,
                themeConfig: this.data.themeConfig
            };
            
            localStorage.setItem('pm_v146_data', JSON.stringify(compressedData));
            
            // æ¸…é™¤å­˜å‚¨è­¦å‘Š
            this.hideStorageWarning();
            
            const time = new Date();
            document.getElementById('statusText').innerText = 'å·²ä¿å­˜ ' + 
                time.getHours().toString().padStart(2, '0') + ':' + 
                time.getMinutes().toString().padStart(2, '0') + ':' + 
                time.getSeconds().toString().padStart(2, '0');
        } catch(e) { 
            console.error('ä¿å­˜å¤±è´¥:', e);
            if (e.name === 'QuotaExceededError') {
                // æ˜¾ç¤ºå­˜å‚¨è­¦å‘Šï¼Œä½†ä¸å¼¹çª—
                this.showStorageWarning();
                // ä»ç„¶æ›´æ–°çŠ¶æ€æ–‡æœ¬ï¼Œä½†ä¸æ˜¾ç¤º"ä¿å­˜å¤±è´¥"ï¼Œé¿å…ç”¨æˆ·å›°æƒ‘
                const time = new Date();
                document.getElementById('statusText').innerText = 'ä¿å­˜å¤±è´¥ ' + 
                    time.getHours().toString().padStart(2, '0') + ':' + 
                    time.getMinutes().toString().padStart(2, '0');
            } else {
                // å…¶ä»–é”™è¯¯
                const time = new Date();
                document.getElementById('statusText').innerText = 'ä¿å­˜å‡ºé”™ ' + 
                    time.getHours().toString().padStart(2, '0') + ':' + 
                    time.getMinutes().toString().padStart(2, '0');
            }
        }
    },
    
    // æ˜¾ç¤ºå­˜å‚¨è­¦å‘Š
    showStorageWarning() {
        if (!this.storageWarning) {
            this.storageWarning = true;
            document.getElementById('storageWarning').style.display = 'inline';
        }
    },
    
    // éšè—å­˜å‚¨è­¦å‘Š
    hideStorageWarning() {
        if (this.storageWarning) {
            this.storageWarning = false;
            document.getElementById('storageWarning').style.display = 'none';
        }
    },
    
    load() {
        try {
            let raw = localStorage.getItem('pm_v146_data');
            
            // å°è¯•è¿ç§»æ—§ç‰ˆæœ¬æ•°æ®
            if (!raw) {
                raw = localStorage.getItem('pm_v145_data') || 
	      localStorage.getItem('pm_v144_data') || 
	      localStorage.getItem('pm_v143_data') || 
                      localStorage.getItem('pm_v140_data') || 
                      localStorage.getItem('pm_v136_data') ||
                      localStorage.getItem('pm_v135_data');
            }
            
            if(raw) {
                try { 
                    const loaded = JSON.parse(raw);
                    this.data = { ...this.data, ...loaded };
                    
                    // ç¡®ä¿ builtInTabOrder å­˜åœ¨
                    if (!this.data.builtInTabOrder) {
                        this.data.builtInTabOrder = [];
                        // ä»æ—§æ•°æ®è¿ç§»
                        if (this.data.config.showMF) this.data.builtInTabOrder.push('Music Free');
                        if (this.data.config.showLY) this.data.builtInTabOrder.push('æ¾œéŸ³');
                    }
                    
                    // ç¡®ä¿ tabOrder å­˜åœ¨
                    if (!this.data.tabOrder) {
                        // åˆå§‹åŒ–æ ‡ç­¾é¡µé¡ºåº
                        this.data.tabOrder = [];
                        // æ·»åŠ å‹¾é€‰çš„å†…ç½®æ ‡ç­¾é¡µ
                        if (this.data.config.showMF) this.data.tabOrder.push('Music Free');
                        if (this.data.config.showLY) this.data.tabOrder.push('æ¾œéŸ³');
                        // æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾é¡µ
                        this.data.tabOrder = this.data.tabOrder.concat(this.data.customTabs);
                    }
                    
                    // ç¡®ä¿ hiddenTabs å­˜åœ¨
                    if (!this.data.hiddenTabs) {
                        this.data.hiddenTabs = [];
                    }
                    
                    // ç¡®ä¿ themeConfig å­˜åœ¨å¹¶ä¿®å¤ç»“æ„
                    if (!this.data.themeConfig) {
                        this.data.themeConfig = {
                            enabled: false,
                            activeId: 'default',
                            themes: [
                                { id: 'default', name: 'é»˜è®¤ä¸»é¢˜', content: DEFAULT_THEME_TEMPLATE, locked: true },
                                { id: 'simple', name: 'æç®€åˆ—è¡¨ (ç¤ºä¾‹)', content: MINIMAL_THEME_TEMPLATE, locked: true }
                            ]
                        };
                    }
                    
                    // ç¡®ä¿æ‰€æœ‰ä¸»é¢˜éƒ½æœ‰æ­£ç¡®çš„lockedå±æ€§
                    this.data.themeConfig.themes.forEach(theme => {
                        if (theme.id === 'default' || theme.id === 'simple') {
                            theme.locked = true;
                        } else if (typeof theme.locked === 'undefined') {
                            theme.locked = false;
                        }
                    });
                    
                    // ç¡®ä¿activeTabæœ‰æ•ˆ
                    const tabs = this.getTabs();
                    if (!tabs.includes(this.data.activeTab)) {
                        this.data.activeTab = 'LX';
                    }
                    
                } catch(e) {
                    console.error('è§£ææ•°æ®å¤±è´¥:', e);
                    // å¦‚æœè§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
                    this.data = { ...this.data };
                }
            }
        } catch(e) {
            console.error('åŠ è½½æ•°æ®å¤±è´¥:', e);
        }
    },

    // --- æ ‡ç­¾é¡µ ---
    getTabs() {
        // LX å›ºå®šåœ¨ç¬¬ä¸€ï¼Œç„¶åæ˜¯tabOrderä¸­çš„æ ‡ç­¾é¡µ
        let tabs = ['LX'];
        // æŒ‰tabOrderçš„é¡ºåºæ·»åŠ æ ‡ç­¾é¡µ
        tabs = tabs.concat(this.data.tabOrder);
        return tabs;
    },
    
    // è·å–æ‰€æœ‰å¯æ’åºçš„æ ‡ç­¾é¡µï¼ˆä¸åŒ…æ‹¬LXï¼‰
    getSortableTabs() {
        const sortableTabs = [];
        
        // æ·»åŠ å‹¾é€‰çš„å†…ç½®æ ‡ç­¾é¡µ
        if (this.data.config.showMF) sortableTabs.push('Music Free');
        if (this.data.config.showLY) sortableTabs.push('æ¾œéŸ³');
        
        // æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾é¡µ
        sortableTabs.push(...this.data.customTabs);
        
        return sortableTabs;
    },
    
    getAllTabs() {
        // è·å–æ‰€æœ‰æ ‡ç­¾é¡µï¼ˆåŒ…æ‹¬éšè—çš„ï¼‰
        let allTabs = ['LX', 'Music Free', 'æ¾œéŸ³'];
        return allTabs.concat(this.data.customTabs, this.data.hiddenTabs);
    },
    
    renderTabs() {
        const tabs = this.getTabs();
        if(!tabs.includes(this.data.activeTab)) this.data.activeTab = 'LX';
        
        const html = tabs.map(t => {
            const isActive = t === this.data.activeTab;
            const isCustom = this.data.customTabs.includes(t);
            const delBtn = isCustom ? `<span class="tab-close" onclick="app.hideCustomTab('${t}', event)">Ã—</span>` : '';
            return `<div class="tab-item ${isActive?'active':''}" onclick="app.switchTab('${t}')">${t} ${delBtn}</div>`;
        }).join('');
        document.getElementById('tabsBar').innerHTML = html + `<div class="tab-add-btn" onclick="ui.openTabOpt()">+</div>`;
    },
    
    // æ¸²æŸ“æ ‡ç­¾é¡µæ’åºåˆ—è¡¨
    renderTabSortList() {
        const container = document.getElementById('tabSortList');
        const sortableTabs = this.getSortableTabs();
        
        if (sortableTabs.length === 0) {
            container.innerHTML = '<div style="color:#94a3b8; font-size:12px; text-align:center; padding:10px;">æš‚æ— å¯æ’åºçš„æ ‡ç­¾é¡µ</div>';
            return;
        }
        
        // ä½¿ç”¨tabOrderä½œä¸ºæ’åºä¾æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨å½“å‰é¡ºåº
        const tabOrder = this.data.tabOrder.filter(tab => sortableTabs.includes(tab));
        
        // æ·»åŠ tabOrderä¸­å¯èƒ½ç¼ºå°‘çš„æ ‡ç­¾é¡µ
        sortableTabs.forEach(tab => {
            if (!tabOrder.includes(tab)) {
                tabOrder.push(tab);
            }
        });
        
        let html = '';
        tabOrder.forEach((tab, index) => {
            const isFirst = index === 0;
            const isLast = index === tabOrder.length - 1;
            const isBuiltIn = tab === 'Music Free' || tab === 'æ¾œéŸ³';
            
            html += `
                <div class="sortable-item" data-tab="${tab}">
                    <div style="display:flex; align-items:center; flex:1;">
                        <span class="sortable-handle">â˜°</span>
                        <span style="font-size:13px; font-weight:${isBuiltIn ? '600' : '500'};">
                            ${tab}
                            ${isBuiltIn ? '<span style="font-size:10px; color:#64748b; margin-left:6px;">(å†…ç½®)</span>' : ''}
                        </span>
                    </div>
                    <div style="display:flex; gap:4px;">
                        <button class="sortable-move-btn" onclick="app.moveTabUp('${tab}')" ${isFirst ? 'disabled' : ''}>â–²</button>
                        <button class="sortable-move-btn" onclick="app.moveTabDown('${tab}')" ${isLast ? 'disabled' : ''}>â–¼</button>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // æ·»åŠ æ‹–æ‹½åŠŸèƒ½
        this.setupTabDragAndDrop();
    },
    
    // è®¾ç½®æ ‡ç­¾é¡µæ‹–æ‹½åŠŸèƒ½
    setupTabDragAndDrop() {
        const container = document.getElementById('tabSortList');
        const items = container.querySelectorAll('.sortable-item');
        
        items.forEach(item => {
            item.setAttribute('draggable', 'true');
            
            item.addEventListener('dragstart', (e) => {
                this.state.draggingTab = e.target;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', e.target.dataset.tab);
                e.target.style.opacity = '0.5';
            });
            
            item.addEventListener('dragend', (e) => {
                e.target.style.opacity = '';
                this.state.draggingTab = null;
            });
            
            item.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });
            
            item.addEventListener('drop', (e) => {
                e.preventDefault();
                if (this.state.draggingTab && this.state.draggingTab !== e.target) {
                    const draggingTabName = this.state.draggingTab.dataset.tab;
                    const targetTabName = e.target.dataset.tab;
                    
                    if (draggingTabName && targetTabName) {
                        const tabOrder = this.data.tabOrder;
                        const fromIndex = tabOrder.indexOf(draggingTabName);
                        const toIndex = tabOrder.indexOf(targetTabName);
                        
                        if (fromIndex > -1 && toIndex > -1) {
                            // ç§»åŠ¨æ ‡ç­¾é¡µ
                            tabOrder.splice(fromIndex, 1);
                            tabOrder.splice(toIndex, 0, draggingTabName);
                            
                            this.save();
                            this.renderTabSortList();
                            this.renderTabs();
                        }
                    }
                }
            });
        });
    },
    
    // å‘ä¸Šç§»åŠ¨æ ‡ç­¾é¡µ
    moveTabUp(tabName) {
        const tabOrder = this.data.tabOrder;
        const index = tabOrder.indexOf(tabName);
        
        if (index > 0) {
            // äº¤æ¢ä½ç½®
            [tabOrder[index], tabOrder[index - 1]] = [tabOrder[index - 1], tabOrder[index]];
            this.save();
            this.renderTabSortList();
            this.renderTabs();
        }
    },
    
    // å‘ä¸‹ç§»åŠ¨æ ‡ç­¾é¡µ
    moveTabDown(tabName) {
        const tabOrder = this.data.tabOrder;
        const index = tabOrder.indexOf(tabName);
        
        if (index < tabOrder.length - 1) {
            // äº¤æ¢ä½ç½®
            [tabOrder[index], tabOrder[index + 1]] = [tabOrder[index + 1], tabOrder[index]];
            this.save();
            this.renderTabSortList();
            this.renderTabs();
        }
    },
    
    switchTab(t) {
        this.data.activeTab = t;
        this.save();
        this.renderTabs();
        this.render();
    },
    
    // ä¿®æ”¹ï¼šæ ¹æ®å‹¾é€‰å…ˆåé¡ºåºæ’åºå†…ç½®æ ‡ç­¾é¡µ
    toggleTabConfig(key, checked) {
        const tabName = key === 'showMF' ? 'Music Free' : 'æ¾œéŸ³';
        
        if (checked) {
            // å‹¾é€‰ï¼šå¦‚æœä¸åœ¨é¡ºåºæ•°ç»„ä¸­ï¼Œåˆ™æ·»åŠ åˆ°æœ«å°¾
            if (!this.data.builtInTabOrder.includes(tabName)) {
                this.data.builtInTabOrder.push(tabName);
            }
            // å¦‚æœä¸åœ¨tabOrderä¸­ï¼Œä¹Ÿæ·»åŠ åˆ°æœ«å°¾
            if (!this.data.tabOrder.includes(tabName)) {
                this.data.tabOrder.push(tabName);
            }
        } else {
            // å–æ¶ˆå‹¾é€‰ï¼šä»é¡ºåºæ•°ç»„ä¸­ç§»é™¤
            this.data.builtInTabOrder = this.data.builtInTabOrder.filter(t => t !== tabName);
            this.data.tabOrder = this.data.tabOrder.filter(t => t !== tabName);
        }
        
        // æ›´æ–°é…ç½®çŠ¶æ€
        this.data.config[key] = checked;
        
        this.save();
        this.renderTabs();
        this.render();
        this.renderHiddenTabsList();
        
        // æ›´æ–°æ ‡ç­¾é¡µæ’åºåˆ—è¡¨
        if (document.getElementById('tabSortList')) {
            this.renderTabSortList();
        }
    },
    
    addCustomTab() {
        const name = document.getElementById('newTabName').value.trim();
        if(!name) {
            alert('è¯·è¾“å…¥æ ‡ç­¾é¡µåç§°');
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆåŒ…æ‹¬éšè—çš„ï¼‰
        const allTabs = this.getAllTabs();
        if(allTabs.includes(name)) {
            alert('å·²å­˜åœ¨åŒåæ ‡ç­¾é¡µ');
            return;
        }
        
        this.data.customTabs.push(name);
        // æ·»åŠ åˆ°tabOrderæœ«å°¾
        this.data.tabOrder.push(name);
        this.data.activeTab = name;
        this.save();
        this.renderTabs();
        this.render();
        this.renderHiddenTabsList();
        this.renderTabSortList();
        ui.close();
        document.getElementById('newTabName').value = '';
    },
    
    // éšè—è‡ªå®šä¹‰æ ‡ç­¾é¡µï¼ˆä¸æ˜¯åˆ é™¤ï¼‰
    hideCustomTab(name, e) {
        e.stopPropagation();
        if(confirm('éšè—æ­¤æ ‡ç­¾é¡µï¼Ÿæ•°æ®å°†è¢«ä¿ç•™ï¼Œå¯åœ¨æ ‡ç­¾é¡µç®¡ç†ä¸­æ¢å¤ã€‚')) {
            // ä»customTabsç§»åˆ°hiddenTabs
            this.data.customTabs = this.data.customTabs.filter(t => t !== name);
            // ä»tabOrderä¸­ç§»é™¤
            this.data.tabOrder = this.data.tabOrder.filter(t => t !== name);
            if (!this.data.hiddenTabs.includes(name)) {
                this.data.hiddenTabs.push(name);
            }
            
            if(this.data.activeTab === name) this.data.activeTab = 'LX';
            this.save();
            this.renderTabs();
            this.render();
            this.renderHiddenTabsList();
            this.renderTabSortList();
        }
    },
    
    // æ¢å¤éšè—çš„æ ‡ç­¾é¡µ
    restoreHiddenTab(name) {
        if(confirm(`æ¢å¤æ ‡ç­¾é¡µ"${name}"ï¼Ÿ`)) {
            // ä»hiddenTabsç§»åˆ°customTabs
            this.data.hiddenTabs = this.data.hiddenTabs.filter(t => t !== name);
            if (!this.data.customTabs.includes(name)) {
                this.data.customTabs.push(name);
            }
            // æ·»åŠ åˆ°tabOrderæœ«å°¾
            if (!this.data.tabOrder.includes(name)) {
                this.data.tabOrder.push(name);
            }
            this.data.activeTab = name;
            this.save();
            this.renderTabs();
            this.render();
            this.renderHiddenTabsList();
            this.renderTabSortList();
            ui.close();
        }
    },
    
    // åˆ é™¤æ‰€æœ‰éšè—æ ‡ç­¾é¡µ
    deleteAllHiddenTabs() {
        if (this.data.hiddenTabs.length === 0) {
            alert('æ²¡æœ‰éšè—çš„æ ‡ç­¾é¡µ');
            return;
        }
        
        const tabCount = this.data.hiddenTabs.length;
        const itemCount = this.data.items.filter(i => this.data.hiddenTabs.includes(i.tab)).length;
        
        if(confirm(`ç¡®å®šè¦åˆ é™¤æ‰€æœ‰éšè—æ ‡ç­¾é¡µå—ï¼Ÿ\n\nå°†åˆ é™¤ ${tabCount} ä¸ªéšè—æ ‡ç­¾é¡µä¸‹çš„ ${itemCount} æ¡æ•°æ®ã€‚`)) {
            // åˆ é™¤éšè—æ ‡ç­¾é¡µçš„æ•°æ®
            this.data.items = this.data.items.filter(i => !this.data.hiddenTabs.includes(i.tab));
            // æ¸…ç©ºéšè—æ ‡ç­¾é¡µåˆ—è¡¨
            this.data.hiddenTabs = [];
            this.save();
            this.render();
            this.renderHiddenTabsList();
            alert(`å·²åˆ é™¤ ${itemCount} æ¡æ•°æ®`);
        }
    },
    
    // æ¸²æŸ“éšè—æ ‡ç­¾é¡µåˆ—è¡¨
    renderHiddenTabsList() {
        const container = document.getElementById('hiddenTabsList');
        if (this.data.hiddenTabs.length === 0) {
            container.innerHTML = '<div style="color:#94a3b8; font-size:12px; text-align:center; padding:10px;">æš‚æ— éšè—æ ‡ç­¾é¡µ</div>';
            return;
        }
        
        let html = '<div style="display:flex; flex-direction:column; gap:6px;">';
        this.data.hiddenTabs.forEach(tab => {
            const itemCount = this.data.items.filter(i => i.tab === tab).length;
            html += `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:#fff; border:1px solid #e2e8f0; border-radius:6px;">
                    <div>
                        <span style="font-size:12px; font-weight:500;">${tab}</span>
                        <span style="font-size:11px; color:#64748b; margin-left:8px;">${itemCount} æ¡æ•°æ®</span>
                    </div>
                    <div style="display:flex; gap:4px;">
                        <button class="btn-icon" style="font-size:11px; padding:2px 6px;" onclick="app.restoreHiddenTab('${tab}')">æ¢å¤</button>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        container.innerHTML = html;
    },
    
    openTabOpt() {
        document.getElementById('chk_mf').checked = this.data.config.showMF;
        document.getElementById('chk_ly').checked = this.data.config.showLY;
        this.renderHiddenTabsList();
        this.renderTabSortList(); // æ¸²æŸ“æ ‡ç­¾é¡µæ’åºåˆ—è¡¨
        ui.open('modalTabs');
    },
    
    clearTab() {
        if(confirm('æ¸…ç©ºå½“å‰é¡µæ‰€æœ‰æ•°æ®ï¼Ÿ')) {
            this.data.items = this.data.items.filter(i => i.tab !== this.data.activeTab);
            this.save();
            this.render();
        }
    },

    // --- åˆ—è¡¨æ¸²æŸ“ ---
    render() {
        const tbody = document.getElementById('tableBody');
        const kw = document.getElementById('searchInput').value.toLowerCase();
        const curTab = this.data.activeTab;
        
        const list = this.data.items.filter(i => {
            const t = i.tab || 'LX';
            return t === curTab && (!kw || (i.name||'').toLowerCase().includes(kw));
        });

        if(list.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="empty-state"><div class="empty-state-icon">ğŸ“‚</div>æš‚æ— æ•°æ®ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹"æ–‡ä»¶"æˆ–"å¯¼å…¥å¤‡ä»½"</td></tr>`;
            return;
        }

        // æ ¹æ®æ ‡ç­¾é¡µç±»å‹è®¾ç½®æ–‡ä»¶ä¸Šä¼ acceptå±æ€§
        let accept = '*/*'; // é»˜è®¤æ‰€æœ‰æ–‡ä»¶
        if (curTab === 'LX' || curTab === 'æ¾œéŸ³') {
            accept = '.js';
        } else if (curTab === 'Music Free') {
            accept = '.js,.json';
        }
        // è‡ªå®šä¹‰æ ‡ç­¾é¡µä¿æŒæ‰€æœ‰æ–‡ä»¶

        tbody.innerHTML = list.map((item, index) => {
            const hasFile = !!(item.file && item.file.content);
            const status = hasFile 
                ? `<span style="color:#15803d;background:#dcfce7;font-size:12px;padding:2px 6px;border-radius:4px;font-weight:500;border:1px solid #bbf7d0">âœ… å·²ä¼  ${fmtSize(item.file.size)}</span>`
                : `<span style="color:#b91c1c;background:#fee2e2;font-size:12px;padding:2px 6px;border-radius:4px;font-weight:500;border:1px solid #fecaca">âš ï¸ ç¼ºæ–‡ä»¶</span>`;

            const supportPreset = ['LX', 'æ¾œéŸ³'].includes(curTab);
            let qualityUi = '';
            if(supportPreset) {
                const isCustom = item.quality && !QUALITY_PRESETS.includes(item.quality);
                if(isCustom) {
                    qualityUi = `<div style="display:flex;gap:4px"><input type="text" value="${esc(item.quality)}" onchange="app.updateItem(${item.id}, 'quality', this.value)"><button class="btn-icon" onclick="app.updateItem(${item.id}, 'quality', '')" title="é‡ç½®">â†º</button></div>`;
                } else {
                    const opts = QUALITY_PRESETS.map(q => `<option value="${q}" ${item.quality===q?'selected':''}>${q}</option>`).join('');
                    qualityUi = `<select onchange="if(this.value==='_C_'){app.updateItem(${item.id},'quality','è‡ªå®šä¹‰')}else{app.updateItem(${item.id},'quality',this.value)}"><option value="">é€‰æ‹©éŸ³è´¨...</option>${opts}<option value="_C_">âœ è‡ªå®šä¹‰...</option></select>`;
                }
            } else {
                qualityUi = `<input type="text" value="${esc(item.quality)}" onchange="app.updateItem(${item.id}, 'quality', this.value)" placeholder="éŸ³è´¨">`;
            }
            qualityUi += `<input type="text" value="${esc(item.ver)}" onchange="app.updateItem(${item.id}, 'ver', this.value)" placeholder="ç‰ˆæœ¬å·" style="margin-top:4px;color:#64748b">`;

            let tags = '';
            if(item.dlLink) tags += `<span class="tag tag-green">ç›´é“¾ <span class="tag-del" onclick="app.updateItem(${item.id},'dlLink','')">Ã—</span></span>`;
            (item.links||[]).forEach((l,i) => {
                tags += `<span class="tag tag-blue"><a href="${l.url}" target="_blank" style="text-decoration:none;color:inherit">${l.text}</a> <span class="tag-del" onclick="app.delLink(${item.id},${i})">Ã—</span></span>`;
            });
            if(curTab === 'LX') {
                if(item.keyConfig?.enableUrl) tags += `<span class="tag tag-orange">Keyåœ¨çº¿ <span class="tag-del" onclick="app.toggleKey(${item.id},'enableUrl',false)">Ã—</span></span>`;
                if(item.keyConfig?.enableVar) tags += `<span class="tag tag-orange">Keyæœ¬åœ° <span class="tag-del" onclick="app.toggleKey(${item.id},'enableVar',false)">Ã—</span></span>`;
            }

            return `
                <tr>
                    <td align="center">
                        <div class="sort-controls">
                            <span class="position-number">${index + 1}</span>
                            <div class="arrow-buttons">
                                <button class="btn-icon" onclick="app.moveItem(${item.id}, -1)">â–²</button>
                                <button class="btn-icon" onclick="app.moveItem(${item.id}, 1)">â–¼</button>
                            </div>
                        </div>
                    </td>
                    <td>
                        <input type="text" value="${esc(item.name)}" onchange="app.updateItem(${item.id}, 'name', this.value)" placeholder="æ–‡ä»¶å" style="font-weight:700;margin-bottom:6px;font-size:14px">
                        <div style="display:flex;align-items:center;gap:6px">
                            ${status}
                            <input type="file" id="f_${item.id}" hidden accept="${accept}" onchange="app.uploadFile(${item.id}, this)">
                            <button class="btn-xs btn-primary" style="margin-left:auto" onclick="document.getElementById('f_${item.id}').click()">${hasFile?'ğŸ“„ é‡ä¼ ':'ğŸ“„ ä¸Šä¼ '}</button>
                        </div>
                    </td>
                    <td valign="top">${qualityUi}</td>
                    <td>
                        <input type="text" value="${esc(item.note)}" onchange="app.updateItem(${item.id}, 'note', this.value)" placeholder="å¤‡æ³¨..." style="margin-bottom:6px">
                        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px">
                            <button class="btn-xs btn-secondary" onclick="app.openLinkModal(${item.id})">+ é“¾æ¥</button>
                            <button class="btn-xs btn-secondary" onclick="app.openDlModal(${item.id})">+ ç›´é“¾</button>
                            ${curTab==='LX' ? `<button class="btn-xs btn-secondary" onclick="app.openKeyModal(${item.id})">âš™ï¸ Key</button>` : ''}
                        </div>
                        <div class="tag-list">${tags}</div>
                    </td>
                    <td>
                        <div style="display:flex;gap:6px;flex-direction:column">
                            ${hasFile ? `<button class="btn btn-success btn-xs" style="width:100%" onclick="app.dlLocal(${item.id})">ä¸‹è½½</button>` : ''}
                            <button class="btn btn-danger btn-xs" style="width:100%" onclick="app.delItem(${item.id})">åˆ é™¤</button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    },

    // --- æ ¸å¿ƒé€»è¾‘ ---
    addItem() {
        this.data.items.push({
            id: Date.now(),
            tab: this.data.activeTab,
            name: '', ver: '', quality: '', note: '',
            file: null, links: [], dlLink: '',
            keyConfig: { enableUrl: false, url: '', enableVar: false, var: '' }
        });
        this.save();
        this.render();
    },
    updateItem(id, k, v) {
        const i = this.data.items.find(x => x.id === id);
        if(i) {
            i[k] = v;
            this.save();
            if(k === 'quality' || k === 'dlLink') this.render();
        }
    },
    toggleKey(id, k, v) {
        const i = this.data.items.find(x => x.id === id);
        if(i && i.keyConfig) { i.keyConfig[k] = v; this.save(); this.render(); }
    },
    delItem(id) {
        if(confirm('åˆ é™¤æ­¤é¡¹ï¼Ÿ')) {
            this.data.items = this.data.items.filter(x => x.id !== id);
            this.save();
            this.render();
        }
    },
    moveItem(id, dir) {
        const idx = this.data.items.findIndex(x => x.id === id);
        if(idx > -1) {
            const t = idx + dir;
            if(t >= 0 && t < this.data.items.length) {
                [this.data.items[idx], this.data.items[t]] = [this.data.items[t], this.data.items[idx]];
                this.save();
                this.render();
            }
        }
    },
    uploadFile(id, input) {
        const f = input.files[0];
        if(!f) return;
        
        // æ£€æŸ¥æ–‡ä»¶ç±»å‹ï¼ˆæ ¹æ®å½“å‰æ ‡ç­¾é¡µï¼‰
        const curTab = this.data.activeTab;
        const fileName = f.name.toLowerCase();
        
        if (curTab === 'LX' || curTab === 'æ¾œéŸ³') {
            if (!fileName.endsWith('.js')) {
                alert('LXå’Œæ¾œéŸ³æ ‡ç­¾é¡µåªèƒ½ä¸Šä¼ .jsæ–‡ä»¶');
                input.value = '';
                return;
            }
        } else if (curTab === 'Music Free') {
            if (!fileName.endsWith('.js') && !fileName.endsWith('.json')) {
                alert('Music Freeæ ‡ç­¾é¡µåªèƒ½ä¸Šä¼ .jsæˆ–.jsonæ–‡ä»¶');
                input.value = '';
                return;
            }
        }
        // è‡ªå®šä¹‰æ ‡ç­¾é¡µä¸é™åˆ¶æ–‡ä»¶ç±»å‹
        
        const r = new FileReader();
        r.onload = e => {
            const i = this.data.items.find(x => x.id === id);
            if(i) {
                if(!i.name) i.name = f.name;
                i.file = { content: e.target.result, size: f.size };
                this.save();
                this.render();
            }
        };
        r.readAsDataURL(f);
        input.value = '';
    },
    dlLocal(id) {
        const i = this.data.items.find(x => x.id === id);
        if(i?.file) saveAs(i.file.content, i.name);
    },

    // --- å¼¹çª—é€»è¾‘ ---
    openLinkModal(id) { this.state.editId = id; ui.setVal('l_text',''); ui.setVal('l_url',''); ui.open('modalLink'); },
    saveLink() {
        const i = this.data.items.find(x => x.id === this.state.editId);
        const t = ui.getVal('l_text'), u = ui.getVal('l_url');
        if(i && t && u) {
            if(!i.links) i.links = [];
            i.links.push({text:t, url:u});
            this.save(); this.render();
        }
        ui.close();
    },
    delLink(id, idx) {
        const i = this.data.items.find(x => x.id === id);
        if(i && i.links) { i.links.splice(idx, 1); this.save(); this.render(); }
    },
    openDlModal(id) {
        this.state.editId = id;
        const i = this.data.items.find(x => x.id === id);
        ui.setVal('d_url', i.dlLink || '');
        ui.open('modalDl');
    },
    saveDl() {
        this.updateItem(this.state.editId, 'dlLink', ui.getVal('d_url'));
        ui.close();
    },
    openKeyModal(id) {
        this.state.editId = id;
        const i = this.data.items.find(x => x.id === id);
        const k = i.keyConfig || {};
        ui.setCheck('k_enable_url', k.enableUrl);
        ui.setVal('k_url', k.url||'');
        ui.setCheck('k_enable_var', k.enableVar);
        ui.setVal('k_var', k.var || 'API_KEY');
        ui.open('modalKey');
    },
    saveKey() {
        const i = this.data.items.find(x => x.id === this.state.editId);
        if(i) {
            i.keyConfig = {
                enableUrl: ui.getCheck('k_enable_url'), url: ui.getVal('k_url'),
                enableVar: ui.getCheck('k_enable_var'), var: ui.getVal('k_var')
            };
            this.save(); this.render();
        }
        ui.close();
    },

    // --- ä¸»é¢˜ç³»ç»Ÿ v1.4.6 - æ–°å¢æ’åºåŠŸèƒ½ ---
    openThemeModal() {
        ui.setCheck('theme_enable', this.data.themeConfig.enabled);
        this.renderThemeList();
        this.updateThemeEditor();
        
        // æ›´æ–°UIçŠ¶æ€
        const themeArea = document.getElementById('themeArea');
        themeArea.style.opacity = this.data.themeConfig.enabled ? '1' : '0.5';
        themeArea.style.pointerEvents = this.data.themeConfig.enabled ? 'auto' : 'none';
        
        ui.open('modalTheme');
    },
    
    renderThemeList() {
        const listEl = document.getElementById('themeList');
        const activeId = this.data.themeConfig.activeId;
        
        listEl.innerHTML = this.data.themeConfig.themes.map((t, index) => {
            const isActive = t.id === activeId;
            const isLocked = t.locked === true;
            const isFirst = index === 0;
            const isLast = index === this.data.themeConfig.themes.length - 1;
            
            // ç§»åŠ¨æŒ‰é’®ï¼ˆåªæœ‰éå†…ç½®ä¸»é¢˜æ‰æ˜¾ç¤ºï¼‰
            let moveButtons = '';
            if (!isLocked) {
                moveButtons = `
                    <div class="theme-move-btn" onclick="app.moveThemeLeft('${t.id}', event)" ${isFirst ? 'style="opacity:0.3;cursor:not-allowed"' : ''}>â—€</div>
                    <div class="theme-move-btn" onclick="app.moveThemeRight('${t.id}', event)" ${isLast ? 'style="opacity:0.3;cursor:not-allowed"' : ''}>â–¶</div>
                `;
            }
            
            // æ“ä½œæŒ‰é’®ï¼ˆåªæœ‰éå†…ç½®ä¸»é¢˜æ‰æ˜¾ç¤ºï¼‰
            let actionButtons = '';
            if (!isLocked) {
                actionButtons = `
                    <div class="theme-actions">
                        <div class="theme-action-btn" onclick="app.renameTheme('${t.id}', event)">âœ</div>
                        <div class="theme-action-btn delete" onclick="app.deleteTheme('${t.id}', event)">Ã—</div>
                    </div>
                `;
            }
            
            return `
                <div class="theme-card ${isActive ? 'active' : ''} ${isLocked ? 'locked' : ''}" onclick="app.switchTheme('${t.id}')">
                    ${moveButtons}
                    ${t.name}
                    ${isLocked ? '<br><span style="font-size:10px;opacity:0.6">ğŸ”’ å†…ç½®</span>' : ''}
                    ${actionButtons}
                </div>
            `;
        }).join('');
    },
    
    // å‘å·¦ç§»åŠ¨ä¸»é¢˜
    moveThemeLeft(id, event) {
        event.stopPropagation();
        const themes = this.data.themeConfig.themes;
        const index = themes.findIndex(t => t.id === id);
        
        if (index > 0) {
            // æ‰¾åˆ°å‰ä¸€ä¸ªéå†…ç½®ä¸»é¢˜çš„ä½ç½®
            let prevIndex = index - 1;
            while (prevIndex >= 0 && themes[prevIndex].locked) {
                prevIndex--;
            }
            
            if (prevIndex >= 0 && !themes[prevIndex].locked) {
                // äº¤æ¢ä½ç½®
                [themes[index], themes[prevIndex]] = [themes[prevIndex], themes[index]];
                this.save();
                this.renderThemeList();
            }
        }
    },
    
    // å‘å³ç§»åŠ¨ä¸»é¢˜
    moveThemeRight(id, event) {
        event.stopPropagation();
        const themes = this.data.themeConfig.themes;
        const index = themes.findIndex(t => t.id === id);
        
        if (index < themes.length - 1) {
            // æ‰¾åˆ°åä¸€ä¸ªéå†…ç½®ä¸»é¢˜çš„ä½ç½®
            let nextIndex = index + 1;
            while (nextIndex < themes.length && themes[nextIndex].locked) {
                nextIndex++;
            }
            
            if (nextIndex < themes.length && !themes[nextIndex].locked) {
                // äº¤æ¢ä½ç½®
                [themes[index], themes[nextIndex]] = [themes[nextIndex], themes[index]];
                this.save();
                this.renderThemeList();
            }
        }
    },
    
    toggleThemeEnable() {
        const enabled = document.getElementById('theme_enable').checked;
        this.data.themeConfig.enabled = enabled;
        
        const themeArea = document.getElementById('themeArea');
        themeArea.style.opacity = enabled ? '1' : '0.5';
        themeArea.style.pointerEvents = enabled ? 'auto' : 'none';
    },
    
    switchTheme(id) {
        this.data.themeConfig.activeId = id;
        this.renderThemeList();
        this.updateThemeEditor();
    },
    
    updateThemeEditor() {
        const active = this.data.themeConfig.themes.find(t => t.id === this.data.themeConfig.activeId);
        if(active) {
            const isLocked = active.locked === true;
            document.getElementById('themeCode').value = active.content;
            document.getElementById('themeCode').readOnly = isLocked;
            document.getElementById('themeCode').style.opacity = isLocked ? '0.7' : '1';
            document.getElementById('themeCode').style.cursor = isLocked ? 'not-allowed' : 'text';
        }
    },
    
    // åˆ›å»ºæ–°ä¸»é¢˜
    createNewTheme() {
        const nameInput = document.getElementById('newThemeName');
        const name = nameInput.value.trim();
        
        if (!name) {
            alert('è¯·è¾“å…¥ä¸»é¢˜åç§°');
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåä¸»é¢˜
        if (this.data.themeConfig.themes.some(t => t.name === name)) {
            alert('å·²å­˜åœ¨åŒåä¸»é¢˜');
            return;
        }
        
        const newId = 'custom_' + Date.now();
        const newTheme = {
            id: newId,
            name: name,
            content: EMPTY_THEME_TEMPLATE,
            locked: false
        };
        
        this.data.themeConfig.themes.push(newTheme);
        this.data.themeConfig.activeId = newId;
        this.data.themeConfig.enabled = true;
        
        this.renderThemeList();
        this.updateThemeEditor();
        
        // æ›´æ–°UIçŠ¶æ€
        document.getElementById('theme_enable').checked = true;
        const themeArea = document.getElementById('themeArea');
        themeArea.style.opacity = '1';
        themeArea.style.pointerEvents = 'auto';
        
        nameInput.value = '';
        alert(`ä¸»é¢˜"${name}"å·²åˆ›å»ºï¼Œè¯·ç¼–å†™æ¨¡æ¿ä»£ç `);
    },
    
    // é‡å‘½åä¸»é¢˜
    renameTheme(id, event) {
        event.stopPropagation();
        
        const theme = this.data.themeConfig.themes.find(t => t.id === id);
        if (!theme || theme.locked) return;
        
        const newName = prompt('è¯·è¾“å…¥æ–°çš„ä¸»é¢˜åç§°:', theme.name);
        if (newName && newName.trim()) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåä¸»é¢˜
            if (this.data.themeConfig.themes.some(t => t !== theme && t.name === newName.trim())) {
                alert('å·²å­˜åœ¨åŒåä¸»é¢˜');
                return;
            }
            
            theme.name = newName.trim();
            this.renderThemeList();
        }
    },
    
    // åˆ é™¤ä¸»é¢˜
    deleteTheme(id, event) {
        event.stopPropagation();
        
        const theme = this.data.themeConfig.themes.find(t => t.id === id);
        if (!theme || theme.locked) return;
        
        if (confirm(`ç¡®å®šè¦åˆ é™¤ä¸»é¢˜"${theme.name}"å—ï¼Ÿ`)) {
            // ä»ä¸»é¢˜åˆ—è¡¨ä¸­ç§»é™¤
            this.data.themeConfig.themes = this.data.themeConfig.themes.filter(t => t.id !== id);
            
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„ä¸»é¢˜ï¼Œåˆ‡æ¢åˆ°é»˜è®¤ä¸»é¢˜
            if (this.data.themeConfig.activeId === id) {
                this.data.themeConfig.activeId = 'default';
            }
            
            this.renderThemeList();
            this.updateThemeEditor();
        }
    },
    
    saveThemeConfig() {
        const activeId = this.data.themeConfig.activeId;
        const code = document.getElementById('themeCode').value;
        const themeIndex = this.data.themeConfig.themes.findIndex(t => t.id === activeId);
        
        if(themeIndex > -1) {
            const theme = this.data.themeConfig.themes[themeIndex];
            
            // å†…ç½®ä¸»é¢˜ä¸èƒ½ç›´æ¥ä¿®æ”¹
            if(theme.locked) {
                if(theme.content !== code) {
                    if(confirm('å†…ç½®ä¸»é¢˜ä¸å¯ç›´æ¥ä¿®æ”¹ï¼Œæ˜¯å¦ä¿å­˜ä¸ºæ–°ä¸»é¢˜å‰¯æœ¬ï¼Ÿ')) {
                        const newId = 'custom_copy_' + Date.now();
                        const newName = theme.name + ' (å‰¯æœ¬)';
                        
                        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåå‰¯æœ¬
                        let copyNumber = 1;
                        let finalName = newName;
                        while(this.data.themeConfig.themes.some(t => t.name === finalName)) {
                            finalName = `${theme.name} (å‰¯æœ¬${copyNumber})`;
                            copyNumber++;
                        }
                        
                        this.data.themeConfig.themes.push({
                            id: newId,
                            name: finalName,
                            content: code,
                            locked: false
                        });
                        this.data.themeConfig.activeId = newId;
                    } else {
                        return;
                    }
                }
            } else {
                // è‡ªå®šä¹‰ä¸»é¢˜ç›´æ¥ä¿å­˜
                theme.content = code;
            }
        }
        
        this.data.themeConfig.enabled = document.getElementById('theme_enable').checked;
        this.save();
        ui.close();
        alert('ä¸»é¢˜é…ç½®å·²ä¿å­˜');
    },
    
    importThemeFromFile(input) {
        const file = input.files[0];
        if(!file) return;
        
        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        const fileName = file.name.toLowerCase();
        if (!fileName.endsWith('.html') && !fileName.endsWith('.htm')) {
            alert('è¯·é€‰æ‹©HTMLæ–‡ä»¶ (.html æˆ– .htm)');
            input.value = '';
            return;
        }
        
        const r = new FileReader();
        r.onload = e => {
            const content = e.target.result;
            const fileName = file.name.replace('.html', '').replace('.htm', '');
            
            // æç¤ºç”¨æˆ·è¾“å…¥ä¸»é¢˜åç§°
            const themeName = prompt('è¯·è¾“å…¥ä¸»é¢˜åç§°:', fileName || 'å¯¼å…¥çš„ä¸»é¢˜');
            if (!themeName || !themeName.trim()) return;
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåä¸»é¢˜
            if (this.data.themeConfig.themes.some(t => t.name === themeName.trim())) {
                alert('å·²å­˜åœ¨åŒåä¸»é¢˜ï¼Œè¯·ä½¿ç”¨ä¸åŒçš„åç§°');
                return;
            }
            
            const newId = 'imported_' + Date.now();
            this.data.themeConfig.themes.push({
                id: newId,
                name: themeName.trim(),
                content: content,
                locked: false
            });
            
            this.data.themeConfig.activeId = newId;
            this.data.themeConfig.enabled = true;
            
            this.renderThemeList();
            this.updateThemeEditor();
            
            // æ›´æ–°UIçŠ¶æ€
            document.getElementById('theme_enable').checked = true;
            const themeArea = document.getElementById('themeArea');
            themeArea.style.opacity = '1';
            themeArea.style.pointerEvents = 'auto';
            
            alert('æ¨¡æ¿å¯¼å…¥æˆåŠŸï¼Œå·²å¯ç”¨è¯¥ä¸»é¢˜');
        };
        r.readAsText(file);
        input.value = '';
    },
    
    resetThemeToDefault() {
        const activeId = this.data.themeConfig.activeId;
        const theme = this.data.themeConfig.themes.find(t => t.id === activeId);
        
        if (!theme) return;
        
        if (theme.locked) {
            // å†…ç½®ä¸»é¢˜ï¼šæ¢å¤åŸå§‹å†…å®¹
            if (activeId === 'default') {
                document.getElementById('themeCode').value = DEFAULT_THEME_TEMPLATE;
            } else if (activeId === 'simple') {
                document.getElementById('themeCode').value = MINIMAL_THEME_TEMPLATE;
            }
        } else {
            // è‡ªå®šä¹‰ä¸»é¢˜ï¼šè¯¢é—®æ˜¯å¦é‡ç½®ä¸ºç©ºæ¨¡æ¿
            if (confirm('é‡ç½®æ­¤è‡ªå®šä¹‰ä¸»é¢˜çš„å†…å®¹ä¸ºç©ºæ¨¡æ¿ï¼Ÿ')) {
                document.getElementById('themeCode').value = EMPTY_THEME_TEMPLATE;
            }
        }
    },

    // --- å¯¼å…¥å¯¼å‡º ---
    exportJson() {
        // å¯¼å‡ºå®Œæ•´æ•°æ®ï¼ŒåŒ…æ‹¬ä¸»é¢˜é…ç½®
        const exportData = {
            config: this.data.config,
            builtInTabOrder: this.data.builtInTabOrder,
            customTabs: this.data.customTabs,
            tabOrder: this.data.tabOrder,
            hiddenTabs: this.data.hiddenTabs,
            items: this.data.items,
            activeTab: this.data.activeTab,
            themeConfig: this.data.themeConfig
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], {type:'application/json'});
        saveAs(URL.createObjectURL(blob), `å¤‡ä»½_${new Date().toISOString().slice(0,10)}.json`);
    },
    
    importJson(input) {
        const file = input.files[0];
        if(!file) return;
        
        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        const fileName = file.name.toLowerCase();
        if (!fileName.endsWith('.json')) {
            alert('è¯·é€‰æ‹©JSONæ–‡ä»¶ (.json)');
            input.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const json = JSON.parse(e.target.result);
                
                // å…¼å®¹ v1.1.5 åŠä¹‹å‰çš„æ•°ç»„æ ¼å¼
                if(Array.isArray(json)) {
                    if(confirm('æ£€æµ‹åˆ°æ—§ç‰ˆå¤‡ä»½æ•°æ® (v1.x)ï¼Œæ˜¯å¦å°†å…¶å¯¼å…¥åˆ° LX æ ‡ç­¾é¡µï¼Ÿ\n(æ³¨æ„ï¼šè¿™å°†è¦†ç›–å½“å‰ LX æ ‡ç­¾é¡µçš„æ•°æ®)')) {
                        // è½¬æ¢æ—§æ•°æ®ç»“æ„ -> æ–°æ•°æ®ç»“æ„
                        const newItems = json.map(old => ({
                            id: old.id || Date.now() + Math.random(),
                            tab: 'LX',
                            name: old.fileName || old.name || 'æœªçŸ¥æ–‡ä»¶',
                            ver: '', // æ—§ç‰ˆæ— æ­¤å­—æ®µ
                            quality: old.quality || '',
                            note: old.note || '',
                            file: old.fileContent ? { content: old.fileContent, size: old.fileSize || 0 } : null,
                            links: old.links || [],
                            dlLink: old.directUrl || '',
                            keyConfig: {
                                enableUrl: (old.keyMode === 'link' || (!!old.keyUrl && old.keyUrl.length > 0)),
                                url: old.keyUrl || '',
                                enableVar: (old.keyVariable && old.keyVariable.length > 0),
                                var: old.keyVariable || ''
                            }
                        }));

                        // ä¿ç•™å…¶ä»–æ ‡ç­¾é¡µçš„æ•°æ®ï¼Œä»…æ›¿æ¢ LX æ ‡ç­¾é¡µ
                        this.data.items = this.data.items.filter(i => i.tab !== 'LX').concat(newItems);
                        this.data.activeTab = 'LX';
                        
                        this.save();
                        this.renderTabs();
                        this.render();
                        alert('æ—§ç‰ˆæ•°æ®å¯¼å…¥æˆåŠŸï¼');
                    }
                    return;
                }
                
                // æ ‡å‡† v1.3+ å¯¹è±¡æ ¼å¼
                if(json.items) {
                    if(confirm('æ˜¯å¦å¯¼å…¥å¤‡ä»½æ•°æ®ï¼Ÿ\n(å½“å‰æ•°æ®å°†è¢«è¦†ç›–)')) {
                        // æ·±åº¦åˆå¹¶é…ç½®
                        this.data.config = json.config || this.data.config;
                        this.data.builtInTabOrder = json.builtInTabOrder || [];
                        this.data.customTabs = json.customTabs || this.data.customTabs;
                        this.data.tabOrder = json.tabOrder || [];
                        this.data.hiddenTabs = json.hiddenTabs || [];
                        this.data.items = json.items;
                        this.data.activeTab = json.activeTab || 'LX';
                        
                        // å¤„ç†ä¸»é¢˜é…ç½®
                        if (json.themeConfig) {
                            // å¯¼å…¥çš„ä¸»é¢˜é…ç½®
                            this.data.themeConfig = json.themeConfig;
                            
                            // ç¡®ä¿å†…ç½®ä¸»é¢˜å­˜åœ¨ä¸”lockedä¸ºtrue
                            const defaultTheme = this.data.themeConfig.themes.find(t => t.id === 'default');
                            const simpleTheme = this.data.themeConfig.themes.find(t => t.id === 'simple');
                            
                            if (!defaultTheme) {
                                this.data.themeConfig.themes.unshift({
                                    id: 'default',
                                    name: 'é»˜è®¤ä¸»é¢˜',
                                    content: DEFAULT_THEME_TEMPLATE,
                                    locked: true
                                });
                            } else {
                                defaultTheme.locked = true;
                            }
                            
                            if (!simpleTheme) {
                                this.data.themeConfig.themes.push({
                                    id: 'simple',
                                    name: 'æç®€åˆ—è¡¨ (ç¤ºä¾‹)',
                                    content: MINIMAL_THEME_TEMPLATE,
                                    locked: true
                                });
                            } else {
                                simpleTheme.locked = true;
                            }
                            
                            // ç¡®ä¿activeIdæœ‰æ•ˆ
                            if (!this.data.themeConfig.themes.some(t => t.id === this.data.themeConfig.activeId)) {
                                this.data.themeConfig.activeId = 'default';
                            }
                        } else {
                            // æ²¡æœ‰ä¸»é¢˜é…ç½®ï¼Œä½¿ç”¨é»˜è®¤
                            this.data.themeConfig = {
                                enabled: false,
                                activeId: 'default',
                                themes: [
                                    { id: 'default', name: 'é»˜è®¤ä¸»é¢˜', content: DEFAULT_THEME_TEMPLATE, locked: true },
                                    { id: 'simple', name: 'æç®€åˆ—è¡¨ (ç¤ºä¾‹)', content: MINIMAL_THEME_TEMPLATE, locked: true }
                                ]
                            };
                        }
                        
                        // å¦‚æœbuiltInTabOrderä¸å­˜åœ¨ï¼Œä»configä¸­æ¢å¤
                        if (!this.data.builtInTabOrder || this.data.builtInTabOrder.length === 0) {
                            this.data.builtInTabOrder = [];
                            if (this.data.config.showMF) this.data.builtInTabOrder.push('Music Free');
                            if (this.data.config.showLY) this.data.builtInTabOrder.push('æ¾œéŸ³');
                        }
                        
                        // å¦‚æœtabOrderä¸å­˜åœ¨ï¼Œåˆå§‹åŒ–
                        if (!this.data.tabOrder || this.data.tabOrder.length === 0) {
                            this.data.tabOrder = [];
                            // æ·»åŠ å‹¾é€‰çš„å†…ç½®æ ‡ç­¾é¡µ
                            if (this.data.config.showMF) this.data.tabOrder.push('Music Free');
                            if (this.data.config.showLY) this.data.tabOrder.push('æ¾œéŸ³');
                            // æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾é¡µ
                            this.data.tabOrder = this.data.tabOrder.concat(this.data.customTabs);
                        }
                        
                        this.save();
                        this.renderTabs();
                        this.render();
                        this.renderHiddenTabsList();
                        alert('å¯¼å…¥æˆåŠŸï¼');
                    }
                } else {
                    alert('æ— æ³•è¯†åˆ«çš„æ–‡ä»¶æ ¼å¼');
                }
            } catch(err) { 
                console.error(err); 
                alert('è§£æå¤±è´¥: ' + err.message); 
            }
        };
        reader.readAsText(file);
        input.value = '';
    },

    exportHtml() {
        const html = generateExportHtml(this.data);
        const blob = new Blob([html], {type:'text/html'});
        saveAs(URL.createObjectURL(blob), `æ’ä»¶åˆ—è¡¨_${new Date().toISOString().slice(0,10)}.html`);
    },
    
    // --- æ–°å¢ï¼šå¯¼å‡ºä¸ºMarkdown ---
    exportMarkdown() {
        try {
            const curTab = this.data.activeTab;
            const list = this.data.items.filter(i => {
                const t = i.tab || 'LX';
                return t === curTab;
            });
            
            if (list.length === 0) {
                alert('å½“å‰æ ‡ç­¾é¡µæ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            let markdown = `# ${curTab} æ’ä»¶åˆ—è¡¨\n\n`;
            markdown += `> å¯¼å‡ºæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}\n\n`;
            
            // æ·»åŠ è¡¨æ ¼æ ‡é¢˜
            markdown += "| æ–‡ä»¶å | ç‰ˆæœ¬ | éŸ³è´¨ | å¤‡æ³¨ | é“¾æ¥ | æ“ä½œ |\n";
            markdown += "|--------|------|------|------|------|------|\n";
            
            // æ·»åŠ æ•°æ®è¡Œ
            list.forEach(item => {
                // æ–‡ä»¶å
                const fileName = item.name || 'æœªå‘½å';
                
                // ç‰ˆæœ¬
                const version = item.ver || '-';
                
                // éŸ³è´¨
                const quality = item.quality || '-';
                
                // å¤‡æ³¨ï¼ˆæ¢è¡Œç¬¦å¤„ç†ï¼‰
                const note = (item.note || '-').replace(/\n/g, '<br>');
                
                // é“¾æ¥
                let linksText = '-';
                if (item.links && item.links.length > 0) {
                    linksText = item.links.map(link => `[${link.text}](${link.url})`).join('<br>');
                }
                
                // æ“ä½œ
                let actions = [];
                if (item.dlLink) {
                    actions.push(`[ç›´é“¾](${item.dlLink})`);
                }
                if (item.file && item.file.content) {
                    actions.push('æ–‡ä»¶å·²ä¸Šä¼ ');
                }
                if (curTab === 'LX' && item.keyConfig) {
                    if (item.keyConfig.enableUrl) {
                        actions.push('Keyåœ¨çº¿');
                    }
                    if (item.keyConfig.enableVar) {
                        actions.push('Keyæœ¬åœ°');
                    }
                }
                const actionsText = actions.length > 0 ? actions.join('<br>') : '-';
                
                markdown += `| ${fileName} | ${version} | ${quality} | ${note} | ${linksText} | ${actionsText} |\n`;
            });
            
            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            navigator.clipboard.writeText(markdown)
                .then(() => {
                    alert('Markdownæ ¼å¼å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nä½ å¯ä»¥å°†å…¶ç²˜è´´åˆ°æ”¯æŒMarkdownçš„ç¼–è¾‘å™¨ä¸­ã€‚');
                })
                .catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    // å¦‚æœclipboard APIå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•
                    const textArea = document.createElement('textarea');
                    textArea.value = markdown;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('Markdownæ ¼å¼å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nä½ å¯ä»¥å°†å…¶ç²˜è´´åˆ°æ”¯æŒMarkdownçš„ç¼–è¾‘å™¨ä¸­ã€‚');
                });
                
        } catch (error) {
            console.error('å¯¼å‡ºMarkdownæ—¶å‘ç”Ÿé”™è¯¯:', error);
            alert('å¯¼å‡ºMarkdownæ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
        }
    }
};

const ui = {
    open(id) { document.getElementById(id).style.display = 'block'; },
    close() { document.querySelectorAll('.modal-overlay').forEach(e=>e.style.display='none'); app.state.editId=null; },
    openTabOpt() {
        document.getElementById('chk_mf').checked = app.data.config.showMF;
        document.getElementById('chk_ly').checked = app.data.config.showLY;
        app.renderHiddenTabsList();
        app.renderTabSortList(); // æ¸²æŸ“æ ‡ç­¾é¡µæ’åºåˆ—è¡¨
        this.open('modalTabs');
    },
    getVal(id) { return document.getElementById(id).value; },
    setVal(id, v) { document.getElementById(id).value = v; },
    getCheck(id) { return document.getElementById(id).checked; },
    setCheck(id, v) { document.getElementById(id).checked = v; }
};

function esc(s) { return s ? s.replace(/"/g, "&quot;") : ""; }
function fmtSize(b) { 
    if(!b) return ''; 
    if(b<1024) return b+'B'; 
    if(b<1048576) return (b/1024).toFixed(1)+'KB'; 
    return (b/1048576).toFixed(1)+'MB'; 
}
function saveAs(url, name) {
    const a = document.createElement('a');
    a.href = url; a.download = name; a.click();
}

// --- å¯¼å‡ºé€»è¾‘ (æ”¯æŒè‡ªå®šä¹‰ä¸»é¢˜) ---
function generateExportHtml(data) {
    let template = DEFAULT_THEME_TEMPLATE;
    
    if (data.themeConfig && data.themeConfig.enabled) {
        const activeTheme = data.themeConfig.themes.find(t => t.id === data.themeConfig.activeId);
        if (activeTheme) {
            template = activeTheme.content;
        }
    }

    // åˆ›å»ºå¹²å‡€çš„å¯¼å‡ºæ•°æ®å¯¹è±¡
    const exportData = {
        config: data.config,
        builtInTabOrder: data.builtInTabOrder,
        customTabs: data.customTabs,
        tabOrder: data.tabOrder,
        items: data.items
        // ä¸åŒ…å« themeConfigï¼Œé¿å…æ±¡æŸ“å¯¼å‡ºçš„HTML
    };
    
    const jsonStr = JSON.stringify(exportData);
    
    let result = template
        .replace(/{{DATA}}/g, jsonStr)
        .replace(/{{DATE}}/g, new Date().toISOString().slice(0,10))
        .replace(/{{TITLE}}/g, "æ’ä»¶åˆ—è¡¨");

    return result;
}

// åˆå§‹åŒ–åº”ç”¨
app.init();

// æ·»åŠ é¡µé¢å¸è½½å‰çš„ä¿å­˜æç¤º
window.addEventListener('beforeunload', function (e) {
    // è‡ªåŠ¨ä¿å­˜å½“å‰æ•°æ®
    try {
        app.save();
    } catch(err) {
        console.error('è‡ªåŠ¨ä¿å­˜å¤±è´¥:', err);
    }
});

// æ·»åŠ é”®ç›˜å¿«æ·é”®
document.addEventListener('keydown', function(e) {
    // Ctrl+S ä¿å­˜
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        app.save();
        alert('æ•°æ®å·²ä¿å­˜');
    }
    
    // Ctrl+D æ–°å¢é¡¹ç›®
    if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
        e.preventDefault();
        app.addItem();
    }
    
    // Ctrl+M å¯¼å‡ºMarkdown
    if ((e.ctrlKey || e.metaKey) && e.key === 'm') {
        e.preventDefault();
        app.exportMarkdown();
    }
});
</script>
</body>
</html>