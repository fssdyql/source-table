<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{TITLE}} - é‡å­å¹³é“º</title>
  <style>
    /* æ ·å¼éƒ¨åˆ† */
    :root {
      --primary-color: #3f51b5; /* é›é’è‰² */
      --secondary-color: #ff9800; /* ç¥ç€è‰²é«˜äº® */
      --bg-color: #f4f6f9;
      --text-color: #2c3e50;
      --tile-bg: #ffffff;
      --drawer-bg: #e8eaf6; /* æŠ½å±‰èƒŒæ™¯è‰² */
      --border-color: #e0e0e0;
      --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
      --radius-sm: 8px;
    }
    .dark {
      --primary-color: #7986cb;
      --secondary-color: #ffb74d;
      --bg-color: #1a1a2e;
      --text-color: #ecf0f1;
      --tile-bg: #2c3e50;
      --drawer-bg: #34495e;
      --border-color: #3b506b;
    }

    /* åŸºç¡€æ ·å¼ */
    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.4s;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* å¤´éƒ¨ä¸å¯¼èˆª */
    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--primary-color);
    }
    .tab-navigation {
      display: flex;
      gap: 10px;
    }
    .tab-btn {
      padding: 10px 15px;
      border: 1px solid var(--border-color);
      background: var(--tile-bg);
      color: var(--text-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.3s;
    }
    .tab-btn.active, .tab-btn:hover {
      background-color: var(--primary-color);
      color: white;
      box-shadow: 0 0 8px rgba(63, 81, 181, 0.4);
    }

    /* === æ ¸å¿ƒï¼šå¹³é“ºå¸ƒå±€ (Tiles Grid) === */
    .tiles-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    .tile-group-header {
      grid-column: 1 / -1; /* è·¨è¶Šæ‰€æœ‰åˆ— */
      margin-top: 30px;
      margin-bottom: 10px;
      padding-left: 10px;
    }
    .tile-group-header h2 {
      margin: 0;
      font-size: 24px;
      color: var(--primary-color);
      border-left: 4px solid var(--primary-color);
      padding-left: 10px;
    }

    /* æ’ä»¶å¹³é“º (Tile) */
    .plugin-tile {
      background: var(--tile-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      transition: all 0.3s;
      position: relative;
    }
    .plugin-tile:hover {
      border-color: var(--primary-color);
      box-shadow: 0 0 15px rgba(63, 81, 181, 0.3);
      transform: translateY(-2px);
    }

    /* å¹³é“ºå¤´éƒ¨ (å§‹ç»ˆå¯è§) */
    .tile-header {
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--tile-bg);
      z-index: 10;
    }
    .tile-header h3 {
      margin: 0;
      font-size: 18px;
      color: var(--text-color);
    }

    /* æ ¸å¿ƒå±æ€§æ ‡è®° */
    .attr-badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
      background-color: var(--secondary-color);
      color: var(--tile-bg);
      font-weight: 500;
      margin-left: 10px;
    }
    .quality-badge { background-color: #4caf50; } /* ç»¿è‰² */

    /* === ä¿¡æ¯æŠ½å±‰ (Information Drawer) === */
    .info-drawer {
      padding: 0 15px;
      background: var(--drawer-bg);
      max-height: 0; /* é»˜è®¤éšè— */
      overflow: hidden;
      transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out;
      border-top: 1px solid var(--border-color);
    }

    /* å±•å¼€çŠ¶æ€ */
    .plugin-tile.open .info-drawer {
      max-height: 300px; /* è¶³å¤Ÿå®¹çº³å†…å®¹ */
      padding: 15px;
    }
    
    .drawer-note {
        font-size: 14px;
        margin-bottom: 15px;
        line-height: 1.5;
    }

    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .btn {
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s;
      font-size: 13px;
    }
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }
    .btn-secondary {
      background-color: var(--border-color);
      color: var(--text-color);
    }

  </style>
</head>
<body class="light">
  <div class="container">
    <div class="header-bar">
      <h1>{{TITLE}} - é‡å­å¹³é“º</h1>
      <div class="header-controls">
        <div class="tab-navigation" id="tabNav">
          </div>
        <button class="btn btn-secondary" onclick="darkModeManager.toggle()" style="margin-top: 10px;">åˆ‡æ¢ä¸»é¢˜</button>
      </div>
    </div>
    
    <input type="search" id="searchInput" class="tab-btn" placeholder="ğŸ” æœç´¢æ–‡ä»¶åã€éŸ³è´¨æˆ–å¤‡æ³¨..." style="width: 100%; max-width: 400px; margin-bottom: 20px;">

    <main id="contentArea">
      <p id="loadingMessage" style="text-align: center;">æ­£åœ¨åŠ è½½æ•°æ®...</p>
    </main>
  </div>
  
  <script>
    // === JavaScript æ ¸å¿ƒé€»è¾‘ ===
    
    let appData = { items: [], config: {}, customTabs: [] };
    let appState = { currentTab: 'LX' };

    // 1. æ•°æ®è§£æå’Œå·¥å…·å‡½æ•°
    function initializeData() {
      const dataString = '{{DATA}}';
      try {
        appData = JSON.parse(dataString);
      } catch (e) {
        console.error('æ•°æ®è§£æå¤±è´¥:', e);
        appData = { items: [], config: {}, customTabs: [] };
      }
    }
    function formatFileSize(bytes) {
      if (bytes === 0 || !bytes) return 'N/A';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    function getAvailableTabs() {
      const tabs = ['LX'];
      if (appData.config.showMF) tabs.push('Music Free');
      if (appData.config.showLY) tabs.push('æ¾œéŸ³');
      if (appData.customTabs && appData.customTabs.length) { tabs.push(...appData.customTabs); }
      return [...new Set(tabs)];
    }
    
    // 2. æ ¸å¿ƒåˆ†ç»„é€»è¾‘ï¼šæŒ‰ Quality å’Œ Key Status åˆ†ç»„
    function groupByAttributes(items) {
      const groups = {};
      items.forEach(item => {
        // ç‹¬ç‰¹æ€§ï¼šå°† Key é…ç½®ä¿¡æ¯ä½œä¸ºé«˜ä¼˜å…ˆçº§åˆ†ç»„æ¡ä»¶
        const keyStatus = item.tab === 'LX' && item.keyConfig && (item.keyConfig.enableUrl || item.keyConfig.enableVar) 
          ? 'ğŸ”‘ KEY é…ç½®éœ€æ±‚' : '';
        const quality = item.quality || 'ğŸ“ æœªæ ‡è®°éŸ³è´¨';
        
        const groupKey = keyStatus || quality;
        
        if (!groups[groupKey]) {
          groups[groupKey] = [];
        }
        groups[groupKey].push(item);
      });
      
      // æ’åºï¼šå°† Key é…ç½®å’Œé«˜è´¨é‡çš„æ”¾åœ¨å‰é¢
      return Object.keys(groups)
        .sort((a, b) => {
          if (a.includes('KEY') && !b.includes('KEY')) return -1;
          if (b.includes('KEY') && !a.includes('KEY')) return 1;
          if (a.includes('Lossless') || a.includes('Flac')) return -1;
          if (b.includes('Lossless') || b.includes('Flac')) return 1;
          return a.localeCompare(b);
        })
        .map(key => ({
          name: key,
          items: groups[key]
        }));
    }
    
    // 3. æ¸²æŸ“å•ä¸ªæ’ä»¶å¹³é“º
    function renderPluginTile(item) {
      const fileSize = formatFileSize(item.file?.size);
      const version = item.ver || 'N/A';
      const itemId = item.id;
      
      // å¤´éƒ¨å¾½ç« 
      const qualityBadge = item.quality ? `<span class="attr-badge quality-badge">${item.quality}</span>` : '';
      const versionBadge = `<span class="attr-badge">${version}</span>`;
      
      let buttonsHtml = '';
      
      // åŠ¨ä½œæŒ‰é’®
      if (item.dlLink) {
        buttonsHtml += `<a href="${item.dlLink}" class="btn btn-primary" download="${item.name}">ç›´é“¾ä¸‹è½½</a>`;
      } else if (item.file) {
        buttonsHtml += `<button class="btn btn-primary" onclick="downloadFile(${itemId})">ä¸‹è½½æ–‡ä»¶ (${fileSize})</button>`;
      }
      if (item.tab === 'LX' && item.keyConfig && item.keyConfig.enableUrl) {
         buttonsHtml += `<button class="btn btn-secondary" onclick="importWithKeyOnline(${itemId})">åœ¨çº¿ Key</button>`;
      }
      if (item.tab === 'LX' && item.keyConfig && item.keyConfig.enableVar) {
         buttonsHtml += `<button class="btn btn-secondary" onclick="generateFileWithKey(${itemId})">æœ¬åœ° Key æ›¿æ¢</button>`;
      }
      (item.links || []).forEach(link => {
        buttonsHtml += `<a href="${link.url}" target="_blank" class="btn btn-secondary">ğŸ”— ${link.text}</a>`;
      });
      
      return `
        <div class="plugin-tile" onclick="toggleDrawer(this)">
            <div class="tile-header">
                <h3>${item.name}</h3>
                <div>${qualityBadge} ${versionBadge}</div>
            </div>
            
            <div class="info-drawer">
                <p class="drawer-note">${item.note || 'æš‚æ— è¯¦ç»†å¤‡æ³¨ä¿¡æ¯ã€‚'}</p>
                <div class="action-buttons">
                    ${buttonsHtml}
                </div>
            </div>
        </div>
      `;
    }

    // 4. æ ¸å¿ƒæ¸²æŸ“å‡½æ•°
    function renderContent(query = '') {
      const contentArea = document.getElementById('contentArea');
      const allItemsInTab = appData.items.filter(item => (item.tab || 'LX') === appState.currentTab);
      const filteredItems = filterAndSearchItems(allItemsInTab, query);
      const groupedData = groupByAttributes(filteredItems);
      
      let html = '';
      
      if (groupedData.length === 0) {
        html = `<p style="text-align: center; padding: 50px;">å½“å‰æ ‡ç­¾é¡µæˆ–æœç´¢ç»“æœä¸‹æ²¡æœ‰æ’ä»¶ã€‚</p>`;
      } else {
        groupedData.forEach(group => {
          html += `
            <div class="tile-group-header">
              <h2>${group.name} (${group.items.length})</h2>
            </div>
            <div class="tiles-grid">
              ${group.items.map(item => renderPluginTile(item)).join('')}
            </div>
          `;
        });
      }
      
      contentArea.innerHTML = html;
    }
    
    // 5. äº¤äº’å®ç°ï¼šä¿¡æ¯æŠ½å±‰ (ä¿è¯æµç•…)
    function toggleDrawer(element) {
        // å…³é—­å…¶ä»–å·²æ‰“å¼€çš„æŠ½å±‰
        document.querySelectorAll('.plugin-tile.open').forEach(item => {
            if (item !== element) {
                item.classList.remove('open');
            }
        });
        // åˆ‡æ¢å½“å‰æŠ½å±‰
        element.classList.toggle('open');
    }

    // 6. æ ‡ç­¾é¡µåˆ‡æ¢é€»è¾‘
    function renderTabs() {
      const tabNav = document.getElementById('tabNav');
      tabNav.innerHTML = '';
      const tabs = getAvailableTabs();
      if (!tabs.includes(appState.currentTab) && tabs.length > 0) {
        appState.currentTab = tabs[0];
      }
      tabs.forEach(tab => {
        const button = document.createElement('button');
        button.className = 'tab-btn' + (tab === appState.currentTab ? ' active' : '');
        button.textContent = tab;
        button.onclick = () => switchTab(tab);
        tabNav.appendChild(button);
      });
    }

    function switchTab(newTab) {
      appState.currentTab = newTab;
      document.getElementById('searchInput').value = '';
      renderTabs();
      renderContent();
    }
    
    // 7. æœç´¢ã€ä¸‹è½½å’Œ Key ç›¸å…³çš„å·¥å…·å‡½æ•°
    function filterAndSearchItems(items, query) {
      if (!query) return items;
      const keywords = query.toLowerCase().split(' ').filter(k => k.length > 0);
      return items.filter(item => {
        const searchableText = [item.name, item.note, item.ver, item.quality, item.tab].join(' ').toLowerCase();
        return keywords.every(keyword => searchableText.includes(keyword));
      });
    }
    
    function downloadFile(itemId) {
      const item = appData.items.find(x => x.id === itemId);
      if (!item || !item.file || !item.file.content) { alert('æ–‡ä»¶æ•°æ®ç¼ºå¤±ï¼Œæ— æ³•ä¸‹è½½ã€‚'); return; }
      const a = document.createElement('a');
      a.href = item.file.content; 
      a.download = item.name;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      // å¯é€‰ï¼šå…³é—­æŠ½å±‰
      document.querySelector(`[data-id="${itemId}"]`)?.closest('.plugin-tile')?.classList.remove('open');
    }
    
    function importWithKeyOnline(itemId) {
      const item = appData.items.find(x => x.id === itemId);
      if (!item?.keyConfig?.enableUrl) return;
      const key = prompt(`è¯·è¾“å…¥Keyä»¥å¯¼å…¥ ${item.name}:`, '');
      if (key && item.keyConfig.url) {
        alert(`å·²æ¨¡æ‹Ÿåœ¨çº¿ Key å¯¼å…¥ã€‚Key: ${key}`);
      }
    }
    function generateFileWithKey(itemId) {
      const item = appData.items.find(x => x.id === itemId);
      if (!item?.keyConfig?.enableVar) return;
      const key = prompt(`è¯·è¾“å…¥Keyï¼ˆå°†æ›¿æ¢å˜é‡ ${item.keyConfig.var}ï¼‰:`, '');
      if (key) {
        alert(`å·²è·å–Keyã€‚éœ€è¦è¿›è¡Œ Base64 è§£ç å’Œæ­£åˆ™æ›¿æ¢æ’ä»¶å†…å®¹æ‰èƒ½ä¸‹è½½æ–°æ–‡ä»¶ã€‚`);
      }
    }
    
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => { clearTimeout(timeout); func(...args); };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // 8. æš—è‰²æ¨¡å¼ç®¡ç†å™¨
    class DarkModeManager {
      init() {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const savedMode = localStorage.getItem('darkMode');
        this.isDark = savedMode !== null ? savedMode === 'dark' : prefersDark;
        this.apply();
      }
      toggle() {
        this.isDark = !this.isDark;
        this.apply();
        localStorage.setItem('darkMode', this.isDark ? 'dark' : 'light');
      }
      apply() {
        document.body.className = this.isDark ? 'dark' : 'light';
      }
    }
    window.darkModeManager = new DarkModeManager();

    // 9. å¯åŠ¨åº”ç”¨
    window.addEventListener('DOMContentLoaded', () => {
      initializeData();
      renderTabs();
      renderContent();
      
      document.getElementById('searchInput').addEventListener('input', debounce(function(e) {
        renderContent(e.target.value);
      }, 300));
      
      document.getElementById('loadingMessage').style.display = 'none';
    });
    
    // æŒ‚è½½åˆ°å…¨å±€
    window.toggleDrawer = toggleDrawer;
    window.downloadFile = downloadFile;
    window.importWithKeyOnline = importWithKeyOnline;
    window.generateFileWithKey = generateFileWithKey;
    
  </script>
</body>
</html>