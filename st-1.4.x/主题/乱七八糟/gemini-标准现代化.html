<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{TITLE}} - 插件列表</title>
  <style>
    /* CSS 变量系统 (支持暗色模式) */
    :root {
      --primary-color: #2563eb;
      --secondary-color: #64748b;
      --bg-color: #ffffff;
      --text-color: #334155;
      --card-bg: #f8fafc;
      --border-color: #e2e8f0;
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --border-radius-lg: 12px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
    }
    
    /* 暗色模式覆盖 */
    .dark {
      --primary-color: #3b82f6;
      --bg-color: #0f172a;
      --text-color: #f1f5f9;
      --card-bg: #1e293b;
      --border-color: #334155;
    }

    /* 基础样式 */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
      margin: 0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--spacing-lg);
    }
    
    /* 头部 */
    .app-header {
      padding: var(--spacing-md) 0;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: var(--spacing-lg);
    }
    .app-header h1 {
      margin: 0;
      font-size: 28px;
    }
    .meta-info {
      font-size: 14px;
      color: var(--secondary-color);
    }

    /* 标签页导航 */
    .tab-navigation {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: var(--spacing-md);
      border-bottom: 1px solid var(--border-color);
    }
    .tab-btn {
      padding: 10px 15px;
      cursor: pointer;
      border: none;
      background: none;
      color: var(--text-color);
      font-size: 16px;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    .tab-btn:hover {
      color: var(--primary-color);
    }
    .tab-btn.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
      font-weight: 600;
    }

    /* 插件网格/卡片视图 */
    .plugin-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: var(--spacing-md);
    }
    .plugin-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-md);
      box-shadow: var(--shadow-sm);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
    }
    .plugin-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .plugin-card h3 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 18px;
    }
    .plugin-card p {
      margin: 0 0 8px 0;
      color: var(--secondary-color);
      font-size: 14px;
    }
    
    /* 标记和按钮 */
    .tags {
      display: flex;
      gap: 8px;
      margin-bottom: var(--spacing-md);
    }
    .tag {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      background-color: #e0f2fe; /* Light blue */
      color: #0369a1; /* Dark blue */
    }
    .dark .tag {
      background-color: #1e40af;
      color: #93c5fd;
    }
    .action-buttons {
      margin-top: auto; /* Push buttons to the bottom */
      display: flex;
      gap: 10px;
      padding-top: var(--spacing-md);
      border-top: 1px dashed var(--border-color);
    }
    .btn {
      flex: 1;
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s;
    }
    .btn-primary {
      background-color: var(--primary-color);
      color: #fff;
    }
    .btn-primary:hover {
      background-color: #1d4ed8;
    }
    .btn-secondary {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-color);
    }
    .btn-secondary:hover {
      background-color: var(--border-color);
    }
    
    /* 响应式调整 */
    @media (max-width: 768px) {
      .container {
        padding: var(--spacing-md);
      }
      .plugin-grid {
        grid-template-columns: 1fr;
      }
      .action-buttons {
        flex-direction: column;
      }
      .tab-btn {
        padding: 8px 12px;
      }
    }
    
    /* 搜索框 */
    .search-bar {
      margin-bottom: var(--spacing-md);
      padding: 10px;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--card-bg);
      color: var(--text-color);
    }
  </style>
</head>
<body class="light">
  <div class="container">
    <header class="app-header">
      <h1>{{TITLE}}</h1>
      <div class="meta-info">导出时间：{{DATE}}</div>
      <button class="btn-secondary" onclick="darkModeManager.toggle()" style="float: right;">切换主题</button>
    </header>
    
    <input type="search" id="searchInput" class="search-bar" placeholder="搜索文件名、音质或备注...">

    <nav class="tab-navigation" id="tabNav"></nav>
    
    <main class="content-area" id="contentArea">
      <p id="loadingMessage">正在加载数据...</p>
    </main>
    
    <footer class="app-footer" style="text-align: center; margin-top: 40px; color: var(--secondary-color);">
      <p>Powered by Plugin List Manager | {{DATE}}</p>
    </footer>
  </div>
  
  <script>
    // -----------------------------------------------------------------
    // 1. 数据解析和初始化
    // -----------------------------------------------------------------

    let appData = { items: [], config: {}, customTabs: [] };
    let appState = { currentTab: 'LX' };
    
    // 安全地解析 {{DATA}} 变量
    function initializeData() {
      const dataString = '{{DATA}}';
      try {
        appData = JSON.parse(dataString);
      } catch (e) {
        console.error('数据解析失败:', e);
        // 提供默认空数据结构以防止应用崩溃
        appData = { items: [], config: {}, customTabs: [] }; 
      }
    }

    // 格式化文件大小
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // -----------------------------------------------------------------
    // 2. 核心渲染函数
    // -----------------------------------------------------------------
    
    // 确定所有可用标签页
    function getAvailableTabs() {
      const tabs = ['LX'];
      if (appData.config.showMF) tabs.push('Music Free');
      if (appData.config.showLY) tabs.push('澜音');
      // 添加自定义标签页
      if (appData.customTabs && appData.customTabs.length) {
        tabs.push(...appData.customTabs);
      }
      return [...new Set(tabs)]; // 去重
    }

    // 渲染标签页导航
    function renderTabs() {
      const tabNav = document.getElementById('tabNav');
      tabNav.innerHTML = '';
      
      const tabs = getAvailableTabs();
      
      tabs.forEach(tab => {
        const button = document.createElement('button');
        button.className = 'tab-btn' + (tab === appState.currentTab ? ' active' : '');
        button.textContent = tab;
        button.onclick = () => switchTab(tab);
        tabNav.appendChild(button);
      });
      
      // 首次加载时确保当前标签页是有效的
      if (!tabs.includes(appState.currentTab) && tabs.length > 0) {
        appState.currentTab = tabs[0];
      }
    }

    // 切换标签页并重新渲染内容
    function switchTab(tabName) {
      appState.currentTab = tabName;
      document.getElementById('searchInput').value = ''; // 清空搜索
      renderTabs();
      renderContent();
    }
    
    // 渲染单个插件卡片
    function renderPluginCard(item) {
      const itemVer = item.ver || 'N/A';
      const fileSize = item.file ? formatFileSize(item.file.size) : '无文件';
      
      // 链接按钮 HTML
      const linkButtons = (item.links || []).map(link => `
        <a href="${link.url}" target="_blank" class="btn btn-secondary">${link.text}</a>
      `).join('');
      
      // 下载按钮逻辑
      let downloadButton = `<button class="btn btn-primary" onclick="downloadFile(${item.id})">下载文件 (${fileSize})</button>`;
      
      if (item.dlLink) {
        // 如果有直链，使用直链下载
        downloadButton = `<a href="${item.dlLink}" class="btn btn-primary" download="${item.name}">直链下载</a>`;
      } else if (!item.file) {
        // 如果没有文件数据，禁用下载
        downloadButton = `<button class="btn btn-primary" disabled>无文件数据</button>`;
      }
      
      // Key 配置按钮 (仅在 LX 标签页下有效时显示)
      let keyButtons = '';
      if (item.tab === 'LX' && item.keyConfig) {
        if (item.keyConfig.enableUrl) {
           keyButtons += `<button class="btn btn-secondary" onclick="importWithKeyOnline(${item.id})">在线Key导入</button>`;
        }
        if (item.keyConfig.enableVar) {
           keyButtons += `<button class="btn btn-secondary" onclick="generateFileWithKey(${item.id})">本地Key替换</button>`;
        }
      }
      
      // 完整的卡片 HTML 结构
      return `
        <div class="plugin-card" data-id="${item.id}">
          <h3>${item.name}</h3>
          <div class="tags">
            <span class="tag">Ver: ${itemVer}</span>
            <span class="tag">Quality: ${item.quality || '未知'}</span>
          </div>
          <p>${item.note || '暂无备注信息'}</p>
          <div style="flex-grow: 1;"></div> <div class="action-buttons">
            ${downloadButton}
            ${keyButtons}
            ${linkButtons}
          </div>
        </div>
      `;
    }

    // 核心内容渲染
    function renderContent(query = '') {
      const contentArea = document.getElementById('contentArea');
      const filteredItems = filterAndSearchItems(appState.currentTab, query);
      
      if (filteredItems.length === 0) {
        contentArea.innerHTML = `<p style="text-align: center; padding: 50px;">当前标签页或搜索结果下没有插件。</p>`;
        return;
      }
      
      const gridHtml = filteredItems.map(item => renderPluginCard(item)).join('');
      contentArea.innerHTML = `<div class="plugin-grid">${gridHtml}</div>`;
    }

    // -----------------------------------------------------------------
    // 3. 交互逻辑 (搜索 & 下载)
    // -----------------------------------------------------------------
    
    // 筛选和搜索逻辑
    function filterAndSearchItems(tabName, query) {
      const items = appData.items.filter(item => (item.tab || 'LX') === tabName);
      if (!query) return items;
      
      const keywords = query.toLowerCase().split(' ').filter(k => k.length > 0);
      
      return items.filter(item => {
        const searchableText = [
          item.name,
          item.note,
          item.ver,
          item.quality
        ].join(' ').toLowerCase();
        
        // 必须匹配所有关键词
        return keywords.every(keyword => searchableText.includes(keyword));
      });
    }

    // 文件下载 (Data URL 方式)
    function downloadFile(itemId) {
      const item = appData.items.find(x => x.id === itemId);
      if (!item || !item.file || !item.file.content) {
        alert('文件数据缺失，无法下载。');
        return;
      }
      try {
        const a = document.createElement('a');
        // file.content 是 Data URL (Base64编码)，可直接用于下载
        a.href = item.file.content; 
        a.download = item.name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } catch (error) {
        console.error('下载失败:', error);
        alert('下载失败：' + error.message);
      }
    }
    
    // Key 配置处理函数 (参考文档4.3.3)
    function importWithKeyOnline(itemId) {
      const item = appData.items.find(x => x.id === itemId);
      if (!item?.keyConfig?.enableUrl) return;
      
      const key = prompt(`请输入Key以导入 ${item.name}:`, '');
      if (key && item.keyConfig.url) {
        window.open(item.keyConfig.url + encodeURIComponent(key), '_blank');
      }
    }
    function generateFileWithKey(itemId) {
      const item = appData.items.find(x => x.id === itemId);
      if (!item?.keyConfig?.enableVar) {
        alert('此文件不支持本地Key导入');
        return;
      }
      // 完整的实现逻辑需要 Base64 解码和正则替换，此处仅做占位和提示
      const key = prompt(`请输入Key（将替换变量 ${item.keyConfig.var}）:`, '');
      if (!key) {
        alert('未输入 Key。');
        return;
      }
      alert(`已获取Key。请查看控制台中的完整生成文件逻辑以完成此操作。`);
      // 实际生产中需要加入文档中提供的 Base64 解码和正则替换逻辑
    }

    // 搜索防抖函数 (参考文档6.1)
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // -----------------------------------------------------------------
    // 4. 暗色模式管理器 (参考文档5.3)
    // -----------------------------------------------------------------
    class DarkModeManager {
      constructor() {
        this.isDark = false;
        this.init();
      }
      init() {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const savedMode = localStorage.getItem('darkMode');
        
        if (savedMode !== null) {
          this.isDark = savedMode === 'dark';
        } else {
          this.isDark = prefersDark;
        }
        this.apply();
      }
      toggle() {
        this.isDark = !this.isDark;
        this.apply();
        localStorage.setItem('darkMode', this.isDark ? 'dark' : 'light');
      }
      apply() {
        if (this.isDark) {
          document.documentElement.classList.add('dark');
          document.body.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
          document.body.classList.remove('dark');
        }
      }
    }
    window.darkModeManager = new DarkModeManager();

    // -----------------------------------------------------------------
    // 5. 启动应用
    // -----------------------------------------------------------------

    window.addEventListener('DOMContentLoaded', () => {
      // 1. 初始化数据
      initializeData();
      
      // 2. 渲染初始视图
      renderTabs();
      renderContent();
      
      // 3. 绑定搜索事件
      const searchInput = document.getElementById('searchInput');
      searchInput.addEventListener('input', debounce(function(e) {
        renderContent(e.target.value);
      }, 300));
      
      document.getElementById('loadingMessage').style.display = 'none';
    });
  </script>
</body>
</html>