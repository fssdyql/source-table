<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{TITLE}} - 宇宙中心</title>
  <style>
    /* === 基础变量与暗色模式 === */
    :root {
      --primary-color: #00bcd4; /* 青色，代表宇宙光芒 */
      --accent-color: #ff9800; /* 橙色，用于高亮 */
      --bg-color: #1a1a2e; /* 深邃的背景色 */
      --text-color: #f1f1f1;
      --detail-bg: #292945; /* 详情背景 */
      --nav-bg: #2b2b40;
      --transition-duration: 0.5s;
      --transition-bezier: cubic-bezier(0.68, -0.55, 0.265, 1.55); /* 弹跳丝滑曲线 */
      --radius-full: 9999px;
    }
    /* 简化暗色模式切换，保持背景统一 */
    .light { 
        --bg-color: #f0f4f8; 
        --text-color: #333; 
        --detail-bg: #ffffff;
        --nav-bg: #e2e8f0;
    }

    /* === 基础布局 === */
    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Segoe UI', sans-serif;
      overflow: hidden; /* 隐藏滚动条以增强沉浸感 */
      display: flex;
      flex-direction: column;
      height: 100vh;
      margin: 0;
      transition: background-color 0.5s;
    }
    
    /* 头部和导航 */
    .app-header {
      padding: 15px 30px;
      text-align: center;
      background: var(--nav-bg);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
    }
    .app-header h1 { margin: 0; font-size: 24px; color: var(--primary-color); }
    .meta-info { font-size: 12px; color: var(--secondary-color); }

    /* 标签导航：中心辐射式按钮 */
    .tab-navigation {
        display: flex;
        gap: 15px;
    }
    .tab-btn {
        padding: 8px 15px;
        background: var(--nav-bg);
        color: var(--text-color);
        border: 1px solid var(--primary-color);
        border-radius: var(--radius-full);
        cursor: pointer;
        transition: all 0.3s;
    }
    .tab-btn.active {
        background-color: var(--primary-color);
        color: var(--bg-color);
        box-shadow: 0 0 10px var(--primary-color);
    }
    
    /* === 主视觉画布 (Canvas) === */
    .canvas-container {
      flex-grow: 1;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden; /* 确保放大效果不溢出 */
    }
    
    /* 插件圆环容器：实现淡入淡出和缩放 */
    .plugin-ring {
      position: absolute;
      width: 100%;
      height: 100%;
      opacity: 0;
      transform: scale(0.5);
      transition: opacity 0.5s ease-in-out, transform 0.5s var(--transition-bezier);
      /* 居中定位点 */
      top: 50%;
      left: 50%;
    }
    .plugin-ring.active {
      opacity: 1;
      transform: scale(1);
    }

    /* 插件点 (The Dot) */
    .plugin-dot {
      position: absolute;
      width: 15px;
      height: 15px;
      border-radius: var(--radius-full);
      background-color: var(--primary-color);
      cursor: pointer;
      transform: translate(-50%, -50%); /* 确保基于中心点定位 */
      transition: all var(--transition-duration) var(--transition-bezier);
      box-shadow: 0 0 5px rgba(0, 188, 212, 0.5);
    }
    
    /* 悬停效果：点放大，显示名称 */
    .plugin-dot:hover {
      transform: translate(-50%, -50%) scale(1.8);
      z-index: 50;
    }

    .dot-name {
      position: absolute;
      top: -25px; /* 位于点上方 */
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
      font-size: 12px;
      opacity: 0;
      padding: 2px 6px;
      background: var(--accent-color);
      color: var(--bg-color);
      border-radius: 4px;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .plugin-dot:hover .dot-name {
      opacity: 1;
    }
    
    /* === 详情视图 (中心展开效果) === */
    .detail-view {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      opacity: 0;
      pointer-events: none;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000; /* 始终在最上层 */
      transition: opacity 0.4s ease-in-out;
    }
    
    /* 放大后的覆盖点 (The Filling Effect) */
    #detail-sphere {
        position: absolute;
        width: 15px; /* 初始大小与 dot 相同 */
        height: 15px;
        background-color: var(--detail-bg);
        border-radius: var(--radius-full);
        transform: scale(0);
        transition: transform 0.6s var(--transition-bezier);
    }

    .detail-view.open {
        opacity: 1;
        pointer-events: auto;
    }
    
    /* 详情内容容器 */
    .detail-content {
        position: relative;
        width: 60%;
        max-width: 500px;
        padding: 30px;
        background: transparent; /* 背景由 sphere 填充 */
        border-radius: 12px;
        text-align: center;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.3s 0.5s, transform 0.3s 0.5s; /* 延迟出现 */
    }
    .detail-view.open .detail-content {
        opacity: 1;
        transform: translateY(0);
    }

    .detail-content h2 { color: var(--accent-color); margin-top: 0; }
    .detail-content p { font-size: 14px; color: var(--secondary-color); }
    .detail-actions { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
    
    .btn-close {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 24px;
        cursor: pointer;
        opacity: 0.6;
        transition: opacity 0.3s;
    }
    .btn-close:hover { opacity: 1; }
  </style>
</head>
<body class="dark">
  <header class="app-header">
    <div class="tab-navigation" id="tabNav">
      </div>
    <h1>{{TITLE}}</h1>
    <button class="tab-btn" onclick="darkModeManager.toggle()">切换主题</button>
  </header>

  <div class="canvas-container">
    <div id="pluginRing" class="plugin-ring active">
      </div>
    
    <div id="detailView" class="detail-view">
        <div id="detail-sphere"></div> <div class="detail-content">
            <button class="btn-close" onclick="closeDetails()">×</button>
            <h2 id="detail-name"></h2>
            <p id="detail-meta"></p>
            <p id="detail-note"></p>
            <div id="detail-actions" class="detail-actions">
                </div>
        </div>
    </div>
  </div>
  
  <script>
    // === JavaScript 核心逻辑 ===

    const APP_RADIUS = 300; // 插件圆环的半径 (px)
    let appData = { items: [], config: {}, customTabs: [] };
    let appState = { currentTab: 'LX' };

    // 1. 数据解析和工具函数
    function initializeData() {
      const dataString = '{{DATA}}';
      try {
        appData = JSON.parse(dataString);
      } catch (e) {
        console.error('数据解析失败:', e);
        appData = { items: [], config: {}, customTabs: [] };
      }
    }
    function formatFileSize(bytes) {
      if (bytes === 0 || !bytes) return 'N/A';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    function getAvailableTabs() {
      const tabs = ['LX'];
      if (appData.config.showMF) tabs.push('Music Free');
      if (appData.config.showLY) tabs.push('澜音');
      if (appData.customTabs && appData.customTabs.length) { tabs.push(...appData.customTabs); }
      return [...new Set(tabs)];
    }
    
    // 2. 核心布局函数：计算圆周坐标
    function calculateCirclePositions(count, radius) {
        const positions = [];
        if (count === 0) return positions;
        const angleStep = 360 / count;
        
        for (let i = 0; i < count; i++) {
            const angle = i * angleStep;
            // 将角度转换为弧度
            const radians = angle * (Math.PI / 180);
            
            // 计算坐标 (中心点 (0,0) 为原点)
            const x = radius * Math.cos(radians);
            const y = radius * Math.sin(radians);
            
            positions.push({ x: x, y: y, angle: angle });
        }
        return positions;
    }
    
    // 3. 渲染插件点
    function renderDots(tabName) {
        const ring = document.getElementById('pluginRing');
        const items = appData.items.filter(item => (item.tab || 'LX') === tabName);
        const count = items.length;
        
        // 大小取决于数量：插件越多，圆环越大，但有一个最大限制
        const currentRadius = Math.min(APP_RADIUS, 150 + count * 5); 
        const positions = calculateCirclePositions(count, currentRadius);
        
        ring.innerHTML = '';
        ring.style.transform = `translate(-50%, -50%) scale(1)`; // 居中
        
        items.forEach((item, index) => {
            const pos = positions[index];
            const dot = document.createElement('div');
            dot.className = 'plugin-dot';
            dot.setAttribute('data-id', item.id);
            dot.setAttribute('data-tab', item.tab);
            
            // 初始定位：使用 transform: translate() 来定位，更平滑
            dot.style.transform = `translate(${pos.x}px, ${pos.y}px)`;
            
            // 添加名称标签
            dot.innerHTML = `<span class="dot-name">${item.name.split('.')[0]}</span>`;
            
            // 绑定点击事件
            dot.onclick = (e) => {
                e.stopPropagation(); // 阻止事件冒泡到其他点
                showDetails(dot, item);
            };

            ring.appendChild(dot);
        });
        
        // 确保新渲染的圆环可见
        ring.classList.add('active');
    }

    // 4. 标签切换动画
    function switchTab(newTab) {
        if (appState.currentTab === newTab) return;
        
        const oldRing = document.getElementById('pluginRing');
        
        // 1. 旧圆环淡出并缩小
        oldRing.classList.remove('active');
        oldRing.style.opacity = 0;
        oldRing.style.transform = `translate(-50%, -50%) scale(0.5)`;
        
        // 2. 更新状态和数据
        appState.currentTab = newTab;
        
        // 3. 延迟渲染新圆环，产生切换动画
        setTimeout(() => {
            renderTabs();
            renderDots(newTab);
        }, 300); // 300ms 保证旧圆环动画完成
    }
    
    // 5. 详情展开动画
    function showDetails(dotElement, item) {
        const detailView = document.getElementById('detailView');
        const detailSphere = document.getElementById('detail-sphere');
        
        // A. 计算 dot 的屏幕中心坐标 (用于起始动画)
        const rect = dotElement.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        
        // B. 定位 detail-sphere 的动画起点
        detailSphere.style.transform = 'scale(0)';
        detailSphere.style.left = `${centerX}px`;
        detailSphere.style.top = `${centerY}px`;
        
        // 立即设置详情内容
        populateDetails(item);
        
        // C. 触发动画
        detailView.classList.add('open');
        
        // 延迟触发放大动画 (确保 DOM 更新完成)
        setTimeout(() => {
            // 目标放大倍数 (足以填充屏幕，此处使用一个巨大值)
            const maxDimension = Math.max(window.innerWidth, window.innerHeight);
            const scaleFactor = maxDimension / 15 * 1.5; 
            
            // 将 sphere 移动到画布中心，并放大
            detailSphere.style.transform = `translate(-50%, -50%) scale(${scaleFactor})`;
            detailSphere.style.left = '50%';
            detailSphere.style.top = '50%';
        }, 10);
    }
    
    // 6. 填充详情内容
    function populateDetails(item) {
        document.getElementById('detail-name').textContent = item.name;
        document.getElementById('detail-meta').textContent = `版本: ${item.ver || 'N/A'} | 音质: ${item.quality || 'N/A'} | 大小: ${formatFileSize(item.file?.size)}`;
        document.getElementById('detail-note').textContent = item.note || '暂无详细备注信息。';
        
        const actions = document.getElementById('detail-actions');
        actions.innerHTML = '';

        // 下载按钮
        if (item.dlLink) {
            actions.innerHTML += `<a href="${item.dlLink}" class="btn btn-primary" download="${item.name}">直链下载</a>`;
        } else if (item.file) {
            actions.innerHTML += `<button class="btn btn-primary" onclick="downloadFile(${item.id})">下载文件</button>`;
        }
        
        // Key 配置按钮
        if (item.tab === 'LX' && item.keyConfig && (item.keyConfig.enableUrl || item.keyConfig.enableVar)) {
            if (item.keyConfig.enableUrl) {
                actions.innerHTML += `<button class="btn btn-secondary" onclick="importWithKeyOnline(${item.id})">在线 Key 导入</button>`;
            }
            if (item.keyConfig.enableVar) {
                actions.innerHTML += `<button class="btn btn-secondary" onclick="generateFileWithKey(${item.id})">本地 Key 替换</button>`;
            }
        }
    }
    
    // 7. 关闭详情
    function closeDetails() {
        const detailView = document.getElementById('detailView');
        const detailSphere = document.getElementById('detail-sphere');
        
        // 1. 内容淡出
        detailView.classList.remove('open');
        
        // 2. 球体缩小 (延迟触发，模拟收回)
        setTimeout(() => {
            detailSphere.style.transform = 'scale(0)';
        }, 400); // 确保内容完全隐藏后开始收缩
    }

    // 8. 工具函数 (下载和 Key 逻辑，同前)
    function renderTabs() {
      const tabNav = document.getElementById('tabNav');
      tabNav.innerHTML = '';
      const tabs = getAvailableTabs();
      tabs.forEach(tab => {
        const button = document.createElement('button');
        button.className = 'tab-btn' + (tab === appState.currentTab ? ' active' : '');
        button.textContent = tab;
        button.onclick = () => switchTab(tab);
        tabNav.appendChild(button);
      });
    }

    function downloadFile(itemId) {
      const item = appData.items.find(x => x.id === itemId);
      if (!item || !item.file || !item.file.content) { alert('文件数据缺失，无法下载。'); return; }
      const a = document.createElement('a');
      a.href = item.file.content; 
      a.download = item.name;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      closeDetails();
    }
    
    function importWithKeyOnline(itemId) {
      const item = appData.items.find(x => x.id === itemId);
      if (!item?.keyConfig?.enableUrl) return;
      const key = prompt(`请输入Key以导入 ${item.name}:`, '');
      if (key && item.keyConfig.url) {
        alert(`已模拟在线 Key 导入。Key: ${key}`);
        // 实际操作: window.open(item.keyConfig.url + encodeURIComponent(key), '_blank');
      }
      closeDetails();
    }
    
    function generateFileWithKey(itemId) {
      const item = appData.items.find(x => x.id === itemId);
      if (!item?.keyConfig?.enableVar) return;
      const key = prompt(`请输入Key（将替换变量 ${item.keyConfig.var}）:`, '');
      if (key) {
        alert(`已获取Key。需要使用 Base64 解码和正则替换插件内容才能下载新文件。`);
      }
      closeDetails();
    }

    // 9. 暗色模式管理器
    class DarkModeManager {
      init() {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const savedMode = localStorage.getItem('darkMode');
        this.isDark = savedMode !== null ? savedMode === 'dark' : prefersDark;
        this.apply();
      }
      toggle() {
        this.isDark = !this.isDark;
        this.apply();
        localStorage.setItem('darkMode', this.isDark ? 'dark' : 'light');
      }
      apply() {
        document.body.className = this.isDark ? 'dark' : 'light';
      }
    }
    window.darkModeManager = new DarkModeManager();

    // 10. 启动应用
    window.addEventListener('DOMContentLoaded', () => {
      initializeData();
      renderTabs();
      renderDots(appState.currentTab);
    });
    
    // 挂载到全局
    window.closeDetails = closeDetails;
    window.downloadFile = downloadFile;
    window.importWithKeyOnline = importWithKeyOnline;
    window.generateFileWithKey = generateFileWithKey;
    
  </script>
</body>
</html>