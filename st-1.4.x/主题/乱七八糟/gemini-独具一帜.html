<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{TITLE}} - ç»“æ„åŒ–ç€‘å¸ƒæµ</title>
  <style>
    /* === é¢œè‰²å’ŒåŸºç¡€å˜é‡ === */
    :root {
      --primary-color: #0d9488; /* Teal é¢œè‰²ä½œä¸ºä¸»è‰²è°ƒ */
      --secondary-color: #4b5563;
      --bg-color: #f9fafb;
      --text-color: #1f2937;
      --card-bg: #ffffff;
      --border-color: #e5e7eb;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
      --spacing-md: 16px;
      --spacing-lg: 32px;
      --radius-sm: 6px;
      --radius-lg: 12px;
    }
    .dark {
      --primary-color: #2dd4bf;
      --bg-color: #111827;
      --text-color: #f3f4f6;
      --card-bg: #1f2937;
      --border-color: #374151;
    }

    /* === åŸºç¡€å¸ƒå±€ === */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
      padding: var(--spacing-lg) 0;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 var(--spacing-md);
    }
    
    /* === å‚ç›´åˆ†ç»„çœ‹æ¿ (Structural Flow) === */
    .group-container {
      margin-top: var(--spacing-lg);
    }
    .group-header {
      display: flex;
      align-items: center;
      margin-bottom: var(--spacing-md);
      color: var(--primary-color);
    }
    .group-header h2 {
      font-size: 20px;
      margin: 0;
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 4px;
    }
    .group-count {
      margin-left: 10px;
      font-size: 14px;
      padding: 2px 8px;
      background: var(--primary-color);
      color: white;
      border-radius: var(--radius-sm);
    }
    
    /* === æ’ä»¶å¡ç‰‡ (The Flow Item) === */
    .plugin-item {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      margin-bottom: 12px;
      overflow: hidden;
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
    }

    /* å¾®å…‰æ•ˆæœ */
    .plugin-item:hover {
      border-color: var(--primary-color);
      box-shadow: 0 0 10px 0 rgba(13, 148, 136, 0.4); /* å¾®å¼±çš„ Primary Color é˜´å½± */
    }

    /* å¡ç‰‡å¤´éƒ¨ï¼ˆå§‹ç»ˆå¯è§ï¼‰ */
    .item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px var(--spacing-md);
    }
    .item-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      flex-grow: 1;
    }
    
    /* ä¿¡æ¯èƒ¶å›Š */
    .info-pills {
      display: flex;
      gap: 8px;
    }
    .pill {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 16px;
      color: white;
      font-weight: 500;
    }
    .pill-ver { background-color: #10b981; } /* ç»¿è‰² */
    .pill-size { background-color: #3b82f6; } /* è“è‰² */

    /* è¯¦æƒ…åŒºåŸŸï¼ˆå¯æŠ˜å ï¼‰ */
    .item-details {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease-out, padding 0.4s ease-out;
      padding: 0 var(--spacing-md);
    }
    /* å±•å¼€çŠ¶æ€ */
    .plugin-item.open .item-details {
      max-height: 500px; /* è¶³å¤Ÿå¤§çš„å€¼ */
      padding: 12px var(--spacing-md) var(--spacing-md) var(--spacing-md);
      border-top: 1px dashed var(--border-color);
    }
    
    .item-note {
        margin-bottom: 10px;
        font-size: 14px;
        line-height: 1.5;
    }
    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    .btn {
        padding: 8px 12px;
        border: none;
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s;
        font-size: 13px;
    }
    .btn-primary {
        background-color: var(--primary-color);
        color: white;
    }
    .btn-secondary {
        background-color: var(--border-color);
        color: var(--text-color);
    }
    
  </style>
</head>
<body class="light">
  <div class="container">
    <header class="app-header">
      <h1>{{TITLE}}</h1>
      <p class="meta-info">å¯¼å‡ºæ—¶é—´ï¼š{{DATE}}</p>
      <button class="btn btn-secondary" onclick="darkModeManager.toggle()" style="float: right;">åˆ‡æ¢ä¸»é¢˜</button>
    </header>
    
    <input type="search" id="searchInput" class="btn-secondary" placeholder="æœç´¢æ’ä»¶..." style="width: 100%; padding: 10px; margin-bottom: 20px;">

    <div id="contentArea">
      <p style="text-align: center;" id="loadingMessage">æ­£åœ¨åŠ è½½æ•°æ®...</p>
    </div>
  </div>
  
  <script>
    // === JavaScript æ ¸å¿ƒé€»è¾‘ ===

    let appData = { items: [], config: {}, customTabs: [] };
    
    // 1. æ•°æ®è§£æå’Œå·¥å…·å‡½æ•°
    function initializeData() {
      const dataString = '{{DATA}}';
      try {
        appData = JSON.parse(dataString);
      } catch (e) {
        console.error('æ•°æ®è§£æå¤±è´¥:', e);
        appData = { items: [], config: {}, customTabs: [] };
      }
    }

    function formatFileSize(bytes) {
      if (bytes === 0 || !bytes) return 'N/A';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // 2. åˆ†ç»„é€»è¾‘ï¼šæŒ‰ Quality åˆ†ç»„
    function groupByQuality(items) {
      const groups = {};
      
      items.forEach(item => {
        // ç‹¬ç‰¹æ€§ï¼šå°† LX æ ‡ç­¾é¡µçš„ Key é…ç½®ä¿¡æ¯ä¹Ÿä½œä¸ºåˆ†ç»„ä¾æ®
        const keyStatus = item.tab === 'LX' && item.keyConfig && (item.keyConfig.enableUrl || item.keyConfig.enableVar) 
          ? 'ğŸ”‘ KEY é…ç½®' : '';
          
        const quality = item.quality || 'ğŸ“ æœªçŸ¥éŸ³è´¨';
        
        // æœ€ç»ˆåˆ†ç»„åï¼šQuality + KeyStatus
        const groupKey = keyStatus ? `${keyStatus} / ${quality}` : quality;
        
        if (!groups[groupKey]) {
          groups[groupKey] = {
            name: groupKey,
            items: [],
            count: 0
          };
        }
        groups[groupKey].items.push(item);
        groups[groupKey].count++;
      });
      
      // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰æ•°é‡æ’åº
      return Object.values(groups).sort((a, b) => b.count - a.count);
    }
    
    // 3. æ¸²æŸ“å•ä¸ªæ’ä»¶é¡¹ (æ ¸å¿ƒï¼šå¯æŠ˜å )
    function renderPluginItem(item) {
      const fileSize = formatFileSize(item.file?.size);
      const version = item.ver || '1.0.0';
      const itemId = item.id;

      // é“¾æ¥ã€Key é…ç½®å’Œä¸‹è½½æŒ‰é’®
      let buttonsHtml = '';
      
      // ä¸‹è½½æŒ‰é’®
      if (item.dlLink) {
        buttonsHtml += `<a href="${item.dlLink}" class="btn btn-primary" download="${item.name}">ç›´é“¾ä¸‹è½½</a>`;
      } else if (item.file) {
        buttonsHtml += `<button class="btn btn-primary" onclick="downloadFile(${itemId})">ä¸‹è½½æ–‡ä»¶</button>`;
      }
      
      // Key é…ç½®æŒ‰é’®
      if (item.tab === 'LX' && item.keyConfig) {
        if (item.keyConfig.enableUrl) {
           buttonsHtml += `<button class="btn btn-secondary" onclick="importWithKeyOnline(${itemId})">åœ¨çº¿ Key</button>`;
        }
        if (item.keyConfig.enableVar) {
           buttonsHtml += `<button class="btn btn-secondary" onclick="generateFileWithKey(${itemId})">æœ¬åœ° Key æ›¿æ¢</button>`;
        }
      }
      
      // å¤–éƒ¨é“¾æ¥
      (item.links || []).forEach(link => {
        buttonsHtml += `<a href="${link.url}" target="_blank" class="btn btn-secondary">${link.text}</a>`;
      });
      
      return `
        <div class="plugin-item" onclick="toggleDetails(this)">
            <div class="item-header">
                <h3>${item.name}</h3>
                <div class="info-pills">
                    <span class="pill pill-ver">Ver: ${version}</span>
                    <span class="pill pill-size">Size: ${fileSize}</span>
                </div>
            </div>
            
            <div class="item-details">
                <p class="item-note">${item.note || 'æš‚æ— è¯¦ç»†å¤‡æ³¨ã€‚'}</p>
                <div class="action-buttons">
                    ${buttonsHtml}
                </div>
            </div>
        </div>
      `;
    }

    // 4. æ ¸å¿ƒæ¸²æŸ“å‡½æ•°
    function renderContent(query = '') {
      const contentArea = document.getElementById('contentArea');
      // ä½¿ç”¨ LX æ ‡ç­¾é¡µä½œä¸ºé»˜è®¤å±•ç¤ºï¼ˆå¯æ‰©å±•ä¸ºåˆ‡æ¢æ ‡ç­¾é¡µï¼‰
      const initialItems = appData.items.filter(item => (item.tab || 'LX') === 'LX');
      const filteredItems = filterAndSearchItems(initialItems, query);
      const groupedData = groupByQuality(filteredItems);
      
      let html = '';
      
      if (groupedData.length === 0) {
        html = `<p style="text-align: center; padding: 50px;">å½“å‰æ²¡æœ‰æ’ä»¶ç¬¦åˆæ¡ä»¶ã€‚</p>`;
      } else {
        groupedData.forEach(group => {
          html += `
            <div class="group-container">
              <div class="group-header">
                <h2>${group.name}</h2>
                <span class="group-count">${group.count}</span>
              </div>
              <div class="group-items">
                ${group.items.map(item => renderPluginItem(item)).join('')}
              </div>
            </div>
          `;
        });
      }
      
      contentArea.innerHTML = html;
    }

    // 5. äº¤äº’å®ç°ï¼šæŠ˜å /å±•å¼€
    function toggleDetails(element) {
        // é˜²æ­¢ç‚¹å‡»å†…éƒ¨æŒ‰é’®æ—¶è§¦å‘æŠ˜å 
        if (event.target.closest('.action-buttons')) {
            return;
        }
        element.classList.toggle('open');
        // ä¼˜åŒ–ï¼šç‚¹å‡»åå°†å…¶ä»–å·²å±•å¼€çš„æŠ˜å èµ·æ¥
        document.querySelectorAll('.plugin-item.open').forEach(item => {
            if (item !== element) {
                item.classList.remove('open');
            }
        });
    }

    // 6. æœç´¢ã€ä¸‹è½½å’Œ Key ç›¸å…³çš„å·¥å…·å‡½æ•°ï¼ˆä½¿ç”¨æ–‡æ¡£ä¸­çš„å®ç°ï¼‰
    
    function filterAndSearchItems(items, query) {
      if (!query) return items;
      const keywords = query.toLowerCase().split(' ').filter(k => k.length > 0);
      return items.filter(item => {
        const searchableText = [item.name, item.note, item.ver, item.quality].join(' ').toLowerCase();
        return keywords.every(keyword => searchableText.includes(keyword));
      });
    }
    
    function downloadFile(itemId) { /* ... implementation from doc ... */ }
    function importWithKeyOnline(itemId) { /* ... implementation from doc ... */ }
    function generateFileWithKey(itemId) { /* ... implementation from doc ... */ }
    function debounce(func, wait) { /* ... implementation from doc ... */ }
    
    // 7. æš—è‰²æ¨¡å¼ç®¡ç†å™¨ (ç®€åŒ–ç‰ˆ)
    class DarkModeManager {
      init() {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const savedMode = localStorage.getItem('darkMode');
        this.isDark = savedMode !== null ? savedMode === 'dark' : prefersDark;
        this.apply();
      }
      toggle() {
        this.isDark = !this.isDark;
        this.apply();
        localStorage.setItem('darkMode', this.isDark ? 'dark' : 'light');
      }
      apply() {
        document.documentElement.className = this.isDark ? 'dark' : 'light';
      }
    }
    window.darkModeManager = new DarkModeManager();

    // 8. å¯åŠ¨åº”ç”¨
    window.addEventListener('DOMContentLoaded', () => {
      initializeData();
      renderContent();
      
      document.getElementById('searchInput').addEventListener('input', debounce(function(e) {
        renderContent(e.target.value);
      }, 300));
      
      document.getElementById('loadingMessage').style.display = 'none';
    });
    
    // æŒ‚è½½åˆ°å…¨å±€ï¼Œä»¥ä¾¿ HTML ä¸­çš„ onclick è°ƒç”¨
    window.toggleDetails = toggleDetails;
    window.downloadFile = downloadFile;
    window.importWithKeyOnline = importWithKeyOnline;
    window.generateFileWithKey = generateFileWithKey;
    
  </script>
</body>
</html>