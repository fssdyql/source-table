<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{TITLE}} - æ—¶åºä¸­å¿ƒ</title>
  <style>
    /* === åŸºç¡€å˜é‡ä¸æš—è‰²æ¨¡å¼ === */
    :root {
      --primary-color: #f97316; /* é²œè‰³çš„æ©™è‰²ä½œä¸ºä¸»è‰² */
      --secondary-color: #9ca3af;
      --bg-color: #fefcfb;
      --text-color: #1f2937;
      --card-bg: #ffffff;
      --border-color: #e5e7eb;
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --spacing-md: 20px;
      --radius-full: 9999px;
    }
    .dark {
      --primary-color: #fb923c;
      --bg-color: #1a1a1a;
      --text-color: #e5e7eb;
      --card-bg: #292929;
      --border-color: #4b5563;
    }

    /* === åŸºç¡€å¸ƒå±€ === */
    body {
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.4s, color 0.4s;
      margin: 0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--spacing-md);
    }

    /* === å¤´éƒ¨ä¸æœç´¢ === */
    .app-header {
      text-align: center;
      padding: 10px 0 20px 0;
    }
    .search-bar {
      width: 100%;
      max-width: 400px;
      padding: 10px 15px;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-full);
      background: var(--card-bg);
      color: var(--text-color);
      margin-bottom: var(--spacing-md);
      transition: border-color 0.3s;
    }
    .search-bar:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    /* === æ ‡ç­¾é¡µï¼šä¸­å¿ƒè¾å°„å¼å¯¼èˆª (The Radial Hub) === */
    .radial-hub {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 40px;
    }
    .tab-btn {
      padding: 10px 20px;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text-color);
      border-radius: var(--radius-full);
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
    }
    .tab-btn:hover {
      border-color: var(--primary-color);
      box-shadow: 0 0 8px rgba(249, 115, 22, 0.3);
    }
    .tab-btn.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
      transform: scale(1.05);
      font-weight: 700;
    }

    /* === å†…å®¹åŒºï¼šå‚ç›´æ—¶é—´çº¿ (Vertical Timeline) === */
    .timeline-wrapper {
      position: relative;
      max-width: 800px; /* å±…ä¸­æ—¶é—´çº¿ */
      margin: 0 auto;
      padding: 0 10px; /* é˜²æ­¢å†…å®¹è´´è¾¹ */
    }

    /* æ—¶é—´çº¿ä¸»çº¿ */
    .timeline-wrapper::before {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      left: 50%; /* å±…ä¸­ */
      width: 2px;
      background-color: var(--border-color);
      margin-left: -1px;
    }

    /* æ—¶é—´çº¿åˆ†ç»„å¤´éƒ¨ */
    .timeline-group-header {
      text-align: center;
      margin-bottom: 20px;
      position: relative;
    }
    .timeline-group-header h2 {
      display: inline-block;
      padding: 8px 15px;
      background-color: var(--primary-color);
      color: white;
      border-radius: 4px;
      margin: 0;
      font-size: 18px;
      z-index: 10;
      position: relative;
    }

    /* æ’ä»¶èŠ‚ç‚¹ */
    .timeline-item {
      position: relative;
      width: 50%;
      padding: 10px 0;
      margin-bottom: 30px;
      cursor: pointer;
    }
    .timeline-item:nth-child(even) {
      left: 50%; /* å³ä¾§èŠ‚ç‚¹ */
      padding-left: 50px;
    }
    .timeline-item:nth-child(odd) {
      left: 0; /* å·¦ä¾§èŠ‚ç‚¹ */
      padding-right: 50px;
      text-align: right;
    }

    /* æ—¶é—´çº¿æ ‡è®°ç‚¹ */
    .timeline-item::before {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: var(--radius-full);
      background: var(--primary-color);
      border: 3px solid var(--bg-color);
      top: 25px;
      z-index: 10;
      transition: all 0.3s;
    }
    .timeline-item:nth-child(even)::before {
      left: -8px; /* è°ƒæ•´åˆ°çº¿ä¸Š */
    }
    .timeline-item:nth-child(odd)::before {
      right: -8px; /* è°ƒæ•´åˆ°çº¿ä¸Š */
    }
    .timeline-item.open::before {
      background: var(--card-bg);
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px var(--primary-color); /* å±•å¼€æ—¶çš„å…‰ç¯æ•ˆæœ */
    }

    /* æ’ä»¶å¡ç‰‡ */
    .item-content {
      background: var(--card-bg);
      padding: 15px;
      border-radius: 8px;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s;
    }
    .item-content h3 {
      margin: 0 0 5px 0;
      font-size: 16px;
      color: var(--primary-color);
      font-weight: 600;
    }
    .item-metadata {
      font-size: 12px;
      color: var(--secondary-color);
    }

    /* å±•å¼€çš„è¯¦æƒ… */
    .item-details {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease-out;
      padding-top: 0;
      border-top: 1px solid transparent;
      margin-top: 0;
    }
    .timeline-item.open .item-details {
      max-height: 300px;
      padding-top: 10px;
      border-top: 1px dashed var(--border-color);
      margin-top: 10px;
    }
    .item-note {
      font-size: 14px;
      margin-bottom: 10px;
    }
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .btn {
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s;
      font-size: 13px;
    }
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }
    .btn-secondary {
      background-color: var(--border-color);
      color: var(--text-color);
    }

    /* å“åº”å¼è°ƒæ•´ï¼šå•åˆ—æ—¶é—´çº¿ */
    @media (max-width: 768px) {
      .timeline-wrapper::before {
        left: 20px; /* å°†ä¸»çº¿ç§»åˆ°å·¦ä¾§ */
      }
      .timeline-item {
        width: 100%;
        left: 0 !important;
        padding: 10px 0 10px 50px !important; /* è°ƒæ•´æ‰€æœ‰èŠ‚ç‚¹åˆ°å³ä¾§ */
        text-align: left !important;
      }
      .timeline-item::before {
        left: 17px !important; /* è°ƒæ•´æ ‡è®°ç‚¹åˆ°ä¸»çº¿ä¸Š */
      }
      .timeline-group-header h2 {
        text-align: left;
        display: block;
        margin-left: 50px;
        padding-left: 0;
      }
    }
  </style>
</head>
<body class="light">
  <div class="container">
    <header class="app-header">
      <button class="btn btn-secondary" onclick="darkModeManager.toggle()" style="float: right; margin-top: 10px;">åˆ‡æ¢ä¸»é¢˜</button>
      <h1>{{TITLE}}</h1>
      <p class="meta-info">å¯¼å‡ºæ—¶é—´ï¼š{{DATE}}</p>
      <input type="search" id="searchInput" class="search-bar" placeholder="ğŸ” æœç´¢æ–‡ä»¶åã€éŸ³è´¨æˆ–å¤‡æ³¨...">
    </header>

    <nav class="radial-hub" id="tabNav">
      </nav>

    <main class="timeline-wrapper" id="contentArea">
      <p style="text-align: center;" id="loadingMessage">æ­£åœ¨åŠ è½½æ•°æ®...</p>
    </main>
  </div>

  <script>
    // === JavaScript æ ¸å¿ƒé€»è¾‘ ===

    let appData = { items: [], config: {}, customTabs: [] };
    let appState = { currentTab: 'LX' };

    // 1. æ•°æ®è§£æå’Œå·¥å…·å‡½æ•°
    function initializeData() {
      const dataString = '{{DATA}}';
      try {
        appData = JSON.parse(dataString);
      } catch (e) {
        console.error('æ•°æ®è§£æå¤±è´¥:', e);
        appData = { items: [], config: {}, customTabs: [] };
      }
    }

    function formatFileSize(bytes) {
      if (bytes === 0 || !bytes) return 'N/A';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // 2. åˆ†ç»„é€»è¾‘ï¼šæŒ‰ Quality åˆ†ç»„
    function groupByQuality(items) {
      const groups = {};
      items.forEach(item => {
        const groupKey = item.quality || 'ğŸ“ é€šç”¨æˆ–æœªæ ‡è®°';
        if (!groups[groupKey]) {
          groups[groupKey] = [];
        }
        groups[groupKey].push(item);
      });
      // å°†é”®è½¬æ¢ä¸ºæ•°ç»„å¹¶è¿›è¡Œæ’åº (ä¾‹å¦‚ï¼Œå°†åŒ…å« 'Lossless' æˆ– 'Flac' çš„ç»„æ’åœ¨å‰é¢)
      return Object.keys(groups)
        .sort((a, b) => {
          if (a.includes('Lossless') || a.includes('Flac')) return -1;
          if (b.includes('Lossless') || b.includes('Flac')) return 1;
          return a.localeCompare(b);
        })
        .map(key => ({
          name: key,
          items: groups[key]
        }));
    }
    
    // 3. æ¸²æŸ“æ ¸å¿ƒå‡½æ•°
    function getAvailableTabs() {
      const tabs = ['LX'];
      if (appData.config.showMF) tabs.push('Music Free');
      if (appData.config.showLY) tabs.push('æ¾œéŸ³');
      if (appData.customTabs && appData.customTabs.length) {
        tabs.push(...appData.customTabs);
      }
      return [...new Set(tabs)];
    }

    function renderTabs() {
      const tabNav = document.getElementById('tabNav');
      tabNav.innerHTML = '';
      const tabs = getAvailableTabs();
      if (!tabs.includes(appState.currentTab) && tabs.length > 0) {
        appState.currentTab = tabs[0];
      }
      tabs.forEach(tab => {
        const button = document.createElement('button');
        button.className = 'tab-btn' + (tab === appState.currentTab ? ' active' : '');
        button.textContent = tab;
        button.onclick = () => switchTab(tab);
        tabNav.appendChild(button);
      });
    }

    function switchTab(tabName) {
      appState.currentTab = tabName;
      document.getElementById('searchInput').value = '';
      renderTabs();
      renderContent();
    }
    
    function renderPluginItem(item) {
      const fileSize = formatFileSize(item.file?.size);
      const version = item.ver || 'N/A';
      const itemId = item.id;
      
      let buttonsHtml = '';
      // ä¸‹è½½æŒ‰é’®
      if (item.dlLink) {
        buttonsHtml += `<a href="${item.dlLink}" class="btn btn-primary" download="${item.name}">ç›´é“¾ä¸‹è½½</a>`;
      } else if (item.file) {
        buttonsHtml += `<button class="btn btn-primary" onclick="downloadFile(${itemId})">ä¸‹è½½æ–‡ä»¶ (${fileSize})</button>`;
      }
      
      // Key é…ç½®æŒ‰é’®
      if (item.tab === 'LX' && item.keyConfig && (item.keyConfig.enableUrl || item.keyConfig.enableVar)) {
        if (item.keyConfig.enableUrl) {
           buttonsHtml += `<button class="btn btn-secondary" onclick="importWithKeyOnline(${itemId})">åœ¨çº¿ Key</button>`;
        }
        if (item.keyConfig.enableVar) {
           buttonsHtml += `<button class="btn btn-secondary" onclick="generateFileWithKey(${itemId})">æœ¬åœ° Key æ›¿æ¢</button>`;
        }
      }
      // å¤–éƒ¨é“¾æ¥
      (item.links || []).forEach(link => {
        buttonsHtml += `<a href="${link.url}" target="_blank" class="btn btn-secondary">ğŸ”— ${link.text}</a>`;
      });
      
      return `
        <div class="timeline-item" onclick="toggleDetails(this)">
            <div class="item-content">
                <h3>${item.name}</h3>
                <div class="item-metadata">
                    ç‰ˆæœ¬: ${version} | å¤§å°: ${fileSize}
                </div>
            </div>
            
            <div class="item-details">
                <p class="item-note">${item.note || 'æš‚æ— è¯¦ç»†å¤‡æ³¨ä¿¡æ¯ã€‚'}</p>
                <div class="action-buttons">
                    ${buttonsHtml}
                </div>
            </div>
        </div>
      `;
    }

    function renderContent(query = '') {
      const contentArea = document.getElementById('contentArea');
      const allItemsInTab = appData.items.filter(item => (item.tab || 'LX') === appState.currentTab);
      const filteredItems = filterAndSearchItems(allItemsInTab, query);
      const groupedData = groupByQuality(filteredItems);
      
      let html = '';
      
      if (groupedData.length === 0) {
        html = `<p style="text-align: center; padding: 50px;">å½“å‰æ ‡ç­¾é¡µæˆ–æœç´¢ç»“æœä¸‹æ²¡æœ‰æ’ä»¶ã€‚</p>`;
      } else {
        groupedData.forEach(group => {
          html += `
            <div class="timeline-group-header">
              <h2>${group.name}</h2>
            </div>
            ${group.items.map(item => renderPluginItem(item)).join('')}
          `;
        });
      }
      
      contentArea.innerHTML = html;
    }
    
    // 4. äº¤äº’å®ç°ï¼šæŠ˜å /å±•å¼€
    function toggleDetails(element) {
        if (event.target.closest('.action-buttons')) {
            return;
        }
        element.classList.toggle('open');
        // ç¡®ä¿åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å±•å¼€çš„
        document.querySelectorAll('.timeline-item.open').forEach(item => {
            if (item !== element) {
                item.classList.remove('open');
            }
        });
    }

    // 5. æœç´¢ã€ä¸‹è½½å’Œ Key ç›¸å…³çš„å·¥å…·å‡½æ•° (æ²¿ç”¨æ–‡æ¡£ä¸­çš„å®ç°æ¡†æ¶)
    function filterAndSearchItems(items, query) {
      if (!query) return items;
      const keywords = query.toLowerCase().split(' ').filter(k => k.length > 0);
      return items.filter(item => {
        const searchableText = [item.name, item.note, item.ver, item.quality, item.tab].join(' ').toLowerCase();
        return keywords.every(keyword => searchableText.includes(keyword));
      });
    }
    
    function downloadFile(itemId) {
      const item = appData.items.find(x => x.id === itemId);
      if (!item || !item.file || !item.file.content) {
        alert('æ–‡ä»¶æ•°æ®ç¼ºå¤±ï¼Œæ— æ³•ä¸‹è½½ã€‚');
        return;
      }
      const a = document.createElement('a');
      a.href = item.file.content; 
      a.download = item.name;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
    
    function importWithKeyOnline(itemId) {
      const item = appData.items.find(x => x.id === itemId);
      if (!item?.keyConfig?.enableUrl) return;
      const key = prompt(`è¯·è¾“å…¥Keyä»¥å¯¼å…¥ ${item.name}:`, '');
      if (key && item.keyConfig.url) {
        // å®é™…åº”ç”¨ä¸­ï¼šwindow.open(item.keyConfig.url + encodeURIComponent(key), '_blank');
        alert(`å·²æ¨¡æ‹Ÿåœ¨çº¿ Key å¯¼å…¥ã€‚Key: ${key}`);
      }
    }
    function generateFileWithKey(itemId) {
      const item = appData.items.find(x => x.id === itemId);
      if (!item?.keyConfig?.enableVar) return;
      const key = prompt(`è¯·è¾“å…¥Keyï¼ˆå°†æ›¿æ¢å˜é‡ ${item.keyConfig.var}ï¼‰:`, '');
      if (key) {
        // å®é™…åº”ç”¨ä¸­ï¼šéœ€è¦è¿›è¡Œ Base64 è§£ç å’Œæ­£åˆ™æ›¿æ¢ï¼Œæ­¤å¤„ä»…åšå ä½å’Œæç¤º
        alert(`å·²è·å–Keyã€‚éœ€è¦ä½¿ç”¨ Base64 è§£ç å’Œæ­£åˆ™æ›¿æ¢æ’ä»¶å†…å®¹æ‰èƒ½ä¸‹è½½æ–°æ–‡ä»¶ã€‚`);
      }
    }
    
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => { clearTimeout(timeout); func(...args); };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // 6. æš—è‰²æ¨¡å¼ç®¡ç†å™¨
    class DarkModeManager {
      init() {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const savedMode = localStorage.getItem('darkMode');
        this.isDark = savedMode !== null ? savedMode === 'dark' : prefersDark;
        this.apply();
      }
      toggle() {
        this.isDark = !this.isDark;
        this.apply();
        localStorage.setItem('darkMode', this.isDark ? 'dark' : 'light');
      }
      apply() {
        document.documentElement.className = this.isDark ? 'dark' : 'light';
        document.body.className = this.isDark ? 'dark' : 'light';
      }
    }
    window.darkModeManager = new DarkModeManager();

    // 7. å¯åŠ¨åº”ç”¨
    window.addEventListener('DOMContentLoaded', () => {
      initializeData();
      renderTabs();
      renderContent();
      
      document.getElementById('searchInput').addEventListener('input', debounce(function(e) {
        renderContent(e.target.value);
      }, 300));
      
      document.getElementById('loadingMessage').style.display = 'none';
    });
    
    // æŒ‚è½½åˆ°å…¨å±€
    window.toggleDetails = toggleDetails;
    window.downloadFile = downloadFile;
    window.importWithKeyOnline = importWithKeyOnline;
    window.generateFileWithKey = generateFileWithKey;
    
  </script>
</body>
</html>