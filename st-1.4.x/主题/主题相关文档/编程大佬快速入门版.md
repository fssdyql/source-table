# 自定义主题技术指南

## 核心概念
主题 = HTML模板 + 变量替换。系统将数据注入模板生成最终页面。

## 模板变量
| 变量 | 类型 | 描述 |
|------|------|------|
| `{{DATA}}` | JSON字符串 | 完整数据对象，需解析 |
| `{{DATE}}` | String | 导出日期 `YYYY-MM-DD` |
| `{{TITLE}}` | String | 页面标题，默认"插件列表" |

## 数据结构
```javascript
const data = {{DATA}};  // 解析后结构:

{
  config: { showMF: boolean, showLY: boolean },
  customTabs: string[],
  items: [
    {
      id: number,           // 唯一ID
      tab: string,          // 'LX'|'Music Free'|'澜音'|自定义
      name: string,         // 文件名
      ver: string,          // 版本号
      quality: string,      // 音质标识
      note: string,         // 备注
      file: {               // 文件数据（可选）
        content: string,    // Base64 data:URL
        size: number
      },
      links: [              // 相关链接
        { text: string, url: string }
      ],
      dlLink: string,       // 直链地址
      keyConfig: {          // LX专用配置
        enableUrl: boolean,
        url: string,
        enableVar: boolean,
        var: string
      }
    }
  ]
}
```

## 基础用法

### 1. 数据解析
```javascript
// 安全解析数据
const appData = (() => {
  try {
    return typeof {{DATA}} === 'string' 
      ? JSON.parse({{DATA}}) 
      : {{DATA}};
  } catch(e) {
    return { items: [], config: {}, customTabs: [] };
  }
})();

// 获取当前标签页数据
function getCurrentItems(tab = 'LX') {
  return appData.items.filter(i => (i.tab || 'LX') === tab);
}
```

### 2. 文件下载
```javascript
function downloadFile(id) {
  const item = appData.items.find(x => x.id == id);
  if (!item?.file) return;
  
  const a = document.createElement('a');
  a.href = item.file.content;
  a.download = item.name;
  a.click();
}

// Base64解码
function decodeBase64(dataURI) {
  try {
    return atob(dataURI.split(',')[1]);
  } catch(e) {
    console.error('解码失败:', e);
    return '';
  }
}
```

### 3. Key处理（LX专用）
```javascript
// 在线Key导入
function importWithKeyOnline(itemId) {
  const item = appData.items.find(x => x.id == itemId);
  const key = prompt(`输入Key导入 ${item.name}:`, '');
  if (key && item.keyConfig.url) {
    window.open(item.keyConfig.url + encodeURIComponent(key), '_blank');
  }
}

// 本地Key替换生成文件
function generateWithKey(itemId) {
  const item = appData.items.find(x => x.id == itemId);
  const key = prompt(`输入Key（替换 ${item.keyConfig.var}）:`, '');
  if (!key) return;
  
  try {
    const raw = decodeBase64(item.file.content);
    const varName = item.keyConfig.var;
    const regex = new RegExp(`(const|var|let)\\s+${varName}\\s*=\\s*['"][^'"]*['"]`, 'g');
    
    if (!regex.test(raw)) throw new Error(`未找到变量: ${varName}`);
    
    const newContent = raw.replace(regex, `$1 ${varName} = "${key}"`);
    const blob = new Blob([newContent], { type: 'text/javascript' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = item.name;
    a.click();
    
    setTimeout(() => URL.revokeObjectURL(url), 100);
  } catch(e) {
    alert('生成失败: ' + e.message);
  }
}
```

## 高级技巧

### 1. 按音质分组
```javascript
const grouped = {};
appData.items.forEach(item => {
  const quality = item.quality || '未知';
  if (!grouped[quality]) grouped[quality] = [];
  grouped[quality].push(item);
});

// 渲染分组
function renderGrouped(groups) {
  return Object.entries(groups).map(([quality, items]) => `
    <div class="quality-group">
      <h3>${quality} (${items.length})</h3>
      ${items.map(renderItem).join('')}
    </div>
  `).join('');
}
```

### 2. 搜索功能
```javascript
class PluginSearch {
  constructor(items) {
    this.items = items;
    this.index = items.map(item => ({
      id: item.id,
      text: [item.name, item.note, item.quality, item.ver].join(' ').toLowerCase(),
      item
    }));
  }
  
  search(query) {
    const keywords = query.toLowerCase().split(' ').filter(k => k);
    if (!keywords.length) return this.items;
    
    return this.index
      .map(entry => ({
        item: entry.item,
        score: keywords.reduce((score, kw) => 
          score + (entry.text.includes(kw) ? 1 : 0), 0)
      }))
      .filter(r => r.score > 0)
      .sort((a, b) => b.score - a.score)
      .map(r => r.item);
  }
}
```

### 3. 暗色模式
```css
/* CSS变量方案 */
:root {
  --bg-color: #ffffff;
  --text-color: #334155;
  --card-bg: #f8fafc;
  --border-color: #e2e8f0;
}

.dark {
  --bg-color: #0f172a;
  --text-color: #f1f5f9;
  --card-bg: #1e293b;
  --border-color: #334155;
}

body {
  background: var(--bg-color);
  color: var(--text-color);
  transition: background 0.3s, color 0.3s;
}
```

```javascript
// 切换逻辑
function toggleDarkMode() {
  document.documentElement.classList.toggle('dark');
  localStorage.setItem('darkMode', 
    document.documentElement.classList.contains('dark') ? 'dark' : 'light'
  );
}

// 初始化
const savedMode = localStorage.getItem('darkMode');
const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
if (savedMode === 'dark' || (!savedMode && systemPrefersDark)) {
  document.documentElement.classList.add('dark');
}
```

### 4. 虚拟滚动（大量数据）
```javascript
class VirtualList {
  constructor(container, items, itemHeight = 60, renderItem) {
    this.container = container;
    this.items = items;
    this.itemHeight = itemHeight;
    this.renderItem = renderItem;
    this.visibleCount = Math.ceil(container.clientHeight / itemHeight);
    this.startIndex = 0;
    
    // 创建占位元素
    this.scroller = document.createElement('div');
    this.scroller.style.height = `${items.length * itemHeight}px`;
    this.container.appendChild(this.scroller);
    
    // 可视区域
    this.viewport = document.createElement('div');
    this.viewport.style.position = 'relative';
    this.container.appendChild(this.viewport);
    
    this.update();
    this.container.addEventListener('scroll', () => this.update());
  }
  
  update() {
    const scrollTop = this.container.scrollTop;
    this.startIndex = Math.floor(scrollTop / this.itemHeight);
    
    this.viewport.innerHTML = this.items
      .slice(this.startIndex, this.startIndex + this.visibleCount + 2)
      .map((item, i) => {
        const top = (this.startIndex + i) * this.itemHeight;
        return `
          <div style="position:absolute;top:${top}px;width:100%;">
            ${this.renderItem(item)}
          </div>
        `;
      })
      .join('');
  }
}
```

### 5. 性能优化
```javascript
// 防抖搜索
const debounce = (fn, delay) => {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => fn(...args), delay);
  };
};

// 图片懒加载
const lazyLoad = new IntersectionObserver(entries => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      const img = entry.target;
      img.src = img.dataset.src;
      lazyLoad.unobserve(img);
    }
  });
});

// 缓存DOM查询
const cache = new Map();
function getElement(id) {
  if (!cache.has(id)) {
    cache.set(id, document.getElementById(id));
  }
  return cache.get(id);
}
```

### 6. 响应式设计
```css
/* 移动端适配 */
@media (max-width: 768px) {
  .plugin-grid {
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  }
  
  .actions {
    flex-direction: column;
  }
}

/* 平板适配 */
@media (min-width: 769px) and (max-width: 1024px) {
  .plugin-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* 桌面适配 */
@media (min-width: 1025px) {
  .plugin-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}
```

### 7. 数据过滤与排序
```javascript
// 多功能过滤器
class PluginFilter {
  static filter(items, options = {}) {
    return items.filter(item => {
      if (options.tab && item.tab !== options.tab) return false;
      if (options.quality && item.quality !== options.quality) return false;
      if (options.hasFile && !item.file) return false;
      if (options.hasLinks && (!item.links || item.links.length === 0)) return false;
      if (options.minSize && item.file && item.file.size < options.minSize) return false;
      return true;
    });
  }
  
  static sort(items, key = 'name', order = 'asc') {
    return [...items].sort((a, b) => {
      const aVal = a[key] || '';
      const bVal = b[key] || '';
      const compare = aVal.localeCompare(bVal);
      return order === 'asc' ? compare : -compare;
    });
  }
}
```

## 模板示例

### 最小工作示例
```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>{{TITLE}}</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:sans-serif; padding:20px; }
    .item { border:1px solid #ddd; padding:15px; margin:10px 0; }
  </style>
</head>
<body>
  <h1>{{TITLE}}</h1>
  <div id="list"></div>
  
  <script>
    const data = {{DATA}};
    const items = data.items || [];
    
    document.getElementById('list').innerHTML = items.map(item => `
      <div class="item">
        <h3>${item.name}</h3>
        <p>${item.note || ''}</p>
        ${item.file ? `<button onclick="download(${item.id})">下载</button>` : ''}
      </div>
    `).join('');
    
    function download(id) {
      const item = items.find(x => x.id == id);
      if (!item?.file) return;
      const a = document.createElement('a');
      a.href = item.file.content;
      a.download = item.name;
      a.click();
    }
  </script>
</body>
</html>
```

## 注意事项

### 必须包含
1. `{{DATA}}` 变量的解析代码
2. 必要的错误处理
3. 文件下载逻辑（如需）

### 推荐实践
1. 使用CSS变量便于主题切换
2. 移动端优先设计
3. 添加加载状态指示
4. 实现基本的错误边界

### 避免问题
1. 不要直接修改内置主题（创建副本）
2. 测试不同标签页的兼容性
3. 确保导出的HTML无外部依赖
4. 验证外部导入HTML的安全性

### 调试技巧
```javascript
// 开发辅助
if (location.search.includes('debug')) {
  console.log('数据:', appData);
  window.dumpData = () => JSON.stringify(appData, null, 2);
}
```

## 快速参考

### 常用代码片段
```javascript
// 1. 获取带文件的项目
const itemsWithFile = appData.items.filter(i => i.file);

// 2. 获取LX标签页项目
const lxItems = appData.items.filter(i => (i.tab || 'LX') === 'LX');

// 3. 生成标签页列表
const tabs = ['LX', 
  ...(appData.config.showMF ? ['Music Free'] : []),
  ...(appData.config.showLY ? ['澜音'] : []),
  ...appData.customTabs
];

// 4. 格式化文件大小
function formatSize(bytes) {
  if (!bytes) return '0 B';
  const units = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(1024));
  return (bytes / Math.pow(1024, i)).toFixed(2) + ' ' + units[i];
}
```

### 性能关键点
- 避免在循环中操作DOM
- 使用事件委托处理点击事件
- 虚拟滚动处理大量数据
- 懒加载非关键资源

### 安全提醒
- 转义用户输入防止XSS
- 验证外部链接的协议（http/https）
- 使用`rel="noopener"`处理外部链接
- 避免使用`eval()`和`innerHTML`插入未经验证的内容

---

**核心原则**：保持HTML文件独立，确保所有功能在无网络环境下正常工作。