<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>{{TITLE}}</title>
<style>
    /* --- æ ¸å¿ƒå˜é‡ --- */
    :root {
        --bg-deep: #0a0a0a;
        --accent: #eeb92e;       /* ç¥ç€é‡‘ */
        --accent-glow: rgba(238, 185, 46, 0.4);
        --glass: rgba(20, 20, 20, 0.95);
        --border: rgba(255, 255, 255, 0.15);
        --text: #f1f1f1;
    }

    body {
        margin: 0; background: var(--bg-deep);
        background-image: radial-gradient(circle at center, #1b1b1b 0%, #000 100%);
        height: 100vh; overflow: hidden;
        font-family: "Courier New", sans-serif;
        color: var(--text); user-select: none;
        -webkit-tap-highlight-color: transparent;
    }

    /* --- UI å…ƒç´  --- */
    #header { 
        position: absolute; top: max(20px, env(safe-area-inset-top)); left: 20px; 
        z-index: 10; pointer-events: none; 
    }
    h1 { margin: 0; font-size: 1.2rem; letter-spacing: 2px; color: var(--accent); }
    .subtitle { font-size: 0.7rem; opacity: 0.5; margin-top: 4px; }

    #nav-dots { 
        position: absolute; bottom: max(30px, env(safe-area-inset-bottom)); 
        width: 100%; text-align: center; z-index: 10; 
    }
    .nav-dot { 
        display: inline-block; width: 8px; height: 8px; 
        background: rgba(255,255,255,0.2); border-radius: 50%; 
        margin: 0 8px; transition: 0.3s; cursor: pointer; position: relative;
    }
    .nav-dot::after { content: ''; position: absolute; inset: -10px; }
    .nav-dot.active { 
        background: var(--accent); transform: scale(1.3); 
        box-shadow: 0 0 10px var(--accent-glow); 
    }

    /* --- å®‡å®™è§†å£ --- */
    #universe {
        position: relative; width: 100vw; height: 100vh;
        overflow: hidden; perspective: 1000px;
    }

    #category-label {
        position: absolute; top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        font-size: 14vw; font-weight: 900;
        color: rgba(255,255,255,0.02); pointer-events: none;
        white-space: nowrap; letter-spacing: -2px;
        transition: opacity 0.5s;
    }

    /* --- ç»å¯¹ä¸­å¿ƒå®šä½ --- */
    #absolute-center {
        position: absolute; top: 50%; left: 50%;
        width: 0; height: 0; z-index: 1;
        transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.4s;
    }
    body.detail-open #absolute-center {
        transform: scale(0.8); opacity: 0.2; filter: blur(4px);
    }

    /* è½¨é“åœ†ç¯ (å°ºå¯¸å’Œå½¢çŠ¶ç”±JSåŠ¨æ€æ§åˆ¶) */
    .orbit-ring {
        position: absolute; top: 0; left: 0;
        border: 1px dashed rgba(238, 185, 46, 0.15);
        border-radius: 50%;
        transform: translate(-50%, -50%); 
        pointer-events: none;
        transition: width 0.6s ease, height 0.6s ease;
        /* é»˜è®¤æ—‹è½¬ï¼Œæ¤­åœ†æ—¶ä¼šè¢«JSæš‚åœ */
        animation: rotate-orbit 120s linear infinite;
    }
    /* æš‚åœåŠ¨ç”»çš„ç±» */
    .orbit-ring.paused {
        animation: none;
        border-style: solid; /* æ¤­åœ†æ—¶ç”¨å®çº¿æ›´å¥½çœ‹ï¼Œé¿å…è™šçº¿æ‹‰ä¼¸ */
        border-width: 1px;
        opacity: 0.3;
    }

    /* --- æ˜Ÿçƒæœ¬ä½“ --- */
    .planet {
        position: absolute; top: 0; left: 0;
        width: 44px; height: 44px; 
        margin-left: -22px; margin-top: -22px;
        display: flex; justify-content: center; align-items: center;
        cursor: pointer; z-index: 5;
        transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
    }
    
    .planet-core {
        width: 14px; height: 14px;
        background: var(--accent); border-radius: 50%;
        box-shadow: 0 0 15px var(--accent-glow);
        transition: 0.3s; position: relative; z-index: 2;
    }
    .planet:active .planet-core { transform: scale(1.3); background: #fff; }

    /* --- å«æ˜Ÿå¼•å¯¼ç³»ç»Ÿ --- */
    
    .planet-guide {
        position: absolute; top: 50%; left: 50%;
        width: 0; height: 0;
        pointer-events: none;
        transform: rotate(var(--arm-angle)); 
        z-index: 1;
    }

    .guide-line {
        position: absolute; top: 0; left: 0;
        height: 1px; background: var(--accent);
        width: 0; 
        transform-origin: left center;
        opacity: 0.6;
        transition: width 0.4s ease-out 0.2s;
    }
    
    .guide-text-wrapper {
        position: absolute; top: -11px; 
        left: var(--arm-len); 
        height: 22px; display: flex; align-items: center;
        transform-origin: center center;
        transform: rotate(var(--text-rotate)); 
        opacity: 0; 
        transition: opacity 0.3s ease-out 0.4s;
    }

    .planet-text {
        font-size: 12px; font-weight: bold; color: #fff;
        background: rgba(0,0,0,0.6); padding: 2px 6px;
        border-radius: 3px; white-space: nowrap;
        border: 1px solid rgba(238, 185, 46, 0.3);
        box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        letter-spacing: 0.5px; 
    }

    .planet.deployed .guide-line { width: var(--arm-len); }
    .planet.deployed .guide-text-wrapper { opacity: 1; }
    
    /* å‘å†…æ¨¡å¼å¾®è°ƒ */
    .planet.inward .planet-text { 
        background: rgba(0,0,0,0.85); 
        color: #ddd; font-size: 11px;
    }
    .planet.inward .guide-line { opacity: 0.4; }


    /* --- è¯¦æƒ…é¢æ¿ --- */
    #backdrop {
        position: absolute; inset: 0; z-index: 40;
        background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
        opacity: 0; pointer-events: none; transition: 0.4s;
    }
    body.detail-open #backdrop { opacity: 1; pointer-events: auto; }

    #core-panel {
        position: absolute; top: 50%; left: 50%;
        transform: translate(-50%, -45%) scale(0.95);
        width: 85%; max-width: 320px;
        background: var(--glass);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: 0 30px 60px rgba(0,0,0,0.9);
        z-index: 50; opacity: 0; pointer-events: none;
        display: flex; flex-direction: column;
        transition: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        overflow: hidden;
    }
    #core-panel.active { transform: translate(-50%, -50%) scale(1); opacity: 1; pointer-events: auto; }
    
    #core-panel::before {
        content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
        background: var(--accent);
    }

    .panel-head { padding: 25px 20px 10px; text-align: center; }
    #core-title { font-size: 1.3rem; font-weight: bold; color: var(--accent); margin-bottom: 5px; }
    #core-meta { font-size: 0.75rem; color: #888; }

    #core-actions { padding: 15px 20px 20px; display: flex; flex-direction: column; gap: 10px; max-height: 50vh; overflow-y: auto; }

    .btn {
        background: rgba(255,255,255,0.05); border: 1px solid var(--border);
        color: #ddd; padding: 12px; border-radius: 6px; font-size: 13px;
        cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
        transition: 0.2s;
    }
    .btn:active { transform: scale(0.97); background: rgba(255,255,255,0.1); }
    .btn.primary { background: rgba(238, 185, 46, 0.15); border-color: var(--accent); color: var(--accent); font-weight: bold; }
    
    .close-tag { text-align: center; padding: 15px; color: #666; font-size: 11px; cursor: pointer; border-top: 1px solid rgba(255,255,255,0.05); }

    @keyframes rotate-orbit { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
    .anim-up { opacity: 0; transform: translateY(10px); animation: fadeUp 0.3s forwards; }
    @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }

</style>
</head>
<body>

    <div id="header">
        <h1>{{TITLE}}</h1>
        <div class="subtitle">SYSTEM ONLINE</div>
    </div>

    <div id="universe">
        <div id="category-label">SYSTEM</div>
        
        <div id="absolute-center">
            <div id="ring" class="orbit-ring"></div>
            <div id="planets-container"></div>
        </div>
        
        <div id="backdrop" onclick="closeDetail()"></div>

        <div id="core-panel">
            <div class="panel-head anim-up">
                <div id="core-title">TITLE</div>
                <div id="core-meta">INFO</div>
            </div>
            <div id="core-actions"></div>
            <div class="close-tag anim-up" onclick="closeDetail()">TAP OUTSIDE TO CLOSE</div>
        </div>
    </div>

    <div id="nav-dots"></div>

<script>
    const RAW_DATA = '{{DATA}}';
    let data = { config: {}, customTabs: [], items: [] };

    try {
        if (RAW_DATA.trim().startsWith('{')) data = JSON.parse(RAW_DATA);
        else throw new Error("Mock");
    } catch(e) {
        data = {
            config: { showMF: true, showLY: true },
            customTabs: ['VIP'],
            items: [
                { id: 1, tab: 'LX', name: 'è¶…é•¿æ–‡å­—æº¢å‡ºæµ‹è¯•é¡¹A', file: { content: '#' } },
                { id: 2, tab: 'LX', name: 'æç®€', dlLink: '#' },
                { id: 3, tab: 'LX', name: 'æ ‡å‡†é¡¹', file: { content: '#' } },
                { id: 4, tab: 'LX', name: 'å³ä¾§æº¢å‡ºè¾¹ç•Œæµ‹è¯•é¡¹B', file: { content: '#' } },
                { id: 5, tab: 'LX', name: 'ç½‘æ˜“äº‘æ¨¡å—', file: { content: '#' } },
                { id: 6, tab: 'LX', name: 'é…·ç‹—æ¨¡å—', file: { content: '#' } },
                { id: 7, tab: 'LX', name: 'QQéŸ³ä¹æ¨¡å—', file: { content: '#' } },
                ...Array.from({length: 8}, (_, i) => ({ id: 10+i, tab: 'VIP', name: `Module_Alpha_${i}`, file: {content:'#'} }))
            ]
        };
    }

    const tabs = ['LX', ...(data.config?.showMF ? ['Music Free'] : []), ...(data.config?.showLY ? ['æ¾œéŸ³'] : []), ...(data.customTabs || [])];
    let currentTabIdx = 0;
    let isDetailOpen = false;

    function init() {
        renderDots();
        loadTab(0);
        setupGestures();
        window.addEventListener('resize', () => loadTab(currentTabIdx));
    }

    function renderDots() {
        document.getElementById('nav-dots').innerHTML = tabs.map((_, i) => 
            `<span class="nav-dot ${i===0?'active':''}" onclick="switchTab(${i})"></span>`
        ).join('');
    }

    function switchTab(idx) {
        if (isDetailOpen) closeDetail();
        if (idx < 0) idx = tabs.length - 1;
        if (idx >= tabs.length) idx = 0;
        currentTabIdx = idx;
        document.querySelectorAll('.nav-dot').forEach((d, i) => d.classList.toggle('active', i === idx));
        loadTab(idx);
    }

    function loadTab(idx) {
        const tabName = tabs[idx];
        const items = data.items.filter(i => (i.tab || 'LX') === tabName);
        const container = document.getElementById('planets-container');
        const ring = document.getElementById('ring');
        const label = document.getElementById('category-label');
        
        label.style.opacity = 0;
        setTimeout(() => { label.innerText = tabName; label.style.opacity = items.length ? 0.05 : 0.02; }, 300);

        container.innerHTML = '';

        if (items.length === 0) {
            ring.style.width = '0'; ring.style.height = '0';
            return;
        }

        // ==========================================
        // æ ¸å¿ƒå¸ƒå±€è®¡ç®— (Layout Engine)
        // ==========================================
        const w = window.innerWidth;
        const h = window.innerHeight;
        const minSide = Math.min(w, h);
        const centerX = w / 2;
        
        // åˆ¤æ–­æ˜¯å¦ä¸ºå®½å± (æ¨ªå‘çŸ©å½¢)
        const isLandscape = w > h * 1.2;

        // 1. å®šä¹‰ä¸¤ç§æ¨¡å¼çš„åŠå¾„
        // Outward (å°åœˆ): å±å¹•çŸ­è¾¹çš„ 24%
        const baseR_Out = minSide * 0.24; 
        const maxR_Out = minSide * 0.32;
        // Inward (å¤§åœˆ): å±å¹•çŸ­è¾¹çš„ 38% (é€‚å½“æ”¾å¤§ï¼Œä½†å—æ§)
        const baseR_In = minSide * 0.38;
        const maxR_In = minSide * 0.44;

        // åŠ¨æ€å¢é•¿ï¼šé¡¹ç›®è¶Šå¤šï¼Œåœˆè¶Šå¤§
        const growth = items.length > 6 ? (items.length - 6) * 4 : 0;
        
        const finalR_Out = Math.min(baseR_Out + growth, maxR_Out);
        const finalR_In = Math.min(baseR_In + growth, maxR_In);

        // 2. é¢„æ£€ï¼šå‡è®¾ä½¿ç”¨ Outward æ¨¡å¼ï¼Œæ˜¯å¦ä¼šæº¢å‡ºï¼Ÿ
        let globalInward = false;
        const step = 360 / items.length;
        // è¿çº¿é•¿(70) + æ–‡å­—å®½(100) + å®‰å…¨è·(20) = 190
        const safeExtension = 190; 
        
        // æ¤­åœ†å‹ç¼©ç³»æ•° (ä»…åœ¨ Outward + æ¨ªå±æ—¶å¯ç”¨)
        // 0.8 è¡¨ç¤ºä¸Šä¸‹é«˜åº¦å‹ç¼©ä¸º 80%ï¼Œè®©ä¸Šä¸‹æ–‡å­—å‘å†…é æ‹¢
        const squashY = isLandscape ? 0.8 : 1.0; 

        // æ¨¡æ‹Ÿè®¡ç®—å¾ªç¯
        for(let i=0; i<items.length; i++) {
            const angleRad = (i * step - 90) * (Math.PI / 180);
            
            // æ¨¡æ‹Ÿ Outward æ¨¡å¼ä¸‹çš„ X åæ ‡
            // æ¤­åœ†å…¬å¼: x = a*cos, y = b*sin (è¿™é‡Œåªå…³å¿ƒxæ˜¯å¦æº¢å‡º)
            const pX = Math.cos(angleRad) * finalR_Out;
            const tipX = centerX + pX + (Math.cos(angleRad) * safeExtension);
            
            if (tipX < 20 || tipX > w - 20) {
                globalInward = true;
                break; 
            }
        }

        // ==========================================
        // ç¡®å®šæœ€ç»ˆå‚æ•°
        // ==========================================
        let renderR_X, renderR_Y, isOval;
        
        if (!globalInward) {
            // [Outward æ¨¡å¼]
            renderR_X = finalR_Out;
            renderR_Y = finalR_Out * squashY; // åº”ç”¨æ¤­åœ†å‹ç¼©
            isOval = squashY < 0.95; // æ ‡è®°æ˜¯å¦ä¸ºæ˜¾è‘—æ¤­åœ†
        } else {
            // [Inward æ¨¡å¼]
            renderR_X = finalR_In;
            renderR_Y = finalR_In; // Inward ä¿æŒæ­£åœ†ï¼Œä¿è¯èºæ—‹ç¾æ„Ÿ
            isOval = false;
        }

        // åº”ç”¨åœ†ç¯æ ·å¼
        ring.style.width = (renderR_X * 2) + 'px';
        ring.style.height = (renderR_Y * 2) + 'px';
        
        // å¦‚æœæ˜¯æ¤­åœ†ï¼Œåœæ­¢æ—‹è½¬åŠ¨ç”»ï¼Œå¦åˆ™çœ‹èµ·æ¥åƒé¸¡è›‹åœ¨æ™ƒ
        if (isOval) ring.classList.add('paused');
        else ring.classList.remove('paused');


        // ==========================================
        // æ¸²æŸ“å¾ªç¯
        // ==========================================
        items.forEach((item, i) => {
            const angleDeg = (i * step - 90);
            const angleRad = angleDeg * (Math.PI / 180);
            
            // è®¡ç®—æ˜Ÿçƒä½ç½® (æ”¯æŒæ¤­åœ†)
            const pX = Math.cos(angleRad) * renderR_X;
            const pY = Math.sin(angleRad) * renderR_Y;

            let armLength, armRotate, textRotate;

            if (!globalInward) {
                // --- å‘å¤–æ¨¡å¼ ---
                armLength = (i % 2 === 0) ? 40 : 70; 
                armRotate = angleDeg; 
                textRotate = -angleDeg; 
            } else {
                // --- å‘å†…æ¨¡å¼ ---
                armRotate = angleDeg + 180;
                // ä¸‰é˜¶èºæ—‹ (40, 80, 120)
                armLength = 40 + (i % 3) * 40;

                // æ™ºèƒ½æ–‡å­—æœå‘ä¿®æ­£
                let normalizedArmAngle = (armRotate % 360 + 360) % 360;
                // å·¦åŠçƒ (90~270åº¦) ç¿»è½¬æ–‡å­—
                const isPointingLeft = normalizedArmAngle > 90 && normalizedArmAngle < 270;
                textRotate = isPointingLeft ? 180 : 0;
            }

            const el = document.createElement('div');
            el.className = `planet ${globalInward ? 'inward' : ''}`;
            
            el.style.setProperty('--arm-angle', `${armRotate}deg`);
            el.style.setProperty('--arm-len', `${armLength}px`);
            el.style.setProperty('--text-rotate', `${textRotate}deg`);
            
            el.innerHTML = `
                <div class="planet-core"></div>
                <div class="planet-guide">
                    <div class="guide-line"></div>
                    <div class="guide-text-wrapper">
                        <span class="planet-text">${item.name}</span>
                    </div>
                </div>
            `;
            
            el.style.transform = `translate(0px, 0px) scale(0)`;
            el.onclick = (e) => { e.stopPropagation(); openDetail(item); };
            
            container.appendChild(el);

            setTimeout(() => {
                el.style.transform = `translate(${pX}px, ${pY}px) scale(1)`;
                setTimeout(() => el.classList.add('deployed'), 250);
            }, 50 + i * 20);
        });
    }

    // ================= è¯¦æƒ…é¢æ¿ (ä¿æŒä¸å˜) =================
    function openDetail(item) {
        if (isDetailOpen) return;
        isDetailOpen = true;
        document.body.classList.add('detail-open');

        document.getElementById('core-title').innerText = item.name;
        let meta = `ID:${item.id}`;
        if (item.file) meta += ` | ${(item.file.size/1024).toFixed(1)}KB`;
        document.getElementById('core-meta').innerText = meta;
        
        const box = document.getElementById('core-actions');
        let html = '';
        let d = 0;

        const add = (cls, js, ico, txt) => {
            d += 0.05;
            html += `<button class="btn ${cls} anim-up" style="animation-delay:${d}s" onclick="${js}">
                <span>${ico}</span><span>${txt}</span>
            </button>`;
        };

        if (item.file) add('primary', `act(${item.id}, 'base64')`, 'ğŸ“¥', 'å®‰è£…æ–‡ä»¶');
        if (item.dlLink) add('', `act(${item.id}, 'link')`, 'ğŸ”—', 'ç›´é“¾ä¸‹è½½');
        if (item.links) item.links.forEach(l => add('', `window.open('${l.url.replace(/'/g,"\\'")}')`, 'ğŸŒ', l.text||'é“¾æ¥'));
        if (item.keyConfig?.enableUrl) add('', `act(${item.id}, 'url')`, 'ğŸ”‘', 'Keyå¯¼å…¥');
        if (item.keyConfig?.enableVar && item.file) add('', `act(${item.id}, 'var')`, 'ğŸ› ï¸', 'å˜é‡æ›¿æ¢');

        box.innerHTML = html || '<div style="padding:20px;text-align:center;color:#666">ä»…å±•ç¤º</div>';
        document.getElementById('core-panel').classList.add('active');
    }

    function closeDetail() {
        isDetailOpen = false;
        document.body.classList.remove('detail-open');
        document.getElementById('core-panel').classList.remove('active');
    }

    window.act = (id, type) => {
        const item = data.items.find(x => x.id == id);
        if(!item) return;

        if (type === 'base64') dl(item.file.content, item.name);
        else if (type === 'link') window.open(item.dlLink, '_blank');
        else if (type === 'url') {
            const k = prompt('è¯·è¾“å…¥ Key:'); if(k) window.open(item.keyConfig.url + k, '_blank');
        } 
        else if (type === 'var') {
            const k = prompt(`æ›¿æ¢ ${item.keyConfig.var}:`);
            if(k) {
                try {
                    const raw = decodeURIComponent(escape(atob(item.file.content.split(',')[1] || item.file.content)));
                    const reg = new RegExp(`(const|var|let)\\s+${item.keyConfig.var}\\s*=\\s*['"][^'"]*['"]`);
                    if(!reg.test(raw)) return alert('å˜é‡æœªæ‰¾åˆ°');
                    const patch = raw.replace(reg, `$1 ${item.keyConfig.var}="${k}"`);
                    const url = URL.createObjectURL(new Blob([patch], {type:'text/javascript'}));
                    dl(url, item.name);
                } catch(e) { alert('é”™è¯¯:' + e.message); }
            }
        }
    };

    function dl(u, n) {
        const a = document.createElement('a'); a.href = u; a.download = n;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    function setupGestures() {
        let sx = 0, isD = false;
        document.addEventListener('touchstart', e => { if(!isDetailOpen){ isD=true; sx=e.touches[0].pageX; } }, {passive:true});
        document.addEventListener('touchend', e => {
            if(!isD) return; isD=false;
            if(Math.abs(e.changedTouches[0].pageX - sx) > 50) switchTab(e.changedTouches[0].pageX - sx > 0 ? currentTabIdx-1 : currentTabIdx+1);
        });
        document.addEventListener('mousedown', e => { if(!isDetailOpen){ isD=true; sx=e.pageX; } });
        document.addEventListener('mouseup', e => {
            if(!isD) return; isD=false;
            if(Math.abs(e.pageX - sx) > 50) switchTab(e.pageX - sx > 0 ? currentTabIdx-1 : currentTabIdx+1);
        });
    }

    init();
</script>
</body>
</html>