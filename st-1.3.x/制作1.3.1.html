<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æ’ä»¶åˆ—è¡¨ç®¡ç†å™¨ v1.3.1</title>
  <style>
    /* æ ¸å¿ƒåŸºç¡€æ ·å¼ */
    :root { --primary: #1890ff; --success: #52c41a; --danger: #ff4d4f; --warning: #faad14; --info: #13c2c2; --bg: #f0f2f5; --border: #d9d9d9; }
    * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", sans-serif; background: var(--bg); color: #333; padding: 20px; font-size: 14px; }
    
    .container { max-width: 1500px; margin: 0 auto; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    
    /* å¤´éƒ¨ */
    .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid var(--border); margin-bottom: 15px; }
    .header h1 { font-size: 20px; color: #262626; font-weight: 600; display: flex; align-items: center; gap: 10px; }
    .header .ver { font-size: 12px; background: #e6f7ff; color: var(--primary); padding: 2px 8px; border-radius: 10px; border: 1px solid #91d5ff; }
    .meta { font-size: 12px; color: #888; }

    /* æ ‡ç­¾é¡µç³»ç»Ÿ */
    .tabs-bar { display: flex; gap: 4px; border-bottom: 2px solid var(--border); margin-bottom: 15px; align-items: flex-end; }
    .tab-btn { padding: 8px 24px; background: #fafafa; border: 1px solid transparent; border-bottom: none; border-radius: 6px 6px 0 0; cursor: pointer; color: #666; font-weight: 500; transition: all 0.2s; position: relative; top: 2px; }
    .tab-btn:hover { color: var(--primary); background: #fff; }
    .tab-btn.active { background: white; color: var(--primary); border-color: var(--border); border-bottom-color: white; font-weight: bold; z-index: 1; }
    .tab-btn .del-tab { margin-left: 8px; font-size: 12px; color: #ccc; border-radius: 50%; padding: 0 4px; }
    .tab-btn .del-tab:hover { background: var(--danger); color: white; }
    
    .tab-manage-btn { margin-left: 5px; padding: 6px 10px; background: transparent; border: none; cursor: pointer; color: #888; font-size: 18px; display: flex; align-items: center; border-radius: 4px; transition: 0.2s; }
    .tab-manage-btn:hover { background: #e6f7ff; color: var(--primary); }

    /* å·¥å…·æ  - å¸ƒå±€è°ƒæ•´ */
    .toolbar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; background: #fff; padding: 4px 0; }
    .spacer { flex: 1; }
    .search-input { padding: 6px 12px; border: 1px solid var(--border); border-radius: 4px; width: 220px; transition: 0.2s; }
    .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(24,144,255,0.2); }

    /* æŒ‰é’®æ ·å¼ä½“ç³» */
    .btn { padding: 6px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 13px; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s; user-select: none; }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    
    .btn-primary { background: var(--primary); }
    .btn-success { background: var(--success); }
    .btn-danger { background: var(--danger); }
    .btn-warning { background: var(--warning); color: #fff; }
    .btn-info { background: var(--info); }
    .btn-gray { background: #8c8c8c; }
    
    /* è¡¨æ ¼æ ·å¼ */
    .table-container { border: 1px solid var(--border); border-radius: 6px; overflow: hidden; }
    table { width: 100%; border-collapse: collapse; background: white; }
    th { background: #fafafa; padding: 12px; text-align: left; font-weight: 600; color: #595959; border-bottom: 1px solid var(--border); white-space: nowrap; }
    td { padding: 10px 12px; border-bottom: 1px solid #f0f0f0; vertical-align: top; }
    tr:hover { background: #fbfbfb; }

    /* è¾“å…¥æ§ä»¶ */
    input[type="text"], select { width: 100%; padding: 5px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; transition: 0.2s; }
    input[type="text"]:focus, select:focus { border-color: var(--primary); }
    input[type="text"].input-sm { padding: 2px 6px; font-size: 12px; height: 24px; }
    
    /* çŠ¶æ€æ ‡ç­¾ */
    .tag-container { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
    .tag { font-size: 12px; padding: 2px 8px; border-radius: 4px; background: #f0f2f5; color: #666; border: 1px solid #d9d9d9; display: inline-flex; align-items: center; gap: 4px; }
    .tag-link { background: #e6f7ff; color: #1890ff; border-color: #91d5ff; }
    .tag-dl { background: #f6ffed; color: #52c41a; border-color: #b7eb8f; }
    .tag-key { background: #fff7e6; color: #fa8c16; border-color: #ffd591; }
    .tag-close { cursor: pointer; opacity: 0.6; font-weight: bold; margin-left: 2px; }
    .tag-close:hover { opacity: 1; color: var(--danger); }

    .status-badge { font-size: 12px; padding: 2px 6px; border-radius: 3px; display: inline-block; }
    .status-ok { color: var(--success); background: #f6ffed; border: 1px solid #b7eb8f; }
    .status-no { color: var(--danger); background: #fff1f0; border: 1px solid #ffa39e; }

    /* æŒ‰é’®ç»„ */
    .btn-group { display: flex; gap: 4px; flex-wrap: wrap; }
    .btn-xs { padding: 2px 8px; font-size: 12px; border-radius: 3px; border: none; cursor: pointer; color: white; }
    
    /* å¼¹çª—é€šç”¨ */
    .modal-mask { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1000; backdrop-filter: blur(2px); }
    .modal { background: white; width: 450px; margin: 10% auto; padding: 25px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); animation: popIn 0.2s; }
    @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .modal-header { font-size: 16px; font-weight: bold; margin-bottom: 20px; display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .form-item { margin-bottom: 15px; }
    .form-item label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 13px; color: #555; }
    .modal-footer { text-align: right; margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
    
    /* å¤é€‰æ¡†æ ·å¼ */
    .checkbox-label { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px; border-radius: 4px; transition: 0.2s; }
    .checkbox-label:hover { background: #f5f5f5; }
    .checkbox-label input { width: 16px; height: 16px; accent-color: var(--primary); }

    /* æç¤ºä¿¡æ¯ */
    .empty-tip { text-align: center; padding: 40px; color: #999; font-style: italic; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>æ’ä»¶åˆ—è¡¨ç®¡ç†å™¨ <span class="ver">v1.3.1</span></h1>
    <div class="meta">æœ€åä¿®æ”¹: <span id="updateTime">-</span></div>
  </div>

  <!-- æ ‡ç­¾é¡µ -->
  <div class="tabs-bar" id="tabsBar">
    <!-- åŠ¨æ€æ¸²æŸ“ -->
  </div>

  <!-- å·¥å…·æ ï¼šé‡æ–°å¸ƒå±€ -->
  <div class="toolbar">
    <button class="btn btn-success" onclick="addNewRow()">â• æ·»åŠ æ–‡ä»¶</button>
    <button class="btn btn-primary" onclick="exportData('json')">ğŸ’¾ å¤‡ä»½æ•°æ®</button>
    <button class="btn btn-info" onclick="exportData('html')">ğŸ“¤ å¯¼å‡ºåˆ—è¡¨</button>
    
    <div class="spacer"></div>
    
    <input type="file" id="importInput" style="display:none" onchange="importData(this)">
    <button class="btn btn-gray" onclick="document.getElementById('importInput').click()">ğŸ“‚ å¯¼å…¥æ—§ç‰ˆ/å¤‡ä»½</button>
    <button class="btn btn-danger" onclick="clearCurrentTab()">ğŸ—‘ï¸ æ¸…ç©ºå½“å‰é¡µ</button>
    
    <input type="text" class="search-input" placeholder="ğŸ” æœç´¢æ–‡ä»¶å..." id="searchInput" onkeyup="renderTable()">
  </div>

  <!-- è¡¨æ ¼ -->
  <div class="table-container">
    <table id="mainTable">
      <thead>
        <tr>
          <th width="50">æ’åº</th>
          <th width="280">æ–‡ä»¶å & çŠ¶æ€</th>
          <th width="160">éŸ³è´¨ & ç‰ˆæœ¬</th>
          <th width="350">å¤‡æ³¨ & é…ç½®</th>
          <th width="200">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<!-- å¼¹çª—ï¼šæ ‡ç­¾é¡µç®¡ç† (é€‰é¡¹å¼) -->
<div id="tabModal" class="modal-mask">
  <div class="modal">
    <div class="modal-header">æ ‡ç­¾é¡µæ˜¾ç¤ºè®¾ç½® <span style="cursor:pointer" onclick="closeModal('tabModal')">Ã—</span></div>
    
    <div class="form-item">
        <label>å†…ç½®æ ‡ç­¾é¡µ (å‹¾é€‰æ˜¾ç¤º):</label>
        <label class="checkbox-label">
            <input type="checkbox" id="chkMusicFree" onchange="toggleBuiltInTab('Music Free')"> 
            Music Free
        </label>
        <label class="checkbox-label">
            <input type="checkbox" id="chkLanyin" onchange="toggleBuiltInTab('æ¾œéŸ³')"> 
            æ¾œéŸ³
        </label>
    </div>

    <hr style="border:0; border-top:1px dashed #eee; margin:15px 0;">

    <div class="form-item">
        <label>æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾é¡µ:</label>
        <div style="display:flex; gap:10px;">
            <input type="text" id="newTabName" placeholder="è¾“å…¥åç§°...">
            <button class="btn btn-primary" onclick="addCustomTab()">æ·»åŠ </button>
        </div>
        <div style="margin-top:10px; font-size:12px; color:#999;">
            è‡ªå®šä¹‰æ ‡ç­¾é¡µå¯åœ¨ä¸Šæ–¹æ ‡ç­¾æ ç›´æ¥åˆ é™¤ã€‚<br>
            æ³¨æ„ï¼šéšè—æ ‡ç­¾é¡µä¸ä¼šåˆ é™¤å…¶ä¸­çš„æ•°æ®ã€‚
        </div>
    </div>
  </div>
</div>

<!-- å¼¹çª—ï¼šKeyé…ç½® -->
<div id="keyModal" class="modal-mask">
  <div class="modal">
    <div class="modal-header">Key é…ç½® <span style="cursor:pointer" onclick="closeModal('keyModal')">Ã—</span></div>
    
    <div class="form-item">
        <label>ğŸ”‘ åœ¨çº¿ Key (URL æ‹¼æ¥):</label>
        <input type="text" id="keyUrl" placeholder="https://api.xxx.com?key=">
        <div style="margin-top:5px">
            <label class="checkbox-label"><input type="checkbox" id="enableKeyUrl"> å¯ç”¨åœ¨çº¿å¯¼å…¥</label>
        </div>
    </div>
    
    <div class="form-item" style="margin-top:15px; border-top:1px dashed #eee; padding-top:15px;">
        <label>ğŸ“‚ æœ¬åœ° Key (å˜é‡æ›¿æ¢):</label>
        <input type="text" id="keyVar" placeholder="å˜é‡å, å¦‚: API_KEY">
        <div style="margin-top:5px">
            <label class="checkbox-label"><input type="checkbox" id="enableKeyVar"> å¯ç”¨æœ¬åœ°å¯¼å…¥</label>
        </div>
    </div>

    <div class="modal-footer">
        <button class="btn btn-primary" onclick="saveKeyConfig()">ä¿å­˜é…ç½®</button>
    </div>
  </div>
</div>

<!-- å¼¹çª—ï¼šæ™®é€šé“¾æ¥ -->
<div id="linkModal" class="modal-mask">
  <div class="modal">
    <div class="modal-header">æ·»åŠ é“¾æ¥ <span style="cursor:pointer" onclick="closeModal('linkModal')">Ã—</span></div>
    <div class="form-item"><label>æ˜¾ç¤ºæ–‡å­—:</label><input type="text" id="linkText" placeholder="å®˜ç½‘ / è¯´æ˜"></div>
    <div class="form-item"><label>è·³è½¬åœ°å€:</label><input type="text" id="linkUrl" placeholder="https://..."></div>
    <div class="modal-footer"><button class="btn btn-primary" onclick="saveLink()">ç¡®å®šæ·»åŠ </button></div>
  </div>
</div>

<!-- å¼¹çª—ï¼šç›´é“¾ä¸‹è½½ -->
<div id="dlLinkModal" class="modal-mask">
  <div class="modal">
    <div class="modal-header">é…ç½®ç›´é“¾ä¸‹è½½ <span style="cursor:pointer" onclick="closeModal('dlLinkModal')">Ã—</span></div>
    <div class="form-item">
        <label>ç›´é“¾ URL:</label>
        <input type="text" id="dlLinkUrl" placeholder="https://...">
        <div style="color:#999; font-size:12px; margin-top:5px">
            è®¾ç½®åï¼Œå¯¼å‡ºåˆ—è¡¨ä¸­å°†æ˜¾ç¤ºâ€œç›´é“¾â€æŒ‰é’®ã€‚
        </div>
    </div>
    <div class="modal-footer"><button class="btn btn-primary" onclick="saveDlLink()">ä¿å­˜</button></div>
  </div>
</div>

<script>
// --- å…¨å±€æ•°æ®ç»“æ„ ---
let app = {
    // é…ç½®é¡¹ï¼šæ§åˆ¶å†…ç½®æ ‡ç­¾é¡µçš„æ˜¾ç¤º/éšè—
    config: {
        showMusicFree: false,
        showLanyin: false
    },
    // è‡ªå®šä¹‰æ ‡ç­¾é¡µåˆ—è¡¨
    customTabs: [],
    // å½“å‰é€‰ä¸­çš„æ ‡ç­¾é¡µ
    currentTab: 'LX',
    // æ‰€æœ‰æ–‡ä»¶æ•°æ®
    files: []
};

// é¢„è®¾éŸ³è´¨
const QUALITY_PRESETS = ['128k', '320k', 'flac', 'flac24bit', 'master', 'dolby', 'sky'];
let currentEditId = null;

// --- åˆå§‹åŒ– ---
window.onload = function() {
    loadData();
    renderTabs();
    renderTable();
};

function loadData() {
    const raw = localStorage.getItem('plugin_mgr_v1_3_1');
    if (raw) {
        try {
            const data = JSON.parse(raw);
            
            // å…¼å®¹æ€§æ ¸å¿ƒï¼šæ£€æµ‹æ˜¯å¦ä¸ºæ—§ç‰ˆæ•°æ®
            if (Array.isArray(data)) {
                // å¦‚æœæ˜¯æ•°ç»„ï¼Œè¯´æ˜æ˜¯ v1.1.5 æˆ–æ›´æ—©ç‰ˆæœ¬
                console.log("æ£€æµ‹åˆ°æ—§ç‰ˆæ•°æ®ï¼Œæ­£åœ¨è¿ç§»...");
                app.files = data.map(f => ({
                    ...f,
                    tab: 'LX', // æ—§ç‰ˆæ•°æ®å…¨éƒ¨å½’å…¥ LX
                    links: f.links || [],
                    // è¿ç§»æ—§ç‰ˆå­—æ®µåˆ°æ–°ç‰ˆç»“æ„
                    keyUrl: f.keyUrl || '',
                    enableKeyUrl: (f.keyMode === 'link'),
                    keyVariable: f.keyVariable || '',
                    enableKeyVar: (f.keyMode === 'local'),
                    dlLink: f.directUrl || ''
                }));
                app.tabs = []; // æ—§ç‰ˆæ²¡æœ‰è‡ªå®šä¹‰Tabs
                app.currentTab = 'LX';
            } else {
                // æ–°ç‰ˆç»“æ„
                app = data;
                // é˜²æ­¢ undefined
                if(!app.config) app.config = { showMusicFree: false, showLanyin: false };
                if(!app.customTabs) app.customTabs = [];
                if(!app.files) app.files = [];
            }
        } catch(e) {
            console.error("æ•°æ®åŠ è½½å¤±è´¥:", e);
        }
    }
    updateTime();
}

function saveData() {
    // æ€§èƒ½ä¼˜åŒ–ï¼šä¸éœ€è¦æ¯æ¬¡æŒ‰é”®éƒ½ä¿å­˜ï¼Œåªæœ‰å…³é”®æ“ä½œä¿å­˜
    localStorage.setItem('plugin_mgr_v1_3_1', JSON.stringify(app));
    updateTime();
}

function updateTime() {
    document.getElementById('updateTime').innerText = new Date().toLocaleString('zh-CN', {hour12: false});
}

// --- æ ‡ç­¾é¡µé€»è¾‘ (é€‰é¡¹å¼ç®¡ç†) ---
function getActiveTabs() {
    let tabs = ['LX'];
    if (app.config.showMusicFree) tabs.push('Music Free');
    if (app.config.showLanyin) tabs.push('æ¾œéŸ³');
    return tabs.concat(app.customTabs);
}

function renderTabs() {
    const container = document.getElementById('tabsBar');
    const tabs = getActiveTabs();
    
    // ç¡®ä¿ currentTab åˆæ³•
    if (!tabs.includes(app.currentTab)) app.currentTab = 'LX';

    let html = tabs.map(tab => {
        const isActive = tab === app.currentTab;
        // åªæœ‰è‡ªå®šä¹‰æ ‡ç­¾é¡µæ‰æ˜¾ç¤ºåˆ é™¤æŒ‰é’® (LX å’Œ å†…ç½®å‹¾é€‰çš„ä¸åœ¨æ­¤ç›´æ¥åˆ é™¤)
        const isCustom = app.customTabs.includes(tab);
        const delBtn = isCustom ? `<span class="del-tab" onclick="deleteCustomTab('${tab}', event)">Ã—</span>` : '';
        
        return `<button class="tab-btn ${isActive ? 'active' : ''}" onclick="switchTab('${tab}')">
            ${tab} ${delBtn}
        </button>`;
    }).join('');

    // æ·»åŠ ç®¡ç†æŒ‰é’®
    html += `<button class="tab-manage-btn" onclick="openTabModal()" title="æ ‡ç­¾é¡µç®¡ç†">âš™ï¸</button>`;
    container.innerHTML = html;
}

function switchTab(tab) {
    app.currentTab = tab;
    renderTabs();
    renderTable();
}

// æ ‡ç­¾é¡µç®¡ç†å¼¹çª—é€»è¾‘
function openTabModal() {
    document.getElementById('chkMusicFree').checked = app.config.showMusicFree;
    document.getElementById('chkLanyin').checked = app.config.showLanyin;
    document.getElementById('newTabName').value = '';
    openModal('tabModal');
}

function toggleBuiltInTab(name) {
    if (name === 'Music Free') app.config.showMusicFree = document.getElementById('chkMusicFree').checked;
    if (name === 'æ¾œéŸ³') app.config.showLanyin = document.getElementById('chkLanyin').checked;
    saveData();
    renderTabs();
}

function addCustomTab() {
    const name = document.getElementById('newTabName').value.trim();
    if (!name) return;
    if (getActiveTabs().includes(name)) {
        alert('æ ‡ç­¾é¡µå·²å­˜åœ¨');
        return;
    }
    app.customTabs.push(name);
    app.currentTab = name; // è‡ªåŠ¨åˆ‡æ¢
    saveData();
    renderTabs();
    renderTable();
    closeModal('tabModal');
}

function deleteCustomTab(name, e) {
    e.stopPropagation(); // é˜²æ­¢è§¦å‘ switchTab
    if (confirm(`ç¡®å®šåˆ é™¤æ ‡ç­¾é¡µ "${name}" å—ï¼Ÿ\næ³¨æ„ï¼šè¯¥æ ‡ç­¾é¡µä¸‹çš„æ–‡ä»¶æ•°æ®å°†ä¿ç•™ï¼Œä½†ä¼šè¢«éšè—ã€‚å»ºè®®å…ˆæ¸…ç©ºè¯¥é¡µæ•°æ®ã€‚`)) {
        app.customTabs = app.customTabs.filter(t => t !== name);
        if (app.currentTab === name) app.currentTab = 'LX';
        saveData();
        renderTabs();
        renderTable();
    }
}

// --- è¡¨æ ¼æ¸²æŸ“ (æ€§èƒ½æ ¸å¿ƒä¼˜åŒ–) ---
function renderTable() {
    const tbody = document.getElementById('tableBody');
    const keyword = document.getElementById('searchInput').value.toLowerCase();
    
    // è¿‡æ»¤æ•°æ®
    const list = app.files.filter(f => {
        const fTab = f.tab || 'LX'; 
        return fTab === app.currentTab && (!keyword || (f.fileName||'').toLowerCase().includes(keyword));
    });

    if (list.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="empty-tip">å½“å‰åˆ—è¡¨ä¸ºç©ºï¼Œè¯·ç‚¹å‡»â€œæ·»åŠ æ–‡ä»¶â€</td></tr>`;
        return;
    }

    const isPresetTab = ['LX', 'æ¾œéŸ³'].includes(app.currentTab);
    const isMF = app.currentTab === 'Music Free';
    // æ–‡ä»¶ç±»å‹é™åˆ¶é€»è¾‘
    const acceptTypes = isMF ? ".js,.json" : ".js";

    // æ„å»º HTML å­—ç¬¦ä¸² (ç›¸æ¯”é€ä¸ªåˆ›å»º DOM å…ƒç´ ï¼Œæå¤§å‡å°‘é‡ç»˜)
    const htmlBuffer = list.map((f, idx) => {
        // 1. éŸ³è´¨ä¸ç‰ˆæœ¬åˆ—
        let qualityHtml = '';
        if (isPresetTab) {
            // ä¸‹æ‹‰é€‰æ‹©
            const isCustom = f.quality && !QUALITY_PRESETS.includes(f.quality);
            if (!isCustom) {
                qualityHtml = `<select onchange="updateFileLazy(${f.id}, 'quality', this.value === 'CUSTOM' ? 'è‡ªå®šä¹‰' : this.value)">
                    <option value="">é€‰æ‹©éŸ³è´¨...</option>
                    ${QUALITY_PRESETS.map(p => `<option value="${p}" ${f.quality===p?'selected':''}>${p}</option>`).join('')}
                    <option value="CUSTOM">âœ è‡ªå®šä¹‰...</option>
                </select>`;
            } else {
                qualityHtml = `<div style="display:flex;gap:2px"><input type="text" value="${f.quality}" onchange="updateFileLazy(${f.id}, 'quality', this.value)" style="flex:1"><button class="btn-xs btn-gray" onclick="updateFileLazy(${f.id}, 'quality', '')" title="é‡ç½®">â†º</button></div>`;
            }
        } else {
            qualityHtml = `<input type="text" value="${f.quality||''}" onchange="updateFileLazy(${f.id}, 'quality', this.value)" placeholder="éŸ³è´¨æè¿°">`;
        }
        // ç‰ˆæœ¬å·è¾“å…¥ (æ–°å¢)
        const verVal = f.version || '';
        qualityHtml += `<input type="text" class="input-sm" style="margin-top:4px;color:#666" value="${verVal}" onchange="updateFileLazy(${f.id}, 'version', this.value)" placeholder="ç‰ˆæœ¬å· (å¯é€‰)">`;

        // 2. çŠ¶æ€æ ‡ç­¾
        let tagsHtml = '';
        if (f.dlLink) tagsHtml += `<span class="tag tag-dl" title="${f.dlLink}">ç›´é“¾ <span class="tag-close" onclick="updateFileLazy(${f.id}, 'dlLink', '')">Ã—</span></span>`;
        
        // Key æ ‡ç­¾
        if (f.enableKeyUrl) tagsHtml += `<span class="tag tag-key" title="${f.keyUrl}">Keyåœ¨çº¿ <span class="tag-close" onclick="toggleKey(${f.id}, 'enableKeyUrl', false)">Ã—</span></span>`;
        if (f.enableKeyVar) tagsHtml += `<span class="tag tag-key" title="${f.keyVariable}">Keyæœ¬åœ° <span class="tag-close" onclick="toggleKey(${f.id}, 'enableKeyVar', false)">Ã—</span></span>`;
        
        // é“¾æ¥æ ‡ç­¾
        if (f.links) f.links.forEach((l, i) => {
            tagsHtml += `<span class="tag tag-link"><a href="${l.url}" target="_blank" style="text-decoration:none;color:inherit">${l.text}</a> <span class="tag-close" onclick="delLink(${f.id}, ${i})">Ã—</span></span>`;
        });

        // 3. æŒ‰é’®ç»„
        const fileStatus = f.fileContent 
            ? `<span class="status-badge status-ok">âœ… å·²ä¸Šä¼  ${formatSize(f.fileSize)}</span>`
            : `<span class="status-badge status-no">âš ï¸ æœªä¸Šä¼ </span>`;

        const upBtns = `
            <div class="btn-group">
                <input type="file" id="f-${f.id}" style="display:none" accept="${acceptTypes}" onchange="uploadFile(${f.id}, this)">
                <button class="btn-xs btn-primary" onclick="document.getElementById('f-${f.id}').click()">${f.fileContent?'é‡ä¼ ':'ä¸Šä¼ '}</button>
                ${f.fileContent ? `<button class="btn-xs btn-success" onclick="downloadFile(${f.id})">ä¸‹è½½</button>` : ''}
                <button class="btn-xs btn-danger" onclick="delRow(${f.id})">åˆ é™¤</button>
            </div>
        `;
        
        const configBtns = `
            <div class="btn-group" style="margin-bottom:4px">
                <button class="btn-xs btn-info" onclick="openLinkModal(${f.id})">+ é“¾æ¥</button>
                <button class="btn-xs btn-success" onclick="openDlLinkModal(${f.id})">+ ç›´é“¾</button>
                ${app.currentTab === 'LX' ? `<button class="btn-xs btn-warning" onclick="openKeyModal(${f.id})">âš™ï¸ Key</button>` : ''}
            </div>
        `;

        return `
            <tr>
                <td style="text-align:center">
                    <button class="btn-xs btn-gray" onclick="moveRow(${f.id}, -1)">â–²</button>
                    <button class="btn-xs btn-gray" style="margin-top:2px" onclick="moveRow(${f.id}, 1)">â–¼</button>
                </td>
                <td>
                    <div style="margin-bottom:5px">
                        <input type="text" value="${f.fileName}" onchange="updateFileLazy(${f.id}, 'fileName', this.value)" placeholder="æ’ä»¶åç§°" style="font-weight:bold; color:#333;">
                    </div>
                    ${fileStatus}
                </td>
                <td valign="top">${qualityHtml}</td>
                <td>
                    <input type="text" value="${f.note||''}" onchange="updateFileLazy(${f.id}, 'note', this.value)" placeholder="å¤‡æ³¨ä¿¡æ¯..." style="margin-bottom:6px">
                    ${configBtns}
                    <div class="tag-container">${tagsHtml}</div>
                </td>
                <td>${upBtns}</td>
            </tr>
        `;
    }).join('');

    tbody.innerHTML = htmlBuffer;
}

// --- æ•°æ®æ“ä½œ (ä½¿ç”¨ Lazy Update ä¿®å¤å¡é¡¿) ---
// å…³é”®ï¼šåªåœ¨ onchange æ—¶è°ƒç”¨ï¼Œä¸é‡ç»˜è¡¨æ ¼ï¼Œæˆ–è€…åªä¿å­˜æ•°æ®
function updateFileLazy(id, key, val) {
    const f = app.files.find(x => x.id === id);
    if(f) {
        f[key] = val;
        saveData();
        // è¿™é‡Œä¸è°ƒç”¨ renderTable()ï¼Œå› ä¸º input çš„å€¼å·²ç»æ”¹å˜äº†ï¼Œ
        // åªæœ‰æ¶‰åŠ UI ç»“æ„å˜åŒ–(å¦‚éŸ³è´¨ä¸‹æ‹‰å˜è¾“å…¥æ¡†)æ‰éœ€è¦é‡æ–° renderï¼Œ
        // ä½†ä¸ºäº†ç®€å•å’Œç¡®ä¿çŠ¶æ€ä¸€è‡´ï¼Œå¯¹äºä¸‹æ‹‰æ¡†è¿™ç§æ”¹å˜ç»“æ„çš„ï¼Œå·²ç»åœ¨ onchange é‡Œåˆ¤æ–­é€»è¾‘äº†ã€‚
        // å¯¹äºçº¯æ–‡æœ¬è¾“å…¥ï¼Œä¸éœ€è¦é‡ç»˜ã€‚
        if (key === 'quality' || key === 'dlLink') renderTable(); // åªæœ‰å½±å“å¸ƒå±€çš„å±æ€§æ‰é‡ç»˜
    }
}

function toggleKey(id, key, val) {
    updateFileLazy(id, key, val);
    renderTable();
}

function addNewRow() {
    app.files.push({
        id: Date.now(),
        tab: app.currentTab,
        fileName: '', quality: '', version: '', note: '',
        fileContent: null, fileSize: 0,
        links: [], dlLink: '',
        enableKeyUrl: false, keyUrl: '',
        enableKeyVar: false, keyVariable: ''
    });
    saveData();
    renderTable();
}

function uploadFile(id, input) {
    const file = input.files[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = e => {
        const f = app.files.find(x => x.id === id);
        if(f) {
            f.fileContent = e.target.result;
            f.fileSize = file.size;
            if(!f.fileName) f.fileName = file.name;
            saveData();
            renderTable();
        }
    };
    r.readAsDataURL(file);
    input.value = '';
}

function downloadFile(id) {
    const f = app.files.find(x => x.id === id);
    if(f && f.fileContent) {
        const a = document.createElement('a');
        a.href = f.fileContent;
        a.download = f.fileName || 'download';
        a.click();
    }
}

function moveRow(id, dir) {
    const idx = app.files.findIndex(x => x.id === id);
    if(idx < 0) return;
    const target = idx + dir;
    if(target >= 0 && target < app.files.length) {
        [app.files[idx], app.files[target]] = [app.files[target], app.files[idx]];
        saveData();
        renderTable();
    }
}

function delRow(id) {
    if(confirm('ç¡®å®šåˆ é™¤æ­¤æ–‡ä»¶ï¼Ÿ')) {
        app.files = app.files.filter(x => x.id !== id);
        saveData();
        renderTable();
    }
}

function clearCurrentTab() {
    if(confirm(`ç¡®å®šæ¸…ç©º "${app.currentTab}" ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å—ï¼Ÿ`)) {
        app.files = app.files.filter(f => (f.tab||'LX') !== app.currentTab);
        saveData();
        renderTable();
    }
}

// --- å¼¹çª—ä¸é…ç½® ---
function openModal(id) { document.getElementById(id).style.display = 'block'; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; currentEditId = null; }

function openLinkModal(id) {
    currentEditId = id;
    document.getElementById('linkText').value = '';
    document.getElementById('linkUrl').value = '';
    openModal('linkModal');
}
function saveLink() {
    const f = app.files.find(x => x.id === currentEditId);
    const text = document.getElementById('linkText').value;
    const url = document.getElementById('linkUrl').value;
    if(text && url) {
        if(!f.links) f.links = [];
        f.links.push({text, url});
        saveData();
        renderTable();
        closeModal('linkModal');
    }
}
function delLink(fid, idx) {
    const f = app.files.find(x => x.id === fid);
    if(f) { f.links.splice(idx, 1); saveData(); renderTable(); }
}

function openDlLinkModal(id) {
    currentEditId = id;
    const f = app.files.find(x => x.id === id);
    document.getElementById('dlLinkUrl').value = f.dlLink || '';
    openModal('dlLinkModal');
}
function saveDlLink() {
    updateFileLazy(currentEditId, 'dlLink', document.getElementById('dlLinkUrl').value);
    renderTable();
    closeModal('dlLinkModal');
}

function openKeyModal(id) {
    currentEditId = id;
    const f = app.files.find(x => x.id === id);
    document.getElementById('keyUrl').value = f.keyUrl || '';
    document.getElementById('enableKeyUrl').checked = f.enableKeyUrl || false;
    document.getElementById('keyVar').value = f.keyVariable || '';
    document.getElementById('enableKeyVar').checked = f.enableKeyVar || false;
    openModal('keyModal');
}
function saveKeyConfig() {
    const f = app.files.find(x => x.id === currentEditId);
    f.keyUrl = document.getElementById('keyUrl').value;
    f.enableKeyUrl = document.getElementById('enableKeyUrl').checked;
    f.keyVariable = document.getElementById('keyVar').value;
    f.enableKeyVar = document.getElementById('enableKeyVar').checked;
    saveData();
    renderTable();
    closeModal('keyModal');
}

// --- è¾…åŠ© ---
function formatSize(bytes) {
    if(!bytes) return '';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + sizes[i];
}

// --- å¯¼å…¥å¯¼å‡º (å…¼å®¹ä¿®å¤) ---
function exportData(type) {
    if(type === 'json') {
        const blob = new Blob([JSON.stringify(app, null, 2)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `å¤‡ä»½_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    } else {
        exportHtml();
    }
}

function importData(input) {
    const f = input.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = e => {
        try {
            const data = JSON.parse(e.target.result);
            if(Array.isArray(data)) {
                // æ—§ç‰ˆå…¼å®¹é€»è¾‘ï¼šArray -> Object
                app.files = data.map(x => ({
                    ...x, 
                    tab:'LX',
                    keyUrl: x.keyUrl || '',
                    enableKeyUrl: (x.keyMode === 'link'),
                    keyVariable: x.keyVariable || '',
                    enableKeyVar: (x.keyMode === 'local'),
                    dlLink: x.directUrl || ''
                }));
                app.tabs = [];
                app.currentTab = 'LX';
                app.config = { showMusicFree: false, showLanyin: false };
            } else {
                app = data;
                // æ•°æ®ç»“æ„è¡¥å…¨
                if(!app.config) app.config = {showMusicFree:false, showLanyin:false};
            }
            saveData();
            renderTabs();
            renderTable();
            alert('å¯¼å…¥æˆåŠŸï¼');
        } catch(err) {
            console.error(err);
            alert('æ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–å·²æŸå');
        }
    };
    r.readAsText(f);
    input.value = '';
}

// --- ç”Ÿæˆå¯¼å‡ºæŠ¥å‘Š HTML (Client Script) ---
function exportHtml() {
    const exportObj = { tabs: getActiveTabs(), files: app.files };
    
    // å®¢æˆ·ç«¯è„šæœ¬ï¼šè´Ÿè´£åœ¨å¯¼å‡ºåçš„HTMLä¸­æ¸²æŸ“æ•°æ®
    const clientScript = `
    const DATA = ${JSON.stringify(exportObj)};
    let curTab = DATA.tabs[0];

    function init() {
        const bar = document.getElementById('tabs');
        bar.innerHTML = DATA.tabs.map(t => 
            '<button class="tab-btn ' + (t===curTab?'active':'') + '" onclick="switchTab(\\''+t+'\\')">' + t + '</button>'
        ).join('');
        render();
    }

    function switchTab(t) { curTab = t; init(); }

    function render() {
        const list = DATA.files.filter(f => (f.tab||'LX') === curTab);
        const box = document.getElementById('list-box');
        
        if(list.length === 0) {
            box.innerHTML = '<div class="empty">æš‚æ— å†…å®¹</div>';
            return;
        }

        let html = '<table class="w-full"><thead><tr><th>æ’ä»¶åç§°</th><th>éŸ³è´¨/ç‰ˆæœ¬</th><th>è¯´æ˜ & é“¾æ¥</th><th>ä¸‹è½½</th></tr></thead><tbody>';
        
        html += list.map((f, idx) => {
            // é“¾æ¥
            let links = (f.links||[]).map(l => '<a href="'+l.url+'" target="_blank" class="link-tag">ğŸ”— '+l.text+'</a>').join('');
            // ç‰ˆæœ¬æ˜¾ç¤º
            let verInfo = f.quality || '';
            if(f.version) verInfo += '<div style="font-size:12px;color:#888;margin-top:2px">v' + f.version + '</div>';

            // ä¸‹è½½åŒºåŸŸæ„å»º
            let dlArea = '<div class="dl-group">';
            
            // ç›´é“¾
            if(f.dlLink) {
                 dlArea += '<a href="'+f.dlLink+'" target="_blank" class="btn btn-blue">ğŸŒ ç›´é“¾</a>';
            }
            // æœ¬åœ°æ–‡ä»¶
            if(f.fileContent) {
                dlArea += '<button class="btn btn-green" onclick="dlLocal('+idx+')">â¬‡ï¸ ä¸‹è½½</button>';
            }
            
            // LX Key é€»è¾‘
            if(curTab === 'LX') {
                if(f.enableKeyUrl && f.keyUrl) {
                    dlArea += '<div class="key-row"><label>åœ¨çº¿å¯¼å…¥Key:</label><div class="flex"><input id="k1-'+idx+'"><button class="btn btn-yellow" onclick="dlOnlineKey('+idx+')">ä¸‹è½½</button></div></div>';
                }
                if(f.enableKeyVar && f.keyVariable && f.fileContent) {
                    dlArea += '<div class="key-row"><label>æœ¬åœ°å¯¼å…¥Key:</label><div class="flex"><input id="k2-'+idx+'"><button class="btn btn-yellow" onclick="dlWithVar('+idx+')">ä¸‹è½½</button></div></div>';
                }
            }
            dlArea += '</div>';

            return '<tr><td><b>'+f.fileName+'</b></td><td>'+verInfo+'</td><td>'+(f.note||'-')+'<br>'+links+'</td><td width="220">'+dlArea+'</td></tr>';
        }).join('');
        
        html += '</tbody></table>';
        box.innerHTML = html;
    }

    // ä¸‹è½½æœ¬åœ°
    function dlLocal(idx) {
        const f = getFile(idx);
        saveAs(b64toBlob(f.fileContent), f.fileName);
    }
    // åœ¨çº¿Key
    function dlOnlineKey(idx) {
        const f = getFile(idx);
        const k = document.getElementById('k1-'+idx).value;
        if(k) window.open(f.keyUrl + k);
    }
    // æœ¬åœ°Keyå˜é‡æ›¿æ¢
    function dlWithVar(idx) {
        const f = getFile(idx);
        const k = document.getElementById('k2-'+idx).value;
        if(!k) { alert('è¯·è¾“å…¥Key'); return; }
        try {
            const binStr = atob(f.fileContent.split(',')[1]);
            const decoder = new TextDecoder('utf-8');
            const arr = new Uint8Array(binStr.length);
            for(let i=0; i<binStr.length; i++) arr[i] = binStr.charCodeAt(i);
            let txt = decoder.decode(arr);
            
            // æ›¿æ¢é€»è¾‘
            const v = f.keyVariable;
            const re = new RegExp('const\\\\s+' + v + '\\\\s*=\\\\s*[\\\'\\"][\\\'\\"]');
            if(re.test(txt)) {
                txt = txt.replace(re, 'const ' + v + ' = "' + k + '"');
            } else {
                txt = txt.replace(v + '=""', v + '="' + k + '"').replace(v + "=''", v + "='" + k + "'");
            }
            const blob = new Blob([txt], {type: 'application/javascript'});
            saveAs(blob, f.fileName);
        } catch(e) { console.error(e); alert('å¤„ç†å‡ºé”™'); }
    }

    function getFile(idx) { return DATA.files.filter(f => (f.tab||'LX') === curTab)[idx]; }
    function b64toBlob(b64) {
        const bin = atob(b64.split(',')[1]);
        const arr = new Uint8Array(bin.length);
        for(let i=0;i<bin.length;i++) arr[i] = bin.charCodeAt(i);
        return new Blob([arr], {type: 'application/octet-stream'});
    }
    function saveAs(blob, name) {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = name;
        a.click();
    }
    init();
    `;

    const htmlContent = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ’ä»¶åˆ—è¡¨</title>
<style>
body{font-family:"Microsoft YaHei",sans-serif;background:#f5f7fa;padding:20px;color:#333}
.container{max-width:1100px;margin:0 auto;background:white;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.05);overflow:hidden}
.header{padding:20px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
.title{font-size:18px;font-weight:bold}
.tabs{display:flex;background:#fafafa;border-bottom:1px solid #eee}
.tab-btn{padding:12px 24px;border:none;background:transparent;cursor:pointer;color:#666;font-size:14px;border-bottom:2px solid transparent}
.tab-btn.active{color:#1890ff;border-bottom-color:#1890ff;background:white;font-weight:bold}
table{width:100%;border-collapse:collapse}
th{text-align:left;background:#fafafa;padding:12px;color:#555;font-size:13px}
td{padding:12px;border-bottom:1px solid #f0f0f0;vertical-align:top;font-size:13px}
tr:hover{background:#fbfbfb}
.btn{display:inline-block;padding:5px 12px;border-radius:4px;color:white;text-decoration:none;font-size:12px;cursor:pointer;border:none;margin-bottom:4px}
.btn-green{background:#52c41a}.btn-blue{background:#1890ff}.btn-yellow{background:#faad14;color:white}
.link-tag{color:#1890ff;text-decoration:none;margin-right:8px;font-size:12px}
.dl-group{display:flex;flex-direction:column;gap:5px}
.key-row{background:#fffbe6;border:1px solid #ffe58f;padding:5px;border-radius:4px;font-size:12px}
.key-row label{display:block;margin-bottom:2px;color:#fa8c16}
.flex{display:flex;gap:4px}
.flex input{flex:1;border:1px solid #d9d9d9;padding:2px 5px;border-radius:2px}
.empty{padding:40px;text-align:center;color:#999}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="title">æ’ä»¶åˆ—è¡¨</div>
        <div style="font-size:12px;color:#999">æ›´æ–°äº: ${new Date().toLocaleString()}</div>
    </div>
    <div class="tabs" id="tabs"></div>
    <div id="list-box"></div>
</div>
<script>
${clientScript}
<\/script>
</body>
</html>`;

    const blob = new Blob([htmlContent], {type: 'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `æ’ä»¶åˆ—è¡¨_${new Date().toISOString().slice(0,10)}.html`;
    a.click();
}
</script>
</body>
</html>