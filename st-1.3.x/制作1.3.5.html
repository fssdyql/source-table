<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’ä»¶åˆ—è¡¨ç®¡ç†å™¨ v1.3.5</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --danger: #dc2626;
            --success: #16a34a;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-700: #374151;
            --border: #d1d5db;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f9fafb; color: #111; margin: 0; padding: 20px; font-size: 14px; }
        * { box-sizing: border-box; outline: none; }

        /* å¸ƒå±€å®¹å™¨ */
        .app-container { max-width: 1400px; margin: 0 auto; background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; flex-direction: column; height: 90vh; }
        
        /* å¤´éƒ¨ */
        .header { padding: 15px 20px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; background: #fff; border-radius: 8px 8px 0 0; }
        .title { font-size: 18px; font-weight: 600; color: #1f2937; display: flex; align-items: center; gap: 10px; }
        .version { font-size: 12px; background: #eff6ff; color: var(--primary); padding: 2px 8px; border-radius: 99px; border: 1px solid #bfdbfe; }
        
        /* æ ‡ç­¾æ  */
        .tabs-wrapper { padding: 10px 20px 0; background: #f9fafb; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 5px; overflow-x: auto; }
        .tab { padding: 8px 20px; border: 1px solid transparent; border-bottom: none; border-radius: 6px 6px 0 0; cursor: pointer; color: var(--gray-700); font-weight: 500; transition: 0.2s; white-space: nowrap; position: relative; top: 1px; }
        .tab:hover { background: #e5e7eb; }
        .tab.active { background: #fff; border-color: var(--border); color: var(--primary); font-weight: 600; border-bottom-color: #fff; }
        .tab-add-btn { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 4px; border: none; background: transparent; cursor: pointer; color: #6b7280; font-size: 16px; }
        .tab-add-btn:hover { background: #e5e7eb; color: var(--primary); }

        /* å·¥å…·æ  */
        .toolbar { padding: 12px 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; background: #fff; border-bottom: 1px solid var(--gray-100); }
        .spacer { flex: 1; }
        .search-box { padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px; width: 240px; font-size: 13px; }
        .search-box:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37,99,235,0.1); }

        /* ä¸»ä½“è¡¨æ ¼åŒº */
        .table-area { flex: 1; overflow-y: auto; padding: 0; position: relative; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { position: sticky; top: 0; background: #f3f4f6; z-index: 10; text-align: left; padding: 10px 15px; font-weight: 600; color: var(--gray-700); border-bottom: 1px solid var(--border); }
        td { padding: 8px 15px; border-bottom: 1px solid var(--gray-100); vertical-align: top; }
        tr:hover { background: #f9fafb; }
        
        /* æ§ä»¶æ ·å¼ */
        .btn { display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; border-radius: 4px; border: none; font-size: 13px; cursor: pointer; transition: 0.15s; color: white; user-select: none; }
        .btn:active { transform: translateY(1px); }
        .btn-primary { background: var(--primary); }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-ghost { background: transparent; color: var(--gray-700); border: 1px solid var(--border); }
        .btn-ghost:hover { background: #f3f4f6; }
        .btn-icon { padding: 4px 8px; font-size: 12px; }

        input[type="text"], select { width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; transition: 0.2s; }
        input[type="text"]:focus, select:focus { border-color: var(--primary); }

        /* çŠ¶æ€æ ‡è¯† */
        .badge { display: inline-flex; align-items: center; font-size: 11px; padding: 1px 6px; border-radius: 4px; margin-right: 4px; margin-top: 4px; border: 1px solid transparent; }
        .badge-success { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .badge-warning { background: #fef9c3; color: #854d0e; border-color: #fde047; }
        .badge-info { background: #eff6ff; color: #1e40af; border-color: #bfdbfe; }
        .del-tag { margin-left: 4px; cursor: pointer; opacity: 0.6; }
        .del-tag:hover { opacity: 1; color: var(--danger); }

        /* æ¨¡æ€æ¡† */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; backdrop-filter: blur(1px); }
        .modal { position: absolute; top: 15%; left: 50%; transform: translateX(-50%); background: white; width: 420px; padding: 20px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .modal-head { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; font-size: 16px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 12px; color: #6b7280; margin-bottom: 4px; }
        .close-modal { cursor: pointer; font-size: 20px; line-height: 1; }

        /* è¾…åŠ© */
        .empty-state { text-align: center; color: #9ca3af; padding: 50px; font-style: italic; }
        .row-actions { display: flex; gap: 4px; flex-wrap: wrap; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <div class="title">æ’ä»¶åˆ—è¡¨ç®¡ç†å™¨ <span class="version">v1.3.5</span></div>
        <div style="font-size:12px; color:#6b7280" id="statusMsg">å°±ç»ª</div>
    </div>

    <!-- æ ‡ç­¾ -->
    <div class="tabs-wrapper" id="tabContainer">
        <!-- JSç”Ÿæˆ -->
    </div>

    <!-- å·¥å…·æ  -->
    <div class="toolbar">
        <button class="btn btn-success" onclick="actions.addRow()">+ æ–°å¢æ–‡ä»¶</button>
        <button class="btn btn-primary" onclick="actions.exportData('html')">å¯¼å‡ºåˆ—è¡¨ (HTML)</button>
        <button class="btn btn-ghost" onclick="actions.exportData('json')">å¤‡ä»½æ•°æ® (JSON)</button>
        
        <div class="spacer"></div>
        
        <input type="file" id="importFile" hidden onchange="actions.importData(this)">
        <button class="btn btn-ghost" onclick="document.getElementById('importFile').click()">å¯¼å…¥å¤‡ä»½</button>
        <button class="btn btn-danger" onclick="actions.clearCurrentTab()">æ¸…ç©ºå½“å‰é¡µ</button>
        <input type="text" class="search-box" placeholder="æœç´¢æ–‡ä»¶å..." id="searchInput" oninput="actions.handleSearch()">
    </div>

    <!-- è¡¨æ ¼ -->
    <div class="table-area">
        <table id="mainTable">
            <thead>
                <tr>
                    <th width="60">æ’åº</th>
                    <th width="300">æ’ä»¶ä¿¡æ¯</th>
                    <th width="180">ç‰ˆæœ¬/éŸ³è´¨</th>
                    <th>é…ç½® (å¤‡æ³¨/Key/é“¾æ¥)</th>
                    <th width="180">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<!-- å¼¹çª—ï¼šé…ç½® Key -->
<div id="modalKey" class="modal-overlay">
    <div class="modal">
        <div class="modal-head"><span>Key æ³¨å…¥é…ç½®</span> <span class="close-modal" onclick="ui.closeModals()">Ã—</span></div>
        <div class="form-group">
            <label>åœ¨çº¿ Key (URL åç¼€æ¨¡å¼):</label>
            <input type="text" id="k_url" placeholder="https://api.example.com?key=">
        </div>
        <div class="form-group">
            <label>æœ¬åœ° Key (JS å˜é‡æ›¿æ¢æ¨¡å¼):</label>
            <input type="text" id="k_var" placeholder="ä¾‹å¦‚: API_KEY">
            <small style="color:#999; display:block; margin-top:4px">ä¸‹è½½æ—¶ä¼šå°†è¾“å…¥çš„Keyæ›¿æ¢æ‰JSæ–‡ä»¶ä¸­çš„åŒåå˜é‡ã€‚</small>
        </div>
        <div style="text-align:right; margin-top:20px">
            <button class="btn btn-primary" onclick="actions.saveKeyConfig()">ä¿å­˜é…ç½®</button>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šæ·»åŠ é“¾æ¥ -->
<div id="modalLink" class="modal-overlay">
    <div class="modal">
        <div class="modal-head"><span>æ·»åŠ é“¾æ¥</span> <span class="close-modal" onclick="ui.closeModals()">Ã—</span></div>
        <div class="form-group">
            <label>é“¾æ¥åç§°:</label>
            <input type="text" id="l_text" placeholder="å®˜ç½‘ / è¯´æ˜">
        </div>
        <div class="form-group">
            <label>è·³è½¬åœ°å€:</label>
            <input type="text" id="l_url" placeholder="http://...">
        </div>
        <div style="text-align:right; margin-top:20px">
            <button class="btn btn-primary" onclick="actions.saveLink()">ç¡®å®š</button>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šç›´é“¾ -->
<div id="modalDl" class="modal-overlay">
    <div class="modal">
        <div class="modal-head"><span>ç›´é“¾ä¸‹è½½é…ç½®</span> <span class="close-modal" onclick="ui.closeModals()">Ã—</span></div>
        <div class="form-group">
            <label>ç›´é“¾ URL (å¯é€‰):</label>
            <input type="text" id="d_url" placeholder="http://...">
            <small style="color:#999">è®¾ç½®åï¼Œå¯¼å‡ºåˆ—è¡¨ä¸­ä¼šæ˜¾ç¤º"ç›´é“¾"æŒ‰é’®ã€‚</small>
        </div>
        <div style="text-align:right; margin-top:20px">
            <button class="btn btn-primary" onclick="actions.saveDl()">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šæ ‡ç­¾ç®¡ç† -->
<div id="modalTabs" class="modal-overlay">
    <div class="modal">
        <div class="modal-head"><span>æ–°å»ºæ ‡ç­¾é¡µ</span> <span class="close-modal" onclick="ui.closeModals()">Ã—</span></div>
        <div class="form-group">
            <label>æ ‡ç­¾é¡µåç§°:</label>
            <input type="text" id="t_name" placeholder="è¾“å…¥åç§°...">
        </div>
        <div style="text-align:right; margin-top:20px">
            <button class="btn btn-primary" onclick="actions.addNewTab()">åˆ›å»º</button>
        </div>
    </div>
</div>

<script>
/**
 * æ ¸å¿ƒé€»è¾‘
 * v1.3.5
 */
const App = {
    data: {
        tabs: ['LX', 'Music Free', 'æ¾œéŸ³'], // é»˜è®¤æ ‡ç­¾
        activeTab: 'LX',
        items: [] // { id, tab, name, ver, quality, note, file: {name, size, data}, keyConfig: {url, var}, links: [], dlLink }
    },
    // è¿è¡Œæ—¶ä¸´æ—¶çŠ¶æ€
    state: {
        editId: null,
        searchKeyword: ''
    }
};

// ----------------------
// æ•°æ®å±‚ (Model)
// ----------------------
const Store = {
    KEY: 'pm_v135_data',
    load() {
        try {
            const raw = localStorage.getItem(this.KEY);
            if (raw) {
                const parsed = JSON.parse(raw);
                // ç®€å•çš„æ•°æ®è¿ç§»/æ ¡éªŒ
                if (parsed.tabs) App.data.tabs = parsed.tabs;
                if (parsed.items) App.data.items = parsed.items;
                // æ¢å¤ä¸Šæ¬¡é€‰ä¸­çš„æ ‡ç­¾ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å›é€€åˆ°ç¬¬ä¸€ä¸ª
                if (parsed.activeTab && App.data.tabs.includes(parsed.activeTab)) {
                    App.data.activeTab = parsed.activeTab;
                }
            }
        } catch (e) {
            console.error('æ•°æ®åŠ è½½å¤±è´¥', e);
            ui.toast('æ•°æ®åŠ è½½å¼‚å¸¸', 'error');
        }
    },
    save() {
        // ä¿å­˜åŒ…å«å½“å‰æ¿€æ´»æ ‡ç­¾ï¼Œä»¥ä¾¿åˆ·æ–°åæ¢å¤
        const toSave = { ...App.data };
        try {
            localStorage.setItem(this.KEY, JSON.stringify(toSave));
            ui.updateStatus('å·²ä¿å­˜');
        } catch (e) {
            if (e.name === 'QuotaExceededError') {
                alert('å­˜å‚¨ç©ºé—´å·²æ»¡ï¼è¯·åˆ é™¤éƒ¨åˆ†å¤§æ–‡ä»¶æˆ–å¯¼å‡ºå¤‡ä»½åæ¸…ç†ã€‚');
            }
        }
    },
    // é˜²æŠ–ä¿å­˜ï¼Œç”¨äºæ–‡æœ¬è¾“å…¥
    debounceSave: null,
    triggerSave() {
        if (this.debounceSave) clearTimeout(this.debounceSave);
        this.debounceSave = setTimeout(() => {
            this.save();
            ui.updateStatus('è‡ªåŠ¨ä¿å­˜äº ' + new Date().toLocaleTimeString());
        }, 1000);
    }
};

// ----------------------
// è§†å›¾å±‚ (View / UI)
// ----------------------
const ui = {
    el: (id) => document.getElementById(id),
    
    init() {
        Store.load();
        this.renderTabs();
        this.renderTable();
    },

    updateStatus(msg) {
        this.el('statusMsg').innerText = msg;
    },

    toast(msg) {
        // ç®€å•çš„ alert æ›¿ä»£
        this.updateStatus(msg);
    },

    renderTabs() {
        const container = this.el('tabContainer');
        let html = App.data.tabs.map(t => {
            const isActive = t === App.data.activeTab;
            // åªæœ‰éé»˜è®¤æ ‡ç­¾å…è®¸åˆ é™¤ (è¿™é‡Œå‡å®šæ‰€æœ‰éƒ½å¯ä»¥åˆ é™¤ï¼Œä¸ºäº†çµæ´»ï¼Œå®é™…é€»è¾‘åœ¨ deleteTab)
            const canDel = true; 
            return `
                <div class="tab ${isActive ? 'active' : ''}" onclick="actions.switchTab('${t}')">
                    ${t}
                    ${(isActive && App.data.tabs.length > 1) ? `<span onclick="actions.deleteTab('${t}', event)" style="margin-left:5px;font-size:12px;opacity:0.5">Ã—</span>` : ''}
                </div>
            `;
        }).join('');
        
        // æ·»åŠ æŒ‰é’®
        html += `<button class="tab-add-btn" onclick="ui.openModal('modalTabs')" title="æ·»åŠ åˆ†ç±»">+</button>`;
        container.innerHTML = html;
    },

    // æ ¸å¿ƒæ¸²æŸ“ï¼šåªæ¸²æŸ“å½“å‰è§†å›¾éœ€è¦çš„æ•°æ®
    renderTable() {
        const tbody = this.el('tableBody');
        const kw = App.state.searchKeyword.toLowerCase();
        
        // è¿‡æ»¤æ•°æ®
        const list = App.data.items.filter(item => {
            if (item.tab !== App.data.activeTab) return false;
            if (!kw) return true;
            return (item.name || '').toLowerCase().includes(kw);
        });

        if (list.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="empty-state">æ­¤åˆ—è¡¨ä¸ºç©ºï¼Œç‚¹å‡»ä¸Šæ–¹â€œæ–°å¢æ–‡ä»¶â€å¼€å§‹</td></tr>`;
            return;
        }

        // æ„å»º DOM
        tbody.innerHTML = list.map((item, index) => {
            // æ–‡ä»¶çŠ¶æ€
            const hasFile = !!(item.file && item.file.data);
            const fileSize = hasFile ? formatSize(item.file.size) : '';
            
            // æ ‡ç­¾æ˜¾ç¤º
            let tags = '';
            if (item.dlLink) tags += `<span class="badge badge-success">ç›´é“¾ <span class="del-tag" onclick="actions.updateItem(${item.id}, 'dlLink', '')">Ã—</span></span>`;
            if (item.keyConfig?.url) tags += `<span class="badge badge-warning">Key:URL</span>`;
            if (item.keyConfig?.var) tags += `<span class="badge badge-warning">Key:Var</span>`;
            if (item.links) item.links.forEach((l, idx) => {
                tags += `<span class="badge badge-info"><a href="${l.url}" target="_blank" style="text-decoration:none;color:inherit">${l.text}</a> <span class="del-tag" onclick="actions.removeLink(${item.id}, ${idx})">Ã—</span></span>`;
            });

            return `
            <tr>
                <td align="center">
                    <div style="display:flex;flex-direction:column;gap:2px">
                        <button class="btn btn-ghost btn-icon" onclick="actions.moveItem(${item.id}, -1)">â–²</button>
                        <button class="btn btn-ghost btn-icon" onclick="actions.moveItem(${item.id}, 1)">â–¼</button>
                    </div>
                </td>
                <td>
                    <input type="text" value="${escapeHtml(item.name)}" 
                           oninput="actions.updateItem(${item.id}, 'name', this.value)" 
                           placeholder="æ’ä»¶åç§°" style="font-weight:bold;margin-bottom:4px">
                    <div style="font-size:12px;color:#666;display:flex;align-items:center;gap:6px">
                        ${hasFile ? `âœ… å·²ä¸Šä¼  (${fileSize})` : `âš ï¸ æœªä¸Šä¼ `}
                        <input type="file" id="f_${item.id}" hidden onchange="actions.uploadFile(${item.id}, this)">
                        <button class="btn btn-ghost btn-icon" onclick="document.getElementById('f_${item.id}').click()">${hasFile?'é‡ä¼ ':'ä¸Šä¼ '}</button>
                    </div>
                </td>
                <td>
                    <input type="text" value="${escapeHtml(item.quality)}" oninput="actions.updateItem(${item.id}, 'quality', this.value)" placeholder="éŸ³è´¨ (å¦‚: 128k, flac)">
                    <input type="text" value="${escapeHtml(item.ver)}" oninput="actions.updateItem(${item.id}, 'ver', this.value)" placeholder="ç‰ˆæœ¬å· (å¦‚: 1.0.0)" style="margin-top:4px">
                </td>
                <td>
                    <input type="text" value="${escapeHtml(item.note)}" oninput="actions.updateItem(${item.id}, 'note', this.value)" placeholder="å¤‡æ³¨è¯´æ˜...">
                    <div class="row-actions" style="margin-top:4px">
                        <button class="btn btn-ghost btn-icon" onclick="actions.openKeyConfig(${item.id})">âš™ï¸ Key</button>
                        <button class="btn btn-ghost btn-icon" onclick="actions.openLinkConfig(${item.id})">ğŸ”— é“¾æ¥</button>
                        <button class="btn btn-ghost btn-icon" onclick="actions.openDlConfig(${item.id})">ğŸŒ ç›´é“¾</button>
                    </div>
                    <div style="margin-top:4px">${tags}</div>
                </td>
                <td>
                    <div class="row-actions">
                        ${hasFile ? `<button class="btn btn-success btn-icon" onclick="actions.downloadLocal(${item.id})">ä¸‹è½½</button>` : ''}
                        <button class="btn btn-danger btn-icon" onclick="actions.deleteItem(${item.id})">åˆ é™¤</button>
                    </div>
                </td>
            </tr>
            `;
        }).join('');
    },

    openModal(id) { this.el(id).style.display = 'block'; },
    closeModals() { 
        document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none'); 
        App.state.editId = null;
    }
};

// ----------------------
// ä¸šåŠ¡é€»è¾‘ (Controller)
// ----------------------
const actions = {
    // æ ‡ç­¾é¡µæ“ä½œ
    switchTab(t) {
        App.data.activeTab = t;
        Store.save();
        ui.renderTabs(); // é‡ç»˜TabçŠ¶æ€
        ui.renderTable(); // é‡ç»˜åˆ—è¡¨
    },
    addNewTab() {
        const name = ui.el('t_name').value.trim();
        if(!name) return;
        if(App.data.tabs.includes(name)) { alert('åç§°å·²å­˜åœ¨'); return; }
        App.data.tabs.push(name);
        ui.el('t_name').value = '';
        ui.closeModals();
        this.switchTab(name);
    },
    deleteTab(t, e) {
        e.stopPropagation();
        if(!confirm(`ç¡®å®šåˆ é™¤åˆ†ç±» "${t}" å—ï¼Ÿ\nè¯¥åˆ†ç±»ä¸‹çš„æ•°æ®å°†è¢«éšè—(ä¸ä¼šç‰©ç†åˆ é™¤ï¼Œé™¤éæ¸…ç©ºæ•°æ®)ã€‚`)) return;
        App.data.tabs = App.data.tabs.filter(x => x !== t);
        // å¦‚æœåˆ é™¤äº†å½“å‰é¡µï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€é¡µ
        if(App.data.activeTab === t) {
            App.data.activeTab = App.data.tabs[0] || '';
        }
        Store.save();
        ui.renderTabs();
        ui.renderTable();
    },
    clearCurrentTab() {
        if(!confirm('ç¡®å®šæ¸…ç©ºå½“å‰é¡µé¢çš„æ‰€æœ‰æ¡ç›®å—ï¼Ÿæ“ä½œä¸å¯æ¢å¤ã€‚')) return;
        App.data.items = App.data.items.filter(i => i.tab !== App.data.activeTab);
        Store.save();
        ui.renderTable();
    },

    // åˆ—è¡¨æ“ä½œ
    addRow() {
        const newItem = {
            id: Date.now(),
            tab: App.data.activeTab,
            name: '', ver: '', quality: '', note: '',
            file: null, // {name, size, data(base64)}
            keyConfig: { url: '', var: '' },
            links: [],
            dlLink: ''
        };
        App.data.items.push(newItem);
        Store.save();
        ui.renderTable();
    },
    deleteItem(id) {
        if(!confirm('ç¡®å®šåˆ é™¤æ­¤è¡Œï¼Ÿ')) return;
        App.data.items = App.data.items.filter(i => i.id !== id);
        Store.save();
        ui.renderTable();
    },
    moveItem(id, dir) {
        const idx = App.data.items.findIndex(i => i.id === id);
        if (idx === -1) return;
        
        // é€»è¾‘ç¨å¾®å¤æ‚ç‚¹ï¼Œå› ä¸ºitemsæ•°ç»„åŒ…å«æ‰€æœ‰æ ‡ç­¾é¡µæ•°æ®
        // æˆ‘ä»¬éœ€è¦äº¤æ¢çš„æ˜¯å½“å‰è§†å›¾ä¸­çš„é¡ºåºï¼Œä½†åœ¨æ€»æ•°ç»„ä¸­ä½ç½®å¯èƒ½ä¸ç›¸é‚»
        // ç®€åŒ–ç­–ç•¥ï¼šç›´æ¥åœ¨æ€»æ•°ç»„ä¸­äº¤æ¢ï¼Œè™½ç„¶å¯èƒ½è·³è¿‡å…¶ä»–tabçš„å…ƒç´ ï¼Œä½†åœ¨å½“å‰è§†å›¾çœ‹èµ·æ¥å°±æ˜¯ä¸Šä¸‹ç§»
        const targetIdx = idx + dir;
        if (targetIdx >= 0 && targetIdx < App.data.items.length) {
            // ç®€å•çš„äº¤æ¢
            [App.data.items[idx], App.data.items[targetIdx]] = [App.data.items[targetIdx], App.data.items[idx]];
            Store.save();
            ui.renderTable();
        }
    },

    // æ•°æ®æ›´æ–° (é«˜æ€§èƒ½éƒ¨åˆ†: ä¸é‡ç»˜DOM)
    updateItem(id, field, val) {
        const item = App.data.items.find(i => i.id === id);
        if (item) {
            item[field] = val;
            Store.triggerSave(); // é˜²æŠ–ä¿å­˜
            // æ³¨æ„ï¼šä¸è°ƒç”¨ ui.renderTable()ï¼Œå› ä¸ºinputå€¼å·²ç»å˜äº†
            // å¦‚æœä¿®æ”¹çš„æ˜¯ dlLink è¿™ç§ä¼šå½±å“ badge æ˜¾ç¤ºçš„ï¼Œéœ€è¦å±€éƒ¨åˆ·æ–°ï¼Œè¿™é‡Œç®€åŒ–ä¸ºé‡æ–°æ¸²æŸ“
            if(field === 'dlLink') ui.renderTable(); 
        }
    },
    handleSearch() {
        App.state.searchKeyword = ui.el('searchInput').value;
        ui.renderTable();
    },

    // æ–‡ä»¶ä¸Šä¼ 
    uploadFile(id, input) {
        const file = input.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const item = App.data.items.find(i => i.id === id);
            if (item) {
                // å¦‚æœæ²¡åå­—ï¼Œè‡ªåŠ¨å¡«æ–‡ä»¶å
                if(!item.name) item.name = file.name;
                item.file = {
                    name: file.name,
                    size: file.size,
                    data: e.target.result // Base64
                };
                Store.save();
                ui.renderTable();
            }
        };
        reader.readAsDataURL(file);
        input.value = ''; // é‡ç½® input ä»¥å…è®¸é‡å¤ä¸Šä¼ åŒåæ–‡ä»¶
    },
    downloadLocal(id) {
        const item = App.data.items.find(i => i.id === id);
        if (item && item.file) {
            const a = document.createElement('a');
            a.href = item.file.data;
            a.download = item.file.name;
            a.click();
        }
    },

    // å­é…ç½®é¡¹é€»è¾‘
    openKeyConfig(id) {
        App.state.editId = id;
        const item = App.data.items.find(i => i.id === id);
        ui.el('k_url').value = item.keyConfig?.url || '';
        ui.el('k_var').value = item.keyConfig?.var || '';
        ui.openModal('modalKey');
    },
    saveKeyConfig() {
        const item = App.data.items.find(i => i.id === App.state.editId);
        if(item) {
            item.keyConfig = {
                url: ui.el('k_url').value,
                var: ui.el('k_var').value
            };
            Store.save();
            ui.renderTable();
        }
        ui.closeModals();
    },

    openLinkConfig(id) {
        App.state.editId = id;
        ui.el('l_text').value = '';
        ui.el('l_url').value = '';
        ui.openModal('modalLink');
    },
    saveLink() {
        const item = App.data.items.find(i => i.id === App.state.editId);
        if(item) {
            if(!item.links) item.links = [];
            const text = ui.el('l_text').value;
            const url = ui.el('l_url').value;
            if(text && url) {
                item.links.push({text, url});
                Store.save();
                ui.renderTable();
            }
        }
        ui.closeModals();
    },
    removeLink(itemId, linkIdx) {
        const item = App.data.items.find(i => i.id === itemId);
        if(item && item.links) {
            item.links.splice(linkIdx, 1);
            Store.save();
            ui.renderTable();
        }
    },

    openDlConfig(id) {
        App.state.editId = id;
        const item = App.data.items.find(i => i.id === id);
        ui.el('d_url').value = item.dlLink || '';
        ui.openModal('modalDl');
    },
    saveDl() {
        this.updateItem(App.state.editId, 'dlLink', ui.el('d_url').value);
        ui.closeModals();
    },

    // å¯¼å…¥å¯¼å‡ºç³»ç»Ÿ
    exportData(type) {
        if(type === 'json') {
            const blob = new Blob([JSON.stringify(App.data, null, 2)], {type: 'application/json'});
            downloadBlob(blob, `å¤‡ä»½_${getDateStr()}.json`);
        } else {
            // ç”Ÿæˆ HTML
            const html = generateExportHtml(App.data);
            const blob = new Blob([html], {type: 'text/html'});
            downloadBlob(blob, `æ’ä»¶åˆ—è¡¨_${getDateStr()}.html`);
        }
    },
    importData(input) {
        const file = input.files[0];
        if(!file) return;
        const r = new FileReader();
        r.onload = e => {
            try {
                const json = JSON.parse(e.target.result);
                // ç®€å•çš„å…¼å®¹æ£€æŸ¥
                if(json.items && Array.isArray(json.items)) {
                    App.data = json;
                    Store.save();
                    ui.init();
                    alert('å¯¼å…¥æˆåŠŸ');
                } else {
                    alert('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
                }
            } catch(err) {
                alert('è§£æJSONå¤±è´¥: ' + err.message);
            }
        };
        r.readAsText(file);
        input.value = '';
    }
};

// ----------------------
// å·¥å…·å‡½æ•°
// ----------------------
function escapeHtml(str) {
    if(!str) return '';
    return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}
function formatSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}
function getDateStr() {
    return new Date().toISOString().slice(0, 10);
}
function downloadBlob(blob, filename) {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    setTimeout(() => URL.revokeObjectURL(a.href), 1000);
}

// ----------------------
// HTML ç”Ÿæˆå™¨ (æ ¸å¿ƒå¯¼å‡ºé€»è¾‘)
// ----------------------
function generateExportHtml(data) {
    // å‹ç¼©æ•°æ®ä»¥å‡å°ä½“ç§¯
    const dataStr = JSON.stringify(data);
    
    // å®¢æˆ·ç«¯è¿è¡Œçš„è„šæœ¬ (åµŒå…¥åœ¨å¯¼å‡ºçš„HTMLä¸­)
    const clientScript = `
    const APP_DATA = ${dataStr};
    let curTab = APP_DATA.tabs[0];
    
    function init() {
        renderTabs();
        renderList();
    }
    
    function renderTabs() {
        const box = document.getElementById('tabs');
        box.innerHTML = APP_DATA.tabs.map(t => 
            '<button class="tab '+(t===curTab?'active':'')+'" onclick="setTab(\\''+t+'\\')">'+t+'</button>'
        ).join('');
    }
    
    function setTab(t) { curTab = t; renderTabs(); renderList(); }
    
    function renderList() {
        const list = APP_DATA.items.filter(i => i.tab === curTab);
        const container = document.getElementById('list');
        if(list.length === 0) {
            container.innerHTML = '<div class="empty">æš‚æ— å†…å®¹</div>';
            return;
        }
        
        let html = '<table class="table"><thead><tr><th>åç§°</th><th>è¯¦æƒ…</th><th>ä¸‹è½½é€‰é¡¹</th></tr></thead><tbody>';
        
        html += list.map((item, idx) => {
            // ç‰ˆæœ¬/éŸ³è´¨æ ‡ç­¾
            let meta = [];
            if(item.quality) meta.push('<span class="tag tag-blue">'+item.quality+'</span>');
            if(item.ver) meta.push('<span class="tag tag-gray">v'+item.ver+'</span>');
            
            // å¤–éƒ¨é“¾æ¥
            let links = (item.links || []).map(l => '<a href="'+l.url+'" target="_blank" class="link">ğŸ”— '+l.text+'</a>').join('');
            
            // ä¸‹è½½æŒ‰é’®é€»è¾‘
            let dlBtns = '';
            
            // 1. ç›´é“¾
            if(item.dlLink) {
                dlBtns += '<a href="'+item.dlLink+'" target="_blank" class="btn btn-pri">ğŸŒ ç›´é“¾ä¸‹è½½</a>';
            }
            
            // 2. æœ¬åœ°æ–‡ä»¶ä¸‹è½½ (å«Keyæ³¨å…¥é€»è¾‘)
            if(item.file && item.file.data) {
                // å¦‚æœæœ‰Keyé…ç½®
                const kConf = item.keyConfig || {};
                
                // æ™®é€šä¸‹è½½
                if(!kConf.url && !kConf.var) {
                     dlBtns += '<button class="btn btn-green" onclick="dlLocal('+item.id+')">â¬‡ï¸ æœ¬åœ°ä¸‹è½½</button>';
                } else {
                    // æœ‰ Key é…ç½®ï¼Œæ˜¾ç¤ºè¾“å…¥æ¡†
                    dlBtns += '<div class="key-area">';
                    if(kConf.url) {
                        dlBtns += '<div class="key-row"><input id="k_url_'+item.id+'" placeholder="è¾“å…¥Key (åœ¨çº¿)"><button class="btn btn-sm" onclick="dlKeyUrl('+item.id+')">Go</button></div>';
                    }
                    if(kConf.var) {
                         dlBtns += '<div class="key-row"><input id="k_var_'+item.id+'" placeholder="è¾“å…¥Key (æœ¬åœ°)"><button class="btn btn-sm" onclick="dlKeyVar('+item.id+')">ä¸‹è½½</button></div>';
                    }
                    dlBtns += '</div>';
                }
            }
            
            return '<tr><td><div class="name">'+item.name+'</div><div class="meta">'+meta.join('')+'</div></td><td><div class="note">'+(item.note||'-')+'</div><div style="margin-top:5px">'+links+'</div></td><td width="260">'+dlBtns+'</td></tr>';
        }).join('');
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // ä¸‹è½½åŠŸèƒ½å®ç°
    window.dlLocal = function(id) {
        const item = APP_DATA.items.find(i => i.id === id);
        saveFile(item.file.data, item.file.name);
    };

    window.dlKeyUrl = function(id) {
        const item = APP_DATA.items.find(i => i.id === id);
        const val = document.getElementById('k_url_'+id).value;
        if(!val) return alert('è¯·è¾“å…¥Key');
        window.open(item.keyConfig.url + val);
    };

    window.dlKeyVar = function(id) {
        const item = APP_DATA.items.find(i => i.id === id);
        const val = document.getElementById('k_var_'+id).value;
        if(!val) return alert('è¯·è¾“å…¥Key');
        
        // Key æ›¿æ¢é€»è¾‘
        try {
            const raw = atob(item.file.data.split(',')[1]);
            // ä½¿ç”¨ Uint8Array å¤„ç†é˜²æ­¢ä¸­æ–‡ä¹±ç 
            const bytes = new Uint8Array(raw.length);
            for(let i=0; i<raw.length; i++) bytes[i] = raw.charCodeAt(i);
            const decoder = new TextDecoder('utf-8');
            let content = decoder.decode(bytes);
            
            // æ›¿æ¢å˜é‡: æŸ¥æ‰¾ const VAR = "" æˆ– let VAR = '' ç­‰
            const varName = item.keyConfig.var;
            // ç®€å•çš„æ­£åˆ™æ›¿æ¢ï¼Œè¦†ç›–å¸¸è§æƒ…å†µ
            // 1. const API_KEY = "";
            let regex = new RegExp('((?:const|var|let)\\\\s+' + varName + '\\\\s*=\\\\s*[\\\'\\"])[\\\'\\"]', 'g');
            if(regex.test(content)) {
                content = content.replace(regex, '$1' + val + '"'); // å‡è®¾ç”¨æˆ·è¾“å…¥æ²¡ç‰¹æ®Šå­—ç¬¦
            } else {
                // 2. API_KEY: "" (å¯¹è±¡å±æ€§)
                regex = new RegExp('(' + varName + '\\\\s*:\\\\s*[\\\'\\"])[\\\'\\"]', 'g');
                content = content.replace(regex, '$1' + val + '"');
            }
            
            const blob = new Blob([content], {type: 'text/javascript'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = item.file.name;
            a.click();
        } catch(e) {
            console.error(e);
            alert('æ–‡ä»¶å¤„ç†å‡ºé”™ï¼Œå¯èƒ½æ˜¯ç¼–ç é—®é¢˜');
        }
    };

    function saveFile(b64, name) {
        const a = document.createElement('a');
        a.href = b64;
        a.download = name;
        a.click();
    }
    
    init();
    `;

    return `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’ä»¶åˆ—è¡¨</title>
    <style>
        body { font-family: sans-serif; background: #f4f6f8; color: #333; padding: 20px; }
        .box { max-width: 1000px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 20px; }
        h1 { margin: 0 0 20px 0; font-size: 20px; color: #333; }
        .tabs { border-bottom: 2px solid #eee; margin-bottom: 20px; display: flex; gap: 10px; }
        .tab { padding: 10px 20px; border: none; background: none; font-size: 15px; cursor: pointer; color: #666; font-weight: bold; border-bottom: 3px solid transparent; }
        .tab.active { color: #2563eb; border-color: #2563eb; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; background: #f8f9fa; padding: 12px; font-size: 13px; color: #666; }
        td { padding: 15px 12px; border-bottom: 1px solid #eee; vertical-align: top; }
        .name { font-weight: bold; font-size: 15px; margin-bottom: 4px; }
        .meta { display: flex; gap: 5px; }
        .tag { font-size: 11px; padding: 1px 6px; border-radius: 4px; }
        .tag-blue { background: #e0f2fe; color: #0369a1; }
        .tag-gray { background: #f3f4f6; color: #4b5563; }
        .note { font-size: 13px; color: #555; }
        .link { font-size: 12px; color: #2563eb; text-decoration: none; display: inline-block; margin-right: 10px; }
        .btn { display: inline-block; padding: 6px 15px; border-radius: 4px; color: white; text-decoration: none; font-size: 13px; cursor: pointer; border: none; width: 100%; text-align: center; margin-bottom: 5px; }
        .btn-pri { background: #2563eb; }
        .btn-green { background: #16a34a; }
        .btn-sm { padding: 4px 8px; width: auto; background: #4b5563; }
        .key-area { background: #fffbeb; border: 1px solid #fde68a; padding: 8px; border-radius: 4px; margin-top: 5px; }
        .key-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .key-row:last-child { margin-bottom: 0; }
        .key-row input { flex: 1; border: 1px solid #ddd; padding: 4px; font-size: 12px; border-radius: 3px; }
        .empty { padding: 40px; text-align: center; color: #999; }
    </style>
</head>
<body>
    <div class="box">
        <h1>æ’ä»¶ä¸‹è½½åˆ—è¡¨</h1>
        <div class="tabs" id="tabs"></div>
        <div id="list"></div>
    </div>
    <script>${clientScript}<\/script>
</body>
</html>`;
}

// å¯åŠ¨
ui.init();
</script>
</body>
</html>