<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ’ä»¶åˆ—è¡¨ç®¡ç†å™¨ v1.3.5</title>
<style>
    :root { --primary: #2563eb; --danger: #dc2626; --success: #16a34a; --bg: #f8fafc; --border: #e2e8f0; --text: #334155; }
    body { font-family: -apple-system, "Microsoft YaHei", sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; font-size: 14px; }
    * { box-sizing: border-box; outline: none; }
    
    /* ä¸»å®¹å™¨ */
    .app { max-width: 1450px; margin: 0 auto; background: white; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); display: flex; flex-direction: column; height: 92vh; border: 1px solid var(--border); }
    
    /* å¤´éƒ¨ */
    .head { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff; border-radius: 8px 8px 0 0; }
    .h-title { font-size: 18px; font-weight: 700; color: #0f172a; display: flex; align-items: center; gap: 8px; }
    .ver-tag { font-size: 12px; background: #eff6ff; color: var(--primary); padding: 2px 8px; border-radius: 12px; border: 1px solid #bfdbfe; }
    
    /* æ ‡ç­¾æ  */
    .tabs { display: flex; gap: 2px; padding: 12px 20px 0; background: #f1f5f9; border-bottom: 1px solid var(--border); overflow-x: auto; }
    .tab { padding: 8px 24px; background: #e2e8f0; border: 1px solid transparent; border-bottom: none; border-radius: 6px 6px 0 0; cursor: pointer; color: #64748b; font-weight: 500; transition: 0.2s; position: relative; top: 1px; white-space: nowrap; }
    .tab:hover { background: #f8fafc; color: var(--primary); }
    .tab.active { background: white; border-color: var(--border); border-bottom-color: white; color: var(--primary); font-weight: 700; z-index: 2; }
    .tab-del { margin-left: 6px; font-size: 14px; color: #94a3b8; border-radius: 50%; width: 18px; height: 18px; display: inline-flex; align-items: center; justify-content: center; }
    .tab-del:hover { background: #fecaca; color: #dc2626; }
    .tab-add { padding: 8px 12px; font-weight: bold; font-size: 16px; color: #64748b; cursor: pointer; }
    .tab-add:hover { color: var(--primary); background: #e2e8f0; border-radius: 6px 6px 0 0; }

    /* å·¥å…·æ  */
    .tools { padding: 12px 20px; display: flex; gap: 10px; align-items: center; background: white; flex-wrap: wrap; border-bottom: 1px solid var(--border); }
    .spacer { flex: 1; }
    .search { padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px; width: 220px; transition: 0.2s; }
    .search:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37,99,235,0.1); }

    /* è¡¨æ ¼åŒºåŸŸ */
    .main-area { flex: 1; overflow-y: auto; position: relative; }
    table { width: 100%; border-collapse: collapse; min-width: 1100px; }
    th { position: sticky; top: 0; background: #f8fafc; z-index: 10; padding: 12px 16px; text-align: left; font-weight: 600; color: #475569; border-bottom: 1px solid var(--border); }
    td { padding: 12px 16px; border-bottom: 1px solid var(--border); vertical-align: top; }
    tr:hover { background: #f8fafc; }

    /* ç»„ä»¶æ ·å¼ */
    .btn { padding: 6px 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; display: inline-flex; align-items: center; gap: 4px; transition: 0.15s; font-family: inherit; }
    .btn:active { transform: translateY(1px); }
    .btn-pri { background: var(--primary); color: white; }
    .btn-pri:hover { background: #1d4ed8; }
    .btn-suc { background: var(--success); color: white; }
    .btn-suc:hover { background: #15803d; }
    .btn-dan { background: var(--danger); color: white; }
    .btn-dan:hover { background: #b91c1c; }
    .btn-sec { background: white; border: 1px solid #cbd5e1; color: #475569; }
    .btn-sec:hover { background: #f1f5f9; border-color: #94a3b8; }
    
    .btn-sm { padding: 3px 8px; font-size: 12px; border-radius: 4px; }
    .btn-icon { padding: 4px; border-radius: 4px; color: #64748b; background: transparent; border: 1px solid transparent; cursor: pointer; }
    .btn-icon:hover { background: #f1f5f9; border-color: #e2e8f0; color: var(--primary); }

    input[type="text"], select { padding: 6px 10px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 13px; width: 100%; }
    input[type="text"]:focus, select:focus { border-color: var(--primary); outline: none; }

    /* æ ‡ç­¾ä¸çŠ¶æ€ */
    .tag-box { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
    .tag { font-size: 12px; padding: 2px 8px; border-radius: 4px; background: #f1f5f9; border: 1px solid #e2e8f0; display: inline-flex; align-items: center; color: #475569; }
    .tag-link { color: #0369a1; background: #e0f2fe; border-color: #bae6fd; }
    .tag-key { color: #b45309; background: #fffbeb; border-color: #fde68a; }
    .tag-dl { color: #15803d; background: #dcfce7; border-color: #bbf7d0; }
    .tag-close { margin-left: 5px; cursor: pointer; opacity: 0.5; font-weight: bold; }
    .tag-close:hover { opacity: 1; color: var(--danger); }

    /* éŸ³è´¨é€‰æ‹©å™¨ç‰¹æ®Šæ ·å¼ */
    .quality-wrapper { display: flex; gap: 4px; align-items: center; }
    .quality-wrapper select { flex: 1; }
    .quality-wrapper input { flex: 1; }

    /* å¼¹çª— */
    .modal-mask { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 50; backdrop-filter: blur(2px); }
    .modal { position: absolute; top: 15%; left: 50%; transform: translateX(-50%); background: white; width: 480px; padding: 24px; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); animation: slideDown 0.2s ease-out; }
    @keyframes slideDown { from { transform: translate(-50%, -20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
    .m-head { font-size: 18px; font-weight: 700; margin-bottom: 20px; display: flex; justify-content: space-between; }
    .m-body { margin-bottom: 20px; }
    .m-foot { text-align: right; display: flex; justify-content: flex-end; gap: 10px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: #64748b; }
    .chk-row { display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; transition: 0.1s; }
    .chk-row:hover { background: #f8fafc; border-color: #cbd5e1; }
    .chk-row input { width: 16px; height: 16px; accent-color: var(--primary); }

    .empty-tip { text-align: center; padding: 60px; color: #94a3b8; font-style: italic; }
</style>
</head>
<body>

<div class="app">
    <div class="head">
        <div class="h-title">
            æ’ä»¶åˆ—è¡¨ç®¡ç†å™¨ <span class="ver-tag">v1.3.5</span>
        </div>
        <div style="font-size:12px; color:#94a3b8" id="lastSaveTime">å°±ç»ª</div>
    </div>

    <!-- æ ‡ç­¾æ  (JSç”Ÿæˆ) -->
    <div class="tabs" id="tabsBar"></div>

    <!-- å·¥å…·æ  -->
    <div class="tools">
        <button class="btn btn-suc" onclick="app.addItem()">â• æ–°å¢æ–‡ä»¶</button>
        <button class="btn btn-pri" onclick="app.exportHtml()">ğŸ“¤ å¯¼å‡ºåˆ—è¡¨</button>
        <button class="btn btn-sec" onclick="app.exportJson()">ğŸ’¾ å¤‡ä»½æ•°æ®</button>
        
        <div class="spacer"></div>
        
        <input type="file" id="importFile" hidden onchange="app.importJson(this)">
        <button class="btn btn-sec" onclick="document.getElementById('importFile').click()">ğŸ“‚ å¯¼å…¥æ—§ç‰ˆ/å¤‡ä»½</button>
        <button class="btn btn-dan" onclick="app.clearTab()">ğŸ—‘ï¸ æ¸…ç©ºå½“å‰é¡µ</button>
        
        <input type="text" class="search" placeholder="ğŸ” æœç´¢æ–‡ä»¶å..." id="searchInput" onkeyup="app.render()">
    </div>

    <!-- åˆ—è¡¨ -->
    <div class="main-area">
        <table id="mainTable">
            <thead>
                <tr>
                    <th width="60">æ’åº</th>
                    <th width="25%">æ–‡ä»¶å & çŠ¶æ€</th>
                    <th width="20%">éŸ³è´¨ & ç‰ˆæœ¬</th>
                    <th width="35%">é…ç½® (å¤‡æ³¨ / é“¾æ¥ / Key)</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<!-- å¼¹çª—ï¼šæ ‡ç­¾é¡µç®¡ç† -->
<div id="modalTabs" class="modal-mask">
    <div class="modal">
        <div class="m-head">æ ‡ç­¾é¡µé€‰é¡¹ <span style="cursor:pointer" onclick="ui.close()">Ã—</span></div>
        <div class="m-body">
            <div class="form-group">
                <label>å†…ç½®æ ‡ç­¾é¡µå¼€å…³:</label>
                <div style="display:flex; gap:10px">
                    <label class="chk-row" style="flex:1">
                        <input type="checkbox" id="chk_mf" onchange="app.toggleTabConfig('showMF')"> Music Free
                    </label>
                    <label class="chk-row" style="flex:1">
                        <input type="checkbox" id="chk_ly" onchange="app.toggleTabConfig('showLY')"> æ¾œéŸ³
                    </label>
                </div>
            </div>
            <div class="form-group" style="margin-top:20px; padding-top:20px; border-top:1px dashed #e2e8f0">
                <label>æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾é¡µ:</label>
                <div style="display:flex; gap:8px">
                    <input type="text" id="newTabName" placeholder="è¾“å…¥æ ‡ç­¾åç§°...">
                    <button class="btn btn-pri" onclick="app.addCustomTab()">æ·»åŠ </button>
                </div>
                <p style="font-size:12px; color:#94a3b8; margin-top:8px">æç¤ºï¼šè‡ªå®šä¹‰æ ‡ç­¾é¡µå¯åœ¨ä¸Šæ–¹æ ‡ç­¾æ ç›´æ¥åˆ é™¤ã€‚åªæœ‰ LX é¡µæ”¯æŒ Key é…ç½®ã€‚</p>
            </div>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šKey é…ç½® -->
<div id="modalKey" class="modal-mask">
    <div class="modal">
        <div class="m-head">Key é…ç½® (ä»… LX æœ‰æ•ˆ) <span style="cursor:pointer" onclick="ui.close()">Ã—</span></div>
        <div class="m-body">
            <div class="form-group p-2 border rounded mb-3 bg-slate-50">
                <label class="chk-row" style="border:none; padding:0; margin-bottom:5px; font-weight:bold; color:#b45309">
                    <input type="checkbox" id="k_enable_url"> å¯ç”¨åœ¨çº¿å¯¼å…¥ (URLæ‹¼æ¥)
                </label>
                <input type="text" id="k_url" placeholder="https://api.example.com?key=">
            </div>
            <div class="form-group p-2 border rounded bg-slate-50">
                <label class="chk-row" style="border:none; padding:0; margin-bottom:5px; font-weight:bold; color:#b45309">
                    <input type="checkbox" id="k_enable_var"> å¯ç”¨æœ¬åœ°å¯¼å…¥ (å˜é‡æ›¿æ¢)
                </label>
                <input type="text" id="k_var" placeholder="å˜é‡å, å¦‚: API_KEY">
            </div>
        </div>
        <div class="m-foot">
            <button class="btn btn-pri" onclick="app.saveKey()">ä¿å­˜é…ç½®</button>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šæ·»åŠ é“¾æ¥ -->
<div id="modalLink" class="modal-mask">
    <div class="modal">
        <div class="m-head">æ·»åŠ é“¾æ¥ <span style="cursor:pointer" onclick="ui.close()">Ã—</span></div>
        <div class="m-body">
            <div class="form-group"><label>é“¾æ¥åç§°</label><input type="text" id="l_text" placeholder="å®˜ç½‘ / è¯´æ˜ / è´­ä¹°é¡µ"></div>
            <div class="form-group"><label>URLåœ°å€</label><input type="text" id="l_url" placeholder="http://..."></div>
        </div>
        <div class="m-foot"><button class="btn btn-pri" onclick="app.saveLink()">ç¡®å®šæ·»åŠ </button></div>
    </div>
</div>

<!-- å¼¹çª—ï¼šç›´é“¾é…ç½® -->
<div id="modalDl" class="modal-mask">
    <div class="modal">
        <div class="m-head">é…ç½®ç›´é“¾ä¸‹è½½ <span style="cursor:pointer" onclick="ui.close()">Ã—</span></div>
        <div class="m-body">
            <div class="form-group">
                <label>ç›´é“¾ URL:</label>
                <input type="text" id="d_url" placeholder="http://...">
                <p style="font-size:12px; color:#94a3b8; margin-top:5px">è®¾ç½®åï¼Œå¯¼å‡ºåˆ—è¡¨ä¸­å°†æ˜¾ç¤ºâ€œç›´é“¾ä¸‹è½½â€æŒ‰é’®ï¼Œå¯ä»£æ›¿æœ¬åœ°æ–‡ä»¶ä¸‹è½½ã€‚</p>
            </div>
        </div>
        <div class="m-foot"><button class="btn btn-pri" onclick="app.saveDl()">ä¿å­˜</button></div>
    </div>
</div>

<script>
/**
 * æ ¸å¿ƒé€»è¾‘ v1.3.5
 * é’ˆå¯¹æœ¬åœ°è¿è¡Œä¼˜åŒ–ï¼Œæ— å¤–éƒ¨ä¾èµ–ã€‚
 */

// é¢„è®¾éŸ³è´¨åˆ—è¡¨ (LX/æ¾œéŸ³ä¸“ç”¨)
const PRESET_QUALITIES = ['128k', '320k', 'flac', 'flac24bit', 'master', 'dolby', 'sky'];

const app = {
    // æ•°æ®æ¨¡å‹
    data: {
        config: { showMF: false, showLY: false },
        customTabs: [],
        items: [],
        activeTab: 'LX'
    },
    
    // è¿è¡Œæ—¶çŠ¶æ€
    state: { editId: null },

    init() {
        this.load();
        this.renderTabs();
        this.render();
        this.updateTime();
    },

    // --- æ•°æ®æŒä¹…åŒ– ---
    save() {
        try {
            localStorage.setItem('pm_v135_db', JSON.stringify(this.data));
            this.updateTime();
        } catch(e) { console.error("Save failed:", e); }
    },

    load() {
        const raw = localStorage.getItem('pm_v135_db');
        if(raw) {
            try {
                const json = JSON.parse(raw);
                if(json.items) this.data = json;
            } catch(e) { console.error("Load failed:", e); }
        }
    },

    updateTime() {
        const now = new Date();
        document.getElementById('lastSaveTime').innerText = 'æœ€åä¿å­˜: ' + 
            now.getHours().toString().padStart(2,'0') + ':' + 
            now.getMinutes().toString().padStart(2,'0') + ':' + 
            now.getSeconds().toString().padStart(2,'0');
    },

    // --- æ ‡ç­¾é¡µé€»è¾‘ ---
    getTabs() {
        let list = ['LX'];
        if(this.data.config.showMF) list.push('Music Free');
        if(this.data.config.showLY) list.push('æ¾œéŸ³');
        return list.concat(this.data.customTabs);
    },

    renderTabs() {
        const tabs = this.getTabs();
        // ä¿®æ­£å½“å‰ activeTab
        if(!tabs.includes(this.data.activeTab)) this.data.activeTab = 'LX';

        const html = tabs.map(t => {
            const isActive = t === this.data.activeTab;
            const isCustom = this.data.customTabs.includes(t);
            // åªæœ‰è‡ªå®šä¹‰æ ‡ç­¾æ˜¾ç¤ºåˆ é™¤X
            const delBtn = isCustom ? `<span class="tab-del" onclick="app.delCustomTab('${t}', event)">Ã—</span>` : '';
            return `<div class="tab ${isActive?'active':''}" onclick="app.switchTab('${t}')">${t} ${delBtn}</div>`;
        }).join('');
        
        // åŠ ä¸Šæ·»åŠ æŒ‰é’®
        document.getElementById('tabsBar').innerHTML = html + `<div class="tab-add" onclick="ui.openTabOpt()" title="ç®¡ç†æ ‡ç­¾é¡µ">+</div>`;
    },

    switchTab(t) {
        this.data.activeTab = t;
        this.save();
        this.renderTabs();
        this.render();
    },

    toggleTabConfig(key) {
        const chk = document.getElementById(key === 'showMF' ? 'chk_mf' : 'chk_ly');
        this.data.config[key] = chk.checked;
        this.save();
        this.renderTabs();
        this.render();
    },

    addCustomTab() {
        const name = document.getElementById('newTabName').value.trim();
        if(!name) return;
        if(this.getTabs().includes(name)) return alert('æ ‡ç­¾åå·²å­˜åœ¨');
        this.data.customTabs.push(name);
        this.data.activeTab = name;
        this.save();
        this.renderTabs();
        this.render();
        ui.close();
        document.getElementById('newTabName').value = '';
    },

    delCustomTab(name, e) {
        e.stopPropagation();
        if(confirm(`ç¡®å®šåˆ é™¤æ ‡ç­¾ "${name}" å—ï¼Ÿè¯¥æ ‡ç­¾ä¸‹çš„æ–‡ä»¶ä¼šè¢«éšè—ä½†ä¸ä¼šåˆ é™¤ã€‚`)) {
            this.data.customTabs = this.data.customTabs.filter(t => t !== name);
            if(this.data.activeTab === name) this.data.activeTab = 'LX';
            this.save();
            this.renderTabs();
            this.render();
        }
    },

    clearTab() {
        if(confirm(`ç¡®å®šæ¸…ç©ºå½“å‰é¡µ (${this.data.activeTab}) çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
            this.data.items = this.data.items.filter(i => i.tab !== this.data.activeTab);
            this.save();
            this.render();
        }
    },

    // --- åˆ—è¡¨æ¸²æŸ“é€»è¾‘ ---
    render() {
        const tbody = document.getElementById('tableBody');
        const kw = document.getElementById('searchInput').value.toLowerCase();
        const curTab = this.data.activeTab;
        
        const list = this.data.items.filter(i => {
            // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœæ²¡æœ‰tabå­—æ®µï¼Œé»˜è®¤å½’ä¸ºLX
            const iTab = i.tab || 'LX';
            return iTab === curTab && (!kw || (i.name||'').toLowerCase().includes(kw));
        });

        if(list.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="empty-tip">æš‚æ— å†…å®¹ï¼Œè¯·ç‚¹å‡»å·¦ä¸Šè§’â€œæ–°å¢æ–‡ä»¶â€</td></tr>`;
            return;
        }

        // åˆ¤æ–­å½“å‰æ ‡ç­¾é¡µæ˜¯å¦æ”¯æŒéŸ³è´¨ä¸‹æ‹‰ï¼ˆLXå’Œæ¾œéŸ³ï¼‰
        const supportQualityPreset = ['LX', 'æ¾œéŸ³'].includes(curTab);
        // Music Free æ”¯æŒ .js å’Œ .jsonï¼Œå…¶ä»–åªæ”¯æŒ .js
        const acceptType = curTab === 'Music Free' ? '.js,.json' : '.js';

        tbody.innerHTML = list.map(item => {
            const hasFile = !!(item.file && item.file.content);
            const statusBadge = hasFile 
                ? `<span style="color:var(--success);font-size:12px;background:#dcfce7;padding:1px 6px;border-radius:4px;">âœ… å·²ä¸Šä¼  (${formatSize(item.file.size)})</span>`
                : `<span style="color:var(--danger);font-size:12px;background:#fee2e2;padding:1px 6px;border-radius:4px;">âš ï¸ æœªä¸Šä¼ </span>`;

            // 1. æ„å»ºéŸ³è´¨/ç‰ˆæœ¬ UI
            let qualityUi = '';
            if (supportQualityPreset) {
                // å¦‚æœå½“å‰å€¼ä¸åœ¨é¢„è®¾ä¸­ï¼Œä¸”ä¸ä¸ºç©ºï¼Œåˆ™è®¤ä¸ºæ˜¯è‡ªå®šä¹‰æ¨¡å¼
                const isCustomMode = item.quality && !PRESET_QUALITIES.includes(item.quality);
                
                if (isCustomMode) {
                    // è‡ªå®šä¹‰æ¨¡å¼ï¼šè¾“å…¥æ¡† + é‡ç½®æŒ‰é’®
                    qualityUi = `
                        <div style="display:flex;gap:4px">
                            <input type="text" value="${esc(item.quality)}" onchange="app.updateItem(${item.id}, 'quality', this.value)" placeholder="è¾“å…¥éŸ³è´¨...">
                            <button class="btn btn-sec btn-sm" onclick="app.updateItem(${item.id}, 'quality', '')" title="é‡ç½®ä¸ºä¸‹æ‹‰èœå•">â†º</button>
                        </div>
                    `;
                } else {
                    // ä¸‹æ‹‰æ¨¡å¼
                    const options = PRESET_QUALITIES.map(q => `<option value="${q}" ${item.quality===q?'selected':''}>${q}</option>`).join('');
                    // ç»‘å®šç‰¹æ®Šçš„ change äº‹ä»¶ï¼šå¦‚æœé€‰äº† CUSTOMï¼Œåˆ™åˆ‡æ¢æ¨¡å¼
                    qualityUi = `
                        <select onchange="if(this.value==='_CUSTOM_'){app.updateItem(${item.id},'quality','è‡ªå®šä¹‰');}else{app.updateItem(${item.id},'quality',this.value);}">
                            <option value="">é€‰æ‹©éŸ³è´¨...</option>
                            ${options}
                            <option value="_CUSTOM_">âœ è‡ªå®šä¹‰...</option>
                        </select>
                    `;
                }
            } else {
                // æ™®é€šè¾“å…¥æ¡†
                qualityUi = `<input type="text" value="${esc(item.quality)}" onchange="app.updateItem(${item.id}, 'quality', this.value)" placeholder="éŸ³è´¨æè¿°">`;
            }
            // ç‰ˆæœ¬å·è¾“å…¥æ¡†å§‹ç»ˆæ˜¾ç¤º
            qualityUi += `<input type="text" value="${esc(item.ver)}" onchange="app.updateItem(${item.id}, 'ver', this.value)" placeholder="ç‰ˆæœ¬å· (å¯é€‰)" style="margin-top:4px;color:#666">`;

            // 2. æ ‡ç­¾æ˜¾ç¤º
            let tags = '';
            if(item.dlLink) tags += `<span class="tag tag-dl">ç›´é“¾ <span class="tag-close" onclick="app.updateItem(${item.id}, 'dlLink', '')">Ã—</span></span>`;
            (item.links||[]).forEach((l, idx) => {
                tags += `<span class="tag tag-link"><a href="${l.url}" target="_blank" style="text-decoration:none;color:inherit">${l.text}</a> <span class="tag-close" onclick="app.delLink(${item.id}, ${idx})">Ã—</span></span>`;
            });
            // Key çŠ¶æ€ (ä»… LX æ˜¾ç¤º)
            if(curTab === 'LX') {
                if(item.keyConfig?.enableUrl) tags += `<span class="tag tag-key">Keyåœ¨çº¿ <span class="tag-close" onclick="app.toggleKeyConfig(${item.id}, 'enableUrl', false)">Ã—</span></span>`;
                if(item.keyConfig?.enableVar) tags += `<span class="tag tag-key">Keyæœ¬åœ° <span class="tag-close" onclick="app.toggleKeyConfig(${item.id}, 'enableVar', false)">Ã—</span></span>`;
            }

            // 3. æŒ‰é’®
            const uploadBtn = `<input type="file" id="f_${item.id}" style="display:none" accept="${acceptType}" onchange="app.uploadFile(${item.id}, this)">
                <button class="btn btn-pri btn-sm" onclick="document.getElementById('f_${item.id}').click()">${hasFile?'é‡ä¼ ':'ä¸Šä¼ '}</button>`;
            
            const configBtns = `
                <div style="display:flex;gap:4px;margin-bottom:4px;flex-wrap:wrap">
                    <button class="btn-icon" onclick="app.openLinkModal(${item.id})" title="æ·»åŠ é“¾æ¥">ğŸ”—</button>
                    <button class="btn-icon" onclick="app.openDlModal(${item.id})" title="é…ç½®ç›´é“¾">ğŸŒ</button>
                    ${curTab==='LX' ? `<button class="btn-icon" onclick="app.openKeyModal(${item.id})" title="é…ç½®Key">ğŸ”‘</button>` : ''}
                </div>
            `;

            return `
                <tr>
                    <td align="center">
                        <div style="display:flex;flex-direction:column;gap:2px">
                            <button class="btn-icon" onclick="app.moveItem(${item.id}, -1)">â–²</button>
                            <button class="btn-icon" onclick="app.moveItem(${item.id}, 1)">â–¼</button>
                        </div>
                    </td>
                    <td>
                        <input type="text" value="${esc(item.name)}" onchange="app.updateItem(${item.id}, 'name', this.value)" placeholder="æ’ä»¶æ–‡ä»¶å" style="font-weight:bold;margin-bottom:4px">
                        <div>${statusBadge} ${uploadBtn}</div>
                    </td>
                    <td valign="top">${qualityUi}</td>
                    <td>
                        <input type="text" value="${esc(item.note)}" onchange="app.updateItem(${item.id}, 'note', this.value)" placeholder="å¤‡æ³¨è¯´æ˜..." style="margin-bottom:4px">
                        ${configBtns}
                        <div class="tag-box">${tags}</div>
                    </td>
                    <td>
                        <div style="display:flex;gap:4px;flex-wrap:wrap">
                            ${hasFile ? `<button class="btn btn-suc btn-sm" onclick="app.dlLocal(${item.id})">ä¸‹è½½</button>` : ''}
                            <button class="btn btn-dan btn-sm" onclick="app.delItem(${item.id})">åˆ é™¤</button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    },

    // --- æ•°æ®æ“ä½œ ---
    addItem() {
        this.data.items.push({
            id: Date.now(),
            tab: this.data.activeTab,
            name: '', ver: '', quality: '', note: '',
            file: null, // { content: base64, size: int }
            links: [], dlLink: '',
            keyConfig: { enableUrl: false, url: '', enableVar: false, var: '' }
        });
        this.save();
        this.render();
    },

    updateItem(id, field, val) {
        const item = this.data.items.find(i => i.id === id);
        if(item) {
            item[field] = val;
            this.save();
            // å¦‚æœæ˜¯ä¿®æ”¹éŸ³è´¨(æ¶‰åŠUIåˆ‡æ¢)æˆ–dlLink(æ¶‰åŠæ ‡ç­¾)ï¼Œéœ€è¦é‡ç»˜
            if(field === 'quality' || field === 'dlLink') this.render();
        }
    },

    delItem(id) {
        if(confirm('ç¡®å®šåˆ é™¤æ­¤æ¡ç›®ï¼Ÿ')) {
            this.data.items = this.data.items.filter(i => i.id !== id);
            this.save();
            this.render();
        }
    },

    moveItem(id, dir) {
        const idx = this.data.items.findIndex(i => i.id === id);
        if(idx === -1) return;
        const target = idx + dir;
        if(target >= 0 && target < this.data.items.length) {
            [this.data.items[idx], this.data.items[target]] = [this.data.items[target], this.data.items[idx]];
            this.save();
            this.render();
        }
    },

    uploadFile(id, input) {
        const file = input.files[0];
        if(!file) return;
        const r = new FileReader();
        r.onload = e => {
            const item = this.data.items.find(i => i.id === id);
            if(item) {
                if(!item.name) item.name = file.name;
                item.file = { content: e.target.result, size: file.size };
                this.save();
                this.render();
            }
        };
        r.readAsDataURL(file);
        input.value = '';
    },

    dlLocal(id) {
        const item = this.data.items.find(i => i.id === id);
        if(item && item.file) {
            const a = document.createElement('a');
            a.href = item.file.content;
            a.download = item.name || 'download';
            a.click();
        }
    },

    // --- Key é…ç½®é€»è¾‘ ---
    openKeyModal(id) {
        this.state.editId = id;
        const item = this.data.items.find(i => i.id === id);
        const k = item.keyConfig || {};
        ui.setCheck('k_enable_url', k.enableUrl);
        ui.setVal('k_url', k.url || '');
        ui.setCheck('k_enable_var', k.enableVar);
        ui.setVal('k_var', k.var || '');
        ui.open('modalKey');
    },
    saveKey() {
        const item = this.data.items.find(i => i.id === this.state.editId);
        if(item) {
            item.keyConfig = {
                enableUrl: ui.getCheck('k_enable_url'),
                url: ui.getVal('k_url'),
                enableVar: ui.getCheck('k_enable_var'),
                var: ui.getVal('k_var')
            };
            this.save();
            this.render();
        }
        ui.close();
    },
    toggleKeyConfig(id, type, val) {
        const item = this.data.items.find(i => i.id === id);
        if(item && item.keyConfig) {
            item.keyConfig[type] = val;
            this.save();
            this.render();
        }
    },

    // --- é“¾æ¥/ç›´é“¾é€»è¾‘ ---
    openLinkModal(id) {
        this.state.editId = id;
        ui.setVal('l_text', '');
        ui.setVal('l_url', '');
        ui.open('modalLink');
    },
    saveLink() {
        const item = this.data.items.find(i => i.id === this.state.editId);
        const text = ui.getVal('l_text');
        const url = ui.getVal('l_url');
        if(item && text && url) {
            if(!item.links) item.links = [];
            item.links.push({text, url});
            this.save();
            this.render();
        }
        ui.close();
    },
    delLink(itemId, idx) {
        const item = this.data.items.find(i => i.id === itemId);
        if(item) {
            item.links.splice(idx, 1);
            this.save();
            this.render();
        }
    },
    openDlModal(id) {
        this.state.editId = id;
        const item = this.data.items.find(i => i.id === id);
        ui.setVal('d_url', item.dlLink || '');
        ui.open('modalDl');
    },
    saveDl() {
        this.updateItem(this.state.editId, 'dlLink', ui.getVal('d_url'));
        ui.close();
    },

    // --- å¯¼å…¥å¯¼å‡º (å…¼å®¹æ ¸å¿ƒ) ---
    exportJson() {
        const blob = new Blob([JSON.stringify(this.data, null, 2)], {type:'application/json'});
        saveAs(blob, `å¤‡ä»½_${Date.now()}.json`);
    },
    
    importJson(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const json = JSON.parse(e.target.result);
                // å…¼å®¹æ€§å¤„ç†
                if(Array.isArray(json)) {
                    // æ—§ç‰ˆæ•°ç»„ï¼šåªåŒ…å«æ–‡ä»¶åˆ—è¡¨ï¼Œé»˜è®¤å…¨éƒ¨æ”¾å…¥LX
                    if(confirm("æ£€æµ‹åˆ°æ—§ç‰ˆå¤‡ä»½æ•°æ®ï¼Œæ˜¯å¦å¯¼å…¥åˆ° LX æ ‡ç­¾é¡µï¼Ÿ")) {
                        const newItems = json.map(old => normalizeOldItem(old));
                        // è¿½åŠ åˆ°ç°æœ‰æ•°æ®è¿˜æ˜¯è¦†ç›–ï¼Ÿè¿™é‡Œé€‰æ‹©è¦†ç›–itemsä½†ä¿ç•™é…ç½®
                        this.data.items = newItems;
                        this.data.config = { showMF: false, showLY: false }; // é‡ç½®é…ç½®å› ä¸ºæ—§ç‰ˆæ²¡æœ‰
                        this.data.customTabs = [];
                        this.data.activeTab = 'LX';
                        this.save();
                        this.renderTabs();
                        this.render();
                        alert('å¯¼å…¥æˆåŠŸï¼');
                    }
                } else if (json.items) {
                    // æ–°ç‰ˆæ•°æ®
                    this.data = json;
                    this.save();
                    this.renderTabs();
                    this.render();
                    alert('å¯¼å…¥æˆåŠŸï¼');
                } else {
                    alert('æ— æ³•è¯†åˆ«çš„æ•°æ®æ ¼å¼');
                }
            } catch(err) {
                console.error(err);
                alert('JSON è§£æå¤±è´¥');
            }
        };
        reader.readAsText(file);
        input.value = '';
    },

    exportHtml() {
        const html = generateExportHtml(this.data);
        const blob = new Blob([html], {type:'text/html'});
        saveAs(blob, `æ’ä»¶åˆ—è¡¨_${getDs()}.html`);
    }
};

// --- è¾…åŠ©å‡½æ•° ---
function normalizeOldItem(old) {
    // å°†æ—§ç‰ˆæ•°æ®ç»“æ„è½¬æ¢ä¸º v1.3.5 ç»“æ„
    return {
        id: old.id || Date.now() + Math.random(),
        tab: 'LX', // é»˜è®¤ä¸º LX
        name: old.fileName || old.name || '',
        ver: '', // æ—§ç‰ˆå¯èƒ½æ²¡æœ‰ç‰ˆæœ¬å·
        quality: old.quality || '',
        note: old.note || '',
        file: (old.fileContent) ? { content: old.fileContent, size: old.fileSize || 0 } : null,
        links: old.links || [],
        dlLink: old.directUrl || '', // æ—§ç‰ˆ directUrl -> dlLink
        keyConfig: {
            // keyMode ä¸º "link" -> enableUrl
            enableUrl: (old.keyMode === 'link' || !!old.keyUrl),
            url: old.keyUrl || '',
            // keyMode ä¸º "local" (æˆ– implied) -> enableVar
            enableVar: (old.keyVariable && old.keyVariable !== ""),
            var: old.keyVariable || ''
        }
    };
}

const ui = {
    open(id) { document.getElementById(id).style.display = 'block'; },
    close() { document.querySelectorAll('.modal-mask').forEach(e=>e.style.display='none'); app.state.editId=null; },
    openTabOpt() {
        document.getElementById('chk_mf').checked = app.data.config.showMF;
        document.getElementById('chk_ly').checked = app.data.config.showLY;
        this.open('modalTabs');
    },
    getVal(id) { return document.getElementById(id).value; },
    setVal(id, v) { document.getElementById(id).value = v; },
    getCheck(id) { return document.getElementById(id).checked; },
    setCheck(id, v) { document.getElementById(id).checked = v; }
};

function esc(s) { return s ? s.replace(/"/g, "&quot;") : ""; }
function formatSize(b) { 
    if(!b) return ''; 
    if(b < 1024) return b + 'B';
    if(b < 1024*1024) return (b/1024).toFixed(1) + 'KB';
    return (b/(1024*1024)).toFixed(1) + 'MB'; 
}
function getDs() { return new Date().toISOString().slice(0,10); }
function saveAs(blob, name) {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
}

// --- å¯¼å‡º HTML ç”Ÿæˆé€»è¾‘ (å†…åµŒï¼Œç¡®ä¿æ— ä¾èµ–) ---
function generateExportHtml(data) {
    // å°†æ•°æ®åºåˆ—åŒ–å¹¶åµŒå…¥ JS
    const jsonStr = JSON.stringify(data);
    
    return `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ’ä»¶åˆ—è¡¨</title>
<style>
body{font-family:-apple-system,sans-serif;background:#f4f6f8;color:#333;margin:0;padding:20px}
.box{max-width:1000px;margin:0 auto;background:white;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.05);overflow:hidden}
.tabs{background:#f9fafb;border-bottom:1px solid #e5e7eb;display:flex;overflow-x:auto}
.tab{padding:12px 20px;cursor:pointer;font-weight:500;color:#6b7280;white-space:nowrap}
.tab.active{background:white;color:#2563eb;font-weight:700;border-top:2px solid #2563eb}
table{width:100%;border-collapse:collapse}
th{text-align:left;background:#f9fafb;padding:12px 15px;color:#4b5563;font-size:13px;border-bottom:1px solid #e5e7eb}
td{padding:12px 15px;border-bottom:1px solid #e5e7eb;vertical-align:top}
.tag{display:inline-block;padding:2px 6px;font-size:12px;border-radius:4px;margin-right:4px;background:#e0f2fe;color:#0284c7}
.ver{background:#f3f4f6;color:#4b5563}
.link{color:#2563eb;text-decoration:none;margin-right:8px;font-size:12px}
.btn{display:inline-block;padding:6px 12px;background:#2563eb;color:white;border-radius:4px;text-decoration:none;font-size:12px;border:none;cursor:pointer}
.btn-dl{background:#16a34a}
.key-area{margin-top:5px;background:#fffbeb;padding:8px;border-radius:4px;border:1px solid #fef3c7}
.key-row{display:flex;gap:5px;margin-bottom:5px}
.key-row:last-child{margin-bottom:0}
input{border:1px solid #d1d5db;padding:4px;flex:1;border-radius:4px}
.empty{text-align:center;padding:40px;color:#9ca3af}
</style>
</head>
<body>
<div class="box">
    <div style="padding:15px 20px;border-bottom:1px solid #eee;font-weight:bold;font-size:18px">æ’ä»¶åˆ—è¡¨</div>
    <div class="tabs" id="t"></div>
    <div id="c"></div>
</div>
<script>
const DB=${jsonStr};
let cur='LX';
function getTabs(){
    let l=['LX'];
    if(DB.config.showMF)l.push('Music Free');
    if(DB.config.showLY)l.push('æ¾œéŸ³');
    return l.concat(DB.customTabs);
}
function rT(){
    const ts=getTabs();
    if(!ts.includes(cur)) cur='LX';
    document.getElementById('t').innerHTML=ts.map(t=>'<div class="tab '+(t===cur?'active':'')+'" onclick="sT(\\''+t+'\\')">'+t+'</div>').join('');
}
function sT(t){cur=t;rT();rL();}
function rL(){
    const l=DB.items.filter(i=>(i.tab||'LX')===cur);
    const b=document.getElementById('c');
    if(!l.length){b.innerHTML='<div class="empty">æš‚æ— å†…å®¹</div>';return;}
    let h='<table><thead><tr><th>åç§°</th><th>ç‰ˆæœ¬/éŸ³è´¨</th><th>è¯´æ˜ & é“¾æ¥</th><th width="200">ä¸‹è½½</th></tr></thead><tbody>';
    h+=l.map(i=>{
        let tags='';
        if(i.quality)tags+='<span class="tag">'+i.quality+'</span>';
        if(i.ver)tags+='<span class="tag ver">v'+i.ver+'</span>';
        let ls=(i.links||[]).map(k=>'<a href="'+k.url+'" target="_blank" class="link">ğŸ”— '+k.text+'</a>').join('');
        let dl='';
        if(i.dlLink) dl+='<a href="'+i.dlLink+'" target="_blank" class="btn">ğŸŒ ç›´é“¾</a> ';
        if(i.file&&i.file.content){
            const k=i.keyConfig||{};
            const su=(cur==='LX'&&k.enableUrl&&k.url);
            const sv=(cur==='LX'&&k.enableVar&&k.var);
            if(!su&&!sv){
                dl+='<button class="btn btn-dl" onclick="D('+i.id+')">â¬‡ï¸ ä¸‹è½½</button>';
            }else{
                dl+='<div class="key-area">';
                if(su) dl+='<div class="key-row"><input id="ku_'+i.id+'" placeholder="Key"><button onclick="KU('+i.id+')">Go</button></div>';
                if(sv) dl+='<div class="key-row"><input id="kv_'+i.id+'" placeholder="Key"><button onclick="KV('+i.id+')">ä¸‹è½½</button></div>';
                dl+='</div>';
            }
        }
        return '<tr><td><b>'+i.name+'</b></td><td>'+tags+'</td><td>'+(i.note||'-')+'<br>'+ls+'</td><td>'+dl+'</td></tr>';
    }).join('');
    b.innerHTML=h+'</tbody></table>';
}
window.D=id=>{
    const i=DB.items.find(x=>x.id==id);
    save(i.file.content,i.name);
};
window.KU=id=>{
    const i=DB.items.find(x=>x.id==id);
    const v=document.getElementById('ku_'+id).value;
    if(v) window.open(i.keyConfig.url+v);
};
window.KV=id=>{
    const i=DB.items.find(x=>x.id==id);
    const v=document.getElementById('kv_'+id).value;
    if(!v)return alert('è¯·è¾“å…¥Key');
    try{
        const raw=atob(i.file.content.split(',')[1]);
        const u8=new Uint8Array(raw.length);
        for(let n=0;n<raw.length;n++)u8[n]=raw.charCodeAt(n);
        let txt=new TextDecoder().decode(u8);
        const vn=i.keyConfig.var;
        // ç®€å•æ›¿æ¢ key
        const re=new RegExp('((?:const|var|let)\\\\s+'+vn+'\\\\s*[:=]\\\\s*)[\\'\\"][\\'\\"]','g');
        if(re.test(txt)){
           txt=txt.replace(re,'$1"'+v+'"');
           const b=new Blob([txt],{type:'text/javascript'});
           const a=document.createElement('a');
           a.href=URL.createObjectURL(b);
           a.download=i.name;
           a.click();
        }else{alert('æœªæ‰¾åˆ°å˜é‡: '+vn);}
    }catch(e){console.error(e);alert('å¤„ç†å‡ºé”™');}
};
function save(u,n){const a=document.createElement('a');a.href=u;a.download=n;a.click();}
rT();rL();
<\/script></body></html>`;
}

// å¯åŠ¨åº”ç”¨
app.init();
</script>
</body>
</html>