<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ’ä»¶åˆ—è¡¨ç®¡ç†å™¨ v1.3.6</title>
<style>
    /* åŸºç¡€å˜é‡ä¸é‡ç½® */
    :root { 
        --primary: #3b82f6; --primary-hover: #2563eb;
        --danger: #ef4444; --danger-hover: #dc2626;
        --success: #22c55e; --text-main: #334155; --text-sub: #64748b;
        --bg: #f1f5f9; --border: #cbd5e1; --white: #ffffff;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft YaHei", sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 20px; font-size: 14px; display: flex; justify-content: center; }
    * { box-sizing: border-box; outline: none; }
    
    /* ä¸»çª—å£ */
    .app-container { width: 100%; max-width: 1400px; background: var(--white); border-radius: 10px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); display: flex; flex-direction: column; height: 92vh; border: 1px solid var(--border); overflow: hidden; }
    
    /* é¡¶éƒ¨å¯¼èˆª */
    .header { padding: 16px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff; }
    .app-title { font-size: 20px; font-weight: 700; color: #0f172a; display: flex; align-items: center; gap: 10px; }
    .version-badge { font-size: 12px; background: #eff6ff; color: var(--primary); padding: 2px 8px; border-radius: 99px; border: 1px solid #bfdbfe; font-weight: 500; }
    .status-text { color: #94a3b8; font-size: 12px; }

    /* æ ‡ç­¾æ  */
    .tabs-container { display: flex; align-items: flex-end; padding: 0 20px; background: #f8fafc; border-bottom: 1px solid var(--border); overflow-x: auto; gap: 4px; }
    .tab-item { padding: 10px 24px; cursor: pointer; color: var(--text-sub); font-weight: 500; border: 1px solid transparent; border-bottom: none; border-radius: 8px 8px 0 0; transition: all 0.2s; position: relative; bottom: -1px; white-space: nowrap; }
    .tab-item:hover { color: var(--primary); background: #e2e8f0; }
    .tab-item.active { background: var(--white); color: var(--primary); border-color: var(--border); border-bottom-color: var(--white); font-weight: 700; }
    .tab-close { margin-left: 6px; font-size: 14px; width: 16px; height: 16px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; color: #cbd5e1; }
    .tab-close:hover { background: #fee2e2; color: var(--danger); }
    .tab-add-btn { padding: 10px 14px; cursor: pointer; color: var(--text-sub); font-size: 18px; font-weight: bold; line-height: 1; opacity: 0.6; }
    .tab-add-btn:hover { opacity: 1; color: var(--primary); }

    /* å·¥å…·æ  */
    .toolbar { padding: 12px 24px; display: flex; gap: 12px; align-items: center; background: var(--white); border-bottom: 1px solid var(--border); flex-wrap: wrap; }
    .spacer { flex: 1; }
    .search-input { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; width: 240px; font-size: 13px; transition: border 0.2s; }
    .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }

    /* è¡¨æ ¼åŒºåŸŸ */
    .table-wrapper { flex: 1; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 1000px; }
    th { position: sticky; top: 0; background: #f8fafc; z-index: 10; padding: 12px 16px; text-align: left; font-weight: 600; color: #475569; border-bottom: 1px solid var(--border); }
    td { padding: 12px 16px; border-bottom: 1px solid #f1f5f9; vertical-align: top; }
    tr:hover { background: #f8fafc; }
    
    /* æŒ‰é’®ç»„ä»¶ */
    .btn { padding: 6px 16px; border-radius: 6px; border: none; font-size: 13px; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; transition: 0.15s; font-weight: 500; color: white; user-select: none; }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: var(--primary); } .btn-primary:hover { background: var(--primary-hover); }
    .btn-success { background: var(--success); } .btn-success:hover { background: #16a34a; }
    .btn-danger { background: var(--danger); } .btn-danger:hover { background: var(--danger-hover); }
    .btn-secondary { background: #fff; border: 1px solid var(--border); color: var(--text-main); } 
    .btn-secondary:hover { background: #f1f5f9; border-color: #94a3b8; }
    
    .btn-xs { padding: 2px 8px; font-size: 12px; border-radius: 4px; height: 24px; }
    .btn-icon { width: 28px; height: 28px; padding: 0; display: inline-flex; justify-content: center; align-items: center; background: transparent; border: 1px solid transparent; border-radius: 4px; color: #64748b; cursor: pointer; font-size: 14px; }
    .btn-icon:hover { background: #f1f5f9; border-color: #e2e8f0; color: var(--primary); }

    /* è¡¨å•æ§ä»¶ */
    input[type="text"], select { width: 100%; padding: 6px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; color: var(--text-main); }
    input[type="text"]:focus, select:focus { border-color: var(--primary); outline: none; }
    
    /* æ ‡ç­¾Tag */
    .tag-list { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
    .tag { font-size: 11px; padding: 1px 6px; border-radius: 3px; border: 1px solid; display: inline-flex; align-items: center; gap: 4px; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .tag-blue { background: #eff6ff; color: #1d4ed8; border-color: #bfdbfe; }
    .tag-orange { background: #fff7ed; color: #c2410c; border-color: #fed7aa; }
    .tag-green { background: #f0fdf4; color: #15803d; border-color: #bbf7d0; }
    .tag-del { cursor: pointer; opacity: 0.5; font-weight: bold; }
    .tag-del:hover { opacity: 1; color: var(--danger); }

    /* å¼¹çª—é€šç”¨ */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 999; backdrop-filter: blur(2px); }
    .modal-box { position: absolute; top: 15%; left: 50%; transform: translateX(-50%); background: white; width: 450px; padding: 24px; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes popIn { from { opacity: 0; transform: translate(-50%, -20px); } to { opacity: 1; transform: translate(-50%, 0); } }
    .modal-header { font-size: 16px; font-weight: 700; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
    .modal-footer { margin-top: 24px; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #f1f5f9; padding-top: 16px; }
    .form-item { margin-bottom: 16px; }
    .form-item label { display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: #475569; }
    
    /* å¤é€‰æ¡†è¡Œ */
    .check-row { display: flex; align-items: center; gap: 8px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; transition: 0.1s; background: #f8fafc; }
    .check-row:hover { border-color: #94a3b8; background: #fff; }
    .check-row input { width: 16px; height: 16px; accent-color: var(--primary); }

    .empty-state { padding: 60px; text-align: center; color: #94a3b8; font-style: italic; }
</style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <div class="app-title">æ’ä»¶åˆ—è¡¨ç®¡ç†å™¨ <span class="version-badge">v1.3.6</span></div>
        <div class="status-text" id="statusText">å°±ç»ª</div>
    </div>

    <!-- æ ‡ç­¾æ  -->
    <div class="tabs-container" id="tabsBar"></div>

    <!-- å·¥å…·æ  -->
    <div class="toolbar">
        <button class="btn btn-success" onclick="app.addItem()">â• æ–°å¢æ–‡ä»¶</button>
        <button class="btn btn-primary" onclick="app.exportHtml()">ğŸ“¤ å¯¼å‡ºåˆ—è¡¨HTML</button>
        <button class="btn btn-secondary" onclick="app.exportJson()">ğŸ’¾ å¤‡ä»½æ•°æ®JSON</button>
        <div class="spacer"></div>
        <input type="file" id="importFile" hidden onchange="app.importJson(this)">
        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">ğŸ“‚ å¯¼å…¥å¤‡ä»½/æ—§ç‰ˆ</button>
        <button class="btn btn-danger" onclick="app.clearTab()">ğŸ—‘ï¸ æ¸…ç©ºå½“å‰é¡µ</button>
        <input type="text" class="search-input" placeholder="æœç´¢æ–‡ä»¶å..." id="searchInput" oninput="app.render()">
    </div>

    <!-- åˆ—è¡¨ -->
    <div class="table-wrapper">
        <table id="mainTable">
            <thead>
                <tr>
                    <th width="70" style="text-align:center">æ’åº</th>
                    <th width="25%">æ–‡ä»¶ä¿¡æ¯</th>
                    <th width="20%">éŸ³è´¨ & ç‰ˆæœ¬</th>
                    <th width="35%">é…ç½®ä¿¡æ¯ (å¤‡æ³¨ / é“¾æ¥ / Key)</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<!-- å¼¹çª—ï¼šæ ‡ç­¾é¡µç®¡ç† -->
<div id="modalTabs" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">æ ‡ç­¾é¡µç®¡ç† <span style="cursor:pointer" onclick="ui.close()">Ã—</span></div>
        <div class="form-item">
            <label>å†…ç½®æ ‡ç­¾é¡µå¼€å…³:</label>
            <div style="display:flex; gap:10px">
                <label class="check-row" style="flex:1">
                    <input type="checkbox" id="chk_mf" onchange="app.toggleTabConfig('showMF')"> 
                    Music Free
                </label>
                <label class="check-row" style="flex:1">
                    <input type="checkbox" id="chk_ly" onchange="app.toggleTabConfig('showLY')"> 
                    æ¾œéŸ³
                </label>
            </div>
        </div>
        <div class="form-item" style="border-top:1px dashed #e2e8f0; margin-top:20px; padding-top:15px">
            <label>æ–°å¢è‡ªå®šä¹‰æ ‡ç­¾é¡µ:</label>
            <div style="display:flex; gap:8px">
                <input type="text" id="newTabName" placeholder="è¾“å…¥åç§°...">
                <button class="btn btn-primary" onclick="app.addCustomTab()">æ·»åŠ </button>
            </div>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šKey é…ç½® (ç‹¬ç«‹å¼€å…³) -->
<div id="modalKey" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">é…ç½® Key (LXä¸“ç”¨) <span style="cursor:pointer" onclick="ui.close()">Ã—</span></div>
        
        <div class="form-item p-3 border rounded bg-slate-50 mb-4" style="border:1px solid #e2e8f0; padding:12px; border-radius:6px; background:#f8fafc">
            <label class="check-row" style="margin-bottom:8px; border:none; padding:0; background:transparent">
                <input type="checkbox" id="k_enable_url"> å¯ç”¨åœ¨çº¿å¯¼å…¥ (URLæ‹¼æ¥)
            </label>
            <input type="text" id="k_url" placeholder="https://api.example.com?key=">
            <div style="font-size:11px; color:#94a3b8; margin-top:4px">ç”¨æˆ·è¾“å…¥Keyåå°†è·³è½¬åˆ°æ­¤é“¾æ¥+Key</div>
        </div>

        <div class="form-item p-3 border rounded bg-slate-50" style="border:1px solid #e2e8f0; padding:12px; border-radius:6px; background:#f8fafc">
            <label class="check-row" style="margin-bottom:8px; border:none; padding:0; background:transparent">
                <input type="checkbox" id="k_enable_var"> å¯ç”¨æœ¬åœ°å¯¼å…¥ (å˜é‡æ›¿æ¢)
            </label>
            <input type="text" id="k_var" placeholder="å˜é‡å, å¦‚: API_KEY">
            <div style="font-size:11px; color:#94a3b8; margin-top:4px">ä¸‹è½½æ–‡ä»¶æ—¶è‡ªåŠ¨æ›¿æ¢æ–‡ä»¶å†…çš„æ­¤å˜é‡ä¸ºç”¨æˆ·è¾“å…¥çš„Key</div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-primary" onclick="app.saveKey()">ä¿å­˜é…ç½®</button>
        </div>
    </div>
</div>

<!-- å¼¹çª—ï¼šé“¾æ¥ -->
<div id="modalLink" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">æ·»åŠ é“¾æ¥ <span style="cursor:pointer" onclick="ui.close()">Ã—</span></div>
        <div class="form-item"><label>æ˜¾ç¤ºæ–‡æœ¬:</label><input type="text" id="l_text" placeholder="å®˜ç½‘ / è´­ä¹°é¡µ / è¯´æ˜"></div>
        <div class="form-item"><label>URLåœ°å€:</label><input type="text" id="l_url" placeholder="http://..."></div>
        <div class="modal-footer"><button class="btn btn-primary" onclick="app.saveLink()">ç¡®è®¤æ·»åŠ </button></div>
    </div>
</div>

<!-- å¼¹çª—ï¼šç›´é“¾ -->
<div id="modalDl" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">é…ç½®ç›´é“¾ä¸‹è½½ <span style="cursor:pointer" onclick="ui.close()">Ã—</span></div>
        <div class="form-item">
            <label>ç›´é“¾ URL:</label>
            <input type="text" id="d_url" placeholder="http://...">
            <div style="font-size:12px; color:#64748b; margin-top:8px">
                è®¾ç½®ç›´é“¾åï¼Œå¯¼å‡ºåˆ—è¡¨ä¸­å°†æ˜¾ç¤ºâ€œç›´é“¾ä¸‹è½½â€æŒ‰é’®ã€‚
            </div>
        </div>
        <div class="modal-footer"><button class="btn btn-primary" onclick="app.saveDl()">ä¿å­˜</button></div>
    </div>
</div>

<script>
/**
 * Application Logic v1.3.6
 * ä¿®å¤å¯¼å…¥æ— ååº”bugï¼Œä¼˜åŒ–å¯¼å‡ºUI
 */
const QUALITY_PRESETS = ['128k', '320k', 'flac', 'flac24bit', 'master', 'dolby', 'sky'];

const app = {
    data: {
        config: { showMF: false, showLY: false },
        customTabs: [],
        items: [],
        activeTab: 'LX'
    },
    state: { editId: null },

    init() {
        this.load();
        this.renderTabs();
        this.render();
    },

    // --- æ•°æ®å­˜å‚¨ ---
    save() {
        try {
            localStorage.setItem('pm_v136_data', JSON.stringify(this.data));
            document.getElementById('statusText').innerText = 'å·²ä¿å­˜ ' + new Date().toLocaleTimeString();
        } catch(e) { console.error(e); }
    },
    load() {
        const raw = localStorage.getItem('pm_v136_data');
        if(raw) {
            try { this.data = JSON.parse(raw); } catch(e){}
        }
    },

    // --- æ ‡ç­¾é¡µ ---
    getTabs() {
        let tabs = ['LX'];
        if(this.data.config.showMF) tabs.push('Music Free');
        if(this.data.config.showLY) tabs.push('æ¾œéŸ³');
        return tabs.concat(this.data.customTabs);
    },
    renderTabs() {
        const tabs = this.getTabs();
        if(!tabs.includes(this.data.activeTab)) this.data.activeTab = 'LX';
        
        const html = tabs.map(t => {
            const isActive = t === this.data.activeTab;
            const isCustom = this.data.customTabs.includes(t);
            const delBtn = isCustom ? `<span class="tab-close" onclick="app.delCustomTab('${t}', event)">Ã—</span>` : '';
            return `<div class="tab-item ${isActive?'active':''}" onclick="app.switchTab('${t}')">${t} ${delBtn}</div>`;
        }).join('');
        document.getElementById('tabsBar').innerHTML = html + `<div class="tab-add-btn" onclick="ui.openTabOpt()">+</div>`;
    },
    switchTab(t) {
        this.data.activeTab = t;
        this.save();
        this.renderTabs();
        this.render();
    },
    toggleTabConfig(key) {
        this.data.config[key] = document.getElementById(key==='showMF'?'chk_mf':'chk_ly').checked;
        this.save();
        this.renderTabs();
        this.render();
    },
    addCustomTab() {
        const name = document.getElementById('newTabName').value.trim();
        if(!name || this.getTabs().includes(name)) return;
        this.data.customTabs.push(name);
        this.data.activeTab = name;
        this.save();
        this.renderTabs();
        this.render();
        ui.close();
        document.getElementById('newTabName').value = '';
    },
    delCustomTab(name, e) {
        e.stopPropagation();
        if(confirm('åˆ é™¤æ­¤æ ‡ç­¾é¡µï¼Ÿæ•°æ®å°†è¢«éšè—ã€‚')) {
            this.data.customTabs = this.data.customTabs.filter(t => t !== name);
            if(this.data.activeTab === name) this.data.activeTab = 'LX';
            this.save();
            this.renderTabs();
            this.render();
        }
    },
    clearTab() {
        if(confirm('æ¸…ç©ºå½“å‰é¡µæ‰€æœ‰æ•°æ®ï¼Ÿ')) {
            this.data.items = this.data.items.filter(i => i.tab !== this.data.activeTab);
            this.save();
            this.render();
        }
    },

    // --- åˆ—è¡¨æ¸²æŸ“ ---
    render() {
        const tbody = document.getElementById('tableBody');
        const kw = document.getElementById('searchInput').value.toLowerCase();
        const curTab = this.data.activeTab;
        
        const list = this.data.items.filter(i => {
            const t = i.tab || 'LX';
            return t === curTab && (!kw || (i.name||'').toLowerCase().includes(kw));
        });

        if(list.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="empty-state">æš‚æ— æ•°æ®ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹â€œæ–°å¢æ–‡ä»¶â€æˆ–â€œå¯¼å…¥å¤‡ä»½â€</td></tr>`;
            return;
        }

        const supportPreset = ['LX', 'æ¾œéŸ³'].includes(curTab);
        const accept = curTab === 'Music Free' ? '.js,.json' : '.js';

        tbody.innerHTML = list.map(item => {
            const hasFile = !!(item.file && item.file.content);
            const status = hasFile 
                ? `<span style="color:#16a34a;background:#dcfce7;font-size:12px;padding:2px 6px;border-radius:4px">âœ… å·²ä¼  ${fmtSize(item.file.size)}</span>`
                : `<span style="color:#dc2626;background:#fee2e2;font-size:12px;padding:2px 6px;border-radius:4px">âš ï¸ ç¼ºæ–‡ä»¶</span>`;

            // éŸ³è´¨ UI
            let qualityUi = '';
            if(supportPreset) {
                const isCustom = item.quality && !QUALITY_PRESETS.includes(item.quality);
                if(isCustom) {
                    qualityUi = `<div style="display:flex;gap:4px"><input type="text" value="${esc(item.quality)}" onchange="app.updateItem(${item.id}, 'quality', this.value)"><button class="btn-icon" onclick="app.updateItem(${item.id}, 'quality', '')" title="é‡ç½®">â†º</button></div>`;
                } else {
                    const opts = QUALITY_PRESETS.map(q => `<option value="${q}" ${item.quality===q?'selected':''}>${q}</option>`).join('');
                    qualityUi = `<select onchange="if(this.value==='_C_'){app.updateItem(${item.id},'quality','è‡ªå®šä¹‰')}else{app.updateItem(${item.id},'quality',this.value)}"><option value="">é€‰æ‹©éŸ³è´¨...</option>${opts}<option value="_C_">âœ è‡ªå®šä¹‰...</option></select>`;
                }
            } else {
                qualityUi = `<input type="text" value="${esc(item.quality)}" onchange="app.updateItem(${item.id}, 'quality', this.value)" placeholder="éŸ³è´¨">`;
            }
            qualityUi += `<input type="text" value="${esc(item.ver)}" onchange="app.updateItem(${item.id}, 'ver', this.value)" placeholder="ç‰ˆæœ¬å·" style="margin-top:4px;color:#64748b">`;

            // æ ‡ç­¾
            let tags = '';
            if(item.dlLink) tags += `<span class="tag tag-green">ç›´é“¾ <span class="tag-del" onclick="app.updateItem(${item.id},'dlLink','')">Ã—</span></span>`;
            (item.links||[]).forEach((l,i) => {
                tags += `<span class="tag tag-blue"><a href="${l.url}" target="_blank" style="text-decoration:none;color:inherit">${l.text}</a> <span class="tag-del" onclick="app.delLink(${item.id},${i})">Ã—</span></span>`;
            });
            if(curTab === 'LX') {
                if(item.keyConfig?.enableUrl) tags += `<span class="tag tag-orange">Keyåœ¨çº¿ <span class="tag-del" onclick="app.toggleKey(${item.id},'enableUrl',false)">Ã—</span></span>`;
                if(item.keyConfig?.enableVar) tags += `<span class="tag tag-orange">Keyæœ¬åœ° <span class="tag-del" onclick="app.toggleKey(${item.id},'enableVar',false)">Ã—</span></span>`;
            }

            return `
                <tr>
                    <td align="center">
                        <div style="display:flex;flex-direction:column;gap:2px">
                            <button class="btn-icon" onclick="app.moveItem(${item.id}, -1)">â–²</button>
                            <button class="btn-icon" onclick="app.moveItem(${item.id}, 1)">â–¼</button>
                        </div>
                    </td>
                    <td>
                        <input type="text" value="${esc(item.name)}" onchange="app.updateItem(${item.id}, 'name', this.value)" placeholder="æ–‡ä»¶å" style="font-weight:700;margin-bottom:4px">
                        <div style="display:flex;align-items:center;gap:6px">
                            ${status}
                            <input type="file" id="f_${item.id}" hidden accept="${accept}" onchange="app.uploadFile(${item.id}, this)">
                            <button class="btn-xs btn-primary" onclick="document.getElementById('f_${item.id}').click()">${hasFile?'é‡ä¼ ':'ä¸Šä¼ '}</button>
                        </div>
                    </td>
                    <td valign="top">${qualityUi}</td>
                    <td>
                        <input type="text" value="${esc(item.note)}" onchange="app.updateItem(${item.id}, 'note', this.value)" placeholder="å¤‡æ³¨..." style="margin-bottom:6px">
                        <div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:6px">
                            <button class="btn-xs btn-secondary" onclick="app.openLinkModal(${item.id})">+ é“¾æ¥</button>
                            <button class="btn-xs btn-secondary" onclick="app.openDlModal(${item.id})">+ ç›´é“¾</button>
                            ${curTab==='LX' ? `<button class="btn-xs btn-secondary" onclick="app.openKeyModal(${item.id})">âš™ï¸ Key</button>` : ''}
                        </div>
                        <div class="tag-list">${tags}</div>
                    </td>
                    <td>
                        <div style="display:flex;gap:4px;flex-direction:column">
                            ${hasFile ? `<button class="btn btn-success btn-sm" onclick="app.dlLocal(${item.id})">ä¸‹è½½</button>` : ''}
                            <button class="btn btn-danger btn-sm" onclick="app.delItem(${item.id})">åˆ é™¤</button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    },

    // --- æ•°æ®ä¿®æ”¹ ---
    addItem() {
        this.data.items.push({
            id: Date.now(),
            tab: this.data.activeTab,
            name: '', ver: '', quality: '', note: '',
            file: null, links: [], dlLink: '',
            keyConfig: { enableUrl: false, url: '', enableVar: false, var: '' }
        });
        this.save();
        this.render();
    },
    updateItem(id, k, v) {
        const i = this.data.items.find(x => x.id === id);
        if(i) {
            i[k] = v;
            this.save();
            if(k === 'quality' || k === 'dlLink') this.render();
        }
    },
    toggleKey(id, k, v) {
        const i = this.data.items.find(x => x.id === id);
        if(i && i.keyConfig) { i.keyConfig[k] = v; this.save(); this.render(); }
    },
    delItem(id) {
        if(confirm('åˆ é™¤æ­¤é¡¹ï¼Ÿ')) {
            this.data.items = this.data.items.filter(x => x.id !== id);
            this.save();
            this.render();
        }
    },
    moveItem(id, dir) {
        const idx = this.data.items.findIndex(x => x.id === id);
        if(idx > -1) {
            const t = idx + dir;
            if(t >= 0 && t < this.data.items.length) {
                [this.data.items[idx], this.data.items[t]] = [this.data.items[t], this.data.items[idx]];
                this.save();
                this.render();
            }
        }
    },
    uploadFile(id, input) {
        const f = input.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = e => {
            const i = this.data.items.find(x => x.id === id);
            if(i) {
                if(!i.name) i.name = f.name;
                i.file = { content: e.target.result, size: f.size };
                this.save();
                this.render();
            }
        };
        r.readAsDataURL(f);
        input.value = '';
    },
    dlLocal(id) {
        const i = this.data.items.find(x => x.id === id);
        if(i?.file) saveAs(i.file.content, i.name);
    },

    // --- å¼¹çª—é€»è¾‘ ---
    openLinkModal(id) { this.state.editId = id; ui.setVal('l_text',''); ui.setVal('l_url',''); ui.open('modalLink'); },
    saveLink() {
        const i = this.data.items.find(x => x.id === this.state.editId);
        const t = ui.getVal('l_text'), u = ui.getVal('l_url');
        if(i && t && u) {
            if(!i.links) i.links = [];
            i.links.push({text:t, url:u});
            this.save(); this.render();
        }
        ui.close();
    },
    delLink(id, idx) {
        const i = this.data.items.find(x => x.id === id);
        if(i && i.links) { i.links.splice(idx, 1); this.save(); this.render(); }
    },
    openDlModal(id) {
        this.state.editId = id;
        const i = this.data.items.find(x => x.id === id);
        ui.setVal('d_url', i.dlLink || '');
        ui.open('modalDl');
    },
    saveDl() {
        this.updateItem(this.state.editId, 'dlLink', ui.getVal('d_url'));
        ui.close();
    },
    openKeyModal(id) {
        this.state.editId = id;
        const i = this.data.items.find(x => x.id === id);
        const k = i.keyConfig || {};
        ui.setCheck('k_enable_url', k.enableUrl);
        ui.setVal('k_url', k.url||'');
        ui.setCheck('k_enable_var', k.enableVar);
        ui.setVal('k_var', k.var||'');
        ui.open('modalKey');
    },
    saveKey() {
        const i = this.data.items.find(x => x.id === this.state.editId);
        if(i) {
            i.keyConfig = {
                enableUrl: ui.getCheck('k_enable_url'), url: ui.getVal('k_url'),
                enableVar: ui.getCheck('k_enable_var'), var: ui.getVal('k_var')
            };
            this.save(); this.render();
        }
        ui.close();
    },

    // --- å¯¼å…¥å¯¼å‡º (ä¿®å¤é‡ç‚¹) ---
    exportJson() {
        const blob = new Blob([JSON.stringify(this.data, null, 2)], {type:'application/json'});
        saveAs(URL.createObjectURL(blob), `å¤‡ä»½_${Date.now()}.json`);
    },
    
    importJson(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const json = JSON.parse(e.target.result);
                // å…¼å®¹æ—§ç‰ˆæ•°ç»„æ ¼å¼
                if(Array.isArray(json)) {
                    if(confirm('æ£€æµ‹åˆ°æ—§ç‰ˆå¤‡ä»½æ•°æ®ï¼Œæ˜¯å¦å¯¼å…¥åˆ° LX æ ‡ç­¾é¡µï¼Ÿ')) {
                        const newItems = json.map(old => ({
                            id: old.id || Date.now() + Math.random(),
                            tab: 'LX',
                            name: old.fileName || old.name || '',
                            ver: '',
                            quality: old.quality || '',
                            note: old.note || '',
                            file: old.fileContent ? { content: old.fileContent, size: old.fileSize || 0 } : null,
                            links: old.links || [],
                            dlLink: old.directUrl || '',
                            keyConfig: {
                                enableUrl: (old.keyMode === 'link' || !!old.keyUrl),
                                url: old.keyUrl || '',
                                enableVar: (old.keyVariable && old.keyVariable !== ""),
                                var: old.keyVariable || ''
                            }
                        }));
                        // æ›´æ–°æ•°æ®ä½†ä¸é‡ç½®é…ç½®
                        this.data.items = newItems;
                        this.data.activeTab = 'LX';
                        this.save();
                        // å…³é”®ï¼šä¸è°ƒç”¨ init/loadï¼Œç›´æ¥æ¸²æŸ“ï¼Œé˜²æ­¢æœ¬åœ° LS è¯»å–è¦†ç›–å†…å­˜æ•°æ®
                        this.renderTabs();
                        this.render();
                        alert('å¯¼å…¥æˆåŠŸï¼');
                    }
                } else if(json.items) {
                    this.data = json;
                    this.save();
                    this.renderTabs();
                    this.render();
                    alert('å¯¼å…¥æˆåŠŸï¼');
                } else {
                    alert('æ ¼å¼é”™è¯¯');
                }
            } catch(err) { console.error(err); alert('è§£æå¤±è´¥'); }
        };
        reader.readAsText(file);
        input.value = ''; // æ¸…ç©ºä»¥å…è®¸é‡å¤å¯¼å…¥åŒåæ–‡ä»¶
    },

    exportHtml() {
        const html = generateExportHtml(this.data);
        const blob = new Blob([html], {type:'text/html'});
        saveAs(URL.createObjectURL(blob), `æ’ä»¶åˆ—è¡¨_${new Date().toISOString().slice(0,10)}.html`);
    }
};

const ui = {
    open(id) { document.getElementById(id).style.display = 'block'; },
    close() { document.querySelectorAll('.modal-overlay').forEach(e=>e.style.display='none'); app.state.editId=null; },
    openTabOpt() {
        document.getElementById('chk_mf').checked = app.data.config.showMF;
        document.getElementById('chk_ly').checked = app.data.config.showLY;
        this.open('modalTabs');
    },
    getVal(id) { return document.getElementById(id).value; },
    setVal(id, v) { document.getElementById(id).value = v; },
    getCheck(id) { return document.getElementById(id).checked; },
    setCheck(id, v) { document.getElementById(id).checked = v; }
};

function esc(s) { return s ? s.replace(/"/g, "&quot;") : ""; }
function fmtSize(b) { 
    if(!b) return ''; 
    if(b<1024) return b+'B'; 
    if(b<1048576) return (b/1024).toFixed(1)+'KB'; 
    return (b/1048576).toFixed(1)+'MB'; 
}
function saveAs(url, name) {
    const a = document.createElement('a');
    a.href = url; a.download = name; a.click();
}

// --- å¯¼å‡º HTML æ¨¡æ¿ (ä¿®å¤Keyä¸‹è½½é€»è¾‘) ---
function generateExportHtml(data) {
    const jsonStr = JSON.stringify(data);
    return `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ’ä»¶åˆ—è¡¨</title>
<style>
body{font-family:-apple-system,sans-serif;background:#f8fafc;color:#334155;padding:20px}
.box{max-width:900px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1);overflow:hidden}
.h{padding:20px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between}
.tabs{background:#f1f5f9;display:flex;gap:2px;padding:0 20px;overflow-x:auto}
.tab{padding:12px 24px;cursor:pointer;font-weight:500;color:#64748b;border-radius:8px 8px 0 0}
.tab.active{background:#fff;color:#2563eb;font-weight:700;box-shadow:0 -2px 4px rgba(0,0,0,0.02)}
.list{padding:10px}
table{width:100%;border-collapse:collapse}
td{padding:12px;border-bottom:1px solid #f1f5f9;vertical-align:top}
.tag{display:inline-block;padding:2px 8px;font-size:12px;border-radius:4px;margin-right:4px;background:#f1f5f9;color:#475569}
.tag-ver{background:#eff6ff;color:#2563eb}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:6px 12px;border-radius:6px;text-decoration:none;font-size:13px;cursor:pointer;border:none;margin-top:4px}
.btn-dl{background:#2563eb;color:#fff;width:100%}
.btn-lnk{background:#fff;border:1px solid #cbd5e1;color:#475569;margin-right:4px}
.key-box{margin-top:8px;display:flex;flex-direction:column;gap:6px}
.key-row{display:flex;gap:4px}
.key-in{flex:1;border:1px solid #cbd5e1;padding:4px 8px;border-radius:4px;font-size:12px}
.key-btn{padding:4px 10px;background:#f1f5f9;border:1px solid #cbd5e1;border-radius:4px;cursor:pointer}
.empty{padding:50px;text-align:center;color:#94a3b8}
</style>
</head>
<body>
<div class="box">
    <div class="h"><strong>æ’ä»¶ä¸‹è½½åˆ—è¡¨</strong><span style="font-size:12px;color:#94a3b8">Update: ${new Date().toLocaleDateString()}</span></div>
    <div class="tabs" id="t"></div>
    <div class="list" id="c"></div>
</div>
<script>
const DB=${jsonStr};
let cur='LX';
function rT(){
    let ts=['LX'];
    if(DB.config.showMF) ts.push('Music Free');
    if(DB.config.showLY) ts.push('æ¾œéŸ³');
    ts = ts.concat(DB.customTabs);
    if(!ts.includes(cur)) cur='LX';
    document.getElementById('t').innerHTML = ts.map(t=>'<div class="tab '+(t===cur?'active':'')+'" onclick="sT(\\''+t+'\\')">'+t+'</div>').join('');
    rL();
}
function sT(t){cur=t;rT();}
function rL(){
    const l = DB.items.filter(i=>(i.tab||'LX')===cur);
    const b = document.getElementById('c');
    if(!l.length){b.innerHTML='<div class="empty">æš‚æ— å†…å®¹</div>';return;}
    let h='<table>';
    h+=l.map(i=>{
        let meta='';
        if(i.quality) meta+='<span class="tag">'+i.quality+'</span>';
        if(i.ver) meta+='<span class="tag tag-ver">v'+i.ver+'</span>';
        let ls = (i.links||[]).map(k=>'<a href="'+k.url+'" target="_blank" class="btn btn-lnk">ğŸ”— '+k.text+'</a>').join('');
        
        let act = '';
        // ç›´é“¾
        if(i.dlLink) act += '<a href="'+i.dlLink+'" target="_blank" class="btn btn-dl" style="background:#16a34a;margin-bottom:5px">ğŸŒ ç›´é“¾ä¸‹è½½</a>';
        
        // æœ¬åœ°æ–‡ä»¶åŠKey
        if(i.file && i.file.content){
            // å§‹ç»ˆæ˜¾ç¤ºåŸæ–‡ä»¶ä¸‹è½½
            act += '<button class="btn btn-dl" onclick="D('+i.id+')">â¬‡ï¸ ä¸‹è½½</button>';
            
            // Key é€»è¾‘
            const k = i.keyConfig||{};
            const su = (cur==='LX' && k.enableUrl && k.url);
            const sv = (cur==='LX' && k.enableVar && k.var);
            
            if(su || sv) {
                act += '<div class="key-box">';
                if(su) act += '<div class="key-row"><input class="key-in" id="ku_'+i.id+'" placeholder="åœ¨çº¿æ·»åŠ Key"><button class="key-btn" onclick="KU('+i.id+')">â¡ï¸</button></div>';
                if(sv) act += '<div class="key-row"><input class="key-in" id="kv_'+i.id+'" placeholder="æœ¬åœ°æ›¿æ¢Keyå˜é‡"><button class="key-btn" onclick="KV('+i.id+')">â¬‡ï¸</button></div>';
                act += '</div>';
            }
        }
        return '<tr><td><div style="font-weight:bold;margin-bottom:4px">'+i.name+'</div>'+meta+'</td><td style="color:#64748b;font-size:13px">'+(i.note||'-')+'<br><div style="margin-top:4px">'+ls+'</div></td><td width="220">'+act+'</td></tr>';
    }).join('');
    b.innerHTML = h+'</table>';
}
window.D=id=>{const i=DB.items.find(x=>x.id==id); save(i.file.content,i.name);};
window.KU=id=>{const i=DB.items.find(x=>x.id==id);const v=document.getElementById('ku_'+id).value; if(v)window.open(i.keyConfig.url+v);};
window.KV=id=>{
    const i=DB.items.find(x=>x.id==id);
    const v=document.getElementById('kv_'+id).value;
    if(!v)return alert('è¯·è¾“å…¥Key');
    try{
        const raw=atob(i.file.content.split(',')[1]);
        const u8=new Uint8Array(raw.length);
        for(let n=0;n<raw.length;n++)u8[n]=raw.charCodeAt(n);
        let txt=new TextDecoder().decode(u8);
        const vn=i.keyConfig.var;
        const re=new RegExp('((?:const|var|let)\\\\s+'+vn+'\\\\s*[:=]\\\\s*)[\\'\\"][\\'\\"]','g');
        if(re.test(txt)){
            txt=txt.replace(re,'$1"'+v+'"');
            const b=new Blob([txt],{type:'text/javascript'});
            const a=document.createElement('a');
            a.href=URL.createObjectURL(b);
            a.download=i.name;
            a.click();
        }else{alert('å˜é‡åæœªæ‰¾åˆ°: '+vn);}
    }catch(e){console.error(e);alert('ç”Ÿæˆå¤±è´¥');}
};
function save(u,n){const a=document.createElement('a');a.href=u;a.download=n;a.click();}
rT();
<\/script>
</body></html>`;
}

app.init();
</script>
</body>
</html>