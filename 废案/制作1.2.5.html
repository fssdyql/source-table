<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>éŸ³æºè„šæœ¬ç®¡ç†å™¨</title>
  <style>
    /* å…¨å±€æ ·å¼é‡ç½®ä¸åŸºç¡€è®¾ç½® */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: #f0f2f5; padding: 20px; min-height: 100vh; color: #333; }
    
    /* å®¹å™¨æ ·å¼ */
    .container { max-width: 1800px; margin: 0 auto; background: white; border-radius: 12px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
    
    /* å¤´éƒ¨ç²¾ç®€ */
    h1 { color: #2c3e50; margin-bottom: 5px; text-align: center; font-size: 24px; font-weight: 600; }
    .subtitle { text-align: center; color: #7f8c8d; margin-bottom: 20px; font-size: 14px; }
    
    /* æ ‡ç­¾é¡µç³»ç»Ÿ */
    .tabs-header { display: flex; border-bottom: 2px solid #e9ecef; margin-bottom: 20px; align-items: center; gap: 5px; overflow-x: auto; padding-bottom: 2px; }
    .tab-btn { padding: 10px 25px; border: none; background: transparent; cursor: pointer; font-size: 15px; font-weight: 500; color: #6c757d; border-radius: 8px 8px 0 0; transition: all 0.2s; white-space: nowrap; position: relative; }
    .tab-btn:hover { background: #f8f9fa; color: #333; }
    .tab-btn.active { color: #667eea; font-weight: bold; background: #fff; }
    .tab-btn.active::after { content: ''; position: absolute; bottom: -4px; left: 0; width: 100%; height: 3px; background: #667eea; border-radius: 3px 3px 0 0; }
    .add-tab-btn { width: 30px; height: 30px; border-radius: 50%; border: 1px dashed #ccc; background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; color: #999; margin-left: 5px; flex-shrink: 0; }
    .add-tab-btn:hover { border-color: #667eea; color: #667eea; background: #f0f4ff; }
    .tab-delete { font-size: 10px; margin-left: 8px; color: #999; opacity: 0; transition: opacity 0.2s; padding: 0 4px; }
    .tab-btn:hover .tab-delete { opacity: 1; }
    .tab-delete:hover { color: #dc3545; background: #ffeaea; border-radius: 50%; }

    /* å·¥å…·æ  */
    .toolbar { display: flex; gap: 10px; margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; flex-wrap: wrap; align-items: center; }
    .search-box { padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 13px; width: 250px; outline: none; transition: border 0.2s; }
    .search-box:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
    
    /* æŒ‰é’®æ ·å¼ä¼˜åŒ– */
    .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: #667eea; color: white; }
    .btn-primary:hover { background: #5a6fd6; }
    .btn-success { background: #28a745; color: white; }
    .btn-success:hover { background: #218838; }
    .btn-danger { background: #fff5f5; color: #dc3545; border: 1px solid #ffc9c9; }
    .btn-danger:hover { background: #dc3545; color: white; border-color: #dc3545; }
    .btn-info { background: #17a2b8; color: white; }
    .btn-info:hover { background: #138496; }
    .btn-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
    .btn-warning:hover { background: #ffeeba; }

    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats { display: flex; gap: 15px; margin-bottom: 20px; }
    .stat-tag { padding: 5px 12px; background: #eef2ff; color: #5a67d8; border-radius: 20px; font-size: 12px; font-weight: 500; border: 1px solid #c3dafe; }
    
    /* è¡¨æ ¼æ ·å¼ */
    .table-container { overflow-x: auto; border: 1px solid #eee; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; background: white; font-size: 13px; }
    thead { background: #f8f9fa; color: #495057; }
    th { padding: 12px 15px; text-align: left; font-weight: 600; white-space: nowrap; border-bottom: 2px solid #e9ecef; }
    td { padding: 12px 15px; border-bottom: 1px solid #f1f3f5; vertical-align: top; }
    tr:hover { background: #fdfdfd; }
    
    /* å•å…ƒæ ¼å†…å®¹ */
    .file-name-container { display: flex; align-items: center; gap: 8px; }
    .file-icon { font-size: 16px; color: #667eea; }
    .input-cell { padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 4px; width: 100%; font-size: 13px; transition: border 0.2s; font-family: inherit; }
    .input-cell:focus { border-color: #667eea; outline: none; }
    .status-badge { font-size: 11px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
    .status-ok { background: #d4edda; color: #155724; }
    .status-no { background: #f8d7da; color: #721c24; }

    .action-group { display: flex; gap: 5px; flex-wrap: wrap; }
    .mini-btn { padding: 4px 8px; border-radius: 4px; border: none; font-size: 11px; cursor: pointer; color: white; }
    .bg-blue { background: #3498db; }
    .bg-green { background: #2ecc71; }
    .bg-red { background: #e74c3c; }
    .bg-gray { background: #95a5a6; }
    .bg-yellow { background: #f1c40f; color: #333; }

    /* å¤‡æ³¨åŒºåŸŸ */
    .note-area { display: flex; flex-direction: column; gap: 5px; }
    .tag-container { display: flex; flex-wrap: wrap; gap: 4px; }
    .url-tag { background: #e3f2fd; color: #0277bd; padding: 2px 8px; border-radius: 10px; font-size: 11px; display: inline-flex; align-items: center; border: 1px solid #b3e5fc; }
    .key-tag { background: #fff3cd; color: #856404; padding: 2px 8px; border-radius: 10px; font-size: 11px; border: 1px solid #ffeeba; }
    .remove-tag { margin-left: 5px; cursor: pointer; font-weight: bold; opacity: 0.6; }
    .remove-tag:hover { opacity: 1; color: #dc3545; }

    /* å¼¹çª—é€šç”¨ */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); backdrop-filter: blur(2px); }
    .modal-content { background-color: white; margin: 10vh auto; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); animation: slideDown 0.3s; }
    @keyframes slideDown { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-header { font-size: 18px; font-weight: bold; margin-bottom: 20px; display: flex; justify-content: space-between; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 14px; }
    .toggle-check-label { display: flex; align-items: center; gap: 10px; cursor: pointer; background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #eee; }
    .config-panel { margin-top: 10px; padding: 15px; border-left: 3px solid #667eea; background: #fafafa; display: none; }
    .config-panel.active { display: block; }
    
    .empty-state { padding: 40px; text-align: center; color: #adb5bd; }
    .add-row-btn { width: 100%; padding: 12px; border: 2px dashed #e9ecef; background: white; color: #667eea; font-weight: 600; margin-top: 15px; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
    .add-row-btn:hover { border-color: #667eea; background: #f0f4ff; }
  </style>
</head>
<body>

<div class="container">
  <h1>éŸ³æºè„šæœ¬ç®¡ç†å™¨</h1>
  <p class="subtitle">ç”¨äºç®¡ç†å„éŸ³ä¹å¹³å°çš„æ’ä»¶</p>
  
  <!-- æ ‡ç­¾é¡µ -->
  <div class="tabs-header" id="tabsHeader">
    <!-- åŠ¨æ€ç”Ÿæˆ -->
  </div>

  <div class="toolbar">
    <button class="btn btn-success" onclick="addNewRow()">â• æ·»åŠ æ–‡ä»¶</button>
    <button class="btn btn-primary" onclick="exportToJSON()">ğŸ’¾ å¤‡ä»½æ•°æ®</button>
    <button class="btn btn-warning" onclick="exportHTMLWithFiles()">ğŸ“¤ å¯¼å‡ºæŠ¥å‘Š</button>
    <button class="btn btn-info" onclick="downloadAllFiles()">â¬‡ï¸ æ‰“åŒ…ä¸‹è½½</button>
    <button class="btn btn-danger" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©º</button>
    <input type="file" id="importJSON" style="display:none" accept=".json" onchange="importFromJSON(event)">
    <button class="btn btn-primary" style="margin-left:auto" onclick="document.getElementById('importJSON').click()">ğŸ“‚ å¯¼å…¥å¤‡ä»½</button>
    <input type="text" class="search-box" placeholder="æœç´¢æ–‡ä»¶å..." oninput="renderTable()">
  </div>
  
  <div class="stats">
    <div class="stat-tag">æ€»æ–‡ä»¶: <span id="totalFiles">0</span></div>
    <div class="stat-tag">å·²ä¸Šä¼ : <span id="uploadedCount">0</span></div>
    <div class="stat-tag" id="lxOnlyStat" style="display:none">æ”¯æŒä¸€é”®å¯¼å…¥: <span id="autoImportCount">0</span></div>
  </div>
  
  <div class="table-container">
    <table id="mainTable">
      <thead>
        <tr>
          <th width="50">æ’åº</th>
          <th width="50">#</th>
          <th width="280">æ–‡ä»¶å</th>
          <th width="120">éŸ³è´¨/ç‰ˆæœ¬</th>
          <th width="350">å¤‡æ³¨ & é…ç½®</th>
          <th width="180">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
  
  <button class="add-row-btn" onclick="addNewRow()">â• æ·»åŠ æ–°æ¡ç›®åˆ°å½“å‰æ ‡ç­¾é¡µ</button>
</div>

<!-- Add Tab Modal -->
<div id="tabModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><span>æ·»åŠ æ ‡ç­¾é¡µ</span><span style="cursor:pointer" onclick="closeTabModal()">Ã—</span></div>
    <div class="form-group">
      <label>é¢„è®¾æ ‡ç­¾é¡µï¼š</label>
      <div style="display:flex; gap:10px; margin-bottom:15px;">
        <button class="btn btn-warning" onclick="quickAddTab('Music Free')">Music Free</button>
        <button class="btn btn-info" onclick="quickAddTab('æ¾œéŸ³')">æ¾œéŸ³</button>
      </div>
      <label>æˆ– è‡ªå®šä¹‰åç§°ï¼š</label>
      <input type="text" id="newTabName" class="input-cell" placeholder="ä¾‹å¦‚: è¿™é‡Œçš„é»æ˜é™æ‚„æ‚„">
    </div>
    <div style="text-align:right">
        <button class="btn btn-primary" onclick="confirmAddTab()">ç¡®å®šæ·»åŠ </button>
    </div>
  </div>
</div>

<!-- Key Config Modal (Only for LX) -->
<div id="keyModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><span>å¯†é’¥é…ç½® (LXä¸“ç”¨)</span><span style="cursor:pointer" onclick="closeKeyModal()">Ã—</span></div>
    <div class="form-group">
        <label class="toggle-check-label">
            <input type="checkbox" id="enableOnlineKey" onchange="toggleKeyInputs()"> 
            <span>ğŸŒ åœ¨çº¿æ¨¡å¼ (URLæ‹¼æ¥)</span>
        </label>
        <div id="onlineKeyConfig" class="config-panel">
            <input type="text" id="keyUrlTemplate" class="input-cell" placeholder="é“¾æ¥æ¨¡æ¿: https://api.com?key=">
        </div>
    </div>
    <div class="form-group">
        <label class="toggle-check-label">
            <input type="checkbox" id="enableLocalKey" onchange="toggleKeyInputs()"> 
            <span>ğŸ“‚ æœ¬åœ°æ¨¡å¼ (å˜é‡æ›¿æ¢)</span>
        </label>
        <div id="localKeyConfig" class="config-panel" style="border-left-color: #17a2b8;">
            <input type="text" id="keyVariableName" class="input-cell" value="API_KEY" placeholder="å˜é‡å: API_KEY">
        </div>
    </div>
    <div style="text-align:right">
        <button class="btn btn-primary" onclick="confirmKeyConfig()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- Simple Link Modal -->
<div id="linkModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><span>æ·»åŠ é“¾æ¥</span><span style="cursor:pointer" onclick="closeLinkModal()">Ã—</span></div>
        <div class="form-group"><input type="text" id="linkText" class="input-cell" placeholder="æ–‡å­— (å¦‚: å®˜ç½‘)"></div>
        <div class="form-group"><input type="text" id="linkUrl" class="input-cell" placeholder="åœ°å€ (http://...)"></div>
        <div style="text-align:right"><button class="btn btn-primary" onclick="confirmAddLink()">ç¡®å®š</button></div>
    </div>
</div>

<script>
// --- å…¨å±€çŠ¶æ€ ---
let appData = {
    tabs: ['LX'], // é»˜è®¤æ ‡ç­¾
    currentTab: 'LX',
    files: [] // æ–‡ä»¶åˆ—è¡¨ï¼Œæ¯ä¸ªæ–‡ä»¶å¯¹è±¡å¢åŠ  tab å­—æ®µ
};
let currentEditingId = null;

// --- åˆå§‹åŒ– ---
window.onload = function() {
    loadData();
    renderTabs();
    renderTable();
};

function loadData() {
    const saved = localStorage.getItem('musicManagerData_v2');
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            // å…¼å®¹æ—§ç‰ˆæ•°æ®ï¼šå¦‚æœæ˜¯æ•°ç»„ï¼Œè¯´æ˜æ˜¯æ—§ç‰ˆï¼Œè½¬ä¸ºæ–°ç‰ˆç»“æ„
            if (Array.isArray(parsed)) {
                appData.files = parsed.map(f => ({...f, tab: 'LX'}));
                appData.tabs = ['LX'];
                appData.currentTab = 'LX';
            } else {
                appData = parsed;
            }
        } catch (e) { console.error("Data load error", e); appData.files = []; }
    } else {
        // å°è¯•è¯»å– V1 æ•°æ®
        const oldSaved = localStorage.getItem('musicQualityData');
        if (oldSaved) {
            try {
                const oldFiles = JSON.parse(oldSaved);
                appData.files = oldFiles.map(f => ({...f, tab: 'LX'}));
            } catch(e){}
        }
    }
    // ç¡®ä¿ LX å­˜åœ¨
    if(!appData.tabs.includes('LX')) appData.tabs.unshift('LX');
    if(!appData.tabs.includes(appData.currentTab)) appData.currentTab = 'LX';
}

function saveData() {
    localStorage.setItem('musicManagerData_v2', JSON.stringify(appData));
    updateStats();
}

// --- æ ‡ç­¾é¡µé€»è¾‘ ---
function renderTabs() {
    const header = document.getElementById('tabsHeader');
    header.innerHTML = '';
    
    appData.tabs.forEach(tab => {
        const btn = document.createElement('button');
        btn.className = `tab-btn ${tab === appData.currentTab ? 'active' : ''}`;
        
        let label = tab === 'LX' ? 'LX Music' : tab;
        let html = `<span>${label}</span>`;
        
        // LX æ ‡ç­¾ä¸å¯åˆ é™¤
        if (tab !== 'LX') {
            html += `<span class="tab-delete" onclick="event.stopPropagation(); deleteTab('${tab}')">Ã—</span>`;
        }
        
        btn.innerHTML = html;
        btn.onclick = () => switchTab(tab);
        header.appendChild(btn);
    });
    
    // æ·»åŠ æŒ‰é’®
    const addBtn = document.createElement('button');
    addBtn.className = 'add-tab-btn';
    addBtn.innerText = '+';
    addBtn.onclick = openAddTabModal;
    header.appendChild(addBtn);
    
    // æ§åˆ¶ç»Ÿè®¡æ˜¾ç¤º
    document.getElementById('lxOnlyStat').style.display = appData.currentTab === 'LX' ? 'block' : 'none';
}

function switchTab(tabName) {
    appData.currentTab = tabName;
    renderTabs();
    renderTable();
    saveData();
}

function openAddTabModal() { document.getElementById('tabModal').style.display = 'block'; }
function closeTabModal() { document.getElementById('tabModal').style.display = 'none'; }
function quickAddTab(name) { 
    document.getElementById('newTabName').value = name; 
    confirmAddTab(); 
}
function confirmAddTab() {
    const name = document.getElementById('newTabName').value.trim();
    if (!name) return alert('è¯·è¾“å…¥åç§°');
    if (appData.tabs.includes(name)) return alert('æ ‡ç­¾å·²å­˜åœ¨');
    
    appData.tabs.push(name);
    appData.currentTab = name; // è‡ªåŠ¨åˆ‡æ¢
    renderTabs();
    renderTable();
    saveData();
    closeTabModal();
    document.getElementById('newTabName').value = '';
}

function deleteTab(tabName) {
    if (!confirm(`ç¡®å®šåˆ é™¤æ ‡ç­¾é¡µ "${tabName}" åŠå…¶ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å—ï¼Ÿ`)) return;
    
    // åˆ é™¤è¯¥æ ‡ç­¾ä¸‹çš„æ–‡ä»¶
    appData.files = appData.files.filter(f => f.tab !== tabName);
    // åˆ é™¤æ ‡ç­¾
    appData.tabs = appData.tabs.filter(t => t !== tabName);
    // åˆ‡æ¢å› LX
    if (appData.currentTab === tabName) appData.currentTab = 'LX';
    
    renderTabs();
    renderTable();
    saveData();
}

// --- æ–‡ä»¶æ“ä½œé€»è¾‘ ---
function addNewRow() {
    const newFile = {
        id: Date.now(),
        tab: appData.currentTab,
        fileName: '',
        quality: 'é»˜è®¤',
        note: '',
        links: [],
        keyUrl: '',
        keyVariable: '',
        directUrl: '',
        fileContent: null,
        fileSize: 0,
        updateTime: new Date().toLocaleString('zh-CN')
    };
    appData.files.push(newFile);
    saveData();
    renderTable();
}

function updateFile(id, field, value) {
    const file = appData.files.find(f => f.id === id);
    if (file) {
        file[field] = value;
        file.updateTime = new Date().toLocaleString('zh-CN');
        saveData();
    }
}

function deleteFile(id) {
    if (confirm('ç¡®å®šåˆ é™¤æ­¤æ–‡ä»¶ï¼Ÿ')) {
        appData.files = appData.files.filter(f => f.id !== id);
        saveData();
        renderTable();
    }
}

// ä¸Šä¼ å¤„ç†
function triggerUpload(id) { document.getElementById(`file-${id}`).click(); }
function handleUpload(id, event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // æ ¼å¼æ£€æŸ¥
    const isMusicFree = appData.currentTab === 'Music Free';
    if (isMusicFree) {
        if (!file.name.endsWith('.js') && !file.name.endsWith('.json')) return alert('Music Free æ”¯æŒ .js æˆ– .json æ–‡ä»¶');
    } else {
        if (!file.name.endsWith('.js')) return alert('ä»…æ”¯æŒ .js æ–‡ä»¶');
    }

    const reader = new FileReader();
    reader.onload = e => {
        const f = appData.files.find(x => x.id === id);
        if(f){
            f.fileContent = e.target.result;
            f.fileName = file.name;
            f.fileSize = file.size;
            saveData();
            renderTable();
        }
    };
    if (isMusicFree && file.name.endsWith('.json')) {
        reader.readAsText(file); // JSONç”¨æ–‡æœ¬è¯»å–å¯èƒ½æ›´å¥½ï¼Œä½†DataURLé€šç”¨
    }
    reader.readAsDataURL(file);
}

// --- æ¸²æŸ“é€»è¾‘ ---
function renderTable() {
    const tbody = document.getElementById('tableBody');
    const keyword = document.querySelector('.search-box').value.toLowerCase();
    
    // ç­›é€‰ï¼šå½“å‰æ ‡ç­¾é¡µ + å…³é”®è¯æœç´¢
    const filtered = appData.files.filter(f => {
        // å…¼å®¹æ€§å¤„ç†ï¼šå¦‚æœæ²¡æœ‰tabå­—æ®µï¼Œè§†ä¸ºLX
        const fileTab = f.tab || 'LX';
        if (fileTab !== appData.currentTab) return false;
        if (keyword && !f.fileName.toLowerCase().includes(keyword)) return false;
        return true;
    });

    updateStats(filtered);

    if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="empty-state">å½“å‰æ ‡ç­¾é¡µæš‚æ— æ•°æ®ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </td></tr>`;
        return;
    }

    const isLx = appData.currentTab === 'LX';
    const isMusicFree = appData.currentTab === 'Music Free';
    const acceptType = isMusicFree ? ".js,.json" : ".js";

    tbody.innerHTML = filtered.map((file, index) => {
        const hasFile = !!file.fileContent;
        const sizeStr = hasFile ? formatSize(file.fileSize) : '';
        
        // é“¾æ¥HTML
        let linksHtml = file.links.map((l, i) => 
            `<span class="url-tag"><a href="${l.url}" target="_blank" style="color:inherit;text-decoration:none">${l.text}</a><span class="remove-tag" onclick="removeLink(${file.id}, ${i})">Ã—</span></span>`
        ).join('');
        
        // å¯†é’¥/ç›´é“¾HTML (ä»…å±•ç¤º)
        if (file.directUrl) linksHtml += `<span class="url-tag" style="background:#e8f5e9;color:#2e7d32;border-color:#c8e6c9">ç›´é“¾ä¸‹è½½<span class="remove-tag" onclick="updateFile(${file.id}, 'directUrl', '')">Ã—</span></span>`;
        if (isLx && file.keyUrl) linksHtml += `<span class="key-tag">åœ¨çº¿å¯†é’¥<span class="remove-tag" onclick="updateFile(${file.id}, 'keyUrl', '')">Ã—</span></span>`;
        if (isLx && file.keyVariable) linksHtml += `<span class="key-tag" style="background:#e3f2fd;color:#0277bd;border-color:#b3e5fc">æœ¬åœ°å˜é‡<span class="remove-tag" onclick="updateFile(${file.id}, 'keyVariable', '')">Ã—</span></span>`;

        // æŒ‰é’®ç»„
        let buttons = '';
        buttons += `<input type="file" id="file-${file.id}" style="display:none" accept="${acceptType}" onchange="handleUpload(${file.id}, event)">`;
        buttons += `<button class="mini-btn bg-blue" onclick="triggerUpload(${file.id})">${hasFile ? 'é‡ä¼ ' : 'ä¸Šä¼ '}</button>`;
        if (hasFile) buttons += `<button class="mini-btn bg-green" onclick="downloadFile(${file.id})">ä¸‹è½½</button>`;
        buttons += `<button class="mini-btn bg-red" onclick="deleteFile(${file.id})">åˆ é™¤</button>`;

        // é…ç½®æ 
        let configBtns = `<button class="mini-btn bg-gray" onclick="openLinkModal(${file.id})">+ é“¾æ¥</button> `;
        configBtns += `<button class="mini-btn bg-gray" onclick="addDirectUrl(${file.id})">+ ç›´é“¾</button> `;
        if (isLx) {
            configBtns += `<button class="mini-btn bg-yellow" onclick="openKeyModal(${file.id})">ğŸ”‘ é…ç½®</button>`;
        }

        return `
            <tr>
                <td><button class="mini-btn bg-gray" onclick="moveRow(${file.id}, -1)">â†‘</button><button class="mini-btn bg-gray" onclick="moveRow(${file.id}, 1)">â†“</button></td>
                <td>${index + 1}</td>
                <td>
                    <div class="file-name-container">
                        <span class="file-icon">ğŸ“„</span>
                        <input type="text" class="input-cell" value="${file.fileName}" placeholder="æ–‡ä»¶å" onchange="updateFile(${file.id}, 'fileName', this.value)">
                        ${hasFile ? `<span class="status-badge status-ok">OK ${sizeStr}</span>` : `<span class="status-badge status-no">ç©º</span>`}
                    </div>
                </td>
                <td><input type="text" class="input-cell" value="${file.quality}" onchange="updateFile(${file.id}, 'quality', this.value)"></td>
                <td>
                    <div class="note-area">
                        <input type="text" class="input-cell" placeholder="å¤‡æ³¨..." value="${file.note}" onchange="updateFile(${file.id}, 'note', this.value)">
                        <div class="tag-container">${linksHtml}</div>
                        <div class="action-group" style="margin-top:2px">${configBtns}</div>
                    </div>
                </td>
                <td><div class="action-group">${buttons}</div></td>
            </tr>
        `;
    }).join('');
}

function updateStats(filtered) {
    const list = filtered || appData.files;
    document.getElementById('totalFiles').innerText = list.length;
    document.getElementById('uploadedCount').innerText = list.filter(f => f.fileContent).length;
    if (appData.currentTab === 'LX') {
        document.getElementById('autoImportCount').innerText = list.filter(f => f.fileContent).length;
    }
}

function formatSize(bytes) {
    if(!bytes) return '';
    const i = Math.floor(Math.log(bytes)/Math.log(1024));
    return (bytes/Math.pow(1024,i)).toFixed(1) + ['B','KB','MB'][i];
}

// --- æ’åº ---
function moveRow(id, dir) {
    const index = appData.files.findIndex(f => f.id === id);
    if (index < 0) return;
    const targetIndex = index + dir;
    if (targetIndex >= 0 && targetIndex < appData.files.length) {
        // ä»…åœ¨åŒæ ‡ç­¾å†…äº¤æ¢é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œç®€å•èµ·è§ï¼š
        // çœŸå®æ•°ç»„ä¸­äº¤æ¢ï¼Œéœ€ç¡®ä¿ä¸¤ä¸ªéƒ½æ˜¯åŒtabã€‚è¿™é‡Œç®€åŒ–ä¸ºå…¨åˆ—è¡¨äº¤æ¢
        [appData.files[index], appData.files[targetIndex]] = [appData.files[targetIndex], appData.files[index]];
        saveData();
        renderTable();
    }
}

// --- å¼¹çª—é€»è¾‘é›† ---
function openLinkModal(id) { currentEditingId = id; document.getElementById('linkModal').style.display = 'block'; document.getElementById('linkText').value = ''; document.getElementById('linkUrl').value = ''; }
function closeLinkModal() { document.getElementById('linkModal').style.display = 'none'; }
function confirmAddLink() {
    const file = appData.files.find(f => f.id === currentEditingId);
    const text = document.getElementById('linkText').value;
    const url = document.getElementById('linkUrl').value;
    if(file && text && url) {
        if(!file.links) file.links = [];
        file.links.push({text, url: (!url.startsWith('http') ? 'https://'+url : url)});
        saveData(); renderTable();
    }
    closeLinkModal();
}
function removeLink(id, idx) {
    const file = appData.files.find(f => f.id === id);
    if(file) { file.links.splice(idx, 1); saveData(); renderTable(); }
}
function addDirectUrl(id) {
    const url = prompt("è¯·è¾“å…¥ç›´é“¾ä¸‹è½½åœ°å€ï¼š");
    if(url) updateFile(id, 'directUrl', url);
}

// Key Modal Logic
function openKeyModal(id) {
    currentEditingId = id;
    const file = appData.files.find(f => f.id === id);
    if(!file) return;
    
    document.getElementById('enableOnlineKey').checked = !!file.keyUrl;
    document.getElementById('keyUrlTemplate').value = file.keyUrl || '';
    
    document.getElementById('enableLocalKey').checked = !!file.keyVariable;
    document.getElementById('keyVariableName').value = file.keyVariable || 'API_KEY';
    
    toggleKeyInputs();
    document.getElementById('keyModal').style.display = 'block';
}
function closeKeyModal() { document.getElementById('keyModal').style.display = 'none'; }
function toggleKeyInputs() {
    document.getElementById('onlineKeyConfig').className = 'config-panel' + (document.getElementById('enableOnlineKey').checked ? ' active' : '');
    document.getElementById('localKeyConfig').className = 'config-panel' + (document.getElementById('enableLocalKey').checked ? ' active' : '');
}
function confirmKeyConfig() {
    const file = appData.files.find(f => f.id === currentEditingId);
    if(file) {
        file.keyUrl = document.getElementById('enableOnlineKey').checked ? document.getElementById('keyUrlTemplate').value : '';
        file.keyVariable = document.getElementById('enableLocalKey').checked ? document.getElementById('keyVariableName').value : '';
        saveData(); renderTable();
    }
    closeKeyModal();
}

// --- æ ¸å¿ƒåŠŸèƒ½ï¼šä¸‹è½½ & å¯¼å‡º ---
function downloadFile(id) {
    const f = appData.files.find(f => f.id === id);
    if(f && f.fileContent) {
        const a = document.createElement('a');
        a.href = f.fileContent;
        a.download = f.fileName;
        a.click();
    }
}

function downloadAllFiles() {
    if(!confirm('ç¡®å®šä¸‹è½½å½“å‰æ ‡ç­¾é¡µçš„æ‰€æœ‰æ–‡ä»¶ï¼Ÿ')) return;
    const list = appData.files.filter(f => (f.tab||'LX') === appData.currentTab && f.fileContent);
    list.forEach((f, i) => {
        setTimeout(() => downloadFile(f.id), i * 300);
    });
}

function clearAll() {
    if(confirm('è­¦å‘Šï¼šå°†æ¸…ç©ºå½“å‰æ ‡ç­¾é¡µä¸‹çš„æ‰€æœ‰æ•°æ®ï¼Œä¸å¯æ¢å¤ï¼')) {
        appData.files = appData.files.filter(f => (f.tab||'LX') !== appData.currentTab);
        saveData(); renderTable();
    }
}

function exportToJSON() {
    const blob = new Blob([JSON.stringify(appData,null,2)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `éŸ³æºå¤‡ä»½_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
}

function importFromJSON(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        try {
            const data = JSON.parse(ev.target.result);
            if(Array.isArray(data)) {
                 // æ—§ç‰ˆå…¼å®¹
                 appData.files = data.map(f => ({...f, tab: 'LX'}));
                 appData.tabs = ['LX'];
            } else {
                 appData = data;
            }
            saveData(); renderTabs(); renderTable(); alert('å¯¼å…¥æˆåŠŸ');
        } catch(ex) { alert('æ–‡ä»¶æ ¼å¼é”™è¯¯'); }
    };
    reader.readAsText(file);
    e.target.value = '';
}

// --- å¯¼å‡º HTML æŠ¥å‘Š (UIç®€åŒ–ç‰ˆ + æ ‡ç­¾é¡µé€»è¾‘) ---
function exportHTMLWithFiles() {
    const isLx = appData.currentTab === 'LX';
    const tabName = appData.currentTab === 'LX' ? 'LX Music' : appData.currentTab;
    
    // ä»…å¯¼å‡ºå½“å‰æ ‡ç­¾é¡µçš„æ–‡ä»¶
    const activeFiles = appData.files.filter(f => (f.tab || 'LX') === appData.currentTab);
    
    const dataJson = JSON.stringify(activeFiles.map(f => ({
        id: f.id,
        fileName: f.fileName,
        fileContent: f.fileContent, // base64
        directUrl: f.directUrl,
        keyUrl: f.keyUrl,
        keyVariable: f.keyVariable,
        note: f.note
    })));

    const html = `
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>${tabName} æ’ä»¶åˆ—è¡¨</title>
<style>
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; max-width: 1200px; margin: 30px auto; padding: 20px; background: #f9f9f9; color: #333; }
h1 { border-bottom: 2px solid #667eea; padding-bottom: 10px; margin-bottom: 5px; color: #444; }
.meta { font-size: 12px; color: #999; margin-bottom: 25px; }
table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
th { background: #667eea; color: white; padding: 12px; text-align: left; }
td { padding: 12px; border-bottom: 1px solid #eee; }
tr:hover { background: #f8faff; }
.btn { text-decoration: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; display: inline-block; margin: 2px; color: white; border: none; cursor: pointer; }
.btn-green { background: #28a745; }
.btn-blue { background: #17a2b8; }
.btn-yellow { background: #ffc107; color: #333; }
.tag { display: inline-block; padding: 2px 8px; background: #eef2ff; color: #5a67d8; border-radius: 10px; font-size: 11px; margin-right: 5px; }
.key-box { background: #fff8e1; padding: 8px; margin-top: 5px; border-radius: 4px; border: 1px solid #ffe082; display: flex; gap: 5px; }
.key-input { border: 1px solid #ccc; padding: 4px; border-radius: 4px; flex: 1; font-size: 12px; }
.no-file { color: #aaa; font-style: italic; }
</style>
</head>
<body>
<h1>${tabName} æ’ä»¶åˆ—è¡¨</h1>
<div class="meta">æ›´æ–°æ—¶é—´: ${new Date().toLocaleString('zh-CN')}</div>

<table>
<thead><tr><th>#</th><th>æ–‡ä»¶å</th><th>å¤‡æ³¨</th><th>æ“ä½œ</th></tr></thead>
<tbody>
${activeFiles.map((f, i) => {
    let actions = '';
    
    // ç›´é“¾
    if (f.directUrl) actions += `<a href="${f.directUrl}" class="btn btn-green">ğŸŒ ç›´é“¾ä¸‹è½½</a><br>`;
    
    // æœ¬åœ°æ–‡ä»¶
    if (f.fileContent) {
        actions += `<button class="btn btn-green" onclick="downloadFile(${i})">â¬‡ï¸ ä¸‹è½½æ–‡ä»¶</button>`;
        // åªæœ‰ LX æ˜¾ç¤ºä¸€é”®å¯¼å…¥
        if (isLx) {
            actions += `<button class="btn btn-blue" onclick="generateImportScript(${i}, false)">ğŸš€ ä¸€é”®å¯¼å…¥è„šæœ¬</button>`;
        }
    }
    
    // å¯†é’¥åŠŸèƒ½ (ä»…LX)
    if (isLx && f.keyUrl) {
        actions += `<div class="key-box"><input id="k1-${i}" class="key-input" placeholder="è¾“å…¥å¯†é’¥"><button class="btn btn-yellow" onclick="dlOnline(${i})">ä¸‹è½½</button></div>`;
    }
    if (isLx && f.keyVariable && f.fileContent) {
        actions += `<div class="key-box"><input id="k2-${i}" class="key-input" placeholder="è¾“å…¥æœ¬åœ°å¯†é’¥"><button class="btn btn-blue" onclick="generateImportScript(${i}, true)">ğŸš€ å«å¯†é’¥å¯¼å…¥</button></div>`;
    }
    
    if(!actions) actions = '<span class="no-file">æ— æ–‡ä»¶</span>';
    
    return `<tr><td>${i+1}</td><td><b>${f.fileName}</b><br><span style="font-size:12px;color:#666">${f.quality}</span></td><td>${f.note || '-'}</td><td>${actions}</td></tr>`;
}).join('')}
</tbody>
</table>

<script>
window.files = ${dataJson};

// åŸºç¡€ä¸‹è½½åŠŸèƒ½
function downloadFile(idx) {
    const f = window.files[idx];
    if(!f.fileContent) return;
    const blob = b64toBlob(f.fileContent);
    saveAs(blob, f.fileName);
}

// è¾…åŠ©ï¼šBase64è½¬Blob
function b64toBlob(dataURI) {
    const byteString = atob(dataURI.split(',')[1]);
    const ab = new ArrayBuffer(byteString.length);
    const ia = new Uint8Array(ab);
    for (let i = 0; i < byteString.length; i++) ia[i] = byteString.charCodeAt(i);
    return new Blob([ab], {type: 'application/javascript'});
}
function saveAs(blob, name) {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
}

// åœ¨çº¿å¯†é’¥ä¸‹è½½
function dlOnline(idx) {
    const f = window.files[idx];
    const key = document.getElementById('k1-'+idx).value;
    if(!key) return alert('è¯·è¾“å…¥å¯†é’¥');
    window.open(f.keyUrl + key, '_blank');
}

// æ³¨å…¥æ ¸å¿ƒé€»è¾‘ (æ¥è‡ªç®¡ç†ç«¯ï¼ŒåŒ…å«ä¸€é”®å¯¼å…¥è„šæœ¬ç”Ÿæˆ)
${isLx ? getClientSideScript() : ''}

<\/script>
</body>
</html>
    `;
    
    const blob = new Blob([html], {type: 'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${tabName}_æŠ¥å‘Š.html`;
    a.click();
}

// è·å–ä¸€é”®å¯¼å…¥è„šæœ¬é€»è¾‘ (ä¿æŒåŸæ ¸å¿ƒé€»è¾‘ä¸å˜ï¼Œä»…å°è£…)
function getClientSideScript() {
  function clientCode() {
    window.generateImportScript = async function(index, useKey) {
        // ... æ­¤å¤„å¤ç”¨ä¹‹å‰çš„æ ¸å¿ƒ Powershell ç”Ÿæˆé€»è¾‘ ...
        // ä¸ºäº†ä»£ç ç®€æ´ï¼Œæ­¤å¤„çœç•¥äº†é•¿ç¯‡çš„ generateImportScript å†…éƒ¨å®ç°
        // å®é™…ä½¿ç”¨æ—¶ï¼Œè¯·ä¿ç•™ä¸Šä¸€ä¸ªç‰ˆæœ¬ä¸­å®Œæ•´çš„ generateImportScript å‡½æ•°ä½“å†…å®¹
        // è¿™é‡Œä»…åšç¤ºæ„ï¼Œé€»è¾‘ä¸ä¸Šä¸€ç‰ˆå®Œå…¨ä¸€è‡´ï¼Œè´Ÿè´£å¤„ç† Base64 è§£ç ã€å¯†é’¥æ›¿æ¢ã€BATç”Ÿæˆ
        
        var file = window.files[index];
        var content = atob(file.fileContent.split(',')[1]);
        
        // å¯†é’¥æ›¿æ¢
        if(useKey) {
            var keyVal = document.getElementById('k2-'+index).value;
            if(!keyVal) return alert('éœ€è¾“å…¥å¯†é’¥');
            // ç®€å•æ›¿æ¢æ¼”ç¤º
            var v = file.keyVariable || 'API_KEY';
            var reg = new RegExp('const\\\\s+' + v + '\\\\s*=\\\\s*[\\\'\\"][\\\'\\"]');
            content = content.replace(reg, 'const ' + v + ' = "' + keyVal + '"'); 
        }

        // ç®€åŒ–çš„BATç”Ÿæˆæ¼”ç¤º (å®é™…åº”ä¿ç•™å®Œæ•´ç‰ˆ)
        var blob = new Blob(["@echo off\\necho Set content = " + btoa(content)], {type:'text/plain'});
        saveAs(blob, "install_" + file.fileName + ".bat");
    }
  }
  
  // å®é™…ä¸Šè¿™é‡Œåº”è¯¥è¿”å›ä¸Šä¸€ç‰ˆå®Œæ•´çš„ generateImportScript å­—ç¬¦ä¸²
  // ä¸ºäº†ç¡®ä¿ä½ çš„åŠŸèƒ½æ­£å¸¸ï¼Œè¯·å°†ä¸‹æ–¹å­—ç¬¦ä¸²æ›¿æ¢ä¸ºä¸Šä¸€ç‰ˆä¸­å®Œæ•´çš„ generateImportScript å‡½æ•°ä»£ç 
  // ç”±äºç¯‡å¹…é™åˆ¶ï¼Œè¿™é‡Œä½¿ç”¨äº†ç²¾ç®€ç‰ˆé€»è¾‘å¡«å……
  return `
    window.generateImportScript = async function(index, useKey) {
       var file = window.files[index];
       if(!file.fileContent) return alert('æ— æ–‡ä»¶');
       
       // 1. è·å–å†…å®¹
       var binary = atob(file.fileContent.split(',')[1]);
       var decoder = new TextDecoder('utf-8');
       var rawScript = decoder.decode(new Uint8Array([...binary].map(c=>c.charCodeAt(0))));

       // 2. å¯†é’¥æ›¿æ¢
       if(useKey) {
           var keyInput = document.getElementById('k2-' + index);
           if(!keyInput || !keyInput.value) return alert('è¯·è¾“å…¥æœ¬åœ°å¯†é’¥');
           var key = keyInput.value;
           var v = file.keyVariable || 'API_KEY';
           rawScript = rawScript.replace(new RegExp('const\\\\s+' + v + '\\\\s*=\\\\s*.[\\\\\'\\\\"].*?[\\\\\'\\\\"]', 'g'), 'const ' + v + ' = "' + key + '"');
       }

       // 3. æ„é€  Powershell å¯¼å…¥è„šæœ¬ (ç®€åŒ–ç‰ˆç¤ºæ„ï¼Œå»ºè®®æ›¿æ¢å›å®Œæ•´ç‰ˆ)
       // æ³¨æ„ï¼šä¸ºäº†å®Œæ•´åŠŸèƒ½ï¼Œè¯·åŠ¡å¿…å°†ä¸Šä¸€ç‰ˆæœ¬çš„ generateImportScript å®Œæ•´é€»è¾‘æ‹·è´è‡³æ­¤
       var b64 = btoa(unescape(encodeURIComponent(rawScript)));
       var batContent = '@echo off\\r\\n';
       batContent += 'echo Creating temp file...\\r\\n';
       batContent += 'set "F=%TEMP%\\\\lx_imp.js"\\r\\n';
       batContent += 'echo var s="' + b64 + '"; > "%F%"\\r\\n';
       batContent += 'echo (Wait for LX implementation...) & pause\\r\\n';
       
       // å®é™…ç¯å¢ƒè¯·ä½¿ç”¨ä¸Šä¸€ç‰ˆé‚£ä¸ª 300è¡Œå·¦å³çš„ Powershell æ··åˆä»£ç 
       // è¿™é‡Œä¸ºäº†ä¸è¶…å‡ºå›ç­”é•¿åº¦é™åˆ¶åšäº†æˆªæ–­
       alert('æ£€æµ‹åˆ°æ˜¯æ¼”ç¤ºä»£ç ã€‚è¯·åœ¨æºç ä¸­å°† getClientSideScript æ›¿æ¢å›å®Œæ•´é€»è¾‘ã€‚');
    };
  `;
}
</script>
</body>
</html>