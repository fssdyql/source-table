<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æ’ä»¶åˆ—è¡¨ç®¡ç†å™¨ v1.3.0-fix4</title>
  <style>
    /* --- åŸºç¡€æ ·å¼ --- */
    * { margin: 0;
padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: #f0f2f5; padding: 20px;
color: #333; min-height: 100vh; }
    .container { max-width: 1600px; margin: 0 auto; background: white; border-radius: 10px;
padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
    
    /* å¤´éƒ¨ */
    .header { text-align: center;
margin-bottom: 25px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; }
    h1 { font-size: 24px; color: #2c3e50; margin-bottom: 5px;
}
    .version-tag { font-size: 12px; background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 4px; vertical-align: middle;
margin-left: 8px; border: 1px solid #bbf7d0; }
    .subtitle { font-size: 12px; color: #999;
}

    /* æ ‡ç­¾é¡µ */
    .tabs-wrapper { display: flex; align-items: center; border-bottom: 2px solid #e9ecef;
margin-bottom: 15px; gap: 5px; user-select: none; }
    .tab-btn { padding: 10px 25px; border: none; background: transparent;
cursor: pointer; font-size: 14px; font-weight: 500; color: #666; border-radius: 8px 8px 0 0; transition: all 0.2s; position: relative;
}
    .tab-btn:hover { background: #f8f9fa; color: #333; }
    .tab-btn.active { background: #fff; color: #667eea;
font-weight: bold; border: 1px solid #e9ecef; border-bottom: 2px solid #fff; margin-bottom: -2px; z-index: 1;
}
    .tab-add-btn { width: 30px; height: 30px; border-radius: 50%; border: 1px dashed #ccc; background: transparent; cursor: pointer;
color: #999; font-size: 18px; margin-left: 5px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;
}
    .tab-add-btn:hover { border-color: #667eea; color: #667eea; background: #f0f4ff; }
    .tab-close { font-size: 10px;
margin-left: 8px; opacity: 0.5; border-radius: 50%; padding: 0 4px; }
    .tab-close:hover { background: #ffcccc; color: #cc0000;
opacity: 1; }

    /* å·¥å…·æ  */
    .toolbar { display: flex; gap: 10px; padding: 12px;
background: #f8f9fa; border-radius: 8px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
    .search-box { padding: 8px 12px;
border: 1px solid #ced4da; border-radius: 4px; font-size: 13px; width: 220px; }
    .spacer { flex: 1;
}
    
    .lx-toggle { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 500;
background: #e3f2fd; padding: 6px 12px; border-radius: 4px; border: 1px solid #bbdefb; color: #0d47a1; margin-left: 10px;
}
    .lx-toggle input { cursor: pointer; width: 16px; height: 16px;
}

    /* æŒ‰é’® */
    .btn { padding: 8px 16px; border: none; border-radius: 5px;
cursor: pointer; font-size: 13px; color: white; transition: opacity 0.2s; display: inline-flex; align-items: center; gap: 5px; user-select: none;
}
    .btn:hover { opacity: 0.9; }
    .btn:active { transform: translateY(1px);
}
    .btn-green { background: #28a745; }
    .btn-blue { background: #667eea;
}
    .btn-info { background: #17a2b8; }
    .btn-gray { background: #6c757d;
}
    .btn-red { background: #dc3545; }
    
    .btn-xs { padding: 4px 8px;
font-size: 12px; border-radius: 3px; border: none; cursor: pointer; color: white; margin-right: 2px; margin-bottom: 2px; display: inline-block;
}
    .btn-cfg { background: #f0ad4e; color: white; }
    .btn-link { background: #5bc0de; color: white;
}
    .btn-del { background: #d9534f; }
    .btn-up { background: #5a6268;
}
    .btn-reset { background: #6c757d; color: white; margin-left: 2px; font-family: monospace;
}
    .btn-direct { background: #20c997; color: white;
}

    /* è¡¨æ ¼ */
    .table-container { overflow-x: auto; border: 1px solid #eee; border-radius: 8px;
background: white; min-height: 200px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px;
}
    th { background: #f8f9fa; padding: 12px 10px; text-align: left; font-weight: 600; color: #444;
border-bottom: 2px solid #eee; white-space: nowrap; }
    td { padding: 10px; border-bottom: 1px solid #f1f1f1; vertical-align: top;
}
    tr:hover { background: #fafafa; }
    
    input[type="text"], select { width: 100%;
padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; transition: border 0.2s;
}
    input[type="text"]:focus, select:focus { border-color: #667eea; outline: none;
}

    /* çŠ¶æ€ä¸æ ‡ç­¾ */
    .status-ok { background: #d4edda; color: #155724; padding: 2px 6px;
border-radius: 3px; font-size: 11px; display: inline-block; border: 1px solid #c3e6cb; }
    .status-no { background: #f8d7da; color: #721c24;
padding: 2px 6px; border-radius: 3px; font-size: 11px; display: inline-block; border: 1px solid #f5c6cb;
}
    
    .tag-container { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px;
}
    .tag { font-size: 11px; padding: 2px 8px; border-radius: 10px; background: #eef2ff; color: #5a67d8;
border: 1px solid #dbeafe; display: flex; align-items: center; gap: 4px; }
    .tag-key { background: #fff3cd; color: #856404;
border-color: #ffeeba; }
    .tag-direct { background: #d1fae5; color: #065f46; border-color: #a7f3d0;
}
    .tag-remove { cursor: pointer; font-weight: bold; opacity: 0.6; }
    .tag-remove:hover { opacity: 1;
color: #dc3545; }

    /* å¼¹çª— */
    .modal { display: none; position: fixed; top: 0;
left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
    .modal-content { background: white; width: 450px;
margin: 80px auto; padding: 20px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: popIn 0.2s; max-height: 85vh; overflow-y: auto;
}
    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1;
} }
    .modal-header { font-weight: bold; font-size: 16px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;
border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .form-group { margin-bottom: 15px;
}
    .form-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 13px;
}
    
    .check-label { display: flex; align-items: center; gap: 8px; font-size: 14px; cursor: pointer;
background: #f8f9fa; padding: 8px; border-radius: 5px; border: 1px solid #eee; margin-bottom: 8px; }
    .check-label:hover { background: #e9ecef;
}
    .check-label input { width: 16px; height: 16px; margin: 0;
}
    .config-area { margin-left: 24px; padding: 10px; background: #fff; border-left: 3px solid #ccc; display: none; margin-bottom: 10px;
}
    .config-area.active { display: block; }
    .config-area.blue { border-left-color: #667eea;
}
    .config-area.yellow { border-left-color: #f0ad4e; }

    .empty-state { padding: 40px; text-align: center; color: #aaa;
font-style: italic; }
    .error-row { color: red; padding: 10px; background: #fff0f0;
}
    .tab-list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
    .tab-list-item:last-child { border-bottom: none; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>æ’ä»¶åˆ—è¡¨ç®¡ç†å™¨ <span class="version-tag">v1.3.0-fix4</span></h1>
    <p class="subtitle">æ›´æ–°æ—¶é—´: <span id="updateTime">-</span></p>
  </div>

  <div class="tabs-wrapper" id="tabsContainer"></div>

  <div class="toolbar">
    <button class="btn btn-green" onclick="safeAction(addNewRow)">â• æ·»åŠ æ–‡ä»¶</button>
    <button class="btn btn-blue" onclick="exportData('json')">ğŸ’¾ å¤‡ä»½æ•°æ®</button>
    <button class="btn btn-info" onclick="exportData('html')">ğŸ“¤ å¯¼å‡ºåˆ—è¡¨</button>
    <div class="lx-toggle" id="lxScriptToggle" style="display:none">
        <input type="checkbox" id="enableScript" onchange="saveData();">
        <label for="enableScript">å¯ç”¨ä¸€é”®å¯¼å…¥è„šæœ¬ (ä»…LX)</label>
    </div>

    
 <div class="spacer"></div>
    <input type="file" id="importInput" style="display:none" onchange="importData(this)">
    <button class="btn btn-gray" onclick="document.getElementById('importInput').click()">ğŸ“‚ å¯¼å…¥æ—§ç‰ˆ/å¤‡ä»½</button>
    
    <button class="btn btn-gray" onclick="openTabManagerModal()">âš™ï¸ æ ‡ç­¾é¡µç®¡ç†</button>
    
    <input type="text" class="search-box" placeholder="ğŸ” æœç´¢æ–‡ä»¶å..." oninput="renderTable()">
  </div>

  <div class="table-container">
    <table id="mainTable">
      <thead>
        <tr>
          <th width="60">æ’åº</th>
          <th width="300">æ–‡ä»¶å & çŠ¶æ€</th>
          <th width="150">éŸ³è´¨/ç‰ˆæœ¬</th>
          <th width="350">å¤‡æ³¨ & é…ç½®</th>
  
          <th width="200">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<div id="tabModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">æ ‡ç­¾é¡µç®¡ç† <span style="cursor:pointer" onclick="closeModal('tabModal')">Ã—</span></div>
    
    <h3>å†…ç½®æ ‡ç­¾é¡µ</h3>
    <div style="margin-top: 10px;">
        <label class="check-label" style="background:#f0f0f0;">
            <input type="checkbox" checked disabled> LX 
        </label>
        <label class="check-label">
            <input type="checkbox" id="chkMusicFree"> Music Free
        </label>
        <label class="check-label">
            <input type="checkbox" id="chkLanYin"> æ¾œéŸ³
        </label>
    </div>

    <h3 style="margin-top:20px;">è‡ªå®šä¹‰æ ‡ç­¾é¡µ</h3>
    <div id="customTabList" style="margin-bottom: 15px;">
        </div>

    <div class="form-group">
        <label>æ·»åŠ è‡ªå®šä¹‰åç§°ï¼š</label>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="newTabName" placeholder="ä¾‹å¦‚ï¼šXXéŸ³ä¹">
            <button class="btn btn-blue" onclick="safeAction(addCustomTab)">æ·»åŠ </button>
        </div>
    </div>
    <div style="text-align:right;">
        <button class="btn btn-gray" onclick="closeModal('tabModal')">å…³é—­</button>
        <button class="btn btn-blue" onclick="safeAction(confirmTabManager)">ä¿å­˜è®¾ç½®</button>
    </div>
  </div>
</div>

<div id="linkModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">æ·»åŠ æ–‡ä»¶é“¾æ¥ <span style="cursor:pointer" onclick="closeModal('linkModal')">Ã—</span></div>
        <div class="form-group"><label>é“¾æ¥æ–‡æœ¬ (å¦‚: ç™¾åº¦ç½‘ç›˜)ï¼š</label><input type="text" id="linkText"></div>
        <div class="form-group"><label>é“¾æ¥ URLï¼š</label><input type="text" id="linkUrl"></div>
        <div style="text-align:right;">
            <button class="btn btn-gray" onclick="closeModal('linkModal')">å–æ¶ˆ</button>
            <button class="btn btn-blue" onclick="confirmAddLink()">æ·»åŠ </button>
        </div>
    </div>
</div>

<div id="directModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">æ·»åŠ åœ¨çº¿ä¸‹è½½é“¾æ¥ <span style="cursor:pointer" onclick="closeModal('directModal')">Ã—</span></div>
        <div class="form-group">
            <label>åœ¨çº¿ä¸‹è½½é“¾æ¥ï¼š</label>
            <input type="text" id="directUrl" placeholder="ä¾‹å¦‚: https://cdn.example.com/file.js">
            <small style="color:#666; margin-top:5px; display:block;">ğŸ’¡ ç”¨æˆ·ç‚¹å‡»ä¸‹è½½æ—¶å°†ç›´æ¥è®¿é—®æ­¤é“¾æ¥</small>
        </div>
        <div style="text-align:right;">
            <button class="btn btn-gray" onclick="closeModal('directModal')">å–æ¶ˆ</button>
            <button class="btn btn-blue" onclick="confirmDirectUrl()">ä¿å­˜</button>
        </div>
    </div>
</div>

<div id="keyModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">å¯†é’¥é…ç½® <span style="cursor:pointer" onclick="closeModal('keyModal')">Ã—</span></div>
        <label class="check-label"><input type="checkbox" id="chkOnlineKey" onchange="toggleKeyUI()"> ğŸ”— å¯ç”¨åœ¨çº¿ Key æ¨¡å¼</label>
        <div id="areaOnlineKey" class="config-area yellow">
            <div class="form-group"><label>é“¾æ¥æ¨¡æ¿ï¼š</label><input type="text" id="keyUrl" placeholder="https://api.com?key="></div>
        </div>
        <label class="check-label"><input type="checkbox" id="chkLocalKey" onchange="toggleKeyUI()"> ğŸ“‚ å¯ç”¨æœ¬åœ° Key æ¨¡å¼</label>
        <div id="areaLocalKey" class="config-area blue">
            <div class="form-group"><label>å˜é‡åï¼š</label><input type="text" id="keyVar" placeholder="é»˜è®¤: API_KEY"></div>
            <small style="color:#666; margin-top:-10px; display:block;">ğŸ’¡ å˜é‡åç”¨äºæ›¿æ¢æ–‡ä»¶å†…å®¹ä¸­çš„ `const API_KEY = ""` ç»“æ„</small>
        </div>
        <div style="text-align:right; margin-top:20px;">
            <button class="btn btn-gray" onclick="closeModal('keyModal')">å–æ¶ˆ</button>
            <button class="btn btn-blue" onclick="confirmKeyConfig()">ä¿å­˜é…ç½®</button>
        </div>
    </div>
</div>

<script>
// --- æ ¸å¿ƒé€»è¾‘ ---
const STORAGE_KEY = 'plugin_mgr_v130_fix4'; // æ›´æ”¹ç‰ˆæœ¬å·
const QUALITY_OPTIONS = ['128k', '320k', 'flac', 'flac24bit', 'master', 'sky', 'dolby'];
const INFO_LIMITS = { name: 30, description: 100, author: 30, version: 15, homepage: 100 };
const BUILT_IN_TABS = ['LX', 'Music Free', 'æ¾œéŸ³'];

// [Fix 1] å¢åŠ  currentList ç”¨äºç¨³å®šç´¢å¼•
let app = { 
    tabs: ['LX'], 
    currentTab: 'LX', 
    files: [], 
    lxScriptEnabled: true, 
    currentList: [] 
}; 
let currentEditId = null;

// å®‰å…¨æ‰§è¡Œ
function safeAction(fn, ...args) {
    try {
        fn(...args);
    } catch (e) {
        console.error("Action Failed:", e);
        alert("é”™è¯¯: " + e.message);
    }
}

window.onload = function() {
    loadData();
    renderTabs();
    renderTable();
};

function loadData() {
    try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
            const data = JSON.parse(raw);
            if (Array.isArray(data)) app.files = data.map(f => sanitizeFile(f));
            else {
                app = data;
                if (!app.files) app.files = [];
                app.files = app.files.map(f => sanitizeFile(f));
                if (!app.tabs || app.tabs.length === 0) app.tabs = ['LX'];
                
                // ç¡®ä¿ LX æ ‡ç­¾é¡µæ°¸è¿œå­˜åœ¨
                if (!app.tabs.includes('LX')) app.tabs.unshift('LX');

                if (!app.currentTab || !app.tabs.includes(app.currentTab)) app.currentTab = app.tabs[0];
            }
        }
        if (app.currentTab === 'LX') {
            document.getElementById('lxScriptToggle').style.display = 'flex';
            document.getElementById('enableScript').checked = app.lxScriptEnabled;
        } else {
            document.getElementById('lxScriptToggle').style.display = 'none';
        }
        document.getElementById('updateTime').textContent = new Date().toLocaleString('zh-CN');
    } catch (e) {
        console.error("Load Data Error:", e);
        alert("æ•°æ®åŠ è½½å¤±è´¥ï¼Œå¯èƒ½æ•°æ®å·²æŸåã€‚å·²é‡ç½®æ•°æ®ã€‚");
        app.files = [];
        app.tabs = ['LX'];
        app.currentTab = 'LX';
        saveData();
    }
}

function saveData() {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(app));
        checkStorage();
    } catch (e) {
        console.error("Save Data Error:", e);
        alert("æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®æˆ–æ¸…ç†å­˜å‚¨ç©ºé—´ã€‚");
    }
}

function sanitizeFile(f) {
    return {
        id: f.id || Date.now() + Math.random(),
        fileName: f.fileName || '',
        quality: f.quality || '',
        note: f.note || '',
        links: f.links || [],
        keyMode: f.keyMode || '',
        keyUrl: f.keyUrl || '',
        keyVariable: f.keyVariable || '',
        directUrl: f.directUrl || '',
        fileContent: f.fileContent || null,
        fileSize: f.fileSize || 0,
        tab: f.tab || 'LX',
        author: f.author || '',
        version: f.version || '',
    };
}

// [Fix 3] ç§»é™¤å­˜å‚¨ç©ºé—´ä¸è¶³çš„è­¦å‘Š
function checkStorage() {
    try {
        const remaining = 5 * 1024 * 1024 - (localStorage.getItem(STORAGE_KEY) || '').length;
        if (remaining < 500 * 1024) { 
            // alert('è­¦å‘Šï¼šæµè§ˆå™¨å­˜å‚¨ç©ºé—´ä¸è¶³ï¼ˆå‰©ä½™' + formatSize(remaining) + 'ï¼‰ï¼Œå¯èƒ½æ— æ³•ä¿å­˜æ›´å¤šæ–‡ä»¶ï¼'); 
        }
    } catch (e) {
        console.error("Storage Check Error:", e);
    }
}

function formatSize(bytes) {
    if (!bytes || bytes === 0) return '';
    const i = Math.floor(Math.log(bytes) / Math.log(1024));
    return (bytes / Math.pow(1024, i)).toFixed(2) + ['B', 'KB', 'MB'][i];
}

// --- å¼¹çª—ä¸æ§åˆ¶ ---
function openModal(id) { document.getElementById(id).style.display = 'block'; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; currentEditId = null; }

function toggleKeyUI() {
    const online = document.getElementById('chkOnlineKey').checked;
    const local = document.getElementById('chkLocalKey').checked;
    document.getElementById('areaOnlineKey').classList.toggle('active', online);
    document.getElementById('areaLocalKey').classList.toggle('active', local);
}

function openKeyModal(id) {
    currentEditId = id;
    const f = app.files.find(x => x.id === id);
    if (!f) return;

    document.getElementById('chkOnlineKey').checked = !!f.keyUrl;
    document.getElementById('keyUrl').value = f.keyUrl || '';
    document.getElementById('chkLocalKey').checked = !!f.keyVariable;
    document.getElementById('keyVar').value = f.keyVariable || '';
    
    toggleKeyUI();
    openModal('keyModal');
}

function confirmKeyConfig() {
    const f = app.files.find(x => x.id === currentEditId);
    if (f) {
        const online = document.getElementById('chkOnlineKey').checked;
        const local = document.getElementById('chkLocalKey').checked;

        f.keyUrl = online ? document.getElementById('keyUrl').value.trim() : '';
        f.keyVariable = local ? document.getElementById('keyVar').value.trim() : '';
        
        if (f.keyUrl && !f.keyUrl.includes('{key}')) {
             if (confirm('é“¾æ¥æ¨¡æ¿æœªåŒ…å« {key} å ä½ç¬¦ï¼Œç¡®å®šä¿å­˜å—ï¼Ÿ')) { /* pass */ } else { return; }
        }

        saveData();
        renderTable();
    }
    closeModal('keyModal');
}

// --- æ ‡ç­¾é¡µç®¡ç†é€»è¾‘ (Fix 2) ---

function renderTabs() {
    const container = document.getElementById('tabsContainer');
    container.innerHTML = app.tabs.map(t => {
        const activeClass = t === app.currentTab ? 'active' : '';
        // æ ‡ç­¾é¡µçš„å…³é—­æŒ‰é’®ï¼Œåªåœ¨æ ‡ç­¾é¡µç®¡ç†å¼¹çª—é‡Œæ“ä½œ
        return `<button class="tab-btn ${activeClass}" onclick="safeAction(switchTab, '${t}')">${t}</button>`;
    }).join('');
    // å°†æ·»åŠ æŒ‰é’®æ”¹ä¸ºç®¡ç†æŒ‰é’®
    container.innerHTML += `<button class="tab-add-btn" onclick="openTabManagerModal()">âš™ï¸</button>`;
}

function switchTab(tab) {
    app.currentTab = tab;
    if (app.currentTab === 'LX') {
        document.getElementById('lxScriptToggle').style.display = 'flex';
        app.lxScriptEnabled = document.getElementById('enableScript').checked;
    } else {
        document.getElementById('lxScriptToggle').style.display = 'none';
    }
    renderTabs();
    renderTable();
}

function openTabManagerModal() {
    // æ¸²æŸ“å†…ç½®æ ‡ç­¾é¡µçš„å‹¾é€‰çŠ¶æ€
    document.getElementById('chkMusicFree').checked = app.tabs.includes('Music Free');
    document.getElementById('chkLanYin').checked = app.tabs.includes('æ¾œéŸ³');
    
    // æ¸²æŸ“è‡ªå®šä¹‰æ ‡ç­¾é¡µ
    renderCustomTabsInModal();
    
    openModal('tabModal');
}

function renderCustomTabsInModal() {
    const container = document.getElementById('customTabList');
    const customTabs = app.tabs.filter(t => !BUILT_IN_TABS.includes(t));
    
    if (customTabs.length === 0) {
        container.innerHTML = '<p style="color:#999; font-size:13px;">æš‚æ— è‡ªå®šä¹‰æ ‡ç­¾é¡µã€‚</p>';
        return;
    }

    container.innerHTML = customTabs.map(t => {
        return `
            <div class="tab-list-item">
                <span>${t}</span>
                <div>
                    <button class="btn btn-red btn-xs" onclick="safeAction(removeTab, event, '${t}')">ğŸ—‘ï¸ åˆ é™¤</button>
                    <button class="btn btn-gray btn-xs" onclick="safeAction(clearTabFiles, event, '${t}')">ğŸ§¹ æ¸…ç©ºæ–‡ä»¶</button>
                </div>
            </div>
        `;
    }).join('');
}

function addCustomTab() {
    const newName = (document.getElementById('newTabName').value || '').trim();
    if (!newName) return alert('è¯·è¾“å…¥æ ‡ç­¾é¡µåç§°ï¼');
    if (app.tabs.includes(newName)) return alert('æ ‡ç­¾é¡µå·²å­˜åœ¨ï¼');
    
    app.tabs.push(newName);
    // æ’åºï¼šLX/MusicFree/æ¾œéŸ³/è‡ªå®šä¹‰...
    app.tabs.sort((a, b) => {
        const aIndex = BUILT_IN_TABS.indexOf(a);
        const bIndex = BUILT_IN_TABS.indexOf(b);
        if (aIndex === -1 && bIndex === -1) return a.localeCompare(b); // éƒ½æ˜¯è‡ªå®šä¹‰ï¼ŒæŒ‰å­—æ¯
        if (aIndex === -1) return 1; // aæ˜¯è‡ªå®šä¹‰ï¼Œbæ˜¯å†…ç½®
        if (bIndex === -1) return -1; // bæ˜¯è‡ªå®šä¹‰ï¼Œaæ˜¯å†…ç½®
        return aIndex - bIndex; // éƒ½æ˜¯å†…ç½®ï¼ŒæŒ‰å†…ç½®é¡ºåº
    });

    document.getElementById('newTabName').value = '';
    renderCustomTabsInModal(); // ç«‹å³æ›´æ–°å¼¹çª—
}

function confirmTabManager() {
    let newTabs = ['LX'];
    if (document.getElementById('chkMusicFree').checked) newTabs.push('Music Free');
    if (document.getElementById('chkLanYin').checked) newTabs.push('æ¾œéŸ³');
    
    // é‡æ–°æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾é¡µ
    const customTabs = app.tabs.filter(t => !BUILT_IN_TABS.includes(t));
    newTabs.push(...customTabs);

    app.tabs = [...new Set(newTabs)]; // ç¡®ä¿å”¯ä¸€æ€§
    
    // ç¡®ä¿å½“å‰é€‰ä¸­çš„æ ‡ç­¾é¡µä»ç„¶å­˜åœ¨
    if (!app.tabs.includes(app.currentTab)) {
        app.currentTab = 'LX';
    }

    saveData();
    renderTabs();
    renderTable();
    closeModal('tabModal');
}

function removeTab(e, t) {
    e.stopPropagation();
    if(BUILT_IN_TABS.includes(t)) return alert("å†…ç½®æ ‡ç­¾é¡µæ— æ³•é€šè¿‡æ­¤æ–¹å¼åˆ é™¤ï¼");

    if(confirm('ç¡®å®šåˆ é™¤æ ‡ç­¾é¡µ "' + t + '" å—ï¼Ÿæ‰€æœ‰è¯¥æ ‡ç­¾é¡µä¸‹çš„æ–‡ä»¶éƒ½å°†ä¸¢å¤±ã€‚')) {
        app.files = app.files.filter(f=>(f.tab||'LX')!==t);
        app.tabs=app.tabs.filter(x=>x!==t);
        if(app.currentTab===t) app.currentTab='LX';
        saveData();
        renderTabs();
        renderTable();
        renderCustomTabsInModal(); // é‡æ–°æ¸²æŸ“å¼¹çª—å†…å®¹
    }
}

function clearTabFiles(e, t) {
    e.stopPropagation();
    if(confirm('ç¡®å®šæ¸…ç©ºæ ‡ç­¾é¡µ "' + t + '" ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å—ï¼Ÿ')) {
        app.files = app.files.filter(f=>(f.tab||'LX')!==t);
        saveData();
        renderTable();
        renderCustomTabsInModal();
        if (app.currentTab === t) {
             alert(`æ ‡ç­¾é¡µ [${t}] æ–‡ä»¶å·²æ¸…ç©ºã€‚`);
        }
    }
}

// --- è¡¨æ ¼æ¸²æŸ“ ---
function renderTable() {
    const tbody = document.getElementById('tableBody');
    if(!tbody) return;
    try {
        const keyword = document.querySelector('.search-box').value.toLowerCase();
        const list = app.files.filter(f => {
            const fTab = f.tab || 'LX';
            return fTab === app.currentTab && (!keyword || (f.fileName||'').toLowerCase().includes(keyword) || (f.note||'').toLowerCase().includes(keyword));
        });
        
        // [Fix 1] å­˜å‚¨å½“å‰åˆ—è¡¨ï¼Œç”¨äºåŠ¨ä½œå‡½æ•°çš„ç´¢å¼•
        app.currentList = list;

        if (list.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="empty-state">å½“å‰åˆ—è¡¨ä¸ºç©ºï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹â€œæ·»åŠ æ–‡ä»¶â€</td></tr>`;
            return;
        }
        
        const isLX = app.currentTab === 'LX';
        const isMF = app.currentTab === 'Music Free';
        const acceptTypes = isMF ? ".js,.json" : ".js";

        tbody.innerHTML = list.map((f, i) => {
            // éŸ³è´¨
            let qualityInputHtml = '';
            const allOptions = QUALITY_OPTIONS.concat(f.quality === 'è‡ªå®šä¹‰' || (f.quality && !QUALITY_OPTIONS.includes(f.quality)) ? [f.quality] : []);
            
            if (isLX || app.currentTab === 'æ¾œéŸ³') {
                const isCustom = f.quality === 'è‡ªå®šä¹‰' || (f.quality && !QUALITY_OPTIONS.includes(f.quality));
                if (!isCustom) {
                    qualityInputHtml = `
                    <select onchange="safeAction(handleQualityChange, ${f.id}, this.value)">
                        <option value="">è¯·é€‰æ‹©...</option>
                        ${QUALITY_OPTIONS.map(opt => `<option value="${opt}" ${f.quality===opt?'selected':''}>${opt}</option>`).join('')}
                        <option value="CUSTOM_ENTRY">âœ è‡ªå®šä¹‰...</option>
                    </select>`;
                } else {
                    qualityInputHtml = `
                    <div style="display:flex; gap:2px;">
                        <input type="text" value="${f.quality==='è‡ªå®šä¹‰'?'':f.quality}" onblur="safeAction(updateFile, ${f.id}, 'quality', this.value.trim()||'è‡ªå®šä¹‰')" placeholder="è¾“å…¥è‡ªå®šä¹‰éŸ³è´¨">
                        <button class="btn-reset" onclick="safeAction(handleQualityChange, ${f.id}, '')">Ã—</button>
                    </div>`;
                }
            } else {
                 qualityInputHtml = `<input type="text" value="${f.quality}" onblur="safeAction(updateFile, ${f.id}, 'quality', this.value.trim())" placeholder="ç‰ˆæœ¬å·/éŸ³è´¨">`;
            }
            
            // å¤‡æ³¨ & é…ç½®
            let tagsHtml = '';
            if (f.keyUrl || f.keyVariable || f.directUrl) {
                tagsHtml += '<div class="tag-container">';
                if (f.keyUrl) tagsHtml += `<span class="tag tag-key" title="${f.keyUrl}">ğŸ”‘ åœ¨çº¿ Key</span>`;
                if (f.keyVariable) tagsHtml += `<span class="tag tag-key" title="${f.keyVariable}">æœ¬åœ° Key</span>`;
                if (f.directUrl) tagsHtml += `<span class="tag tag-direct" title="${f.directUrl}">ğŸ”— åœ¨çº¿ä¸‹è½½</span>`;
                tagsHtml += '</div>';
            }
            
            let linksHtml = '';
            if (f.links && f.links.length > 0) {
                linksHtml += '<div class="tag-container" style="margin-top:8px;">';
                f.links.forEach((l, idx) => {
                    linksHtml += `<span class="tag"><a href="${l.url}" target="_blank" style="color:inherit; text-decoration:none;">${l.text}</a> <span class="tag-remove" onclick="safeAction(removeLink, ${f.id}, ${idx})">Ã—</span></span>`;
                });
                linksHtml += '</div>';
            }

            // æ“ä½œæŒ‰é’® (Actions)
            let actionButtons = '';
            const en = app.lxScriptEnabled && isLX;

            // [Fix 1] åœ¨çº¿ä¸‹è½½ (ç›´é“¾)
            if(f.directUrl) actionButtons += `<a class="btn btn-direct btn-xs" href="${f.directUrl}" download style="margin-right:0">â¬‡ï¸ åœ¨çº¿ä¸‹è½½</a>`;

            // æœ¬åœ°æ–‡ä»¶æ“ä½œ
            if (f.fileContent) {
                const fileSizeInfo = formatSize(f.fileSize);
                
                // å§‹ç»ˆæ˜¾ç¤ºä¸‹è½½åŸæ–‡ä»¶æŒ‰é’®
                actionButtons += `<button class="btn btn-green btn-xs" onclick="safeAction(downloadFile, ${f.id})" style="margin-right:0" title="å¤§å°: ${fileSizeInfo}">â¬‡ï¸ ä¸‹è½½åŸæ–‡ä»¶</button>`;
                
                // æœ¬åœ° Key ç›¸å…³ä¸‹è½½ä¸å¯¼å…¥
                if(isLX && f.keyVariable){
                    // ä¸‹è½½JS(å«Key)
                    actionButtons += `<button class="btn btn-info btn-xs" title="ä»…ä¸‹è½½æ›¿æ¢äº†Keyçš„JSæ–‡ä»¶" onclick="safeAction(DL_JS, ${i})">ä¸‹è½½JS(å«Key)</button>`; 
                    
                    // Keyed One-click Import (åªæœ‰å¼€å¯äº†æ‰æ˜¾ç¤º)
                    if(en) {
                         actionButtons += `<button class="btn btn-blue btn-xs" title="ç”Ÿæˆè‡ªåŠ¨å®‰è£…è„šæœ¬(å«Key)" onclick="safeAction(DL_IMPORT, ${i})">ğŸš€ ä¸€é”®å¯¼å…¥(å«Key)</button>`;
                    }
                } 
                
                // æ ‡å‡†ä¸€é”®å¯¼å…¥ (åªæœ‰LX tab, å¯ç”¨è„šæœ¬, ä¸”æ²¡æœ‰é…ç½®æœ¬åœ°Keyæ—¶æ˜¾ç¤º)
                else if (isLX && en && !f.keyVariable) {
                    actionButtons += `<button class="btn btn-blue btn-xs" title="ç”Ÿæˆè‡ªåŠ¨å®‰è£…è„šæœ¬" onclick="safeAction(DL_IMPORT, ${i})">ğŸš€ ä¸€é”®å¯¼å…¥</button>`;
                }
            }

            // å…¶ä»–æŒ‰é’®
            actionButtons += `<button class="btn btn-cfg btn-xs" onclick="safeAction(openKeyModal, ${f.id})">ğŸ”‘ å¯†é’¥/URL</button>`;
            actionButtons += `<button class="btn btn-link btn-xs" onclick="safeAction(openLinkModal, ${f.id})">ğŸ”— æ·»åŠ é“¾æ¥</button>`;
            actionButtons += `<button class="btn btn-link btn-xs" onclick="safeAction(openDirectModal, ${f.id})">ğŸŒ é…ç½®ç›´é“¾</button>`; // æ¢å¤ç›´é“¾é…ç½®
            actionButtons += `<button class="btn btn-del btn-xs" onclick="safeAction(deleteRow, ${f.id})">åˆ é™¤</button>`;
            actionButtons += `<button class="btn btn-up btn-xs" onclick="safeAction(moveRow, ${f.id}, -1)">â–²</button>`;
            actionButtons += `<button class="btn btn-up btn-xs" onclick="safeAction(moveRow, ${f.id}, 1)">â–¼</button>`;
            

            const status = f.fileContent ? `<span class="status-ok">æ–‡ä»¶å°±ç»ª${formatSize(f.fileSize)}</span>` : '<span class="status-no">æœªä¸Šä¼ æ–‡ä»¶</span>';
            const uploadBtnText = f.fileContent ? 'ğŸ“¤ é‡ä¼ ' : 'ğŸ“ ä¸Šä¼ ';

            return `
            <tr>
                <td>${i + 1}</td>
                <td>
                    <input type="text" value="${f.fileName}" onblur="safeAction(updateFile, ${f.id}, 'fileName', this.value.trim())" placeholder="æ–‡ä»¶å">
                    ${status}
                </td>
                <td>
                    ${qualityInputHtml}
                    <input type="text" value="${f.version}" onblur="safeAction(updateFile, ${f.id}, 'version', this.value.trim())" placeholder="ç‰ˆæœ¬å·" style="margin-top:5px;">
                </td>
                <td>
                    <input type="text" value="${f.note}" onblur="safeAction(updateFile, ${f.id}, 'note', this.value.trim())" placeholder="å¤‡æ³¨ä¿¡æ¯">
                    ${tagsHtml}
                    ${linksHtml}
                    <div style="margin-top: 10px; display: flex; gap: 5px;">
                        <input type="file" id="file-${f.id}" style="display:none" accept="${acceptTypes}" onchange="safeAction(uploadFile, ${f.id}, this)">
                        <button class="btn btn-info btn-xs" onclick="document.getElementById('file-${f.id}').click()">${uploadBtnText}</button>
                    </div>
                </td>
                <td>
                    <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                        ${actionButtons}
                    </div>
                </td>
            </tr>`;
        }).join('');

    } catch (e) {
        tbody.innerHTML = `<tr><td colspan="5" class="error-row">æ¸²æŸ“é”™è¯¯: ${e.message}</td></tr>`;
    }
}

// --- æ•°æ®æ“ä½œ ---
function addNewRow() {
    app.files.push(sanitizeFile({ tab: app.currentTab }));
    saveData();
    renderTable();
}

function updateFile(id, key, val) {
    const f = app.files.find(x => x.id === id);
    if(f) { 
        f[key] = val; 
        saveData(); 
        renderTable(); 
    }
}

function handleQualityChange(id, val) {
    const f = app.files.find(x => x.id === id);
    if(f) {
        f.quality = val === 'CUSTOM_ENTRY' ? "è‡ªå®šä¹‰" : val;
        saveData(); 
        renderTable();
    }
}

function deleteRow(id) {
    if(confirm('ç¡®å®šåˆ é™¤è¯¥æ–‡ä»¶å—ï¼Ÿ')) {
        app.files = app.files.filter(f => f.id !== id);
        saveData();
        renderTable();
    }
}

function moveRow(id, direction) {
    const list = app.files.filter(f => (f.tab || 'LX') === app.currentTab);
    const oldIndex = list.findIndex(f => f.id === id);
    if (oldIndex === -1) return;

    const newIndex = oldIndex + direction;
    if (newIndex >= 0 && newIndex < list.length) {
        // Swap IDs in the global app.files array's current tab entries
        const targetFile = list[oldIndex];
        const swapFile = list[newIndex];
        
        // Find their positions in the global array
        const globalOldIndex = app.files.findIndex(f => f.id === targetFile.id);
        const globalNewIndex = app.files.findIndex(f => f.id === swapFile.id);

        if(globalOldIndex !== -1 && globalNewIndex !== -1) {
            [app.files[globalOldIndex], app.files[globalNewIndex]] = [app.files[globalNewIndex], app.files[globalOldIndex]];
            saveData();
            renderTable();
        }
    }
}

// --- æ–‡ä»¶æ“ä½œ ---
function uploadFile(id, input) {
    const file = input.files[0];
    if(!file) return; 

    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
    const acceptTypes = (app.currentTab === 'Music Free' ? ".js,.json" : ".js").split(',');
    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
    if (!acceptTypes.includes(fileExtension)) {
        alert(`æ–‡ä»¶ç±»å‹é”™è¯¯ï¼å½“å‰æ ‡ç­¾é¡µåªæ¥å—: ${acceptTypes.join(', ')}`);
        input.value = '';
        return;
    }

    const reader = new FileReader();
    reader.onload = e => {
        const f = app.files.find(x => x.id === id);
        if(f) {
            f.fileContent = e.target.result;
            f.fileName = f.fileName || file.name;
            f.fileSize = file.size;
            saveData();
            renderTable();
        }
    };
    reader.readAsDataURL(file);
    input.value = '';
}

function downloadFile(id) {
    const f = app.files.find(x => x.id === id);
    if (f && f.fileContent) {
        const a = document.createElement('a');
        a.href = f.fileContent;
        a.download = f.fileName;
        a.click();
    } else {
        alert("æ–‡ä»¶å†…å®¹ä¸ºç©ºï¼Œæ— æ³•ä¸‹è½½ã€‚");
    }
}

// --- é“¾æ¥ä¸å¯†é’¥å¼¹çª— ---
function openLinkModal(id) {
    currentEditId = id;
    document.getElementById('linkText').value='';
    document.getElementById('linkUrl').value='';
    openModal('linkModal');
}

function confirmAddLink() {
    const f=app.files.find(x=>x.id===currentEditId), 
          t=document.getElementById('linkText').value.trim(), 
          u=document.getElementById('linkUrl').value.trim();
          
    if(f&&t&&u) {
        const finalUrl = (!u.startsWith('http')) ? 'https://' + u : u;
        if (!f.links) f.links = [];
        f.links.push({text:t, url:finalUrl});
        saveData(); 
        renderTable(); 
    } else if (!t || !u) {
        alert("è¯·å¡«å†™å®Œæ•´çš„é“¾æ¥æ–‡æœ¬å’Œ URLï¼");
        return;
    }
    closeModal('linkModal');
}

function removeLink(fid, idx) {
    const f=app.files.find(x=>x.id===fid);
    if(f && f.links){
        f.links.splice(idx,1);
        saveData();
        renderTable();
    }
}

function openDirectModal(id) {
    currentEditId=id;
    document.getElementById('directUrl').value=app.files.find(x=>x.id===id)?.directUrl||'';
    openModal('directModal');
}

function confirmDirectUrl() {
    const f=app.files.find(x=>x.id===currentEditId);
    if(f){
        f.directUrl=document.getElementById('directUrl').value.trim();
        saveData();
        renderTable();
    }
    closeModal('directModal');
}


// --- å¯¼å‡ºä¸å¯¼å…¥ ---
function exportData(type) {
    const data = JSON.stringify(app);
    let blob;
    let filename;

    if (type === 'json') {
        blob = new Blob([data], {type: "application/json;charset=utf-8"});
        filename = 'LX_Plugin_Manager_Backup_' + Date.now() + '.json';
    } else if (type === 'html') {
        const list = app.files.filter(f => (f.tab || 'LX') === app.currentTab);
        if (list.length === 0) return alert('å½“å‰åˆ—è¡¨ä¸ºç©ºï¼');
        
        let htmlContent = `
            <!DOCTYPE html><html><head><meta charset="UTF-8"><title>æ’ä»¶åˆ—è¡¨ - ${app.currentTab}</title>
            <style>
                body { font-family: sans-serif; padding: 20px; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
                .status-ok { color: green; } .status-no { color: red; }
            </style>
            </head><body>
            <h1>æ’ä»¶åˆ—è¡¨ - ${app.currentTab}</h1>
            <p>å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString('zh-CN')}</p>
            <table>
                <thead><tr><th>#</th><th>æ–‡ä»¶å</th><th>éŸ³è´¨/ç‰ˆæœ¬</th><th>å¤‡æ³¨</th><th>ä¸‹è½½é“¾æ¥</th><th>Key é…ç½®</th></tr></thead>
                <tbody>
        `;
        list.forEach((f, i) => {
            const status = f.fileContent ? 'å·²ä¸Šä¼ ' : (f.directUrl ? 'åœ¨çº¿é“¾æ¥' : 'æ— æ–‡ä»¶');
            const links = (f.links || []).map(l => `<a href="${l.url}" target="_blank">${l.text}</a>`).join('; ');
            const direct = f.directUrl ? `<a href="${f.directUrl}" download>åœ¨çº¿ä¸‹è½½</a>` : '';
            const keyInfo = (f.keyUrl ? `åœ¨çº¿Key: ${f.keyUrl}` : '') + (f.keyVariable ? ` æœ¬åœ°Keyå˜é‡: ${f.keyVariable}` : '');
            
            htmlContent += `
                <tr>
                    <td>${i + 1}</td>
                    <td>${f.fileName} (${status})</td>
                    <td>${f.quality || '-'} / ${f.version || '-'}</td>
                    <td>${f.note || '-'}</td>
                    <td>${direct} ${links}</td>
                    <td>${keyInfo || '-'}</td>
                </tr>
            `;
        });
        htmlContent += '</tbody></table></body></html>';
        
        blob = new Blob([htmlContent], {type: "text/html;charset=utf-8"});
        filename = `LX_Plugin_List_${app.currentTab}_${Date.now()}.html`;
    } else {
        return;
    }
    
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
}

function importData(input) {
    const file = input.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = e => {
        try {
            const data = JSON.parse(e.target.result);
            if (data.files || Array.isArray(data)) {
                if (confirm('ç¡®å®šå¯¼å…¥æ•°æ®å—ï¼Ÿè¿™ä¼šè¦†ç›–ç°æœ‰æ•°æ®ï¼')) {
                    if (Array.isArray(data)) {
                        app.files = data.map(f => sanitizeFile(f));
                        app.tabs = ['LX'];
                        app.currentTab = 'LX';
                    } else {
                        app = data;
                        if (!app.files) app.files = [];
                        app.files = app.files.map(f => sanitizeFile(f));
                        if (!app.tabs || app.tabs.length === 0) app.tabs = ['LX'];
                        
                        // ç¡®ä¿ LX æ ‡ç­¾é¡µæ°¸è¿œå­˜åœ¨
                        if (!app.tabs.includes('LX')) app.tabs.unshift('LX');
                        
                        if (!app.currentTab || !app.tabs.includes(app.currentTab)) app.currentTab = app.tabs[0];
                    }
                    saveData();
                    renderTabs();
                    renderTable();
                    alert("æ•°æ®å¯¼å…¥æˆåŠŸï¼");
                }
            } else {
                 throw new Error("æ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–æ•°æ®ç»“æ„ä¸æ­£ç¡®");
            }
        } catch (e) {
            alert("æ–‡ä»¶è¯»å–æˆ–è§£æå¤±è´¥: " + e.message);
        }
    };
    reader.readAsText(file);
    input.value = '';
}

// --- LX è„šæœ¬ç”Ÿæˆä¸ä¸‹è½½ (Fix 1 æ ¸å¿ƒä¿®æ”¹) ---

// è¾…åŠ©å‡½æ•°
function truncateText(text, limit) { return text.length > limit ? text.substring(0, limit - 3) + '...' : text; }

// BAT/PS è„šæœ¬ä¸»ä½“
const psCode = '$json_base64_file="$env:TEMP\\$args[0]"\n' +
               '$ps_base64_file="$env:TEMP\\$args[1]"\n' +
               '$ps_file="$env:TEMP\\$args[2]"\n' +
               'try {\n' +
               '  $json_base64 = Get-Content $json_base64_file\n' +
               '  $ps_base64 = Get-Content $ps_base64_file\n' +
               '  \n' +
               '  [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($ps_base64)) | Out-File $ps_file -Encoding UTF8\n' +
               '  \n' +
               '  $content = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($json_base64))\n' +
               '  $data = ConvertFrom-Json $content\n' +
               '  \n' +
               '  $import_script_path = (Get-Content $ps_file | Select-String -Pattern \'^\\$LX_IMPORT_SCRIPT_PATH="(.+)"$\').Matches[0].Groups[1].Value\n' +
               '  \n' +
               '  if (-not (Test-Path $import_script_path)) {\n' +
               '    Write-Error "LX Music Pro not found or import script path not recognized."\n' +
               '    exit 1\n' +
               '  }\n' +
               '  \n' +
               '  $api_id = $data.id\n' +
               '  $api_file_path = Join-Path $import_script_path "$api_id.json"\n' +
               '  \n' +
               '  $data | ConvertTo-Json -Depth 100 | Out-File $api_file_path -Encoding UTF8\n' +
               '  \n' +
               '  Write-Host "Successfully imported $api_id"\n' +
               '} catch {\n' +
               '  Write-Error $_.Exception.Message\n' +
               '  exit 1\n' +
               '}\n' +
               '$json_base64_file\n' +
               '$ps_base64_file\n' +
               '$ps_file\n' +
               'exit 0\n';


// æ ¸å¿ƒæ–‡ä»¶å†…å®¹å¤„ç†å‡½æ•° (æ›¿æ¢ Key å˜é‡)
function processContent(index, key) {
    const file = app.currentList[index]; // [Fix 1] ä½¿ç”¨ currentList
    let decodedData;
    
    try {
        const base64Content = file.fileContent.split(',')[1];
        const bytes = atob(base64Content);
        
        // å°è¯•ç”¨ TextDecoder è§£ç 
        var decoder = new TextDecoder("utf-8");
        decodedData = decoder.decode(bytes); 

        // æ›¿æ¢ Key å˜é‡
        if (key) {
            var keyVariable = file.keyVariable || "API_KEY";
            // ä½¿ç”¨ new RegExp åŠ¨æ€æ„å»ºæ­£åˆ™ï¼Œé¿å…å­—ç¬¦ä¸²è½¬ä¹‰é—®é¢˜
            var regex1 = new RegExp("const\\s+" + keyVariable + "\\s*=\\s*\"\"", "g");
            var regex2 = new RegExp("const\\s+" + keyVariable + "\\s*=\\s*\'\'", "g");
            var regex3 = new RegExp("let\\s+" + keyVariable + "\\s*=\\s*\"\"", "g");
            var regex4 = new RegExp("let\\s+" + keyVariable + "\\s*=\\s*\'\'", "g");
            var regex5 = new RegExp("var\\s+" + keyVariable + "\\s*=\\s*\"\"", "g");
            var regex6 = new RegExp("var\\s+" + keyVariable + "\\s*=\\s*\'\'", "g");
            
            // æ›¿æ¢ Key 
            decodedData = decodedData.replace(regex1, "const " + keyVariable + " = \"" + key + "\"");
            decodedData = decodedData.replace(regex2, "const " + keyVariable + " = \'" + key + "\'");
            decodedData = decodedData.replace(regex3, "let " + keyVariable + " = \"" + key + "\"");
            decodedData = decodedData.replace(regex4, "let " + keyVariable + " = \'" + key + "\'");
            decodedData = decodedData.replace(regex5, "var " + keyVariable + " = \"" + key + "\"");
            decodedData = decodedData.replace(regex6, "var " + keyVariable + " = \'" + key + "\'");

            // ç§»é™¤å¯èƒ½å­˜åœ¨çš„å…¬ç›Šç‰ˆ/å…è´¹ç‰ˆå­—æ ·
            decodedData = decodedData.replace(/\(å…¬ç›Šç‰ˆ\)/g, "").replace(/\(å…è´¹ç‰ˆ\)/g, "").replace(/ï¼ˆå…¬ç›Šç‰ˆï¼‰/g, "").replace(/ï¼ˆå…è´¹ç‰ˆï¼‰/g, "");
        }

        return decodedData;
    } catch (e) {
        alert("å¤„ç†æ–‡ä»¶å¤±è´¥ï¼š" + e.message);
        return null;
    }
}

// ä¸‹è½½å«Keyçš„JSæ–‡ä»¶
window.DL_JS = function(index) {
    const file = app.currentList[index]; // [Fix 1] ä½¿ç”¨ currentList
    
    // å¦‚æœæ˜¯å«Keyä¸‹è½½ï¼Œå°è¯•è·å–Key
    let key = null;
    let useKey = false;
    if (file.keyVariable) {
        const keyInput = document.getElementById('k2-'+index);
        if (keyInput) {
            key = keyInput.value.trim();
            if (!key) {
                alert("è¯·è¾“å…¥å¯†é’¥ï¼");
                keyInput.focus();
                return;
            }
            useKey = true;
        }
    }
    
    // å¦‚æœæ˜¯æ— Keyä¸‹è½½ï¼Œkeyå’ŒuseKeyéƒ½æ˜¯null/false
    const content = processContent(index, useKey ? key : null);
    if(!content) return; 

    try {
        const blob = new Blob([content], {type: "text/javascript;charset=utf-8"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = file.fileName;
        a.click();
    } catch(e) {
        alert("ä¸‹è½½å¤±è´¥: " + e);
    }
};

// ç”Ÿæˆä¸€é”®å¯¼å…¥è„šæœ¬ (Fix 1: æ›¿æ¢ä¸ºæ—§ç‰ˆæ›´å¯é çš„é€»è¾‘)
window.DL_IMPORT = async function(index) {
    const btn = event.target;
    const orgTxt = btn.innerText;
    btn.innerText = "ç”Ÿæˆä¸­...";
    btn.disabled = true;
    
    try {
        const file = app.currentList[index]; // [Fix 1] ä½¿ç”¨ currentList
        if (!file) throw new Error("æ–‡ä»¶æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢");

        let key = null;
        let useKey = false;

        if(file.keyVariable) {
            const keyInput = document.getElementById('k2-'+index);
            key = keyInput ? keyInput.value.trim() : "";
            if(!key) throw new Error("è¯·è¾“å…¥ Key");
            useKey = true;
        }

        const scriptContent = processContent(index, useKey ? key : null);
        if (!scriptContent) throw new Error("å¤„ç†è„šæœ¬å†…å®¹å¤±è´¥");

        // --- æ ¸å¿ƒå‹ç¼©é€»è¾‘ (é‡‡ç”¨æ—§ç‰ˆæ›´å¯é çš„å®ç°) ---

        // å‹ç¼©
        const stream = new Blob([new TextEncoder().encode(scriptContent)]).stream();
        const compressedStream = stream.pipeThrough(new CompressionStream('deflate'));
        const response = await new Response(compressedStream).arrayBuffer();
        const compressedBytes = new Uint8Array(response);
        let binary = "";
        for (let i = 0; i < compressedBytes.byteLength; i++) {
            binary += String.fromCharCode(compressedBytes[i]);
        }
        const compressedBase64 = "gz_" + btoa(binary);

        // æ„é€ å…ƒæ•°æ® (ä»æ–‡ä»¶å…ƒæ•°æ®è·å–)
        const apiId = "user_api_" + Math.random().toString().substring(2, 5) + "_" + Date.now();
        const apiName = truncateText(file.fileName.replace(/\.js$/i,'') || "unknown", INFO_LIMITS.name);
        const apiDesc = truncateText(file.note || "Imported source", INFO_LIMITS.description);
        const apiAuthor = truncateText(file.author || "User", INFO_LIMITS.author);
        const apiVersion = truncateText(file.version || "1.0.0", INFO_LIMITS.version);
        const apiHomepage = truncateText((file.links[0]?.url || ""), INFO_LIMITS.homepage);
        
        const userApiObj = { 
            "id": apiId, 
            "name": apiName, 
            "description": apiDesc, 
            "version": apiVersion, 
            "author": apiAuthor, 
            "homepage": apiHomepage, 
            "allowShowUpdateAlert": true, 
            "script": compressedBase64 
        };
        
        const jsonStr = JSON.stringify(userApiObj);
        const jsonBase64 = btoa(unescape(encodeURIComponent(jsonStr)));
        const randId = Math.floor(Math.random() * 100000);

        const b64FileName = "lx_payload_" + randId + ".txt";
        const psFileName = "lx_importer_" + randId + ".ps1";
        const chunks = [];
        const chunkSize = 70;
        for (let i = 0; i < jsonBase64.length; i += chunkSize) {
            chunks.push(jsonBase64.substring(i, i + chunkSize));
        }

        // æ„é€  BAT
        let bat = '@echo off\r\nsetlocal\r\necho Initializing...\r\n';
        bat += 'set "B64_FILE=%TEMP%\\' + b64FileName + '"\r\n';
        bat += 'type nul > "%B64_FILE%"\r\n';
        for(let i=0; i<chunks.length; i++) { 
            bat += 'echo ' + chunks[i] + '>> "%B64_FILE%"\r\n'; 
        }

        // PS ç¼–ç 
        const psCodeBase64 = btoa(unescape(encodeURIComponent(psCode)));
        const psChunks = [];
        for (let k = 0; k < psCodeBase64.length; k += 70) {
            psChunks.push(psCodeBase64.substring(k, k + 70));
        }
        
        bat += 'set "PS_B64=%TEMP%\\ps_' + randId + '.b64"\r\n';
        bat += 'type nul > "%PS_B64%"\r\n';
        for(let m=0; m<psChunks.length; m++) { 
            bat += 'echo ' + psChunks[m] + '>> "%PS_B64%"\r\n'; 
        }

        bat += 'certutil -decode "%PS_B64%" "%TEMP%\\' + psFileName + '" >nul\r\n';
        bat += 'echo Running installation script...\r\n';
        bat += 'powershell -NoProfile -ExecutionPolicy Bypass -File "%TEMP%\\' + psFileName + '" "' + b64FileName + '" "ps_' + randId + '.b64" "' + psFileName + '"\r\n';

        bat += 'if %errorlevel% neq 0 ( color 4f & echo. & echo [ERROR] Installation Failed! & pause ) else ( \r\n';
        bat += ' del "%B64_FILE%"\r\n';
        bat += ' del "%PS_B64%"\r\n';
        bat += ' del "%TEMP%\\' + psFileName + '"\r\n';
        bat += ' echo. & echo [SUCCESS] Installation Complete! Please restart LX Music. & timeout /t 5 >nul \r\n';
        bat += ')\r\n';

        const blob = new Blob([bat], { type: "text/plain;charset=us-ascii" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "ä¸€é”®å¯¼å…¥_" + apiName.replace(/[\/\\?%*:|\"<>\s]/g, '_') + ".bat";
        link.click();

    } catch(e) {
        alert("ç”Ÿæˆè„šæœ¬å¤±è´¥: " + e.message);
    } finally {
        btn.innerText = orgTxt;
        btn.disabled = false;
    }
};

// --- å…¶ä»–ä»£ç  (JUMP_KEY ä¿æŒåŸæ ·ï¼Œæœªåœ¨ç”¨æˆ·é—®é¢˜ä¸­æ¶‰åŠ) ---
window.JUMP_KEY = function(index) {
    const file = app.currentList[index];
    if(!file) return;

    let key = document.getElementById('k1-'+index)?.value?.trim();
    if(!key) return alert("è¯·è¾“å…¥ Key");
    
    let url = file.keyUrl.replace('{key}', encodeURIComponent(key));
    window.open(url, '_blank');
}
</script>
</body>
</html>