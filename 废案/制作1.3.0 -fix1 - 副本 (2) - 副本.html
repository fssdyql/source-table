<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æ’ä»¶åˆ—è¡¨ç®¡ç†å™¨ v1.3.0-fix2</title>
  <style>
    /* --- åŸºç¡€æ ·å¼ --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: #f0f2f5; padding: 20px; color: #333; min-height: 100vh; }
    .container { max-width: 1600px; margin: 0 auto; background: white; border-radius: 10px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
    
    /* å¤´éƒ¨ */
    .header { text-align: center; margin-bottom: 25px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; }
    h1 { font-size: 24px; color: #2c3e50; margin-bottom: 5px; }
    .version-tag { font-size: 12px; background: #e0f2fe; color: #0369a1; padding: 2px 8px; border-radius: 4px; vertical-align: middle; margin-left: 8px; border: 1px solid #bae6fd; }
    .subtitle { font-size: 12px; color: #999; }

    /* æ ‡ç­¾é¡µ */
    .tabs-wrapper { display: flex; align-items: center; border-bottom: 2px solid #e9ecef; margin-bottom: 15px; gap: 5px; user-select: none; }
    .tab-btn { padding: 10px 25px; border: none; background: transparent; cursor: pointer; font-size: 14px; font-weight: 500; color: #666; border-radius: 8px 8px 0 0; transition: all 0.2s; position: relative; }
    .tab-btn:hover { background: #f8f9fa; color: #333; }
    .tab-btn.active { background: #fff; color: #667eea; font-weight: bold; border: 1px solid #e9ecef; border-bottom: 2px solid #fff; margin-bottom: -2px; z-index: 1; }
    .tab-add-btn { width: 30px; height: 30px; border-radius: 50%; border: 1px dashed #ccc; background: transparent; cursor: pointer; color: #999; font-size: 18px; margin-left: 5px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .tab-add-btn:hover { border-color: #667eea; color: #667eea; background: #f0f4ff; }
    .tab-close { font-size: 10px; margin-left: 8px; opacity: 0.5; border-radius: 50%; padding: 0 4px; }
    .tab-close:hover { background: #ffcccc; color: #cc0000; opacity: 1; }

    /* å·¥å…·æ  */
    .toolbar { display: flex; gap: 10px; padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
    .search-box { padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px; width: 220px; }
    .spacer { flex: 1; }
    
    .lx-toggle { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 500; background: #e3f2fd; padding: 6px 12px; border-radius: 4px; border: 1px solid #bbdefb; color: #0d47a1; margin-left: 10px; }
    .lx-toggle input { cursor: pointer; width: 16px; height: 16px; }

    /* æŒ‰é’® */
    .btn { padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-size: 13px; color: white; transition: opacity 0.2s; display: inline-flex; align-items: center; gap: 5px; user-select: none; }
    .btn:hover { opacity: 0.9; }
    .btn:active { transform: translateY(1px); }
    .btn-green { background: #28a745; }
    .btn-blue { background: #667eea; }
    .btn-info { background: #17a2b8; }
    .btn-gray { background: #6c757d; }
    .btn-red { background: #dc3545; }
    
    .btn-xs { padding: 4px 8px; font-size: 12px; border-radius: 3px; border: none; cursor: pointer; color: white; margin-right: 2px; margin-bottom: 2px; display: inline-block; }
    .btn-cfg { background: #f0ad4e; color: white; }
    .btn-link { background: #5bc0de; color: white; }
    .btn-del { background: #d9534f; }
    .btn-up { background: #5a6268; }
    .btn-reset { background: #6c757d; color: white; margin-left: 2px; font-family: monospace; }
    .btn-direct { background: #20c997; color: white; }

    /* è¡¨æ ¼ */
    .table-container { overflow-x: auto; border: 1px solid #eee; border-radius: 8px; background: white; min-height: 200px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { background: #f8f9fa; padding: 12px 10px; text-align: left; font-weight: 600; color: #444; border-bottom: 2px solid #eee; white-space: nowrap; }
    td { padding: 10px; border-bottom: 1px solid #f1f1f1; vertical-align: top; }
    tr:hover { background: #fafafa; }
    
    input[type="text"], select { width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; transition: border 0.2s; }
    input[type="text"]:focus, select:focus { border-color: #667eea; outline: none; }

    /* çŠ¶æ€ä¸æ ‡ç­¾ */
    .status-ok { background: #d4edda; color: #155724; padding: 2px 6px; border-radius: 3px; font-size: 11px; display: inline-block; border: 1px solid #c3e6cb; }
    .status-no { background: #f8d7da; color: #721c24; padding: 2px 6px; border-radius: 3px; font-size: 11px; display: inline-block; border: 1px solid #f5c6cb; }
    
    .tag-container { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px; }
    .tag { font-size: 11px; padding: 2px 8px; border-radius: 10px; background: #eef2ff; color: #5a67d8; border: 1px solid #dbeafe; display: flex; align-items: center; gap: 4px; }
    .tag-key { background: #fff3cd; color: #856404; border-color: #ffeeba; }
    .tag-direct { background: #d1fae5; color: #065f46; border-color: #a7f3d0; }
    .tag-remove { cursor: pointer; font-weight: bold; opacity: 0.6; }
    .tag-remove:hover { opacity: 1; color: #dc3545; }

    /* å¼¹çª— */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
    .modal-content { background: white; width: 450px; margin: 80px auto; padding: 20px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: popIn 0.2s; max-height: 85vh; overflow-y: auto; }
    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .modal-header { font-weight: bold; font-size: 16px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 13px; }
    
    .check-label { display: flex; align-items: center; gap: 8px; font-size: 14px; cursor: pointer; background: #f8f9fa; padding: 8px; border-radius: 5px; border: 1px solid #eee; margin-bottom: 8px; }
    .check-label:hover { background: #e9ecef; }
    .check-label input { width: 16px; height: 16px; margin: 0; }
    .config-area { margin-left: 24px; padding: 10px; background: #fff; border-left: 3px solid #ccc; display: none; margin-bottom: 10px; }
    .config-area.active { display: block; }
    .config-area.blue { border-left-color: #667eea; }
    .config-area.yellow { border-left-color: #f0ad4e; }

    .empty-state { padding: 40px; text-align: center; color: #aaa; font-style: italic; }
    .error-row { color: red; padding: 10px; background: #fff0f0; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>æ’ä»¶åˆ—è¡¨ç®¡ç†å™¨ <span class="version-tag">v1.3.0-fix2</span></h1>
    <p class="subtitle">æ›´æ–°æ—¶é—´: <span id="updateTime">-</span></p>
  </div>

  <div class="tabs-wrapper" id="tabsContainer"></div>

  <div class="toolbar">
    <button class="btn btn-green" onclick="safeAction(addNewRow)">â• æ·»åŠ æ–‡ä»¶</button>
    <button class="btn btn-blue" onclick="exportData('json')">ğŸ’¾ å¤‡ä»½æ•°æ®</button>
    <button class="btn btn-info" onclick="exportData('html')">ğŸ“¤ å¯¼å‡ºåˆ—è¡¨</button>
    <button class="btn btn-red" onclick="safeAction(clearCurrentTab)">ğŸ—‘ï¸ æ¸…ç©ºå½“å‰é¡µ</button>
    
    <div class="lx-toggle" id="lxScriptToggle" style="display:none">
        <input type="checkbox" id="enableScript" onchange="saveData();">
        <label for="enableScript">å¯ç”¨ä¸€é”®å¯¼å…¥è„šæœ¬ (ä»…LX)</label>
    </div>

    <div class="spacer"></div>
    <input type="file" id="importInput" style="display:none" onchange="importData(this)">
    <button class="btn btn-gray" onclick="document.getElementById('importInput').click()">ğŸ“‚ å¯¼å…¥æ—§ç‰ˆ/å¤‡ä»½</button>
    <input type="text" class="search-box" placeholder="ğŸ” æœç´¢æ–‡ä»¶å..." oninput="renderTable()">
  </div>

  <div class="table-container">
    <table id="mainTable">
      <thead>
        <tr>
          <th width="60">æ’åº</th>
          <th width="300">æ–‡ä»¶å & çŠ¶æ€</th>
          <th width="150">éŸ³è´¨/ç‰ˆæœ¬</th>
          <th width="350">å¤‡æ³¨ & é…ç½®</th>
          <th width="200">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<div id="tabModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">æ·»åŠ æ–°æ ‡ç­¾é¡µ <span style="cursor:pointer" onclick="closeModal('tabModal')">Ã—</span></div>
    <div class="form-group">
        <label>å¿«é€Ÿé€‰æ‹©ï¼š</label>
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <button class="btn btn-info btn-xs" onclick="quickAddTab('Music Free')">Music Free</button>
            <button class="btn btn-info btn-xs" onclick="quickAddTab('æ¾œéŸ³')">æ¾œéŸ³</button>
        </div>
        <label>æˆ– è‡ªå®šä¹‰åç§°ï¼š</label>
        <input type="text" id="newTabName" placeholder="è¾“å…¥åç§°...">
    </div>
    <div style="text-align:right"><button class="btn btn-blue" onclick="confirmAddTab()">ç¡®å®š</button></div>
  </div>
</div>

<div id="linkModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">æ·»åŠ é“¾æ¥ <span style="cursor:pointer" onclick="closeModal('linkModal')">Ã—</span></div>
    <div class="form-group"><label>æ˜¾ç¤ºæ–‡å­—ï¼š</label><input type="text" id="linkText" placeholder="å¦‚: å®˜ç½‘"></div>
    <div class="form-group"><label>è·³è½¬åœ°å€ï¼š</label><input type="text" id="linkUrl" placeholder="https://..."></div>
    <div style="text-align:right"><button class="btn btn-blue" onclick="confirmAddLink()">æ·»åŠ </button></div>
  </div>
</div>

<div id="directModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">é…ç½®åœ¨çº¿ä¸‹è½½é“¾æ¥ <span style="cursor:pointer" onclick="closeModal('directModal')">Ã—</span></div>
    <div class="form-group">
        <label>ğŸ”— åœ¨çº¿æ–‡ä»¶åœ°å€ï¼š</label>
        <input type="text" id="directUrl" placeholder="ä¾‹å¦‚: https://cdn.example.com/script.js">
        <small style="color:#666">è®¾ç½®åå°†åœ¨åˆ—è¡¨æ˜¾ç¤ºâ€œåœ¨çº¿ä¸‹è½½â€æŒ‰é’®</small>
    </div>
    <div style="text-align:right"><button class="btn btn-blue" onclick="confirmDirectUrl()">ä¿å­˜</button></div>
  </div>
</div>

<div id="keyModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">é…ç½® Key æ¨¡å¼ (LXä¸“å±) <span style="cursor:pointer" onclick="closeModal('keyModal')">Ã—</span></div>
    <label class="check-label"><input type="checkbox" id="chkOnlineKey" onchange="toggleKeyUI()"> ğŸŒ å¯ç”¨åœ¨çº¿ Key æ¨¡å¼</label>
    <div id="areaOnlineKey" class="config-area yellow">
        <div class="form-group"><label>é“¾æ¥æ¨¡æ¿ï¼š</label><input type="text" id="keyUrl" placeholder="https://api.com?key="></div>
    </div>
    <label class="check-label"><input type="checkbox" id="chkLocalKey" onchange="toggleKeyUI()"> ğŸ“‚ å¯ç”¨æœ¬åœ° Key æ¨¡å¼</label>
    <div id="areaLocalKey" class="config-area blue">
        <div class="form-group"><label>å˜é‡åï¼š</label><input type="text" id="keyVar" placeholder="é»˜è®¤: API_KEY"></div>
    </div>
    <div style="text-align:right; margin-top:20px;">
        <button class="btn btn-gray" onclick="closeModal('keyModal')">å–æ¶ˆ</button>
        <button class="btn btn-blue" onclick="confirmKeyConfig()">ä¿å­˜é…ç½®</button>
    </div>
  </div>
</div>

<script>
// --- æ ¸å¿ƒé€»è¾‘ ---

let app = {
    tabs: ['LX'],
    currentTab: 'LX',
    files: [],
    lxScriptEnabled: true
};

const QUALITY_OPTIONS = ['128k', '320k', 'flac', 'flac24bit', 'master', 'sky', 'dolby'];
let currentEditId = null;

// å®‰å…¨æ‰§è¡ŒåŒ…è£…å™¨ï¼Œé˜²æ­¢å•ä¸ªé”™è¯¯å¯¼è‡´é¡µé¢å¡æ­»
function safeAction(fn, ...args) {
    try {
        fn(...args);
    } catch (e) {
        console.error("Action Failed:", e);
        alert("æ“ä½œå‘ç”Ÿé”™è¯¯: " + e.message + "\nå»ºè®®å¤‡ä»½æ•°æ®åç‚¹å‡»â€œæ¸…ç©ºå½“å‰é¡µâ€æˆ–åˆ·æ–°é¡µé¢ã€‚");
    }
}

window.onload = function() {
    try {
        loadData();
    } catch(e) {
        console.error('Load Error', e);
        // æ•°æ®æŸåæ—¶çš„ç´§æ€¥æ¢å¤åˆå§‹åŒ–
        app = { tabs: ['LX'], currentTab: 'LX', files: [], lxScriptEnabled: true };
    }
    renderTabs();
    renderTable();
};

function loadData() {
    const raw = localStorage.getItem('plugin_mgr_v130_fix2');
    if (raw) {
        const data = JSON.parse(raw);
        // æ•°æ®è¿ç§»é€»è¾‘
        if (Array.isArray(data)) { 
            // å…¼å®¹ v1.2.0 å’Œ v1.0 æ•°æ®
            app.files = data.map(f => sanitizeFile(f));
        } else {
            // v1.3.0 æ•°æ®
            app = data;
            // äºŒæ¬¡æ¸…æ´—é˜²æ­¢ null
            if(!app.files) app.files = [];
            app.files = app.files.map(f => sanitizeFile(f));
        }
    }
    
    // ç¡®ä¿åŸºç¡€æ•°æ®å®Œæ•´
    if(!app.tabs || app.tabs.length === 0) app.tabs = ['LX'];
    if(!app.tabs.includes('LX')) app.tabs.unshift('LX');
    if(!app.tabs.includes(app.currentTab)) app.currentTab = 'LX';
    
    const chk = document.getElementById('enableScript');
    if(chk) chk.checked = app.lxScriptEnabled;
    updateTime();
}

// æ ¸å¿ƒï¼šæ•°æ®æ¸…æ´—å‡½æ•°ï¼ˆè§£å†³å¯¼å…¥æŠ¥é”™çš„å…³é”®ï¼‰
function sanitizeFile(f) {
    return {
        id: f.id || Date.now() + Math.floor(Math.random()*1000),
        tab: f.tab || 'LX',
        fileName: f.fileName || '',
        quality: f.quality || '',
        note: f.note || '',
        // ç¡®ä¿ links æ˜¯æ•°ç»„
        links: Array.isArray(f.links) ? f.links : [], 
        fileContent: f.fileContent || null,
        fileSize: f.fileSize || 0,
        directUrl: f.directUrl || '',
        keyUrl: f.keyUrl || '',
        keyVariable: f.keyVariable || ''
    };
}

function saveData() {
    try {
        app.lxScriptEnabled = document.getElementById('enableScript').checked;
        const str = JSON.stringify(app);
        localStorage.setItem('plugin_mgr_v130_fix2', str);
        updateTime();
    } catch (e) {
        if (e.name === 'QuotaExceededError') {
            alert("âš ï¸ å­˜å‚¨ç©ºé—´ä¸è¶³ï¼\næµè§ˆå™¨ LocalStorage å·²æ»¡ (çº¦5MB)ã€‚\n\nè¯·åˆ é™¤ä¸€äº›å¤§æ–‡ä»¶æˆ–æ¸…ç†æ—§æ•°æ®ï¼Œå¦åˆ™æ— æ³•ä¿å­˜ã€‚");
        } else {
            console.error("Save Error:", e);
        }
    }
}

function updateTime() {
    document.getElementById('updateTime').innerText = new Date().toLocaleString('zh-CN');
}

// --- æ¸²æŸ“é€»è¾‘ ---

function renderTabs() {
    const container = document.getElementById('tabsContainer');
    container.innerHTML = '';
    
    app.tabs.forEach(tab => {
        const btn = document.createElement('button');
        btn.className = `tab-btn ${tab === app.currentTab ? 'active' : ''}`;
        let label = tab === 'LX' ? 'LX Music' : tab;
        btn.innerHTML = `<span>${label}</span>${tab !== 'LX' ? `<span class="tab-close" onclick="deleteTab('${tab}', event)">âœ•</span>` : ''}`;
        btn.onclick = (e) => { if(e.target.className !== 'tab-close') switchTab(tab); };
        container.appendChild(btn);
    });

    const addBtn = document.createElement('button');
    addBtn.className = 'tab-add-btn';
    addBtn.innerHTML = '+';
    addBtn.onclick = () => openModal('tabModal');
    container.appendChild(addBtn);
    
    const toggle = document.getElementById('lxScriptToggle');
    if(toggle) toggle.style.display = (app.currentTab === 'LX') ? 'flex' : 'none';
}

function switchTab(tab) {
    app.currentTab = tab;
    renderTabs();
    renderTable();
}

// --- å¥å£®çš„è¡¨æ ¼æ¸²æŸ“ ---
function renderTable() {
    const tbody = document.getElementById('tableBody');
    if(!tbody) return;

    try {
        const keyword = document.querySelector('.search-box').value.toLowerCase();
        // è¿‡æ»¤
        const list = app.files.filter(f => {
            const fTab = f.tab || 'LX';
            return fTab === app.currentTab && (!keyword || (f.fileName||'').toLowerCase().includes(keyword));
        });

        if (list.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="empty-state">å½“å‰åˆ—è¡¨ä¸ºç©ºï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹â€œæ·»åŠ æ–‡ä»¶â€</td></tr>`;
            return;
        }

        const isLX = app.currentTab === 'LX';
        const isMF = app.currentTab === 'Music Free';
        const acceptTypes = isMF ? ".js,.json" : ".js";

        tbody.innerHTML = list.map((f, index) => {
            try {
                // 1. éŸ³è´¨æ§ä»¶
                let qualityInputHtml = '';
                if (isLX || app.currentTab === 'æ¾œéŸ³') {
                    // ä¿®å¤ï¼šåªè¦å€¼ä¸åœ¨é¢„è®¾ä¸­ï¼Œæˆ–è€…æ˜¯ "è‡ªå®šä¹‰"ï¼Œå°±æ˜¾ç¤ºè¾“å…¥æ¡†
                    const isCustom = f.quality === 'è‡ªå®šä¹‰' || (f.quality && !QUALITY_OPTIONS.includes(f.quality));
                    if (!isCustom) {
                        qualityInputHtml = `
                        <select onchange="safeAction(handleQualityChange, ${f.id}, this.value)">
                            <option value="">è¯·é€‰æ‹©...</option>
                            ${QUALITY_OPTIONS.map(opt => `<option value="${opt}" ${f.quality===opt?'selected':''}>${opt}</option>`).join('')}
                            <option value="CUSTOM_ENTRY">âœ è‡ªå®šä¹‰...</option>
                        </select>`;
                    } else {
                        qualityInputHtml = `
                        <div style="display:flex; gap:2px;">
                            <input type="text" value="${f.quality==='è‡ªå®šä¹‰'?'':f.quality}" onblur="safeAction(updateFile, ${f.id}, 'quality', this.value)" placeholder="è¾“å…¥éŸ³è´¨">
                            <button class="btn-xs btn-reset" onclick="safeAction(updateFile, ${f.id}, 'quality', '')" title="é‡ç½®">â†º</button>
                        </div>`;
                    }
                } else {
                    qualityInputHtml = `<input type="text" value="${f.quality||''}" onchange="safeAction(updateFile, ${f.id}, 'quality', this.value)" placeholder="ç‰ˆæœ¬/éŸ³è´¨">`;
                }

                // 2. æ ‡ç­¾
                const sizeStr = f.fileContent ? formatSize(f.fileSize) : '';
                let tagsHtml = (f.links||[]).map((l, i) => 
                    `<span class="tag"><a href="${l.url}" target="_blank" style="color:inherit;text-decoration:none">${l.text}</a><span class="tag-remove" onclick="safeAction(removeLink, ${f.id}, ${i})">Ã—</span></span>`
                ).join('');
                
                if (f.directUrl) tagsHtml += `<span class="tag tag-direct" title="${f.directUrl}">åœ¨çº¿æº <span class="tag-remove" onclick="safeAction(updateFile, ${f.id}, 'directUrl', '')">Ã—</span></span>`;
                if (isLX && f.keyUrl) tagsHtml += `<span class="tag tag-key">åœ¨çº¿Key <span class="tag-remove" onclick="safeAction(updateFile, ${f.id}, 'keyUrl', '')">Ã—</span></span>`;
                if (isLX && f.keyVariable) tagsHtml += `<span class="tag tag-key">æœ¬åœ°Key <span class="tag-remove" onclick="safeAction(updateFile, ${f.id}, 'keyVariable', '')">Ã—</span></span>`;

                // 3. æŒ‰é’®
                let configBtns = `
                    <button class="btn-xs btn-link" onclick="openLinkModal(${f.id})">+ é“¾æ¥</button>
                    <button class="btn-xs btn-direct" onclick="openDirectModal(${f.id})">ğŸŒ ç›´è¿</button>
                `;
                if (isLX) configBtns += ` <button class="btn-xs btn-cfg" onclick="openKeyModal(${f.id})">âš™ï¸ Key</button>`;

                return `
                    <tr>
                        <td>
                           <button class="btn-xs btn-gray" onclick="safeAction(moveRow, ${f.id}, -1)">â†‘</button>
                           <button class="btn-xs btn-gray" onclick="safeAction(moveRow, ${f.id}, 1)">â†“</button>
                        </td>
                        <td>
                            <div style="display:flex;align-items:center;gap:5px;margin-bottom:4px">
                                <span style="font-size:16px">ğŸ“„</span>
                                <input type="text" value="${f.fileName}" onchange="safeAction(updateFile, ${f.id}, 'fileName', this.value)" placeholder="æ–‡ä»¶å" style="font-weight:bold;width:200px">
                            </div>
                            ${f.fileContent ? `<span class="status-ok">âœ… å·²ä¸Šä¼  ${sizeStr}</span>` : `<span class="status-no">âš ï¸ æœªä¸Šä¼ </span>`}
                        </td>
                        <td>${qualityInputHtml}</td>
                        <td>
                            <input type="text" value="${f.note||''}" onchange="safeAction(updateFile, ${f.id}, 'note', this.value)" placeholder="å¤‡æ³¨ä¿¡æ¯...">
                            <div class="tag-container">${configBtns} ${tagsHtml}</div>
                        </td>
                        <td>
                            <input type="file" id="file-${f.id}" style="display:none" accept="${acceptTypes}" onchange="uploadFile(${f.id}, this)">
                            <button class="btn-xs btn-up" onclick="document.getElementById('file-${f.id}').click()">${f.fileContent ? 'ğŸ”„ é‡ä¼ ' : 'ğŸ“¤ ä¸Šä¼ '}</button>
                            ${f.fileContent ? `<button class="btn-xs btn-green" onclick="downloadFile(${f.id})">â¬‡ï¸ ä¸‹è½½</button>` : ''}
                            <button class="btn-xs btn-del" onclick="safeAction(deleteRow, ${f.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            } catch (rowErr) {
                console.error("Render Row Error", rowErr);
                return `<tr><td colspan="5" class="error-row">âš ï¸ æ­¤è¡Œæ•°æ®æŸå (ID: ${f.id}) - <button class="btn-xs btn-del" onclick="safeAction(deleteRow, ${f.id})">å¼ºåˆ¶åˆ é™¤</button></td></tr>`;
            }
        }).join('');
    } catch (e) {
        tbody.innerHTML = `<tr><td colspan="5" class="error-row">ğŸš¨ æ¸²æŸ“å‘ç”Ÿä¸¥é‡é”™è¯¯: ${e.message}ã€‚è¯·å°è¯•æ¸…ç©ºæˆ–åˆ·æ–°ã€‚</td></tr>`;
    }
}

// --- æ•°æ®æ“ä½œ ---

function addNewRow() {
    app.files.push(sanitizeFile({ tab: app.currentTab }));
    saveData();
    renderTable();
}

function updateFile(id, key, val) {
    const f = app.files.find(x => x.id === id);
    if(f) { f[key] = val; saveData(); renderTable(); }
}

function handleQualityChange(id, val) {
    const f = app.files.find(x => x.id === id);
    if(f) {
        if (val === 'CUSTOM_ENTRY') {
            f.quality = "è‡ªå®šä¹‰"; // æ ‡è®°ä¸ºè‡ªå®šä¹‰æ¨¡å¼
        } else {
            f.quality = val;
        }
        saveData();
        renderTable();
    }
}

function uploadFile(id, input) {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        const f = app.files.find(x => x.id === id);
        if(f) {
            f.fileContent = e.target.result;
            f.fileName = f.fileName || file.name;
            f.fileSize = file.size;
            saveData();
            renderTable();
        }
    };
    reader.readAsDataURL(file);
    input.value = '';
}

function downloadFile(id) {
    const f = app.files.find(x => x.id === id);
    if(f && f.fileContent) {
        const a = document.createElement('a');
        a.href = f.fileContent;
        a.download = f.fileName;
        a.click();
    }
}

function deleteRow(id) {
    if(confirm('åˆ é™¤æ­¤æ–‡ä»¶?')) {
        app.files = app.files.filter(x => x.id !== id);
        saveData();
        renderTable();
    }
}

function moveRow(id, dir) {
    const idx = app.files.findIndex(x => x.id === id);
    if (idx < 0) return;
    const target = idx + dir;
    if (target >= 0 && target < app.files.length) {
        [app.files[idx], app.files[target]] = [app.files[target], app.files[idx]];
        saveData();
        renderTable();
    }
}

// --- å¯¼å…¥é€»è¾‘ (å¢å¼ºç‰ˆ) ---
function importData(input) {
    const f = input.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = e => {
        try {
            const json = JSON.parse(e.target.result);
            let importedFiles = [];

            // æ™ºèƒ½è¯†åˆ«æ ¼å¼
            if (Array.isArray(json)) {
                // æ—§ç‰ˆæ•°ç»„æ ¼å¼
                importedFiles = json.map(item => ({...item, tab: 'LX'}));
            } else if (json.files && Array.isArray(json.files)) {
                // æ–°ç‰ˆå¯¹è±¡æ ¼å¼
                importedFiles = json.files;
            } else {
                throw new Error("æ— æ³•è¯†åˆ«çš„æ–‡ä»¶ç»“æ„");
            }

            // æ•°æ®æ¸…æ´—å¹¶åˆå¹¶
            const cleanFiles = importedFiles.map(file => sanitizeFile(file));
            
            // è¯¢é—®æ˜¯è¦†ç›–è¿˜æ˜¯è¿½åŠ 
            if (confirm(`æˆåŠŸè§£æ ${cleanFiles.length} ä¸ªæ–‡ä»¶ã€‚\nç‚¹å‡»â€œç¡®å®šâ€è¦†ç›–å½“å‰åˆ—è¡¨ï¼Œç‚¹å‡»â€œå–æ¶ˆâ€è¿½åŠ åˆ°æœ«å°¾ã€‚`)) {
                app.files = cleanFiles;
            } else {
                app.files = app.files.concat(cleanFiles);
            }
            
            saveData();
            renderTable();
            alert('å¯¼å…¥å®Œæˆï¼');
        } catch(err) {
            alert('å¯¼å…¥å¤±è´¥: ' + err.message);
            console.error(err);
        }
    };
    r.readAsText(f);
    input.value = '';
}

function exportData(type) {
    if(type === 'json') {
        const blob = new Blob([JSON.stringify(app, null, 2)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `å¤‡ä»½_fix2_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    } else {
        exportHtmlReport();
    }
}

// --- å¼¹çª—ä¸ UI ---
function openModal(id) { document.getElementById(id).style.display = 'block'; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; currentEditId = null; }
function quickAddTab(n) { document.getElementById('newTabName').value = n; confirmAddTab(); }
function confirmAddTab() {
    const name = document.getElementById('newTabName').value.trim();
    if(name && !app.tabs.includes(name)) { app.tabs.push(name); switchTab(name); closeModal('tabModal'); }
}
function deleteTab(t, e) { e.stopPropagation(); if(confirm('åˆ ?')) { app.files = app.files.filter(f=>f.tab!==t); app.tabs=app.tabs.filter(x=>x!==t); if(app.currentTab===t) app.currentTab='LX'; saveData(); renderTabs(); renderTable(); } }
function clearCurrentTab() { if(confirm('æ¸…ç©º?')) { app.files = app.files.filter(f=>(f.tab||'LX')!==app.currentTab); saveData(); renderTable(); } }

function openLinkModal(id) { currentEditId = id; document.getElementById('linkText').value=''; document.getElementById('linkUrl').value=''; openModal('linkModal'); }
function confirmAddLink() {
    const f=app.files.find(x=>x.id===currentEditId), t=document.getElementById('linkText').value, u=document.getElementById('linkUrl').value;
    if(f&&t&&u) { f.links.push({text:t,url:u}); saveData(); renderTable(); } closeModal('linkModal');
}
function removeLink(fid, idx) { const f=app.files.find(x=>x.id===fid); if(f){f.links.splice(idx,1);saveData();renderTable();} }

function openDirectModal(id) { currentEditId=id; document.getElementById('directUrl').value=app.files.find(x=>x.id===id)?.directUrl||''; openModal('directModal'); }
function confirmDirectUrl() { const f=app.files.find(x=>x.id===currentEditId); if(f){f.directUrl=document.getElementById('directUrl').value.trim();saveData();renderTable();} closeModal('directModal'); }

function openKeyModal(id) {
    currentEditId = id;
    const f = app.files.find(x => x.id === id);
    document.getElementById('chkOnlineKey').checked = !!f.keyUrl;
    document.getElementById('keyUrl').value = f.keyUrl || '';
    document.getElementById('chkLocalKey').checked = !!f.keyVariable;
    document.getElementById('keyVar').value = f.keyVariable || 'API_KEY';
    toggleKeyUI(); openModal('keyModal');
}
function toggleKeyUI() {
    const on = document.getElementById('chkOnlineKey').checked;
    const loc = document.getElementById('chkLocalKey').checked;
    document.getElementById('areaOnlineKey').style.display = on ? 'block' : 'none';
    document.getElementById('areaLocalKey').style.display = loc ? 'block' : 'none';
}
function confirmKeyConfig() {
    const f = app.files.find(x => x.id === currentEditId);
    if(f) {
        f.keyUrl = document.getElementById('chkOnlineKey').checked ? document.getElementById('keyUrl').value.trim() : '';
        f.keyVariable = document.getElementById('chkLocalKey').checked ? document.getElementById('keyVar').value.trim() : '';
        saveData(); renderTable();
    } closeModal('keyModal');
}
function formatSize(b) { if(!b)return''; const i=Math.floor(Math.log(b)/Math.log(1024)); return (b/Math.pow(1024,i)).toFixed(1)+['B','KB','MB'][i]; }

// --- HTML å¯¼å‡º ---
function exportHtmlReport() {
    const exportObj = { tabs: app.tabs, files: app.files, lxScriptEnabled: app.lxScriptEnabled };
    // å‹ç¼©çš„ HTML æ¨¡æ¿
    const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>åˆ—è¡¨</title><style>body{font-family:'Microsoft YaHei';background:#f9f9f9;padding:20px;max-width:1200px;margin:0 auto}table{width:100%;border-collapse:collapse;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,0.05)}th{background:#f5f5f5;padding:10px;text-align:left}td{padding:10px;border-bottom:1px solid #eee}.btn{padding:5px 10px;color:#fff;border-radius:3px;cursor:pointer;border:none;margin:2px;text-decoration:none;display:inline-block;font-size:12px}.bg-g{background:#28a745}.bg-b{background:#667eea}.bg-y{background:#f0ad4e}.bg-t{background:#20c997}.tab-bar{display:flex;margin-bottom:20px;border-bottom:1px solid #ddd}.tab{padding:10px 20px;border:none;background:none;cursor:pointer}.tab.active{border:1px solid #ddd;border-bottom:2px solid #fff;background:#fff;font-weight:bold}.tag{background:#eef2ff;color:#5a67d8;padding:2px 6px;border-radius:4px;font-size:11px;margin-right:4px;text-decoration:none}.key-box{margin-top:5px;background:#fffbe6;padding:5px;display:flex;gap:5px;border:1px solid #ffe58f}.key-in{border:1px solid #ddd;padding:3px}</style></head><body><h2>æ’ä»¶åˆ—è¡¨</h2><div class="tab-bar" id="tb"></div><div id="ct"></div><script>
    const D=${JSON.stringify(exportObj)};let c=D.tabs[0];
    function I(){document.getElementById('tb').innerHTML=D.tabs.map(t=>'<button class="tab '+(t==c?'active':'')+'" onclick="S(\\''+t+'\\')">'+(t=='LX'?'LX Music':t)+'</button>').join('');R()}
    function S(t){c=t;I()}
    function R(){
        const l=D.files.filter(f=>(f.tab||'LX')==c), el=document.getElementById('ct'), isLX=(c=='LX'), en=isLX&&D.lxScriptEnabled;
        if(!l.length){el.innerHTML='æ— æ–‡ä»¶';return}
        el.innerHTML='<table><thead><tr><th>æ–‡ä»¶å</th><th>ç‰ˆæœ¬</th><th>å¤‡æ³¨</th><th>æ“ä½œ</th></tr></thead><tbody>'+l.map((f,i)=>{
            let bs = '';
            if(f.directUrl) bs+='<a href="'+f.directUrl+'" class="btn bg-t" download>ğŸŒ åœ¨çº¿ä¸‹è½½</a> ';
            if(f.fileContent){
                bs+='<button class="btn bg-g" onclick="DL('+i+')">â¬‡ï¸ æœ¬åœ°ä¸‹è½½</button> ';
                if(en) bs+='<button class="btn bg-b" onclick="GS('+i+',0)">ğŸš€ ä¸€é”®å¯¼å…¥</button>';
            }
            if(isLX&&f.fileContent){
                if(f.keyUrl) bs+='<div class="key-box"><input id="k1-'+i+'" class="key-in" placeholder="Key"><button class="btn bg-y" onclick="K1('+i+')">è·³è½¬</button></div>';
                if(f.keyVariable&&en) bs+='<div class="key-box"><input id="k2-'+i+'" class="key-in" placeholder="Key"><button class="btn bg-b" onclick="GS('+i+',1)">å«Keyå¯¼å…¥</button></div>';
            }
            return '<tr><td><b>'+f.fileName+'</b></td><td>'+f.quality+'</td><td>'+f.note+'<br>'+(f.links||[]).map(k=>'<a href="'+k.url+'" class="tag" target="_blank">ğŸ”— '+k.text+'</a>').join('')+'</td><td>'+bs+'</td></tr>';
        }).join('')+'</tbody></table>';
    }
    function DL(i){const f=g(i);save(b64(f.fileContent),f.fileName)}
    function K1(i){const f=g(i),k=document.getElementById('k1-'+i).value;if(k)window.open(f.keyUrl+k)}
    function g(i){return D.files.filter(f=>(f.tab||'LX')==c)[i]}
    function b64(s){const b=atob(s.split(',')[1]),a=new Uint8Array(b.length);for(let i=0;i<b.length;i++)a[i]=b.charCodeAt(i);return new Blob([a],{type:'application/javascript'})}
    function save(b,n){const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=n;a.click()}
    ${getClientLogic()}
    I();
    <\/script></body></html>`;
    const b = new Blob([html], {type:'text/html'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='åˆ—è¡¨.html'; a.click();
}

function getClientLogic() {
    return `
    window.GS = function(i,uk){
        const f=g(i),btn=event.target,ot=btn.innerText;
        btn.innerText='...';btn.disabled=1;
        try{
            let c=atob(f.fileContent.split(',')[1]), dec=new TextDecoder('utf-8'), txt=dec.decode(new Uint8Array([...c].map(x=>x.charCodeAt(0))));
            if(uk){
                const k=document.getElementById('k2-'+i).value, v=f.keyVariable||'API_KEY';
                if(!k)throw'è¯·è¾“å…¥Key';
                const r=new RegExp('const\\\\s+'+v+'\\\\s*=\\\\s*[\\'\\"][\\'\\"]');
                txt = r.test(txt) ? txt.replace(r,'const '+v+'="'+k+'"') : txt.replace(v+'=""',v+'="'+k+'"').replace(v+"=''",v+"='"+k+"'");
            }
            const enc=new TextEncoder(), bin=Array.from(enc.encode(txt), b=>String.fromCharCode(b)).join(''), b64=btoa(bin);
            const ps='$c=[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("'+b64+'"));$p=[Environment]::GetFolderPath("Desktop")+"\\\\'+(f.fileName||'p.js')+'";[System.IO.File]::WriteAllText($p,$c);Write-Host "å·²ä¿å­˜åˆ°æ¡Œé¢: "$p -F Green;Start-Sleep 3';
            const bat='@echo off\\r\\npowershell -Command "'+ps.replace(/"/g,'\\"')+'"';
            save(new Blob([bat],{type:'text/plain;charset=gbk'}), 'ä¸€é”®å®‰è£….bat');
        }catch(e){alert(e)}finally{btn.innerText=ot;btn.disabled=0}
    }`;
}
</script>
</body>
</html>