<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æ’ä»¶åˆ—è¡¨ç®¡ç†å™¨ v1.3.0-fix1</title>
  <style>
    /* å…¨å±€é‡ç½® */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: #f0f2f5; padding: 20px; color: #333; min-height: 100vh; }
    
    .container { max-width: 1600px; margin: 0 auto; background: white; border-radius: 10px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
    
    /* å¤´éƒ¨ */
    .header { text-align: center; margin-bottom: 25px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; }
    h1 { font-size: 24px; color: #2c3e50; margin-bottom: 5px; }
    .version-tag { font-size: 12px; background: #e2e8f0; color: #475569; padding: 2px 6px; border-radius: 4px; vertical-align: middle; margin-left: 8px; }
    .subtitle { font-size: 12px; color: #999; }

    /* æ ‡ç­¾é¡µç³»ç»Ÿ */
    .tabs-wrapper { display: flex; align-items: center; border-bottom: 2px solid #e9ecef; margin-bottom: 15px; gap: 5px; }
    .tab-btn { padding: 10px 25px; border: none; background: transparent; cursor: pointer; font-size: 14px; font-weight: 500; color: #666; border-radius: 8px 8px 0 0; transition: all 0.2s; position: relative; }
    .tab-btn:hover { background: #f8f9fa; color: #333; }
    .tab-btn.active { background: #fff; color: #667eea; font-weight: bold; border: 1px solid #e9ecef; border-bottom: 2px solid #fff; margin-bottom: -2px; z-index: 1; }
    .tab-add-btn { width: 30px; height: 30px; border-radius: 50%; border: 1px dashed #ccc; background: transparent; cursor: pointer; color: #999; font-size: 18px; margin-left: 5px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .tab-add-btn:hover { border-color: #667eea; color: #667eea; background: #f0f4ff; }
    .tab-close { font-size: 10px; margin-left: 8px; opacity: 0.5; border-radius: 50%; padding: 0 4px; }
    .tab-close:hover { background: #ffcccc; color: #cc0000; opacity: 1; }

    /* å·¥å…·æ  */
    .toolbar { display: flex; gap: 10px; padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
    .search-box { padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px; width: 220px; }
    .spacer { flex: 1; }
    
    /* LX ä¸“å±å¼€å…³ */
    .lx-toggle { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 500; background: #e3f2fd; padding: 6px 12px; border-radius: 4px; border: 1px solid #bbdefb; color: #0d47a1; margin-left: 10px; }
    .lx-toggle input { cursor: pointer; width: 16px; height: 16px; }

    /* æŒ‰é’®æ ·å¼ */
    .btn { padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-size: 13px; color: white; transition: opacity 0.2s; display: inline-flex; align-items: center; gap: 5px; }
    .btn:hover { opacity: 0.9; }
    .btn-green { background: #28a745; }
    .btn-blue { background: #667eea; }
    .btn-info { background: #17a2b8; }
    .btn-gray { background: #6c757d; }
    .btn-red { background: #dc3545; }
    
    /* è¡¨æ ¼å†…å°æŒ‰é’® */
    .btn-xs { padding: 4px 8px; font-size: 12px; border-radius: 3px; border: none; cursor: pointer; color: white; margin-right: 2px; margin-bottom: 2px; display: inline-block; }
    .btn-cfg { background: #f0ad4e; color: white; }
    .btn-link { background: #5bc0de; color: white; }
    .btn-del { background: #d9534f; }
    .btn-up { background: #5a6268; }
    .btn-reset { background: #6c757d; color: white; margin-left: 2px; }
    .btn-direct { background: #20c997; color: white; }

    /* è¡¨æ ¼æ ·å¼ */
    .table-container { overflow-x: auto; border: 1px solid #eee; border-radius: 8px; background: white; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { background: #f8f9fa; padding: 12px 10px; text-align: left; font-weight: 600; color: #444; border-bottom: 2px solid #eee; white-space: nowrap; }
    td { padding: 10px; border-bottom: 1px solid #f1f1f1; vertical-align: top; }
    tr:hover { background: #fafafa; }
    
    input[type="text"], select { width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; transition: border 0.2s; }
    input[type="text"]:focus, select:focus { border-color: #667eea; outline: none; }

    /* çŠ¶æ€ä¸æ ‡ç­¾ */
    .status-ok { background: #d4edda; color: #155724; padding: 2px 6px; border-radius: 3px; font-size: 11px; display: inline-block; border: 1px solid #c3e6cb; }
    .status-no { background: #f8d7da; color: #721c24; padding: 2px 6px; border-radius: 3px; font-size: 11px; display: inline-block; border: 1px solid #f5c6cb; }
    
    .tag-container { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px; }
    .tag { font-size: 11px; padding: 2px 8px; border-radius: 10px; background: #eef2ff; color: #5a67d8; border: 1px solid #dbeafe; display: flex; align-items: center; gap: 4px; }
    .tag-key { background: #fff3cd; color: #856404; border-color: #ffeeba; }
    .tag-direct { background: #d1fae5; color: #065f46; border-color: #a7f3d0; }
    .tag-remove { cursor: pointer; font-weight: bold; opacity: 0.6; }
    .tag-remove:hover { opacity: 1; color: #dc3545; }

    /* å¼¹çª— */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
    .modal-content { background: white; width: 450px; margin: 80px auto; padding: 20px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: popIn 0.2s; max-height: 85vh; overflow-y: auto; }
    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .modal-header { font-weight: bold; font-size: 16px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 13px; }
    
    /* å‹¾é€‰æ¡†æ ·å¼ */
    .check-label { display: flex; align-items: center; gap: 8px; font-size: 14px; cursor: pointer; background: #f8f9fa; padding: 8px; border-radius: 5px; border: 1px solid #eee; margin-bottom: 8px; }
    .check-label:hover { background: #e9ecef; }
    .check-label input { width: 16px; height: 16px; margin: 0; }
    .config-area { margin-left: 24px; padding: 10px; background: #fff; border-left: 3px solid #ccc; display: none; margin-bottom: 10px; }
    .config-area.active { display: block; }
    .config-area.blue { border-left-color: #667eea; }
    .config-area.yellow { border-left-color: #f0ad4e; }

    .empty-state { padding: 40px; text-align: center; color: #aaa; font-style: italic; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>æ’ä»¶åˆ—è¡¨ç®¡ç†å™¨ <span class="version-tag">v1.3.0-fix1</span></h1>
    <p class="subtitle">æ›´æ–°æ—¶é—´: <span id="updateTime">-</span></p>
  </div>

  <div class="tabs-wrapper" id="tabsContainer">
    </div>

  <div class="toolbar">
    <button class="btn btn-green" onclick="addNewRow()">â• æ·»åŠ æ–‡ä»¶</button>
    <button class="btn btn-blue" onclick="exportData('json')">ğŸ’¾ å¤‡ä»½æ•°æ®</button>
    <button class="btn btn-info" onclick="exportData('html')">ğŸ“¤ å¯¼å‡ºåˆ—è¡¨</button>
    <button class="btn btn-red" onclick="clearCurrentTab()">ğŸ—‘ï¸ æ¸…ç©ºå½“å‰é¡µ</button>
    
    <div class="lx-toggle" id="lxScriptToggle" style="display:none">
        <input type="checkbox" id="enableScript" onchange="saveData();">
        <label for="enableScript">å¯ç”¨ä¸€é”®å¯¼å…¥è„šæœ¬ (ä»…LX)</label>
    </div>

    <div class="spacer"></div>
    <input type="file" id="importInput" style="display:none" onchange="importData(this)">
    <button class="btn btn-gray" onclick="document.getElementById('importInput').click()">ğŸ“‚ å¯¼å…¥æ—§ç‰ˆ/å¤‡ä»½</button>
    <input type="text" class="search-box" placeholder="ğŸ” æœç´¢æ–‡ä»¶å..." oninput="renderTable()">
  </div>

  <div class="table-container">
    <table id="mainTable">
      <thead>
        <tr>
          <th width="60">æ’åº</th>
          <th width="300">æ–‡ä»¶å & çŠ¶æ€</th>
          <th width="150">éŸ³è´¨/ç‰ˆæœ¬</th>
          <th width="350">å¤‡æ³¨ & é…ç½®</th>
          <th width="200">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<div id="tabModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">æ·»åŠ æ–°æ ‡ç­¾é¡µ <span style="cursor:pointer" onclick="closeModal('tabModal')">Ã—</span></div>
    <div class="form-group">
        <label>å¿«é€Ÿé€‰æ‹©ï¼š</label>
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <button class="btn btn-info btn-xs" onclick="quickAddTab('Music Free')">Music Free</button>
            <button class="btn btn-info btn-xs" onclick="quickAddTab('æ¾œéŸ³')">æ¾œéŸ³</button>
        </div>
        <label>æˆ– è‡ªå®šä¹‰åç§°ï¼š</label>
        <input type="text" id="newTabName" placeholder="è¾“å…¥åç§°...">
    </div>
    <div style="text-align:right"><button class="btn btn-blue" onclick="confirmAddTab()">ç¡®å®š</button></div>
  </div>
</div>

<div id="linkModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">æ·»åŠ é“¾æ¥ <span style="cursor:pointer" onclick="closeModal('linkModal')">Ã—</span></div>
    <div class="form-group"><label>æ˜¾ç¤ºæ–‡å­—ï¼š</label><input type="text" id="linkText" placeholder="å¦‚: å®˜ç½‘"></div>
    <div class="form-group"><label>è·³è½¬åœ°å€ï¼š</label><input type="text" id="linkUrl" placeholder="https://..."></div>
    <div style="text-align:right"><button class="btn btn-blue" onclick="confirmAddLink()">æ·»åŠ </button></div>
  </div>
</div>

<div id="directModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">é…ç½®åœ¨çº¿ä¸‹è½½é“¾æ¥ <span style="cursor:pointer" onclick="closeModal('directModal')">Ã—</span></div>
    <div class="form-group">
        <label>ğŸ”— åœ¨çº¿æ–‡ä»¶åœ°å€ï¼š</label>
        <input type="text" id="directUrl" placeholder="ä¾‹å¦‚: https://cdn.example.com/script.js">
        <small style="color:#666">è®¾ç½®åå°†åœ¨åˆ—è¡¨æ˜¾ç¤ºâ€œåœ¨çº¿ä¸‹è½½â€æŒ‰é’®</small>
    </div>
    <div style="text-align:right"><button class="btn btn-blue" onclick="confirmDirectUrl()">ä¿å­˜</button></div>
  </div>
</div>

<div id="keyModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">é…ç½® Key æ¨¡å¼ (LXä¸“å±) <span style="cursor:pointer" onclick="closeModal('keyModal')">Ã—</span></div>
    
    <label class="check-label">
        <input type="checkbox" id="chkOnlineKey" onchange="toggleKeyUI()"> 
        ğŸŒ å¯ç”¨åœ¨çº¿ Key æ¨¡å¼ (URLæ‹¼æ¥)
    </label>
    <div id="areaOnlineKey" class="config-area yellow">
        <div class="form-group">
            <label>é“¾æ¥æ¨¡æ¿ (Keyå°†æ‹¼æ¥åˆ°æœ«å°¾)</label>
            <input type="text" id="keyUrl" placeholder="https://api.com?key=">
        </div>
    </div>

    <label class="check-label">
        <input type="checkbox" id="chkLocalKey" onchange="toggleKeyUI()"> 
        ğŸ“‚ å¯ç”¨æœ¬åœ° Key æ¨¡å¼ (JSå˜é‡æ›¿æ¢)
    </label>
    <div id="areaLocalKey" class="config-area blue">
        <div class="form-group">
            <label>å˜é‡å (const XXX = "")</label>
            <input type="text" id="keyVar" placeholder="é»˜è®¤: API_KEY">
        </div>
        <small style="color:red;font-size:12px">æ³¨æ„ï¼šå¦‚æœä¸»ç•Œé¢å…³é—­äº†â€œä¸€é”®å¯¼å…¥è„šæœ¬â€ï¼Œæ­¤åŠŸèƒ½åœ¨å¯¼å‡ºæ–‡ä»¶ä¸­å°†å¤±æ•ˆï¼ˆå› ä¸ºæ— æ³•æ³¨å…¥è„šæœ¬ï¼‰ã€‚</small>
    </div>

    <div style="text-align:right; margin-top:20px;">
        <button class="btn btn-gray" onclick="closeModal('keyModal')">å–æ¶ˆ</button>
        <button class="btn btn-blue" onclick="confirmKeyConfig()">ä¿å­˜é…ç½®</button>
    </div>
  </div>
</div>

<script>
// --- å…¨å±€æ•°æ® ---
let app = {
    tabs: ['LX'],
    currentTab: 'LX',
    files: [],
    // LX ä¸“å±è®¾ç½®
    lxScriptEnabled: true
};

// é¢„è®¾éŸ³è´¨æ¨¡æ¿
const QUALITY_OPTIONS = ['128k', '320k', 'flac', 'flac24bit', 'master', 'sky', 'dolby'];

let currentEditId = null;

// --- åˆå§‹åŒ– ---
window.onload = function() {
    loadData();
    renderTabs();
    renderTable();
};

function loadData() {
    const raw = localStorage.getItem('plugin_mgr_v130_fix1');
    if (raw) {
        try {
            const data = JSON.parse(raw);
            if (Array.isArray(data)) { 
                app.files = data.map(f => ({...f, tab: 'LX'}));
            } else {
                app = data;
            }
        } catch(e) { console.error('Data load error', e); }
    }
    if(!app.tabs.includes('LX')) app.tabs.unshift('LX');
    if(!app.tabs.includes(app.currentTab)) app.currentTab = 'LX';
    
    document.getElementById('enableScript').checked = app.lxScriptEnabled;
    updateTime();
}

function saveData() {
    app.lxScriptEnabled = document.getElementById('enableScript').checked;
    localStorage.setItem('plugin_mgr_v130_fix1', JSON.stringify(app));
    updateTime();
}

function updateTime() {
    document.getElementById('updateTime').innerText = new Date().toLocaleString('zh-CN');
}

// --- æ ‡ç­¾é¡µé€»è¾‘ ---
function renderTabs() {
    const container = document.getElementById('tabsContainer');
    container.innerHTML = '';
    
    app.tabs.forEach(tab => {
        const btn = document.createElement('button');
        btn.className = `tab-btn ${tab === app.currentTab ? 'active' : ''}`;
        
        let label = tab === 'LX' ? 'LX Music' : tab;
        let html = `<span>${label}</span>`;
        if (tab !== 'LX') { 
            html += `<span class="tab-close" onclick="deleteTab('${tab}', event)">âœ•</span>`;
        }
        btn.innerHTML = html;
        btn.onclick = (e) => {
            if(e.target.className !== 'tab-close') switchTab(tab);
        };
        container.appendChild(btn);
    });

    const addBtn = document.createElement('button');
    addBtn.className = 'tab-add-btn';
    addBtn.innerHTML = '+';
    addBtn.onclick = () => openModal('tabModal');
    container.appendChild(addBtn);
    
    // åªæœ‰ LX æ‰æ˜¾ç¤ºè„šæœ¬å¼€å…³
    document.getElementById('lxScriptToggle').style.display = (app.currentTab === 'LX') ? 'flex' : 'none';
}

function switchTab(tab) {
    app.currentTab = tab;
    renderTabs();
    renderTable();
}

function quickAddTab(name) {
    document.getElementById('newTabName').value = name;
    confirmAddTab();
}

function confirmAddTab() {
    const name = document.getElementById('newTabName').value.trim();
    if (name && !app.tabs.includes(name)) {
        app.tabs.push(name);
        switchTab(name);
        closeModal('tabModal');
        document.getElementById('newTabName').value = '';
    } else {
        alert('åç§°æ— æ•ˆæˆ–å·²å­˜åœ¨');
    }
}

function deleteTab(tab, e) {
    e.stopPropagation();
    if(confirm(`ç¡®å®šåˆ é™¤ "${tab}" åŠå…¶æ‰€æœ‰æ–‡ä»¶å—ï¼Ÿ`)) {
        app.files = app.files.filter(f => f.tab !== tab);
        app.tabs = app.tabs.filter(t => t !== tab);
        if(app.currentTab === tab) app.currentTab = 'LX';
        saveData();
        renderTabs();
        renderTable();
    }
}

// --- è¡¨æ ¼æ¸²æŸ“ ---
function renderTable() {
    const tbody = document.getElementById('tableBody');
    const keyword = document.querySelector('.search-box').value.toLowerCase();
    
    const list = app.files.filter(f => {
        const fTab = f.tab || 'LX';
        return fTab === app.currentTab && (!keyword || (f.fileName||'').toLowerCase().includes(keyword));
    });

    if (list.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="empty-state">å½“å‰åˆ—è¡¨ä¸ºç©ºï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹â€œæ·»åŠ æ–‡ä»¶â€</td></tr>`;
        return;
    }

    // ç¯å¢ƒåˆ¤æ–­
    const isLX = app.currentTab === 'LX';
    const isLanyin = app.currentTab === 'æ¾œéŸ³';
    const isMF = app.currentTab === 'Music Free';
    
    // æ–‡ä»¶ç±»å‹é™åˆ¶
    let acceptTypes = "*";
    if (isLX || isLanyin) acceptTypes = ".js";
    if (isMF) acceptTypes = ".js,.json";

    tbody.innerHTML = list.map((f, index) => {
        // 1. éŸ³è´¨/ç‰ˆæœ¬è¾“å…¥æ¸²æŸ“ (ä¿®å¤ï¼šå¢åŠ é‡ç½®æŒ‰é’®)
        let qualityInputHtml = '';
        if (isLX || isLanyin) {
            const isCustom = f.quality && !QUALITY_OPTIONS.includes(f.quality);
            if (!isCustom) {
                qualityInputHtml = `
                <select onchange="handleQualityChange(${f.id}, this.value)">
                    <option value="">è¯·é€‰æ‹©...</option>
                    ${QUALITY_OPTIONS.map(opt => `<option value="${opt}" ${f.quality===opt?'selected':''}>${opt}</option>`).join('')}
                    <option value="CUSTOM_ENTRY">âœ è‡ªå®šä¹‰...</option>
                </select>`;
            } else {
                qualityInputHtml = `
                <div style="display:flex; gap:2px;">
                    <input type="text" value="${f.quality}" onblur="updateFile(${f.id}, 'quality', this.value)" placeholder="è¾“å…¥éŸ³è´¨">
                    <button class="btn-xs btn-reset" onclick="updateFile(${f.id}, 'quality', '')" title="æ¢å¤ä¸‹æ‹‰èœå•">â†º</button>
                </div>`;
            }
        } else {
            // MF æˆ–å…¶ä»–
            qualityInputHtml = `<input type="text" value="${f.quality||''}" onchange="updateFile(${f.id}, 'quality', this.value)" placeholder="ç‰ˆæœ¬/éŸ³è´¨">`;
        }

        // 2. çŠ¶æ€ä¸æ ‡ç­¾
        const sizeStr = f.fileContent ? formatSize(f.fileSize) : '';
        let tagsHtml = (f.links||[]).map((l, i) => 
            `<span class="tag"><a href="${l.url}" target="_blank" style="color:inherit;text-decoration:none">${l.text}</a><span class="tag-remove" onclick="removeLink(${f.id}, ${i})">Ã—</span></span>`
        ).join('');
        
        // æ˜¾ç¤ºç›´è¿ URL æ ‡ç­¾
        if (f.directUrl) {
            tagsHtml += `<span class="tag tag-direct" title="${f.directUrl}">åœ¨çº¿æº <span class="tag-remove" onclick="updateFile(${f.id}, 'directUrl', '')">Ã—</span></span>`;
        }

        // æ˜¾ç¤ºKeyæ ‡ç­¾ (ä»…LX)
        if (isLX) {
            if (f.keyUrl) tagsHtml += `<span class="tag tag-key" title="${f.keyUrl}">åœ¨çº¿Key <span class="tag-remove" onclick="updateFile(${f.id}, 'keyUrl', '')">Ã—</span></span>`;
            if (f.keyVariable) tagsHtml += `<span class="tag tag-key" title="${f.keyVariable}">æœ¬åœ°Key <span class="tag-remove" onclick="updateFile(${f.id}, 'keyVariable', '')">Ã—</span></span>`;
        }

        // 3. å³ä¾§æ“ä½œæŒ‰é’®
        let btnsHtml = `
            <input type="file" id="file-${f.id}" style="display:none" accept="${acceptTypes}" onchange="uploadFile(${f.id}, this)">
            <button class="btn-xs btn-up" onclick="document.getElementById('file-${f.id}').click()">${f.fileContent ? 'ğŸ”„ é‡ä¼ ' : 'ğŸ“¤ ä¸Šä¼ '}</button>
            ${f.fileContent ? `<button class="btn-xs btn-green" onclick="downloadFile(${f.id})">â¬‡ï¸ ä¸‹è½½</button>` : ''}
            <button class="btn-xs btn-del" onclick="deleteRow(${f.id})">åˆ é™¤</button>
        `;

        // 4. é…ç½®æŒ‰é’®ç»„
        let configBtns = `
            <button class="btn-xs btn-link" onclick="openLinkModal(${f.id})">+ é“¾æ¥</button>
            <button class="btn-xs btn-direct" onclick="openDirectModal(${f.id})">ğŸŒ ç›´è¿</button>
        `;
        
        // Key æŒ‰é’®ä»…åœ¨ LX æ˜¾ç¤º (å³ä½¿å…³é—­äº†ä¸€é”®å¯¼å…¥ï¼ŒKeyé…ç½®ä¾ç„¶å¯ä»¥ç¼–è¾‘ï¼Œä¸ºäº†å¯¼å‡ºæ—¶å¯èƒ½çš„åœ¨çº¿KeyåŠŸèƒ½)
        if (isLX) {
            configBtns += ` <button class="btn-xs btn-cfg" onclick="openKeyModal(${f.id})">âš™ï¸ Key</button>`;
        }

        return `
            <tr>
                <td>
                   <button class="btn-xs btn-gray" onclick="moveRow(${f.id}, -1)">â†‘</button>
                   <button class="btn-xs btn-gray" onclick="moveRow(${f.id}, 1)">â†“</button>
                </td>
                <td>
                    <div style="display:flex;align-items:center;gap:5px;margin-bottom:4px">
                        <span style="font-size:16px">ğŸ“„</span>
                        <input type="text" value="${f.fileName}" onchange="updateFile(${f.id}, 'fileName', this.value)" placeholder="æ–‡ä»¶å" style="font-weight:bold;width:200px">
                    </div>
                    ${f.fileContent ? `<span class="status-ok">âœ… å·²ä¸Šä¼  ${sizeStr}</span>` : `<span class="status-no">âš ï¸ æœªä¸Šä¼ </span>`}
                </td>
                <td>${qualityInputHtml}</td>
                <td>
                    <input type="text" value="${f.note||''}" onchange="updateFile(${f.id}, 'note', this.value)" placeholder="å¤‡æ³¨ä¿¡æ¯...">
                    <div class="tag-container">
                        ${configBtns} ${tagsHtml}
                    </div>
                </td>
                <td>${btnsHtml}</td>
            </tr>
        `;
    }).join('');
}

// --- æ–‡ä»¶æ“ä½œé€»è¾‘ ---
function addNewRow() {
    app.files.push({
        id: Date.now(),
        tab: app.currentTab,
        fileName: '',
        quality: '',
        note: '',
        links: [],
        fileContent: null,
        fileSize: 0,
        directUrl: '',
        keyUrl: '',
        keyVariable: ''
    });
    saveData();
    renderTable();
}

function updateFile(id, key, val) {
    const f = app.files.find(x => x.id === id);
    if(f) { f[key] = val; saveData(); renderTable(); }
}

function handleQualityChange(id, val) {
    if (val === 'CUSTOM_ENTRY') {
        const f = app.files.find(x => x.id === id);
        f.quality = "è‡ªå®šä¹‰"; 
        saveData();
        renderTable(); 
    } else {
        updateFile(id, 'quality', val);
    }
}

function uploadFile(id, input) {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        const f = app.files.find(x => x.id === id);
        if(f) {
            f.fileContent = e.target.result;
            f.fileName = f.fileName || file.name;
            f.fileSize = file.size;
            saveData();
            renderTable();
        }
    };
    reader.readAsDataURL(file);
    input.value = '';
}

function downloadFile(id) {
    const f = app.files.find(x => x.id === id);
    if(f && f.fileContent) {
        const a = document.createElement('a');
        a.href = f.fileContent;
        a.download = f.fileName;
        a.click();
    }
}

function deleteRow(id) {
    if(confirm('åˆ é™¤æ­¤æ–‡ä»¶?')) {
        app.files = app.files.filter(x => x.id !== id);
        saveData();
        renderTable();
    }
}

function moveRow(id, dir) {
    const idx = app.files.findIndex(x => x.id === id);
    if (idx < 0) return;
    const target = idx + dir;
    if (target >= 0 && target < app.files.length) {
        [app.files[idx], app.files[target]] = [app.files[target], app.files[idx]];
        saveData();
        renderTable();
    }
}

function clearCurrentTab() {
    if(confirm('ç¡®å®šæ¸…ç©ºå½“å‰æ ‡ç­¾é¡µçš„æ‰€æœ‰æ–‡ä»¶å—ï¼Ÿ')) {
        app.files = app.files.filter(f => (f.tab||'LX') !== app.currentTab);
        saveData();
        renderTable();
    }
}

// --- å¼¹çª—é€»è¾‘ ---
function openModal(id) { document.getElementById(id).style.display = 'block'; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; currentEditId = null; }

// é“¾æ¥
function openLinkModal(id) {
    currentEditId = id;
    document.getElementById('linkText').value = '';
    document.getElementById('linkUrl').value = '';
    openModal('linkModal');
}

function confirmAddLink() {
    const f = app.files.find(x => x.id === currentEditId);
    const t = document.getElementById('linkText').value;
    const u = document.getElementById('linkUrl').value;
    if(f && t && u) {
        if(!f.links) f.links = [];
        f.links.push({text:t, url:u});
        saveData();
        renderTable();
    }
    closeModal('linkModal');
}

function removeLink(fid, idx) {
    const f = app.files.find(x => x.id === fid);
    if(f) { f.links.splice(idx, 1); saveData(); renderTable(); }
}

// ç›´è¿
function openDirectModal(id) {
    currentEditId = id;
    const f = app.files.find(x => x.id === id);
    document.getElementById('directUrl').value = f.directUrl || '';
    openModal('directModal');
}

function confirmDirectUrl() {
    const f = app.files.find(x => x.id === currentEditId);
    if(f) {
        f.directUrl = document.getElementById('directUrl').value.trim();
        saveData();
        renderTable();
    }
    closeModal('directModal');
}

// Key é…ç½® (ä¿®å¤ï¼šCheckbox é€»è¾‘)
function openKeyModal(id) {
    currentEditId = id;
    const f = app.files.find(x => x.id === id);
    
    // åˆå§‹åŒ– UI çŠ¶æ€
    const hasOnline = !!f.keyUrl;
    const hasLocal = !!f.keyVariable;
    
    document.getElementById('chkOnlineKey').checked = hasOnline;
    document.getElementById('keyUrl').value = f.keyUrl || '';
    
    document.getElementById('chkLocalKey').checked = hasLocal;
    document.getElementById('keyVar').value = f.keyVariable || 'API_KEY';
    
    toggleKeyUI();
    openModal('keyModal');
}

function toggleKeyUI() {
    const on = document.getElementById('chkOnlineKey').checked;
    const loc = document.getElementById('chkLocalKey').checked;
    
    const areaOn = document.getElementById('areaOnlineKey');
    const areaLoc = document.getElementById('areaLocalKey');
    
    areaOn.style.display = on ? 'block' : 'none';
    areaLoc.style.display = loc ? 'block' : 'none';
    if(on) areaOn.classList.add('active');
    if(loc) areaLoc.classList.add('active');
}

function confirmKeyConfig() {
    const f = app.files.find(x => x.id === currentEditId);
    if(f) {
        const on = document.getElementById('chkOnlineKey').checked;
        const loc = document.getElementById('chkLocalKey').checked;
        
        f.keyUrl = on ? document.getElementById('keyUrl').value.trim() : '';
        f.keyVariable = loc ? document.getElementById('keyVar').value.trim() : '';
        
        saveData();
        renderTable();
    }
    closeModal('keyModal');
}

// --- è¾…åŠ© ---
function formatSize(bytes) {
    if(!bytes) return '';
    const i = Math.floor(Math.log(bytes)/Math.log(1024));
    return (bytes/Math.pow(1024,i)).toFixed(1) + ['B','KB','MB'][i];
}

// --- å¯¼å…¥å¯¼å‡º ---
function exportData(type) {
    if(type === 'json') {
        const blob = new Blob([JSON.stringify(app, null, 2)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `å¤‡ä»½_v1.3.0_fix1_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    } else {
        exportHtmlReport();
    }
}

function importData(input) {
    const f = input.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = e => {
        try {
            const data = JSON.parse(e.target.result);
            if (Array.isArray(data)) {
                app.files = data.map(item => ({
                    ...item,
                    tab: 'LX'
                }));
                app.tabs = ['LX'];
            } else {
                app = data;
            }
            saveData();
            renderTabs();
            renderTable();
            alert('å¯¼å…¥æˆåŠŸï¼');
        } catch(err) {
            alert('æ–‡ä»¶æ ¼å¼é”™è¯¯');
            console.error(err);
        }
    };
    r.readAsText(f);
    input.value = '';
}

// --- HTML å¯¼å‡ºç”Ÿæˆå™¨ (å«ä¿®å¤é€»è¾‘) ---
function exportHtmlReport() {
    const exportObj = {
        tabs: app.tabs,
        files: app.files,
        lxScriptEnabled: app.lxScriptEnabled
    };
    
    const html = `
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>æ’ä»¶åˆ—è¡¨ (v1.3.0-fix1)</title>
<style>
body{font-family:'Microsoft YaHei',sans-serif;background:#f9f9f9;padding:20px;max-width:1200px;margin:0 auto;color:#333}
h1{border-bottom:2px solid #667eea;padding-bottom:10px;margin-bottom:20px;color:#444}
.tab-bar{display:flex;border-bottom:1px solid #ddd;margin-bottom:20px;gap:5px}
.tab{padding:10px 20px;border:none;background:none;cursor:pointer;font-size:14px;color:#666;border-radius:5px 5px 0 0}
.tab.active{background:#fff;color:#667eea;font-weight:bold;border:1px solid #ddd;border-bottom:2px solid #fff;margin-bottom:-1px}
table{width:100%;border-collapse:collapse;background:white;box-shadow:0 2px 5px rgba(0,0,0,0.05)}
th{background:#f5f5f5;padding:10px;text-align:left;font-size:13px}
td{padding:10px;border-bottom:1px solid #eee;vertical-align:top}
.btn{display:inline-block;padding:5px 10px;color:white;text-decoration:none;border-radius:3px;font-size:12px;margin:2px;cursor:pointer;border:none}
.bg-green{background:#28a745}.bg-blue{background:#667eea}.bg-yellow{background:#f0ad4e}.bg-teal{background:#20c997}
.tag{background:#eef2ff;color:#5a67d8;padding:2px 6px;border-radius:4px;font-size:11px;margin-right:4px;text-decoration:none;display:inline-block}
.key-box{margin-top:5px;background:#fffbe6;padding:5px;border:1px solid #ffe58f;display:flex;gap:5px;border-radius:3px;align-items:center}
.key-in{flex:1;border:1px solid #ddd;padding:3px;font-size:12px}
</style>
</head>
<body>
<h1>æ’ä»¶åˆ—è¡¨ <span style="font-size:12px;color:#999;font-weight:normal">v1.3.0-fix1 | ${new Date().toLocaleString()}</span></h1>

<div class="tab-bar" id="tabBar"></div>
<div id="content"></div>

<script>
const DATA = ${JSON.stringify(exportObj)};
let curTab = DATA.tabs[0];

function init() {
    const bar = document.getElementById('tabBar');
    bar.innerHTML = DATA.tabs.map(t => 
        '<button class="tab ' + (t===curTab?'active':'') + '" onclick="switchTab(\\''+t+'\\')">' + (t==='LX'?'LX Music':t) + '</button>'
    ).join('');
    render();
}

function switchTab(t) { curTab = t; init(); }

function render() {
    const list = DATA.files.filter(f => (f.tab||'LX') === curTab);
    const div = document.getElementById('content');
    
    if(list.length === 0) {
        div.innerHTML = '<div style="padding:20px;text-align:center;color:#999">æ­¤æ ‡ç­¾é¡µæ— æ–‡ä»¶</div>';
        return;
    }

    // LX åŠŸèƒ½å¼€å…³åˆ¤æ–­
    const isLX = (curTab === 'LX');
    // å¦‚æœæ˜¯ LX ä¸”è„šæœ¬å¼€å¯ï¼Œåˆ™å…è®¸ç”Ÿæˆå¯¼å…¥è„šæœ¬ï¼›å¦åˆ™ï¼ˆè„šæœ¬å…³é—­æˆ–éLXï¼‰ä¸å…è®¸ç”Ÿæˆå¯¼å…¥è„šæœ¬
    const enableScript = isLX && DATA.lxScriptEnabled;

    let html = '<table><thead><tr><th>æ–‡ä»¶å</th><th>éŸ³è´¨/ç‰ˆæœ¬</th><th>å¤‡æ³¨ & é“¾æ¥</th><th>ä¸‹è½½/æ“ä½œ</th></tr></thead><tbody>';
    
    html += list.map((f, idx) => {
        let tags = (f.links||[]).map(l => '<a href="'+l.url+'" target="_blank" class="tag">ğŸ”— '+l.text+'</a>').join('');
        
        let btns = '';
        
        // 1. ç›´è¿ä¸‹è½½ (å¦‚æœæœ‰)
        if(f.directUrl) {
            btns += '<a href="'+f.directUrl+'" class="btn bg-teal" download>ğŸŒ åœ¨çº¿ä¸‹è½½</a> ';
        }
        
        // 2. æœ¬åœ°æ–‡ä»¶ä¸‹è½½
        if(f.fileContent) {
            btns += '<button class="btn bg-green" onclick="download('+idx+')">â¬‡ï¸ æœ¬åœ°ä¸‹è½½</button> ';
            
            // 3. ä¸€é”®å¯¼å…¥è„šæœ¬ (ä»…å½“å¯ç”¨æ—¶æ˜¾ç¤º)
            if(enableScript) {
                btns += '<button class="btn bg-blue" onclick="genScript('+idx+', false)">ğŸš€ ä¸€é”®å¯¼å…¥</button>';
            }
        }
        
        // 4. Key åŒºåŸŸ (é€»è¾‘ï¼šåªè¦é…ç½®äº†Keyå°±æ˜¾ç¤ºKeyæ¡†ï¼Œä½†æ˜¯å¦èƒ½â€œå«Keyå¯¼å…¥â€å–å†³äº enableScript)
        if(isLX && f.fileContent) {
            // åœ¨çº¿ Key è·³è½¬ (ä¸å—è„šæœ¬å¼€å…³å½±å“ï¼Œåªè¦é…äº†å°±èƒ½è·³è½¬)
            if(f.keyUrl) {
                btns += '<div class="key-box"><span style="font-size:10px">åœ¨çº¿Key</span><input id="k1-'+idx+'" class="key-in" placeholder="è¾“å…¥Key"><button class="btn bg-yellow" onclick="dlKey('+idx+')">è·³è½¬ä¸‹è½½</button></div>';
            }
            
            // æœ¬åœ° Key æ³¨å…¥
            if(f.keyVariable) {
                if(enableScript) {
                    // è„šæœ¬å¼€å¯ï¼šæ˜¾ç¤ºæ³¨å…¥æŒ‰é’®
                    btns += '<div class="key-box"><span style="font-size:10px">æœ¬åœ°Key</span><input id="k2-'+idx+'" class="key-in" placeholder="è¾“å…¥Key"><button class="btn bg-blue" onclick="genScript('+idx+', true)">å«Keyå¯¼å…¥</button></div>';
                } else {
                    // è„šæœ¬å…³é—­ï¼šåªæ˜¾ç¤ºæç¤ºæˆ–ä»…å…è®¸å¤åˆ¶ (æ­¤å¤„ç®€å•å¤„ç†ï¼šä¸æ˜¾ç¤ºæ³¨å…¥æŒ‰é’®)
                }
            }
        }

        return '<tr><td><b>'+f.fileName+'</b></td><td>'+f.quality+'</td><td>'+f.note+'<br>'+tags+'</td><td>'+btns+'</td></tr>';
    }).join('');
    
    html += '</tbody></table>';
    div.innerHTML = html;
}

function download(idx) {
    const list = DATA.files.filter(f => (f.tab||'LX') === curTab);
    const f = list[idx];
    saveAs(b64toBlob(f.fileContent), f.fileName);
}

function dlKey(idx) {
    const list = DATA.files.filter(f => (f.tab||'LX') === curTab);
    const f = list[idx];
    const k = document.getElementById('k1-'+idx).value;
    if(k && f.keyUrl) window.open(f.keyUrl + k);
}

function b64toBlob(b64) {
    const bin = atob(b64.split(',')[1]);
    const arr = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) arr[i] = bin.charCodeAt(i);
    return new Blob([arr], {type: 'application/javascript'});
}

function saveAs(blob, name) {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
}

// æ³¨å…¥è„šæœ¬ç”Ÿæˆé€»è¾‘
${getClientLogic()}

init();
<\/script>
</body>
</html>`;

    const blob = new Blob([html], {type: 'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `åˆ—è¡¨_v1.3.0_fix1_${new Date().toISOString().slice(0,10)}.html`;
    a.click();
}

function getClientLogic() {
    function logic() {
        window.genScript = function(idx, useKey) {
            const list = DATA.files.filter(f => (f.tab||'LX') === curTab);
            const f = list[idx];
            
            const btn = event.target;
            const orgTxt = btn.innerText;
            btn.innerText = "ç”Ÿæˆä¸­...";
            btn.disabled = true;

            try {
                let content = atob(f.fileContent.split(',')[1]);
                const decoder = new TextDecoder('utf-8');
                const rawArr = new Uint8Array([...content].map(c=>c.charCodeAt(0)));
                let txt = decoder.decode(rawArr);

                if(useKey) {
                    const k = document.getElementById('k2-'+idx).value;
                    if(!k) throw new Error("è¯·è¾“å…¥Key");
                    const v = f.keyVariable || 'API_KEY';
                    // æ›¿æ¢å˜é‡
                    const reg = new RegExp('const\\\\s+' + v + '\\\\s*=\\\\s*[\\\'\\"][\\\'\\"]');
                    if(reg.test(txt)) {
                        txt = txt.replace(reg, 'const ' + v + ' = "' + k + '"');
                    } else {
                         txt = txt.replace(v + '=""', v + '="' + k + '"');
                         txt = txt.replace(v + "=''", v + "='" + k + "'");
                    }
                }

                // PowerShell è„šæœ¬éƒ¨åˆ† (ä¿æŒåŸæ ·)
                const encoder = new TextEncoder();
                const bytes = encoder.encode(txt);
                let binStr = '';
                for(let i=0; i<bytes.length; i++) binStr += String.fromCharCode(bytes[i]);
                const b64 = btoa(binStr);
                
                const ps = [
                    '$content = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("' + b64 + '"))',
                    '$path = [Environment]::GetFolderPath("Desktop") + "\\' + (f.fileName || 'plugin.js') + '"',
                    '[System.IO.File]::WriteAllText($path, $content)',
                    'Write-Host "æ–‡ä»¶å·²ä¿å­˜åˆ°æ¡Œé¢: " $path -ForegroundColor Green',
                    'Write-Host "è¯·å‰å¾€ LX Music è®¾ç½® -> è‡ªå®šä¹‰æº -> å¯¼å…¥æ­¤æ–‡ä»¶" -ForegroundColor Yellow',
                    'Start-Sleep -Seconds 5'
                ].join('\\r\\n');

                const bat = '@echo off\\r\\npowershell -Command "' + ps.replace(/"/g, '\\"') + '"';
                
                const blob = new Blob([bat], {type: 'text/plain;charset=gbk'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'ä¸€é”®å®‰è£…_' + f.fileName + '.bat';
                a.click();
            } catch(e) {
                alert('é”™è¯¯: ' + e.message);
            } finally {
                btn.innerText = orgTxt;
                btn.disabled = false;
            }
        };
    }
    const s = logic.toString();
    return s.substring(s.indexOf('{')+1, s.lastIndexOf('}'));
}
</script>
</body>
</html>