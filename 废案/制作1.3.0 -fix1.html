<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æ’ä»¶åˆ—è¡¨ç®¡ç†å™¨ v1.3.0-fix1</title>
  <style>
    /* å…¨å±€åŸºç¡€ */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: #f2f4f8; padding: 20px; color: #333; min-height: 100vh; }
    .container { max-width: 1650px; margin: 0 auto; background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    
    /* å¤´éƒ¨ */
    .header { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid #eaedf1; padding-bottom: 15px; margin-bottom: 20px; }
    .title h1 { font-size: 24px; color: #2d3748; margin-bottom: 4px; display: flex; align-items: baseline; gap: 10px; }
    .version-tag { font-size: 14px; color: #a0aec0; font-weight: normal; background: #edf2f7; padding: 2px 8px; border-radius: 4px; }
    .title p { font-size: 12px; color: #a0aec0; margin-top: 2px; }
    
    /* æ ‡ç­¾é¡µ */
    .tabs-area { display: flex; gap: 4px; border-bottom: 1px solid #e2e8f0; margin-bottom: 15px; overflow-x: auto; }
    .tab-item { 
        padding: 8px 24px; 
        background: transparent; 
        border: 1px solid transparent; 
        border-bottom: none; 
        cursor: pointer; 
        color: #718096; 
        font-size: 14px; 
        font-weight: 500;
        border-radius: 6px 6px 0 0;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
    }
    .tab-item:hover { background: #f7fafc; color: #2d3748; }
    .tab-item.active { background: #fff; color: #5a67d8; font-weight: bold; border-color: #e2e8f0; border-top: 2px solid #5a67d8; margin-bottom: -1px; z-index: 5; }
    .tab-close { font-size: 12px; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; border-radius: 50%; color: #cbd5e0; }
    .tab-close:hover { background: #fed7d7; color: #e53e3e; }
    .tab-add { padding: 8px 12px; cursor: pointer; color: #cbd5e0; font-size: 18px; }
    .tab-add:hover { color: #5a67d8; }

    /* å·¥å…·æ  */
    .toolbar { display: flex; gap: 10px; padding: 12px; background: #f7fafc; border-radius: 8px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; border: 1px solid #edf2f7; }
    .search-input { padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 13px; width: 240px; }
    .spacer { flex: 1; }
    
    /* æŒ‰é’®ç³»ç»Ÿ */
    .btn { padding: 7px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; color: white; display: inline-flex; align-items: center; gap: 6px; transition: opacity 0.2s; font-weight: 500; }
    .btn:hover { opacity: 0.9; }
    .btn-green { background: #38a169; }
    .btn-blue { background: #5a67d8; }
    .btn-red { background: #e53e3e; }
    .btn-gray { background: #718096; }
    .btn-info { background: #3182ce; }

    /* è¡¨æ ¼æ“ä½œå°æŒ‰é’® */
    .xs-btn { padding: 4px 10px; font-size: 12px; border-radius: 4px; border: none; cursor: pointer; color: white; display: inline-block; margin: 0 2px 4px 0; }
    .xs-up { background: #718096; }
    .xs-dl { background: #38a169; }
    .xs-del { background: #e53e3e; }
    .xs-cfg { background: #d69e2e; } 
    .xs-link { background: #3182ce; }
    .xs-dir { background: #00b5ad; }

    /* è¡¨æ ¼ */
    .table-wrap { overflow-x: auto; border: 1px solid #e2e8f0; border-radius: 8px; background: white; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { background: #f7fafc; padding: 12px 15px; text-align: left; font-weight: 600; color: #4a5568; border-bottom: 2px solid #e2e8f0; white-space: nowrap; }
    td { padding: 12px 15px; border-bottom: 1px solid #edf2f7; vertical-align: top; }
    tr:hover { background: #fafafa; }
    
    input[type="text"], select { width: 100%; padding: 7px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 13px; }
    input:focus, select:focus { border-color: #5a67d8; outline: none; box-shadow: 0 0 0 2px rgba(90, 103, 216, 0.1); }

    /* æ ‡ç­¾Tag */
    .tags-list { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
    .tag { font-size: 11px; padding: 3px 10px; border-radius: 12px; background: #ebf4ff; color: #5a67d8; border: 1px solid #c3dafe; display: inline-flex; align-items: center; gap: 5px; }
    .tag-key { background: #fffff0; color: #d69e2e; border-color: #fefcbf; }
    .tag-local { background: #e6fffa; color: #319795; border-color: #b2f5ea; }
    .tag-dir { background: #e0f2f1; color: #00695c; border-color: #b2dfdb; }
    .tag-x { cursor: pointer; font-weight: bold; opacity: 0.5; font-size: 12px; }
    .tag-x:hover { color: #e53e3e; opacity: 1; }

    /* å¼€å…³ç»„ä»¶ */
    .toggle-box { display: flex; align-items: center; gap: 8px; font-size: 13px; background: #ebf8ff; padding: 6px 12px; border-radius: 20px; color: #2b6cb0; border: 1px solid #bee3f8; margin-left: 10px; }
    .toggle-box input { cursor: pointer; }

    /* å¼¹çª— */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
    .modal-main { background: white; width: 450px; margin: 8vh auto; padding: 25px; border-radius: 10px; box-shadow: 0 20px 50px rgba(0,0,0,0.15); animation: fadeUp 0.2s; }
    @keyframes fadeUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-head { font-weight: bold; font-size: 16px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
    .field { margin-bottom: 15px; }
    .field label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; color: #4a5568; }
    .check-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 14px; font-weight: 500; cursor: pointer; }

    .empty-state { padding: 50px; text-align: center; color: #a0aec0; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="title">
      <h1>æ’ä»¶åˆ—è¡¨ç®¡ç†å™¨ <span class="version-tag">v1.3.0-fix1</span></h1>
      <p>ä¸Šæ¬¡ä¿å­˜: <span id="saveTime">-</span></p>
    </div>
  </div>

  <!-- æ ‡ç­¾é¡µåŒºåŸŸ -->
  <div class="tabs-area" id="tabsRenderArea"></div>

  <!-- å·¥å…·æ  -->
  <div class="toolbar">
    <button class="btn btn-green" onclick="addFile()">â• æ·»åŠ æ–‡ä»¶</button>
    <button class="btn btn-blue" onclick="exportBackup()">ğŸ’¾ å¤‡ä»½æ•°æ®</button>
    <button class="btn btn-info" onclick="exportHtml()">ğŸ“¤ å¯¼å‡ºæŠ¥å‘Š</button>
    <button class="btn btn-red" onclick="clearPage()">ğŸ—‘ï¸ æ¸…ç©ºæ­¤é¡µ</button>
    
    <!-- LX ä¸“å±è„šæœ¬å¼€å…³ -->
    <div class="toggle-box" id="scriptSwitchPanel" style="display:none">
        <input type="checkbox" id="scriptToggle" onchange="toggleScript()">
        <label for="scriptToggle" style="cursor:pointer">å¯ç”¨ä¸€é”®å¯¼å…¥è„šæœ¬ (ç”ŸæˆBAT)</label>
    </div>

    <div class="spacer"></div>
    <!-- éšè—çš„é€šç”¨æ–‡ä»¶è¾“å…¥æ¡†ï¼Œå®é™…ä¸Šä¼šé€šè¿‡JSåŠ¨æ€æ£€æŸ¥æ–‡ä»¶ç±»å‹ -->
    <input type="file" id="impFile" hidden onchange="importBackup(this)">
    <button class="btn btn-gray" onclick="document.getElementById('impFile').click()">ğŸ“‚ å¯¼å…¥æ•°æ®</button>
    <input type="text" class="search-input" placeholder="ğŸ” æœç´¢..." oninput="renderFiles()">
  </div>

  <!-- åˆ—è¡¨è¡¨æ ¼ -->
  <div class="table-wrap">
    <table id="mainTable">
      <thead>
        <tr>
          <th width="60">æ’åº</th>
          <th width="320">æ–‡ä»¶å & çŠ¶æ€</th>
          <th width="160">éŸ³è´¨/ç‰ˆæœ¬</th>
          <th width="400">å¤‡æ³¨ & é…ç½®</th>
          <th width="200">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="fileListBody"></tbody>
    </table>
  </div>
</div>

<!-- å¼¹çª—ï¼šæ·»åŠ æ ‡ç­¾ -->
<div id="modalTab" class="modal">
  <div class="modal-main">
    <div class="modal-head">æ–°å»ºæ ‡ç­¾é¡µ <span style="cursor:pointer" onclick="closeM('modalTab')">âœ•</span></div>
    <div class="field">
      <label>é¢„è®¾ï¼š</label>
      <div style="display:flex; gap:10px; margin-bottom:15px">
        <button class="xs-btn xs-link" onclick="qTab('Music Free')">Music Free</button>
        <button class="xs-btn xs-link" onclick="qTab('æ¾œéŸ³')">æ¾œéŸ³</button>
      </div>
      <label>åç§°ï¼š</label>
      <input type="text" id="tabNameInput">
    </div>
    <div style="text-align:right"><button class="btn btn-blue" onclick="doAddTab()">ç¡®å®š</button></div>
  </div>
</div>

<!-- å¼¹çª—ï¼šKeyé…ç½® -->
<div id="modalKey" class="modal">
  <div class="modal-main">
    <div class="modal-head">Key é…ç½® (LX) <span style="cursor:pointer" onclick="closeM('modalKey')">âœ•</span></div>
    
    <div class="field" style="background:#fffaf0; padding:12px; border-radius:6px; border:1px solid #fbd38d;">
      <label class="check-row">
        <input type="checkbox" id="chkOnlineKey" onchange="updKeyUI()"> ğŸŒ å¯ç”¨åœ¨çº¿ Key
      </label>
      <div id="boxOnline">
        <input type="text" id="valKeyUrl" placeholder="æ¨¡æ¿URL, å¦‚: https://api.com?k=">
      </div>
    </div>

    <div class="field" style="background:#f0fff4; padding:12px; border-radius:6px; border:1px solid #9ae6b4;">
      <label class="check-row">
        <input type="checkbox" id="chkLocalKey" onchange="updKeyUI()"> ğŸ“‚ å¯ç”¨æœ¬åœ° Key
      </label>
      <div id="boxLocal">
        <input type="text" id="valKeyVar" placeholder="å˜é‡å, å¦‚: API_KEY">
      </div>
    </div>

    <div style="text-align:right"><button class="btn btn-blue" onclick="saveKey()">ä¿å­˜</button></div>
  </div>
</div>

<!-- å¼¹çª—ï¼šé“¾æ¥/ç›´è¿ -->
<div id="modalLink" class="modal">
  <div class="modal-main">
    <div class="modal-head">æ·»åŠ ä¿¡æ¯ <span style="cursor:pointer" onclick="closeM('modalLink')">âœ•</span></div>
    <!-- æ™®é€šé“¾æ¥ -->
    <div id="linkModeNormal">
        <div class="field"><label>é“¾æ¥åç§°</label><input type="text" id="linkTxt"></div>
        <div class="field"><label>é“¾æ¥åœ°å€</label><input type="text" id="linkHref"></div>
        <div style="text-align:right"><button class="btn btn-blue" onclick="doAddLink()">æ·»åŠ é“¾æ¥</button></div>
    </div>
    <!-- ç›´è¿æ¨¡å¼ -->
    <div id="linkModeDirect" style="display:none">
        <div class="field"><label>ç›´è¿ä¸‹è½½åœ°å€ (Direct URL)</label><input type="text" id="dirUrlVal"></div>
        <div style="text-align:right"><button class="btn btn-green" onclick="doAddDirect()">ä¿å­˜ç›´è¿</button></div>
    </div>
  </div>
</div>

<script>
// --- æ•°æ®æ ¸å¿ƒ ---
let data = {
  tabs: ['LX'],
  curTab: 'LX',
  files: [],
  scriptOn: true
};
const PRESETS = ['128k', '320k', 'flac', 'flac24bit', 'master', 'sky', 'dolby'];
let editId = null;

window.onload = () => {
  load();
  renderTabs();
  renderFiles();
};

function load() {
  const s = localStorage.getItem('pm_v130fix1');
  if(s) {
    try {
        const d = JSON.parse(s);
        if(Array.isArray(d)) {
            data.files = d.map(f => ({...f, tab:'LX', directUrl: f.directUrl||''}));
        } else {
            data = d;
            data.files.forEach(f => {
                if(f.directUrl === undefined) f.directUrl = '';
            });
        }
    } catch(e){}
  }
  if(!data.tabs.includes('LX')) data.tabs.unshift('LX');
  if(!data.tabs.includes(data.curTab)) data.curTab = 'LX';
  
  document.getElementById('scriptToggle').checked = data.scriptOn;
  document.getElementById('saveTime').innerText = new Date().toLocaleTimeString();
}

function save() {
  data.scriptOn = document.getElementById('scriptToggle').checked;
  localStorage.setItem('pm_v130fix1', JSON.stringify(data));
  document.getElementById('saveTime').innerText = new Date().toLocaleTimeString();
}

// --- æ ‡ç­¾é¡µ ---
function renderTabs() {
  const box = document.getElementById('tabsRenderArea');
  box.innerHTML = '';
  
  data.tabs.forEach(t => {
    const el = document.createElement('div');
    el.className = `tab-item ${t === data.curTab ? 'active' : ''}`;
    
    const spanTxt = document.createElement('span');
    spanTxt.innerText = t === 'LX' ? 'LX Music' : t;
    spanTxt.onclick = () => { data.curTab = t; renderTabs(); renderFiles(); save(); };
    el.appendChild(spanTxt);

    if(t !== 'LX') {
      const spanClose = document.createElement('span');
      spanClose.className = 'tab-close';
      spanClose.innerHTML = 'âœ•';
      spanClose.onclick = (e) => {
        e.stopPropagation();
        if(confirm(`åˆ é™¤ "${t}" é¡µåŠæ–‡ä»¶ï¼Ÿ`)) {
          data.tabs = data.tabs.filter(x => x !== t);
          data.files = data.files.filter(f => f.tab !== t);
          if(data.curTab === t) data.curTab = 'LX';
          save(); renderTabs(); renderFiles();
        }
      };
      el.appendChild(spanClose);
    }
    box.appendChild(el);
  });

  const addBtn = document.createElement('div');
  addBtn.className = 'tab-add';
  addBtn.innerHTML = '+';
  addBtn.onclick = () => openM('modalTab');
  box.appendChild(addBtn);

  document.getElementById('scriptSwitchPanel').style.display = (data.curTab === 'LX') ? 'flex' : 'none';
}

function toggleScript() { save(); renderFiles(); }

// --- æ–‡ä»¶åˆ—è¡¨ ---
function renderFiles() {
  const tbody = document.getElementById('fileListBody');
  const term = document.querySelector('.search-input').value.toLowerCase();
  
  const list = data.files.filter(f => {
    const ft = f.tab || 'LX';
    return ft === data.curTab && (!term || (f.fileName||'').toLowerCase().includes(term));
  });

  if(!list.length) {
    tbody.innerHTML = `<tr><td colspan="5" class="empty-state">æ­¤é¡µé¢æ— æ•°æ®ï¼Œè¯·æ·»åŠ </td></tr>`;
    return;
  }

  const isLX = data.curTab === 'LX';
  const isLanyin = data.curTab === 'æ¾œéŸ³';
  const isMusicFree = data.curTab === 'Music Free';
  // LX å’Œ æ¾œéŸ³ é™åˆ¶ä¸º .js; Music Free é™åˆ¶ä¸º .js, .json; å…¶ä»–ä¸é™
  let acceptAttr = '';
  if(isLX || isLanyin) acceptAttr = '.js';
  else if(isMusicFree) acceptAttr = '.js,.json';

  const showKeyCfg = isLX; 

  tbody.innerHTML = list.map((f, i) => {
    let qHtml;
    if(isLX || isLanyin) {
      const isCustom = f.quality && !PRESETS.includes(f.quality);
      if(isCustom) {
        qHtml = `<div style="display:flex;gap:5px;align-items:center">
          <input type="text" value="${f.quality}" onblur="updFile(${f.id},'quality',this.value)">
          <span style="font-size:11px;color:#718096;cursor:pointer;text-decoration:underline" onclick="updFile(${f.id},'quality','')">é‡ç½®</span>
        </div>`;
      } else {
        qHtml = `<select onchange="changeQual(${f.id},this.value)">
          <option value="">é€‰æ‹©...</option>
          ${PRESETS.map(p => `<option value="${p}" ${f.quality===p?'selected':''}>${p}</option>`).join('')}
          <option value="__C__">è‡ªå®šä¹‰...</option>
        </select>`;
      }
    } else {
      qHtml = `<input type="text" value="${f.quality||''}" onchange="updFile(${f.id},'quality',this.value)">`;
    }

    let tags = '';
    if(f.directUrl) tags += `<span class="tag tag-dir" title="${f.directUrl}">ğŸŒ ç›´è¿ <span class="tag-x" onclick="updFile(${f.id},'directUrl','')">âœ•</span></span>`;
    if(isLX && f.enableOnline && f.keyUrl) tags += `<span class="tag tag-key" title="${f.keyUrl}">åœ¨çº¿Key</span>`;
    if(isLX && f.enableLocal && f.keyVariable) tags += `<span class="tag tag-local" title="${f.keyVariable}">æœ¬åœ°Key</span>`;
    (f.links||[]).forEach((l, idx) => {
      tags += `<span class="tag"><a href="${l.url}" target="_blank" style="text-decoration:none;color:inherit">${l.text}</a><span class="tag-x" onclick="delLink(${f.id},${idx})">âœ•</span></span>`;
    });

    let acts = `
      <input type="file" id="u-${f.id}" hidden accept="${acceptAttr}" onchange="upl(${f.id},this)">
      <button class="xs-btn xs-up" onclick="document.getElementById('u-${f.id}').click()">${f.fileContent?'ğŸ”„ é‡ä¼ ':'ğŸ“¤ ä¸Šä¼ '}</button>
      <button class="xs-btn xs-del" onclick="delFile(${f.id})">åˆ é™¤</button>
    `;
    if(f.fileContent) acts = `<button class="xs-btn xs-dl" onclick="dlLocal(${f.id})">â¬‡ï¸ ä¸‹è½½</button> ` + acts;

    let cfgs = `<button class="xs-btn xs-link" onclick="openLink(${f.id}, false)">+ é“¾æ¥</button>`;
    cfgs += ` <button class="xs-btn xs-dir" onclick="openLink(${f.id}, true)">+ ç›´è¿</button>`;
    if(showKeyCfg) cfgs += ` <button class="xs-btn xs-cfg" onclick="openKey(${f.id})">âš™ï¸ Key</button>`;

    return `<tr>
      <td>
        <button class="xs-btn xs-up" onclick="move(${f.id},-1)">â†‘</button>
        <button class="xs-btn xs-up" onclick="move(${f.id},1)">â†“</button>
      </td>
      <td>
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
          <span style="font-size:16px">ğŸ“„</span>
          <input type="text" value="${f.fileName}" onchange="updFile(${f.id},'fileName',this.value)" placeholder="æ–‡ä»¶å" style="font-weight:600;width:180px">
        </div>
        ${f.fileContent ? `<span class="status-badge" style="background:#def7ec;color:#03543f">å·²ä¸Šä¼  ${sz(f.fileSize)}</span>` : `<span class="status-badge" style="background:#fde8e8;color:#9b1c1c">æœªä¸Šä¼ </span>`}
      </td>
      <td>${qHtml}</td>
      <td>
        <input type="text" value="${f.note||''}" onchange="updFile(${f.id},'note',this.value)" placeholder="å¤‡æ³¨..." style="margin-bottom:6px">
        <div class="tags-list">${cfgs} ${tags}</div>
      </td>
      <td style="display:flex;flex-direction:column;gap:4px;align-items:flex-start">${acts}</td>
    </tr>`;
  }).join('');
}

function addFile() {
  data.files.push({
    id: Date.now(), tab: data.curTab,
    fileName: '', quality: '', note: '', links: [], directUrl: '',
    fileContent: null, fileSize: 0,
    enableOnline: true, keyUrl: '', 
    enableLocal: true, keyVariable: ''
  });
  save(); renderFiles();
}
function updFile(id,k,v) { const f=find(id); if(f){f[k]=v;save();renderFiles();} }
function changeQual(id,v) { if(v==='__C__') updFile(id,'quality','è‡ªå®šä¹‰'); else updFile(id,'quality',v); }

// --- æ ¸å¿ƒä¸Šä¼ ä¸æ ¡éªŒé€»è¾‘ ---
function upl(id,inp) {
  const file=inp.files[0]; 
  if(!file)return;
  
  const fName = file.name.toLowerCase();
  const cur = data.curTab;
  
  // æ ¡éªŒé€»è¾‘
  let valid = true;
  if(cur === 'LX' || cur === 'æ¾œéŸ³') {
      if(!fName.endsWith('.js')) {
          alert('å½“å‰æ ‡ç­¾é¡µ (' + cur + ') ä»…å…è®¸ä¸Šä¼  .js æ–‡ä»¶ï¼');
          valid = false;
      }
  } else if(cur === 'Music Free') {
      if(!fName.endsWith('.js') && !fName.endsWith('.json')) {
          alert('Music Free ä»…å…è®¸ä¸Šä¼  .js æˆ– .json æ–‡ä»¶ï¼');
          valid = false;
      }
  }
  
  if(!valid) {
      inp.value = ''; // æ¸…ç©ºé€‰æ‹©
      return;
  }

  const r=new FileReader();
  r.onload=e=>{
    const f=find(id); 
    f.fileContent=e.target.result; 
    f.fileName=f.fileName||file.name; 
    f.fileSize=file.size;
    save(); renderFiles();
  };
  r.readAsDataURL(file); 
  inp.value='';
}

function dlLocal(id){ const f=find(id); saveAs(b64blob(f.fileContent), f.fileName); }
function delFile(id){ if(confirm('åˆ é™¤?')) { data.files=data.files.filter(x=>x.id!==id); save(); renderFiles(); } }
function clearPage(){ if(confirm('æ¸…ç©º?')) { data.files=data.files.filter(f=>(f.tab||'LX')!==data.curTab); save(); renderFiles(); } }
function move(id,d){ const idx=data.files.findIndex(x=>x.id===id); const t=idx+d; if(t>=0&&t<data.files.length){ [data.files[idx],data.files[t]]=[data.files[t],data.files[idx]]; save(); renderFiles(); } }

// --- å¼¹çª—é€»è¾‘ ---
function openM(id){ document.getElementById(id).style.display='block'; }
function closeM(id){ document.getElementById(id).style.display='none'; editId=null; }

function qTab(n){ document.getElementById('tabNameInput').value=n; doAddTab(); }
function doAddTab(){ 
  const n=document.getElementById('tabNameInput').value.trim();
  if(n && !data.tabs.includes(n)){ data.tabs.push(n); data.curTab=n; save(); renderTabs(); renderFiles(); closeM('modalTab'); document.getElementById('tabNameInput').value=''; }
}

function openLink(id, isDir){
  editId=id; 
  document.getElementById('linkModeNormal').style.display = isDir ? 'none' : 'block';
  document.getElementById('linkModeDirect').style.display = isDir ? 'block' : 'none';
  const f = find(id);
  if(isDir) document.getElementById('dirUrlVal').value = f.directUrl||'';
  else { document.getElementById('linkTxt').value=''; document.getElementById('linkHref').value=''; }
  openM('modalLink');
}
function doAddLink(){
  const f=find(editId); const t=document.getElementById('linkTxt').value; const u=document.getElementById('linkHref').value;
  if(f&&t&&u){ f.links.push({text:t,url:u}); save(); renderFiles(); closeM('modalLink'); }
}
function doAddDirect(){
  const f=find(editId); const u=document.getElementById('dirUrlVal').value;
  if(f){ f.directUrl=u; save(); renderFiles(); closeM('modalLink'); }
}
function delLink(fid,i){ const f=find(fid); if(f){ f.links.splice(i,1); save(); renderFiles(); } }

function openKey(id){
  editId=id; const f=find(id);
  document.getElementById('chkOnlineKey').checked = f.enableOnline!==false;
  document.getElementById('valKeyUrl').value = f.keyUrl||'';
  document.getElementById('chkLocalKey').checked = f.enableLocal!==false;
  document.getElementById('valKeyVar').value = f.keyVariable||'';
  updKeyUI(); openM('modalKey');
}
function updKeyUI(){
  const on=document.getElementById('chkOnlineKey').checked;
  const lc=document.getElementById('chkLocalKey').checked;
  document.getElementById('boxOnline').style.opacity = on?'1':'0.5';
  document.getElementById('valKeyUrl').disabled = !on;
  document.getElementById('boxLocal').style.opacity = lc?'1':'0.5';
  document.getElementById('valKeyVar').disabled = !lc;
}
function saveKey(){
  const f=find(editId);
  if(f){
    f.enableOnline = document.getElementById('chkOnlineKey').checked;
    f.keyUrl = document.getElementById('valKeyUrl').value;
    f.enableLocal = document.getElementById('chkLocalKey').checked;
    f.keyVariable = document.getElementById('valKeyVar').value;
    save(); renderFiles(); closeM('modalKey');
  }
}

// --- è¾…åŠ© ---
function find(id){ return data.files.find(x=>x.id===id); }
function sz(b){ if(!b)return'';const i=Math.floor(Math.log(b)/Math.log(1024));return (b/Math.pow(1024,i)).toFixed(1)+['B','KB','MB'][i]; }
function b64blob(s){ const b=atob(s.split(',')[1]); const a=new Uint8Array(b.length); for(let i=0;i<b.length;i++)a[i]=b.charCodeAt(i); return new Blob([a],{type:'application/javascript'}); }
function saveAs(b,n){ const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=n; a.click(); }

// --- å¯¼å…¥å¯¼å‡º ---
function exportBackup(){ 
  const b=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); 
  saveAs(b, 'backup.json'); 
}
function importBackup(i){
  const f=i.files[0]; if(!f)return;
  const r=new FileReader(); r.onload=e=>{
    try{ 
      const d=JSON.parse(e.target.result); 
      if(Array.isArray(d)) data.files=d.map(x=>({...x,tab:'LX'})); else data=d;
      save(); renderTabs(); renderFiles(); alert('å¯¼å…¥å®Œæˆ');
    }catch(e){alert('æ ¼å¼é”™è¯¯');}
  }; r.readAsText(f); i.value='';
}

function exportHtml(){
  const ex = { tabs:data.tabs, files:data.files, scriptOn:data.scriptOn };
  const h = `
<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><title>æ’ä»¶åˆ—è¡¨</title>
<style>
body{font-family:'Segoe UI',sans-serif;background:#f9fafb;padding:30px;max-width:1200px;margin:0 auto;color:#2d3748}
h1{border-bottom:2px solid #5a67d8;padding-bottom:15px;margin-bottom:20px;color:#2d3748}
.nav{display:flex;gap:5px;border-bottom:1px solid #e2e8f0;margin-bottom:20px}
.tab{padding:10px 25px;border:none;background:transparent;cursor:pointer;color:#718096;font-size:15px;border-radius:6px 6px 0 0}
.tab.active{background:#fff;color:#5a67d8;font-weight:bold;border:1px solid #e2e8f0;border-bottom:2px solid #fff;margin-bottom:-1px}
table{width:100%;background:#fff;border-collapse:collapse;box-shadow:0 2px 6px rgba(0,0,0,0.05)}
th{background:#f7fafc;padding:12px;text-align:left;color:#4a5568}
td{padding:12px;border-bottom:1px solid #edf2f7}
.btn{display:inline-block;padding:6px 12px;color:#fff;border-radius:4px;font-size:12px;text-decoration:none;cursor:pointer;border:none;margin:2px}
.g{background:#38a169} .b{background:#5a67d8} .o{background:#dd6b20} .t{background:#319795}
.tag{background:#ebf8ff;color:#3182ce;padding:2px 8px;border-radius:10px;font-size:11px;margin-right:5px;text-decoration:none}
.box{background:#fffaf0;padding:8px;border:1px solid #fbd38d;border-radius:4px;margin-top:5px;display:flex;gap:5px}
.inp{border:1px solid #cbd5e0;padding:4px;flex:1}
</style></head>
<body>
<h1>æ’ä»¶åˆ—è¡¨ <small style="font-size:12px;color:#a0aec0;font-weight:normal">${new Date().toLocaleString()}</small></h1>
<div class="nav" id="nav"></div>
<div id="cnt"></div>
<script>
const D=${JSON.stringify(ex)}; let cur=D.tabs[0];
function init(){
  document.getElementById('nav').innerHTML=D.tabs.map(t=>'<button class="tab '+(t===cur?'active':'')+'" onclick="sw(\\''+t+'\\')">'+(t==='LX'?'LX Music':t)+'</button>').join('');
  render();
}
function sw(t){cur=t;init();}
function render(){
  const list=D.files.filter(f=>(f.tab||'LX')===cur);
  const div=document.getElementById('cnt');
  if(!list.length){div.innerHTML='<div style="padding:40px;text-align:center;color:#a0aec0">æš‚æ— æ’ä»¶</div>';return;}
  
  const isLX = cur === 'LX';
  const canBAT = isLX && D.scriptOn;

  let h='<table><thead><tr><th>æ’ä»¶å</th><th>éŸ³è´¨</th><th>å¤‡æ³¨</th><th>æ“ä½œ</th></tr></thead><tbody>';
  h+=list.map((f,i)=>{
    let tags=(f.links||[]).map(l=>'<a href="'+l.url+'" target="_blank" class="tag">ğŸ”— '+l.text+'</a>').join('');
    
    let acts='';
    if(f.directUrl) acts+='<a href="'+f.directUrl+'" class="btn t">ğŸŒ ç›´è¿ä¸‹è½½</a> ';
    if(f.fileContent){
      acts+='<button class="btn g" onclick="dl('+i+')">â¬‡ï¸ ä¸‹è½½æ–‡ä»¶</button> ';
      if(canBAT) acts+='<button class="btn b" onclick="gen('+i+',false)">ğŸš€ ä¸€é”®å¯¼å…¥</button>';
    }
    
    if(isLX && f.fileContent){
      if(f.enableOnline!==false && f.keyUrl){
        acts+='<div class="box"><input id="k1-'+i+'" class="inp" placeholder="åœ¨çº¿Key"><button class="btn o" onclick="dlK('+i+')">ä¸‹è½½</button></div>';
      }
      if(f.enableLocal!==false && f.keyVariable){
        let btnHtml = canBAT 
          ? '<button class="btn b" onclick="gen('+i+',true)">å«Keyå¯¼å…¥</button>'
          : '<button class="btn b" onclick="dlLoc('+i+')">ä¸‹è½½(å«Key)</button>';
        acts+='<div class="box"><input id="k2-'+i+'" class="inp" placeholder="æœ¬åœ°Key">'+btnHtml+'</div>';
      }
    }
    return '<tr><td><b>'+f.fileName+'</b></td><td>'+f.quality+'</td><td>'+f.note+'<br>'+tags+'</td><td>'+acts+'</td></tr>';
  }).join('');
  div.innerHTML=h+'</tbody></table>';
}
function getF(i){return D.files.filter(f=>(f.tab||'LX')===cur)[i];}
function b64(s){const b=atob(s.split(',')[1]);const a=new Uint8Array(b.length);for(let i=0;i<b.length;i++)a[i]=b.charCodeAt(i);return new Blob([a],{type:'application/javascript'});}
function sv(b,n){const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=n;a.click();}
function dl(i){const f=getF(i);sv(b64(f.fileContent),f.fileName);}
function dlK(i){const f=getF(i);const k=document.getElementById('k1-'+i).value;if(k)window.open(f.keyUrl+k);}

function dlLoc(i){
  try{
    const txt = repKey(i);
    const f=getF(i);
    sv(new Blob([txt],{type:'application/javascript'}), f.fileName);
  }catch(e){alert(e.message);}
}

function repKey(i){
  const f=getF(i);
  const bin = atob(f.fileContent.split(',')[1]);
  const arr = new Uint8Array(bin.length);
  for(let j=0;j<bin.length;j++) arr[j]=bin.charCodeAt(j);
  const txt = new TextDecoder('utf-8').decode(arr);

  const k=document.getElementById('k2-'+i).value;
  if(!k)throw new Error('è¯·è¾“å…¥Key');
  const v=f.keyVariable||'API_KEY';
  const r=new RegExp('const\\\\s+'+v+'\\\\s*=\\\\s*[\\\\'\\\\"][\\\\'\\\\"]');
  if(r.test(txt)) return txt.replace(r,'const '+v+' = "'+k+'"');
  let t2=txt.replace(v+'=""', v+'="'+k+'"');
  return t2.replace(v+"=''", v+"='"+k+"'");
}

function gen(i,wk){
  try{
    const f=getF(i);
    let txt = wk ? repKey(i) : new TextDecoder('utf-8').decode(b64(f.fileContent));
    
    const enc=new TextEncoder(); const b=enc.encode(txt);
    let s='';for(let j=0;j<b.length;j++)s+=String.fromCharCode(b[j]);
    const b64Str=btoa(s);

    const ps=[
      '$c=[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("'+b64Str+'"))',
      '$p=[Environment]::GetFolderPath("Desktop")+"\\\\'+(f.fileName||'plugin.js')+'"',
      '[System.IO.File]::WriteAllText($p,$c)',
      'Write-Host "å·²ä¿å­˜åˆ°æ¡Œé¢:" $p -F Green',
      'Start-Sleep 3'
    ].join('\\r\\n');
    sv(new Blob(['@echo off\\r\\npowershell -Command "'+ps.replace(/"/g,'\\"')+'"'],{type:'text/plain;charset=gbk'}), 'å®‰è£…_'+f.fileName+'.bat');
  }catch(e){alert(e.message);}
}
init();
<\/script></body></html>`;
  const b=new Blob([h],{type:'text/html'}); sv(b,'åˆ—è¡¨.html');
}
</script>
</body>
</html>