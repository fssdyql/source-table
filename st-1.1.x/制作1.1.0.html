<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>éŸ³æºç®¡ç†ç³»ç»Ÿ - å®Œæ•´ç‰ˆ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 1900px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 { 
      color: #333; 
      margin-bottom: 10px;
      text-align: center;
    }
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 25px;
      font-size: 14px;
    }
    
    .toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s;
    }
    .btn-primary { background: #667eea; color: white; }
    .btn-primary:hover { background: #5568d3; }
    .btn-success { background: #28a745; color: white; }
    .btn-success:hover { background: #218838; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-danger:hover { background: #c82333; }
    .btn-info { background: #17a2b8; color: white; }
    .btn-info:hover { background: #138496; }
    .btn-warning { background: #ffc107; color: #333; }
    .btn-warning:hover { background: #e0a800; }
    
    .filter-bar {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px;
      background: #fff3cd;
      border-radius: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-bar label {
      font-weight: bold;
      margin-right: 5px;
    }
    .filter-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      background: white;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .checkbox-label:hover {
      background: #e3f2fd;
    }
    .checkbox-label input {
      cursor: pointer;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-card {
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 10px;
      text-align: center;
    }
    .stat-number {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .stat-label {
      font-size: 13px;
      opacity: 0.9;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      background: white;
    }
    thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    th {
      padding: 15px 10px;
      text-align: left;
      font-weight: bold;
      white-space: nowrap;
    }
    td {
      padding: 12px 10px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }
    tr:hover {
      background: #f8f9fa;
    }
    
    .file-name {
      font-weight: 500;
      color: #667eea;
      font-family: 'Consolas', monospace;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .file-icon {
      font-size: 18px;
    }
    .file-status {
      font-size: 11px;
      color: #28a745;
      margin-left: 5px;
    }
    .no-file {
      color: #dc3545;
    }
    
    input[type="text"], select, textarea {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      width: 100%;
      font-family: inherit;
    }
    
    textarea {
      min-height: 60px;
      resize: vertical;
    }
    
    .delete-btn, .download-btn, .sort-btn {
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin: 2px;
    }
    .delete-btn {
      background: #dc3545;
    }
    .delete-btn:hover {
      background: #c82333;
    }
    .download-btn {
      background: #28a745;
    }
    .download-btn:hover {
      background: #218838;
    }
    .sort-btn {
      background: #6c757d;
      padding: 4px 8px;
      font-size: 16px;
      line-height: 1;
    }
    .sort-btn:hover {
      background: #5a6268;
    }
    .sort-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .add-row-btn {
      width: 100%;
      padding: 15px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      margin-top: 20px;
      transition: all 0.3s;
    }
    .add-row-btn:hover {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
      font-size: 16px;
    }
    
    .checkbox-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .source-checkbox {
      display: flex;
      align-items: center;
      gap: 3px;
    }
    .source-checkbox input {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }
    .source-checkbox label {
      font-size: 12px;
      cursor: pointer;
      user-select: none;
    }
    
    .search-box {
      padding: 10px 15px;
      border: 2px solid #667eea;
      border-radius: 5px;
      font-size: 14px;
      width: 300px;
    }

    .file-upload-cell {
      position: relative;
    }
    .upload-btn {
      background: #17a2b8;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      border: none;
      display: inline-block;
    }
    .upload-btn:hover {
      background: #138496;
    }
    .file-input {
      display: none;
    }

    .note-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .note-text {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      width: 100%;
      min-height: 40px;
    }
    
    .links-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 5px;
    }
    
    .link-tag {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px;
      font-size: 12px;
      text-decoration: none;
      transition: all 0.3s;
      max-width: 200px;
    }
    
    .link-tag:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }
    
    .link-tag-text {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .link-tag-remove {
      background: rgba(255,255,255,0.3);
      border: none;
      color: white;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      font-size: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      flex-shrink: 0;
    }
    
    .link-tag-remove:hover {
      background: rgba(255,255,255,0.5);
    }
    
    .add-link-btn, .add-key-btn, .add-direct-btn {
      background: #17a2b8;
      color: white;
      border: none;
      padding: 5px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      align-self: flex-start;
      margin-right: 5px;
    }
    
    .add-link-btn:hover, .add-key-btn:hover, .add-direct-btn:hover {
      background: #138496;
    }

    .add-key-btn {
      background: #ffc107;
      color: #333;
    }
    
    .add-key-btn:hover {
      background: #e0a800;
    }

    .add-direct-btn {
      background: #28a745;
      color: white;
    }

    .add-direct-btn:hover {
      background: #218838;
    }

    .key-url-display {
      display: inline-block;
      padding: 4px 10px;
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 15px;
      font-size: 11px;
      color: #856404;
      margin-top: 5px;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .direct-url-display {
      display: inline-block;
      padding: 4px 10px;
      background: #d4edda;
      border: 1px solid #28a745;
      border-radius: 15px;
      font-size: 11px;
      color: #155724;
      margin-top: 5px;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .key-url-display .remove-key, .direct-url-display .remove-key {
      margin-left: 8px;
      cursor: pointer;
      color: #dc3545;
      font-weight: bold;
    }

    .key-url-display .remove-key:hover, .direct-url-display .remove-key:hover {
      color: #c82333;
    }

    .sort-buttons {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      animation: slideIn 0.3s;
    }
    
    @keyframes slideIn {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #667eea;
    }
    
    .modal-header h2 {
      color: #333;
      margin: 0;
    }
    
    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }
    
    .close:hover {
      color: #000;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group small {
      display: block;
      margin-top: 5px;
      color: #666;
      font-size: 12px;
    }

    .radio-group {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
    }

    .radio-group label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-weight: normal;
    }

    .radio-group input[type="radio"] {
      width: auto;
      cursor: pointer;
    }
    
    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 25px;
    }
    
    .btn-modal {
      padding: 10px 25px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .btn-modal-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-modal-primary:hover {
      background: #5568d3;
    }
    
    .btn-modal-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-modal-secondary:hover {
      background: #5a6268;
    }

    .mode-hint {
      padding: 10px;
      background: #e3f2fd;
      border-left: 4px solid #2196F3;
      border-radius: 4px;
      margin-top: 10px;
      font-size: 13px;
      color: #1976D2;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>ğŸµ éŸ³æºç®¡ç†ç³»ç»Ÿï¼ˆå®Œæ•´ç‰ˆï¼‰</h1>
  <p class="subtitle">âœ¨ æ”¯æŒä¸Šä¼ .jsæ–‡ä»¶ | æ”¯æŒåœ¨çº¿é“¾æ¥ | æ”¯æŒå¯†é’¥ä¸‹è½½ | æ”¯æŒæœ¬åœ°å¯†é’¥å¯¼å…¥ | å¤‡æ³¨æ”¯æŒå¤šé“¾æ¥ | æ‰‹åŠ¨æ’åº</p>
  
  <div class="toolbar">
    <button class="btn btn-success" onclick="addNewRow()">â• æ·»åŠ æ–‡ä»¶</button>
    <button class="btn btn-primary" onclick="exportToJSON()">ğŸ’¾ å¯¼å‡ºæ•°æ®</button>
    <button class="btn btn-warning" onclick="exportHTMLWithFiles()">ğŸ“¦ å¯¼å‡ºå®Œæ•´æŠ¥å‘Š(å«æ–‡ä»¶)</button>
    <button class="btn btn-info" onclick="exportToMarkdown()">ğŸ“ å¯¼å‡ºMarkdown</button>
    <button class="btn btn-success" onclick="downloadAllFiles()">â¬‡ï¸ æ‰“åŒ…ä¸‹è½½æ‰€æœ‰æ–‡ä»¶</button>
    <input type="file" id="importJSON" style="display:none" accept=".json" onchange="importFromJSON(event)">
    <button class="btn btn-primary" onclick="document.getElementById('importJSON').click()">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
    <button class="btn btn-danger" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
    <input type="text" class="search-box" placeholder="ğŸ” æœç´¢æ–‡ä»¶å..." oninput="filterTable()">
  </div>
  
  <div class="filter-bar">
    <div class="filter-group">
      <label>ğŸ” ç­›é€‰ä¸æ”¯æŒçš„æºï¼š</label>
      <label class="checkbox-label">
        <input type="checkbox" onchange="filterTable()" id="filter-kw"> é…·æˆ‘(KW)
      </label>
      <label class="checkbox-label">
        <input type="checkbox" onchange="filterTable()" id="filter-kg"> é…·ç‹—(KG)
      </label>
      <label class="checkbox-label">
        <input type="checkbox" onchange="filterTable()" id="filter-tx"> è…¾è®¯(TX)
      </label>
      <label class="checkbox-label">
        <input type="checkbox" onchange="filterTable()" id="filter-wy"> ç½‘æ˜“(WY)
      </label>
      <label class="checkbox-label">
        <input type="checkbox" onchange="filterTable()" id="filter-mg"> å’ªå’•(MG)
      </label>
      <button class="btn btn-info" onclick="clearFilters()">æ¸…é™¤ç­›é€‰</button>
    </div>
  </div>
  
  <div class="stats">
    <div class="stat-card">
      <div class="stat-number" id="totalFiles">0</div>
      <div class="stat-label">æ€»æ–‡ä»¶æ•°</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="uploadedCount">0</div>
      <div class="stat-label">å·²ä¸Šä¼ æ–‡ä»¶</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="flacCount">0</div>
      <div class="stat-label">FLAC/FLAC24éŸ³è´¨</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="fullSupportCount">0</div>
      <div class="stat-label">å…¨å¹³å°æ”¯æŒ</div>
    </div>
  </div>
  
  <div style="overflow-x: auto;">
    <table id="mainTable">
      <thead>
        <tr>
          <th width="80">æ’åº</th>
          <th width="60">åºå·</th>
          <th width="250">æ–‡ä»¶å</th>
          <th width="120">æœ€é«˜éŸ³è´¨</th>
          <th width="300">ä¸æ”¯æŒçš„æº</th>
          <th width="350">å¤‡æ³¨ & é“¾æ¥</th>
          <th width="150">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
  
  <button class="add-row-btn" onclick="addNewRow()">â• æ·»åŠ æ–°æ–‡ä»¶</button>
</div>

<div id="linkModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ğŸ”— æ·»åŠ é“¾æ¥</h2>
      <span class="close" onclick="closeLinkModal()">&times;</span>
    </div>
    <div class="form-group">
      <label>é“¾æ¥æ–‡å­—ï¼š</label>
      <input type="text" id="linkText" placeholder="ä¾‹å¦‚: å®˜æ–¹æ–‡æ¡£">
    </div>
    <div class="form-group">
      <label>é“¾æ¥åœ°å€ï¼š</label>
      <input type="text" id="linkUrl" placeholder="ä¾‹å¦‚: https://example.com">
    </div>
    <div class="modal-footer">
      <button class="btn-modal btn-modal-secondary" onclick="closeLinkModal()">å–æ¶ˆ</button>
      <button class="btn-modal btn-modal-primary" onclick="confirmAddLink()">ç¡®å®š</button>
    </div>
  </div>
</div>

<div id="keyModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ğŸ”‘ æ·»åŠ å¯†é’¥é…ç½®</h2>
      <span class="close" onclick="closeKeyModal()">&times;</span>
    </div>
    <div class="form-group">
      <label>é€‰æ‹©å¯†é’¥æ¨¡å¼ï¼š</label>
      <div class="radio-group">
        <label>
          <input type="radio" name="keyMode" value="link" checked onchange="toggleKeyMode()">
          åœ¨çº¿å¯†é’¥é“¾æ¥
        </label>
        <label>
          <input type="radio" name="keyMode" value="local" onchange="toggleKeyMode()">
          æœ¬åœ°å¯†é’¥å¯¼å…¥
        </label>
      </div>
    </div>
    <div id="keyLinkMode">
      <div class="form-group">
        <label>å¯†é’¥é“¾æ¥æ¨¡æ¿ï¼š</label>
        <input type="text" id="keyUrlTemplate" placeholder="ä¾‹å¦‚: https://api.ikunshare.com/script?key=">
        <small>ğŸ’¡ é“¾æ¥æœ«å°¾ä¸éœ€è¦åŠ å¯†é’¥ï¼Œç”¨æˆ·åœ¨æŠ¥å‘Šä¸­è¾“å…¥å¯†é’¥åä¼šè‡ªåŠ¨æ‹¼æ¥</small>
      </div>
      <div class="form-group">
        <label>ç¤ºä¾‹å®Œæ•´é“¾æ¥ï¼š</label>
        <input type="text" id="keyUrlExample" readonly style="background: #f8f9fa;">
      </div>
      <div class="mode-hint">
        ğŸ“Œ <strong>åœ¨çº¿æ¨¡å¼ï¼š</strong>ç”¨æˆ·è¾“å…¥å¯†é’¥åï¼Œä»æŒ‡å®šURLä¸‹è½½æ–‡ä»¶
      </div>
    </div>
    <div id="keyLocalMode" style="display:none;">
      <div class="form-group">
        <label>å¯†é’¥å˜é‡åï¼š</label>
        <input type="text" id="keyVariableName" value="API_KEY" placeholder="ä¾‹å¦‚: API_KEY">
        <small>ğŸ’¡ æ–‡ä»¶ä¸­çš„å¯†é’¥å˜é‡åï¼Œé»˜è®¤ä¸º API_KEY</small>
      </div>
      <div class="mode-hint">
        ğŸ“Œ <strong>æœ¬åœ°æ¨¡å¼ï¼š</strong>ç”¨æˆ·è¾“å…¥å¯†é’¥åï¼Œè‡ªåŠ¨æ›¿æ¢æ–‡ä»¶ä¸­çš„ <code>const API_KEY = ""</code>ï¼Œå¹¶åˆ é™¤ (å…¬ç›Šç‰ˆ)ã€(å…è´¹ç‰ˆ) ç­‰æ ‡è®°
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-modal btn-modal-secondary" onclick="closeKeyModal()">å–æ¶ˆ</button>
      <button class="btn-modal btn-modal-primary" onclick="confirmAddKeyUrl()">ç¡®å®š</button>
    </div>
  </div>
</div>

<div id="directUrlModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ğŸŒ æ·»åŠ å…è´¹åœ¨çº¿é“¾æ¥</h2>
      <span class="close" onclick="closeDirectUrlModal()">&times;</span>
    </div>
    <div class="form-group">
      <label>åœ¨çº¿ä¸‹è½½é“¾æ¥ï¼š</label>
      <input type="text" id="directUrlInput" placeholder="ä¾‹å¦‚: https://cdn.example.com/music.js">
      <small>ğŸ’¡ ç”¨æˆ·ç‚¹å‡»ä¸‹è½½æ—¶å°†ç›´æ¥è®¿é—®æ­¤é“¾æ¥</small>
    </div>
    <div class="form-group">
      <label>ç¤ºä¾‹ï¼š</label>
      <input type="text" value="https://cdn.jsdelivr.net/gh/user/repo/file.js" readonly style="background: #f8f9fa;">
      <small>ğŸ“Œ æ”¯æŒ GitHubã€CDNã€ç›´é“¾ç­‰ä»»ä½•å¯è®¿é—®çš„URL</small>
    </div>
    <div class="modal-footer">
      <button class="btn-modal btn-modal-secondary" onclick="closeDirectUrlModal()">å–æ¶ˆ</button>
      <button class="btn-modal btn-modal-primary" onclick="confirmAddDirectUrl()">ç¡®å®š</button>
    </div>
  </div>
</div>

<script>
let fileList = [];
let currentEditingId = null;
const qualityOptions = ['128k', '192k', '230k', '320k', 'flac', 'flac24bit', 'æ‰©å±•éŸ³è´¨', 'å…¶ä»–'];
const sources = ['kw', 'kg', 'tx', 'wy', 'mg'];
const sourceNames = {'kw': 'é…·æˆ‘','kg': 'é…·ç‹—','tx': 'è…¾è®¯','wy': 'ç½‘æ˜“','mg': 'å’ªå’•'};

function loadData() {
  const saved = localStorage.getItem('musicQualityData');
  if (saved) {
    try {
      fileList = JSON.parse(saved);
      renderTable();
      updateStats();
    } catch (e) {
      console.error('åŠ è½½æ•°æ®å¤±è´¥:', e);
      fileList = [];
    }
  }
}

function saveData() {
  try {
    localStorage.setItem('musicQualityData', JSON.stringify(fileList));
    updateStats();
  } catch (e) {
    console.error('ä¿å­˜æ•°æ®å¤±è´¥:', e);
    alert('ä¿å­˜å¤±è´¥ï¼Œæ•°æ®å¯èƒ½è¿‡å¤§ï¼');
  }
}

function addNewRow() {
  const newFile = {
    id: Date.now(),
    fileName: '',
    quality: '320k',
    unsupportedSources: [],
    note: '',
    links: [],
    keyMode: '',
    keyUrl: '',
    keyVariable: '',
    directUrl: '',
    fileContent: null,
    fileSize: 0,
    addedTime: new Date().toLocaleString('zh-CN')
  };
  fileList.push(newFile);
  saveData();
  renderTable();
  setTimeout(() => {
    const lastInput = document.querySelector('#tableBody tr:last-child input[type="text"]');
    if (lastInput) {
      lastInput.focus();
      lastInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }, 100);
}

function moveUp(index) {
  if (index > 0) {
    [fileList[index], fileList[index - 1]] = [fileList[index - 1], fileList[index]];
    saveData();
    renderTable();
  }
}

function moveDown(index) {
  if (index < fileList.length - 1) {
    [fileList[index], fileList[index + 1]] = [fileList[index + 1], fileList[index]];
    saveData();
    renderTable();
  }
}

function uploadFile(id, event) {
  const file = event.target.files[0];
  if (!file) return;
  if (!file.name.endsWith('.js')) {
    alert('åªå…è®¸ä¸Šä¼ .jsæ–‡ä»¶ï¼');
    event.target.value = '';
    return;
  }
  const reader = new FileReader();
  reader.onload = function(e) {
    const fileObj = fileList.find(f => f.id === id);
    if (fileObj) {
      fileObj.fileContent = e.target.result;
      fileObj.fileName = file.name;
      fileObj.fileSize = file.size;
      saveData();
      renderTable();
    }
  };
  reader.readAsDataURL(file);
}

function downloadFile(id) {
  const file = fileList.find(f => f.id === id);
  if (!file || !file.fileContent) {
    alert('è¯¥æ–‡ä»¶æœªä¸Šä¼ ï¼');
    return;
  }
  const link = document.createElement('a');
  link.href = file.fileContent;
  link.download = file.fileName || 'download.js';
  link.click();
}

function deleteRow(id) {
  if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
    fileList = fileList.filter(file => file.id !== id);
    saveData();
    renderTable();
  }
}

function updateFileName(id, value) {
  const file = fileList.find(f => f.id === id);
  if (file) {
    file.fileName = value;
    saveData();
  }
}

function updateQuality(id, value) {
  const file = fileList.find(f => f.id === id);
  if (file) {
    file.quality = value;
    saveData();
    renderTable();
  }
}

function updateUnsupportedSources(id, source, checked) {
  const file = fileList.find(f => f.id === id);
  if (file) {
    if (checked) {
      if (!file.unsupportedSources.includes(source)) {
        file.unsupportedSources.push(source);
      }
    } else {
      file.unsupportedSources = file.unsupportedSources.filter(s => s !== source);
    }
    saveData();
    renderTable();
  }
}

function updateNote(id, value) {
  const file = fileList.find(f => f.id === id);
  if (file) {
    file.note = value;
    saveData();
  }
}

function openLinkModal(id) {
  currentEditingId = id;
  document.getElementById('linkText').value = '';
  document.getElementById('linkUrl').value = '';
  document.getElementById('linkModal').style.display = 'block';
  setTimeout(() => {
    document.getElementById('linkText').focus();
  }, 100);
}

function closeLinkModal() {
  document.getElementById('linkModal').style.display = 'none';
  currentEditingId = null;
}

function confirmAddLink() {
  const text = document.getElementById('linkText').value.trim();
  const url = document.getElementById('linkUrl').value.trim();
  if (!text) {
    alert('è¯·è¾“å…¥é“¾æ¥æ–‡å­—ï¼');
    return;
  }
  if (!url) {
    alert('è¯·è¾“å…¥é“¾æ¥åœ°å€ï¼');
    return;
  }
  let finalUrl = url;
  if (!url.startsWith('http://') && !url.startsWith('https://')) {
    finalUrl = 'https://' + url;
  }
  const file = fileList.find(f => f.id === currentEditingId);
  if (file) {
    if (!file.links) {
      file.links = [];
    }
    file.links.push({
      text: text,
      url: finalUrl
    });
    saveData();
    renderTable();
  }
  closeLinkModal();
}

function removeLink(fileId, linkIndex) {
  const file = fileList.find(f => f.id === fileId);
  if (file && file.links) {
    file.links.splice(linkIndex, 1);
    saveData();
    renderTable();
  }
}

function toggleKeyMode() {
  const mode = document.querySelector('input[name="keyMode"]:checked').value;
  const linkMode = document.getElementById('keyLinkMode');
  const localMode = document.getElementById('keyLocalMode');
  if (mode === 'link') {
    linkMode.style.display = 'block';
    localMode.style.display = 'none';
  } else {
    linkMode.style.display = 'none';
    localMode.style.display = 'block';
  }
}

function openKeyModal(id) {
  currentEditingId = id;
  const file = fileList.find(f => f.id === id);
  if (file?.keyMode === 'local') {
    document.querySelector('input[name="keyMode"][value="local"]').checked = true;
    document.getElementById('keyVariableName').value = file.keyVariable || 'API_KEY';
  } else {
    document.querySelector('input[name="keyMode"][value="link"]').checked = true;
    document.getElementById('keyUrlTemplate').value = file?.keyUrl || '';
  }
  toggleKeyMode();
  document.getElementById('keyUrlExample').value = '';
  document.getElementById('keyModal').style.display = 'block';
  setTimeout(() => {
    if (file?.keyMode === 'local') {
      document.getElementById('keyVariableName').focus();
    } else {
      document.getElementById('keyUrlTemplate').focus();
    }
  }, 100);
}

function closeKeyModal() {
  document.getElementById('keyModal').style.display = 'none';
  currentEditingId = null;
}

function confirmAddKeyUrl() {
  const mode = document.querySelector('input[name="keyMode"]:checked').value;
  const file = fileList.find(f => f.id === currentEditingId);
  if (!file) return;
  if (mode === 'link') {
    const keyUrl = document.getElementById('keyUrlTemplate').value.trim();
    if (!keyUrl) {
      if (confirm('é“¾æ¥ä¸ºç©ºï¼Œæ˜¯å¦åˆ é™¤å·²æœ‰çš„å¯†é’¥é…ç½®ï¼Ÿ')) {
        file.keyMode = '';
        file.keyUrl = '';
        file.keyVariable = '';
        saveData();
        renderTable();
        closeKeyModal();
      }
      return;
    }
    if (!keyUrl.startsWith('http://') && !keyUrl.startsWith('https://')) {
      alert('è¯·è¾“å…¥å®Œæ•´çš„URLï¼ˆä»¥http://æˆ–https://å¼€å¤´ï¼‰');
      return;
    }
    file.keyMode = 'link';
    file.keyUrl = keyUrl;
    file.keyVariable = '';
  } else {
    const keyVariable = document.getElementById('keyVariableName').value.trim() || 'API_KEY';
    if (!file.fileContent) {
      alert('æœ¬åœ°å¯†é’¥æ¨¡å¼éœ€è¦å…ˆä¸Šä¼ .jsæ–‡ä»¶ï¼');
      return;
    }
    file.keyMode = 'local';
    file.keyUrl = '';
    file.keyVariable = keyVariable;
  }
  saveData();
  renderTable();
  closeKeyModal();
}

function removeKeyUrl(fileId) {
  const file = fileList.find(f => f.id === fileId);
  if (file) {
    file.keyMode = '';
    file.keyUrl = '';
    file.keyVariable = '';
    saveData();
    renderTable();
  }
}

function openDirectUrlModal(id) {
  currentEditingId = id;
  const file = fileList.find(f => f.id === id);
  document.getElementById('directUrlInput').value = file?.directUrl || '';
  document.getElementById('directUrlModal').style.display = 'block';
  setTimeout(() => {
    document.getElementById('directUrlInput').focus();
  }, 100);
}

function closeDirectUrlModal() {
  document.getElementById('directUrlModal').style.display = 'none';
  currentEditingId = null;
}

function confirmAddDirectUrl() {
  const directUrl = document.getElementById('directUrlInput').value.trim();
  if (!directUrl) {
    if (confirm('é“¾æ¥ä¸ºç©ºï¼Œæ˜¯å¦åˆ é™¤å·²æœ‰çš„åœ¨çº¿é“¾æ¥ï¼Ÿ')) {
      const file = fileList.find(f => f.id === currentEditingId);
      if (file) {
        file.directUrl = '';
        saveData();
        renderTable();
      }
      closeDirectUrlModal();
    }
    return;
  }
  if (!directUrl.startsWith('http://') && !directUrl.startsWith('https://')) {
    alert('è¯·è¾“å…¥å®Œæ•´çš„URLï¼ˆä»¥http://æˆ–https://å¼€å¤´ï¼‰');
    return;
  }
  const file = fileList.find(f => f.id === currentEditingId);
  if (file) {
    file.directUrl = directUrl;
    saveData();
    renderTable();
  }
  closeDirectUrlModal();
}

function removeDirectUrl(fileId) {
  const file = fileList.find(f => f.id === fileId);
  if (file) {
    file.directUrl = '';
    saveData();
    renderTable();
  }
}

function formatFileSize(bytes) {
  if (!bytes || bytes === 0) return '';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return ' (' + Math.round(bytes / Math.pow(k, i) * 100) / 100 + sizes[i] + ')';
}

function renderTable() {
  const tbody = document.getElementById('tableBody');
  if (fileList.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="empty-state">æš‚æ— æ•°æ®ï¼Œç‚¹å‡»ä¸Šæ–¹"æ·»åŠ æ–‡ä»¶"æŒ‰é’®å¼€å§‹</td></tr>';
    return;
  }
  let html = '';
  let displayIndex = 1;
  fileList.forEach((file, index) => {
    const isFiltered = checkFilter(file);
    if (!isFiltered) return;
    const hasFile = file.fileContent ? true : false;
    let linksHtml = '';
    if (file.links && file.links.length > 0) {
      linksHtml = '<div class="links-container">';
      file.links.forEach((link, linkIndex) => {
        linksHtml += '<a href="' + link.url + '" target="_blank" class="link-tag" title="' + link.url + '">';
        linksHtml += '<span class="link-tag-text">ğŸ”— ' + link.text + '</span>';
        linksHtml += '<button class="link-tag-remove" onclick="event.preventDefault(); removeLink(' + file.id + ', ' + linkIndex + ')">Ã—</button>';
        linksHtml += '</a>';
      });
      linksHtml += '</div>';
    }
    let keyUrlHtml = '';
    if (file.keyMode === 'link' && file.keyUrl) {
      keyUrlHtml = '<div class="key-url-display" title="' + file.keyUrl + '">';
      keyUrlHtml += 'ğŸ”‘ åœ¨çº¿å¯†é’¥: ' + file.keyUrl;
      keyUrlHtml += '<span class="remove-key" onclick="removeKeyUrl(' + file.id + ')">Ã—</span>';
      keyUrlHtml += '</div>';
    } else if (file.keyMode === 'local' && file.keyVariable) {
      keyUrlHtml = '<div class="key-url-display" title="æœ¬åœ°å¯†é’¥å¯¼å…¥æ¨¡å¼">';
      keyUrlHtml += 'ğŸ”‘ æœ¬åœ°å¯†é’¥: ' + file.keyVariable;
      keyUrlHtml += '<span class="remove-key" onclick="removeKeyUrl(' + file.id + ')">Ã—</span>';
      keyUrlHtml += '</div>';
    }
    let directUrlHtml = '';
    if (file.directUrl) {
      directUrlHtml = '<div class="direct-url-display" title="' + file.directUrl + '">';
      directUrlHtml += 'ğŸŒ åœ¨çº¿é“¾æ¥: ' + file.directUrl;
      directUrlHtml += '<span class="remove-key" onclick="removeDirectUrl(' + file.id + ')">Ã—</span>';
      directUrlHtml += '</div>';
    }
    html += '<tr>';
    html += '<td><div class="sort-buttons">';
    html += '<button class="sort-btn" onclick="moveUp(' + index + ')" ' + (index === 0 ? 'disabled' : '') + ' title="ä¸Šç§»">â–²</button>';
    html += '<button class="sort-btn" onclick="moveDown(' + index + ')" ' + (index === fileList.length - 1 ? 'disabled' : '') + ' title="ä¸‹ç§»">â–¼</button>';
    html += '</div></td>';
    html += '<td style="text-align: center; font-weight: bold; color: #666;">' + displayIndex + '</td>';
    html += '<td class="file-upload-cell">';
    html += '<div class="file-name"><span class="file-icon">ğŸ“œ</span><div style="flex: 1;">';
    html += '<input type="text" value="' + file.fileName + '" onchange="updateFileName(' + file.id + ', this.value)" placeholder="è¾“å…¥æ–‡ä»¶åæˆ–ä¸Šä¼ æ–‡ä»¶" style="border: ' + (file.fileName ? '1px solid #ddd' : '2px solid #ffc107') + ';">';
    html += hasFile ? '<span class="file-status">âœ… å·²ä¸Šä¼ ' + formatFileSize(file.fileSize) + '</span>' : '<span class="file-status no-file">âš ï¸ æœªä¸Šä¼ </span>';
    html += '</div></div></td>';
    html += '<td><select onchange="updateQuality(' + file.id + ', this.value)" style="width: 100%;">';
    qualityOptions.forEach(q => {
      html += '<option value="' + q + '" ' + (file.quality === q ? 'selected' : '') + '>' + q + '</option>';
    });
    html += '</select></td>';
    html += '<td><div class="checkbox-group">';
    sources.forEach(source => {
      html += '<div class="source-checkbox">';
      html += '<input type="checkbox" id="source-' + file.id + '-' + source + '" ' + (file.unsupportedSources.includes(source) ? 'checked' : '') + ' onchange="updateUnsupportedSources(' + file.id + ', \'' + source + '\', this.checked)">';
      html += '<label for="source-' + file.id + '-' + source + '">' + sourceNames[source] + '</label>';
      html += '</div>';
    });
    html += file.unsupportedSources.length === 0 ? '<span style="color: #28a745; font-size: 11px; font-weight: bold;">âœ“ å…¨æ”¯æŒ</span>' : '';
    html += '</div></td>';
    html += '<td><div class="note-container">';
    html += '<textarea class="note-text" onchange="updateNote(' + file.id + ', this.value)" placeholder="è¾“å…¥å¤‡æ³¨...">' + (file.note || '') + '</textarea>';
    html += '<div>';
    html += '<button class="add-link-btn" onclick="openLinkModal(' + file.id + ')">â• æ·»åŠ é“¾æ¥</button>';
    html += '<button class="add-direct-btn" onclick="openDirectUrlModal(' + file.id + ')">ğŸŒ åœ¨çº¿é“¾æ¥</button>';
    html += '<button class="add-key-btn" onclick="openKeyModal(' + file.id + ')">ğŸ”‘ å¯†é’¥é…ç½®</button>';
    html += '</div>';
    html += linksHtml + directUrlHtml + keyUrlHtml;
    html += '</div></td>';
    html += '<td>';
    html += '<input type="file" id="file-' + file.id + '" class="file-input" accept=".js" onchange="uploadFile(' + file.id + ', event)">';
    html += '<button class="upload-btn" onclick="document.getElementById(\'file-' + file.id + '\').click()">' + (hasFile ? 'ğŸ“¤ é‡ä¼ ' : 'ğŸ“ ä¸Šä¼ ') + '</button>';
    html += hasFile ? '<button class="download-btn" onclick="downloadFile(' + file.id + ')">â¬‡ï¸ ä¸‹è½½</button>' : '';
    html += '<button class="delete-btn" onclick="deleteRow(' + file.id + ')">åˆ é™¤</button>';
    html += '</td>';
    html += '</tr>';
    displayIndex++;
  });
  tbody.innerHTML = html;
}

function checkFilter(file) {
  const searchBox = document.querySelector('.search-box');
  if (searchBox && searchBox.value.trim()) {
    const keyword = searchBox.value.toLowerCase();
    if (!file.fileName.toLowerCase().includes(keyword) && !file.note.toLowerCase().includes(keyword)) {
      return false;
    }
  }
  const activeFilters = sources.filter(source => document.getElementById('filter-' + source)?.checked);
  if (activeFilters.length > 0) {
    const hasMatch = activeFilters.some(source => file.unsupportedSources.includes(source));
    if (!hasMatch) return false;
  }
  return true;
}

function filterTable() {
  renderTable();
}

function clearFilters() {
  sources.forEach(source => {
    const checkbox = document.getElementById('filter-' + source);
    if (checkbox) checkbox.checked = false;
  });
  document.querySelector('.search-box').value = '';
  filterTable();
}

function updateStats() {
  const total = fileList.length;
  const uploaded = fileList.filter(f => f.fileContent).length;
  const flacCount = fileList.filter(f => f.quality === 'flac' || f.quality === 'flac24bit').length;
  const fullSupport = fileList.filter(f => f.unsupportedSources.length === 0).length;
  document.getElementById('totalFiles').textContent = total;
  document.getElementById('uploadedCount').textContent = uploaded;
  document.getElementById('flacCount').textContent = flacCount;
  document.getElementById('fullSupportCount').textContent = fullSupport;
}

function clearAll() {
  if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
    fileList = [];
    saveData();
    renderTable();
  }
}

function exportToJSON() {
  const dataStr = JSON.stringify(fileList, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'éŸ³æºæ•°æ®_' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  URL.revokeObjectURL(url);
}

function importFromJSON(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const imported = JSON.parse(e.target.result);
      if (confirm('ç¡®å®šè¦å¯¼å…¥æ•°æ®å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼')) {
        fileList = imported;
        saveData();
        renderTable();
        alert('å¯¼å…¥æˆåŠŸï¼');
      }
    } catch (err) {
      alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function exportToMarkdown() {
  let md = '# éŸ³æºç®¡ç†æŠ¥å‘Š\n\nç”Ÿæˆæ—¶é—´: ' + new Date().toLocaleString('zh-CN') + '\n\næ€»æ–‡ä»¶æ•°: ' + fileList.length + '\n\n## æ–‡ä»¶åˆ—è¡¨\n\n| åºå· | æ–‡ä»¶å | éŸ³è´¨ | ä¸æ”¯æŒæº | å¤‡æ³¨ |\n|------|--------|------|----------|------|\n';
  fileList.forEach((file, index) => {
    const unsupported = file.unsupportedSources.length > 0 ? file.unsupportedSources.map(s => sourceNames[s]).join(', ') : 'å…¨æ”¯æŒ';
    md += '| ' + (index + 1) + ' | ' + (file.fileName || '(æœªå‘½å)') + ' | ' + file.quality + ' | ' + unsupported + ' | ' + (file.note || '-') + ' |\n';
  });
  const blob = new Blob([md], { type: 'text/markdown' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'éŸ³æºæŠ¥å‘Š_' + new Date().toISOString().slice(0,10) + '.md';
  a.click();
  URL.revokeObjectURL(url);
}

function exportHTMLWithFiles() {
  const filesDataJSON = JSON.stringify(fileList.map(f => ({
    fileName: f.fileName,
    fileContent: f.fileContent,
    quality: f.quality,
    unsupportedSources: f.unsupportedSources,
    note: f.note,
    links: f.links,
    keyMode: f.keyMode,
    keyUrl: f.keyUrl,
    keyVariable: f.keyVariable,
    directUrl: f.directUrl
  })));
  
  const reportHTML = [];
  reportHTML.push('<!DOCTYPE html>');
  reportHTML.push('<html><head><meta charset="UTF-8"><title>éŸ³æºç®¡ç†æŠ¥å‘Š</title>');
  reportHTML.push('<style>body{font-family:Microsoft YaHei,Arial,sans-serif;max-width:1400px;margin:20px auto;padding:20px;background:#f5f5f5}h1{color:#333;border-bottom:3px solid #667eea;padding-bottom:10px}.info-box{background:#e3f2fd;padding:15px;border-radius:8px;margin:20px 0}table{width:100%;border-collapse:collapse;margin:20px 0;background:white;box-shadow:0 2px 8px rgba(0,0,0,0.1)}th{background:#667eea;color:white;padding:12px;text-align:left}td{padding:10px;border-bottom:1px solid #ddd;vertical-align:top}tr:hover{background:#f8f9fa}.download-btn{background:#28a745;color:white;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;font-size:12px;text-decoration:none;display:inline-block;margin:2px}.download-btn:hover{background:#218838}.no-file{color:#999;font-style:italic}.download-all-btn{background:#667eea;color:white;padding:12px 24px;border:none;border-radius:6px;cursor:pointer;font-size:16px;font-weight:bold;margin:10px 0}.download-all-btn:hover{background:#5568d3}.quality{padding:4px 10px;border-radius:12px;font-size:12px;font-weight:bold;display:inline-block}.q-flac{background:#007bff;color:white}.q-flac24bit{background:#6f42c1;color:white}.q-320k{background:#28a745;color:white}.q-128k{background:#ffc107;color:#333}.unsupported{color:#dc3545;font-weight:bold}.supported{color:#28a745;font-weight:bold}.link-tag{display:inline-block;margin:3px;padding:4px 10px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border-radius:15px;font-size:11px;text-decoration:none}.link-tag:hover{opacity:0.8}.key-input-container{margin-top:10px;padding:10px;background:#fff3cd;border-radius:8px;border:2px solid #ffc107}.key-input-container label{display:block;margin-bottom:5px;font-weight:bold;color:#856404}.key-input-group{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.key-input{flex:1;min-width:200px;padding:8px;border:2px solid #ffc107;border-radius:4px;font-size:13px}.key-download-btn{background:#ffc107;color:#333;padding:8px 16px;border:none;border-radius:4px;cursor:pointer;font-size:13px;font-weight:bold}.key-download-btn:hover{background:#e0a800}.local-key-hint{font-size:11px;color:#856404;margin-top:5px}</style>');
  reportHTML.push('</head><body>');
  reportHTML.push('<h1>ğŸµ éŸ³æºç®¡ç†æŠ¥å‘Š</h1>');
  reportHTML.push('<div class="info-box">');
  reportHTML.push('<p><strong>ç”Ÿæˆæ—¶é—´:</strong> ' + new Date().toLocaleString('zh-CN') + '</p>');
  reportHTML.push('<p><strong>æ€»æ–‡ä»¶æ•°:</strong> ' + fileList.length + '</p>');
  reportHTML.push('<p><strong>å·²ä¸Šä¼ æ–‡ä»¶:</strong> ' + fileList.filter(f => f.fileContent).length + '</p>');
  reportHTML.push('<p><strong>åœ¨çº¿é“¾æ¥:</strong> ' + fileList.filter(f => f.directUrl).length + '</p>');
  reportHTML.push('<p><strong>ğŸ’¡ æç¤º:</strong> éƒ¨åˆ†æ–‡ä»¶æ”¯æŒå¯†é’¥ä¸‹è½½ï¼Œè¯·è¾“å…¥æ‚¨çš„å¯†é’¥åç‚¹å‡»ä¸‹è½½</p>');
  reportHTML.push('</div>');
  reportHTML.push('<button class="download-all-btn" onclick="downloadAllFiles()">ğŸ“¦ æ‰“åŒ…ä¸‹è½½æ‰€æœ‰å…è´¹æ–‡ä»¶</button>');
  reportHTML.push('<table><thead><tr><th>åºå·</th><th>æ–‡ä»¶å</th><th>æœ€é«˜éŸ³è´¨</th><th>ä¸æ”¯æŒçš„æº</th><th>å¤‡æ³¨ & é“¾æ¥</th><th>ä¸‹è½½</th></tr></thead><tbody>');
  
  fileList.forEach((file, index) => {
    const unsupported = file.unsupportedSources.length > 0 ? '<span class="unsupported">' + file.unsupportedSources.map(s => sourceNames[s]).join(', ') + '</span>' : '<span class="supported">å…¨æ”¯æŒ</span>';
    const qualityClass = file.quality.includes('flac24') ? 'q-flac24bit' : file.quality === 'flac' ? 'q-flac' : file.quality.includes('320') ? 'q-320k' : 'q-128k';
    let fileAction = '';
    if (file.directUrl) {
      fileAction += '<a href="' + file.directUrl + '" class="download-btn" download>â¬‡ï¸ åœ¨çº¿ä¸‹è½½</a><br>';
    }
    if (file.fileContent) {
      fileAction += '<a class="download-btn" onclick="downloadFile(' + index + ')">â¬‡ï¸ æœ¬åœ°ä¸‹è½½</a><br>';
    }
    if (file.keyMode === 'link' && file.keyUrl) {
      fileAction += '<div class="key-input-container"><label>ğŸ”‘ åœ¨çº¿å¯†é’¥ä¸‹è½½:</label><div class="key-input-group"><input type="text" class="key-input" id="key-' + index + '" placeholder="è¯·è¾“å…¥æ‚¨çš„å¯†é’¥..."><button class="key-download-btn" onclick="downloadWithOnlineKey(' + index + ')">ä¸‹è½½</button></div></div>';
    }
    if (file.keyMode === 'local' && file.keyVariable && file.fileContent) {
      fileAction += '<div class="key-input-container"><label>ğŸ”‘ æœ¬åœ°å¯†é’¥å¯¼å…¥:</label><div class="key-input-group"><input type="text" class="key-input" id="localkey-' + index + '" placeholder="è¯·è¾“å…¥æ‚¨çš„å¯†é’¥..."><button class="key-download-btn" onclick="downloadWithLocalKey(' + index + ')">å¯¼å…¥ä¸‹è½½</button></div><div class="local-key-hint">ğŸ’¡ å°†è‡ªåŠ¨æ›¿æ¢æ–‡ä»¶ä¸­çš„ ' + file.keyVariable + ' å¹¶ç§»é™¤å…¬ç›Šç‰ˆæ ‡è®°</div></div>';
    }
    if (!file.directUrl && !file.fileContent && !file.keyMode) {
      fileAction = '<span class="no-file">æœªé…ç½®ä¸‹è½½</span>';
    }
    let noteAndLinks = (file.note || '-') + '<br>';
    if (file.links && file.links.length > 0) {
      file.links.forEach(link => {
        noteAndLinks += '<a href="' + link.url + '" target="_blank" class="link-tag">ğŸ”— ' + link.text + '</a> ';
      });
    }
    reportHTML.push('<tr><td>' + (index + 1) + '</td><td>' + (file.fileName || '(æœªå‘½å)') + '</td><td><span class="quality ' + qualityClass + '">' + file.quality + '</span></td><td>' + unsupported + '</td><td>' + noteAndLinks + '</td><td>' + fileAction + '</td></tr>');
  });
  
  reportHTML.push('</tbody></table>');
  reportHTML.push('<script>');
  reportHTML.push('var filesData=' + filesDataJSON + ';');
  reportHTML.push('function downloadFile(index){var file=filesData[index];if(!file.fileContent){alert("è¯¥æ–‡ä»¶æœªä¸Šä¼ !");return;}var link=document.createElement("a");link.href=file.fileContent;link.download=file.fileName||"download.js";link.click();}');
  reportHTML.push('function downloadWithOnlineKey(index){var file=filesData[index];var keyInput=document.getElementById("key-"+index);var key=keyInput.value.trim();if(!key){alert("è¯·è¾“å…¥å¯†é’¥ï¼");keyInput.focus();return;}if(!file.keyUrl){alert("è¯¥æ–‡ä»¶æ²¡æœ‰é…ç½®å¯†é’¥é“¾æ¥ï¼");return;}var downloadUrl=file.keyUrl+key;var link=document.createElement("a");link.href=downloadUrl;link.download=file.fileName||"download.js";link.click();alert("å¼€å§‹ä¸‹è½½ï¼Œå¦‚æœæ²¡æœ‰ååº”è¯·æ£€æŸ¥å¯†é’¥æ˜¯å¦æ­£ç¡®ï¼");}');
  
  // ä¿®å¤åçš„æœ¬åœ°å¯†é’¥ä¸‹è½½å‡½æ•°
  reportHTML.push('function downloadWithLocalKey(index){var file=filesData[index];var keyInput=document.getElementById("localkey-"+index);var key=keyInput.value.trim();if(!key){alert("è¯·è¾“å…¥å¯†é’¥ï¼");keyInput.focus();return;}if(!file.fileContent){alert("è¯¥æ–‡ä»¶æœªä¸Šä¼ ï¼");return;}try{var base64Data=file.fileContent.split(",")[1];var binaryString=atob(base64Data);var bytes=new Uint8Array(binaryString.length);for(var i=0;i<binaryString.length;i++){bytes[i]=binaryString.charCodeAt(i);}var decoder=new TextDecoder("utf-8");var decodedData=decoder.decode(bytes);var keyVariable=file.keyVariable||"API_KEY";var regex1=new RegExp("const\\\\s+"+keyVariable+"\\\\s*=\\\\s*\\"\\"","g");var regex2=new RegExp("const\\\\s+"+keyVariable+"\\\\s*=\\\\s*\\\'\\\'","g");decodedData=decodedData.replace(regex1,"const "+keyVariable+" = \\""+key+"\\"");decodedData=decodedData.replace(regex2,"const "+keyVariable+" = \\\'"+key+"\\\'");decodedData=decodedData.replace(/\\(å…¬ç›Šç‰ˆ\\)/g,"");decodedData=decodedData.replace(/\\(å…è´¹ç‰ˆ\\)/g,"");decodedData=decodedData.replace(/ï¼ˆå…¬ç›Šç‰ˆï¼‰/g,"");decodedData=decodedData.replace(/ï¼ˆå…è´¹ç‰ˆï¼‰/g,"");var blob=new Blob([decodedData],{type:"text/javascript;charset=utf-8"});var url=URL.createObjectURL(blob);var link=document.createElement("a");link.href=url;link.download=file.fileName||"download.js";link.click();URL.revokeObjectURL(url);alert("å¯†é’¥å·²å¯¼å…¥ï¼Œå¼€å§‹ä¸‹è½½ï¼");}catch(e){alert("å¤„ç†å¤±è´¥ï¼š"+e.message);}}');
  
  reportHTML.push('function downloadAllFiles(){var validFiles=filesData.filter(function(f){return f.fileContent||f.directUrl;});if(validFiles.length===0){alert("æ²¡æœ‰å¯ä¸‹è½½çš„å…è´¹æ–‡ä»¶!");return;}if(!confirm("å°†ä¸‹è½½ "+validFiles.length+" ä¸ªæ–‡ä»¶ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ")){return;}validFiles.forEach(function(file,index){setTimeout(function(){if(file.directUrl){var link=document.createElement("a");link.href=file.directUrl;link.download=file.fileName||"file_"+index+".js";link.click();}else if(file.fileContent){var link=document.createElement("a");link.href=file.fileContent;link.download=file.fileName||"file_"+index+".js";link.click();}},index*500);});alert("å¼€å§‹ä¸‹è½½ "+validFiles.length+" ä¸ªæ–‡ä»¶...");}');
  reportHTML.push('<\/script>');
  reportHTML.push('</body></html>');
  
  const htmlBlob = new Blob([reportHTML.join('')], { type: 'text/html;charset=utf-8' });
  const url = URL.createObjectURL(htmlBlob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'éŸ³æºå®Œæ•´æŠ¥å‘Š_' + new Date().toISOString().slice(0,10) + '.html';
  a.click();
  URL.revokeObjectURL(url);
  alert('å¯¼å‡ºæˆåŠŸï¼\n\nğŸŒ åœ¨çº¿é“¾æ¥ï¼šå¯ç›´æ¥ä¸‹è½½\nğŸ“¦ æœ¬åœ°æ–‡ä»¶ï¼šå¯ç›´æ¥ä¸‹è½½\nğŸ”‘ åœ¨çº¿å¯†é’¥ï¼šç”¨æˆ·è¾“å…¥å¯†é’¥ä»URLä¸‹è½½\nğŸ”‘ æœ¬åœ°å¯†é’¥ï¼šç”¨æˆ·è¾“å…¥å¯†é’¥è‡ªåŠ¨æ›¿æ¢æ–‡ä»¶å†…å®¹');
}

function downloadAllFiles() {
  const validFiles = fileList.filter(f => f.fileContent);
  if (validFiles.length === 0) {
    alert('æ²¡æœ‰å·²ä¸Šä¼ çš„æ–‡ä»¶ï¼');
    return;
  }
  if (!confirm('å°†ä¸‹è½½ ' + validFiles.length + ' ä¸ªæ–‡ä»¶ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
    return;
  }
  validFiles.forEach((file, index) => {
    setTimeout(() => {
      const link = document.createElement('a');
      link.href = file.fileContent;
      link.download = file.fileName || 'file_' + index + '.js';
      link.click();
    }, index * 500);
  });
  alert('å¼€å§‹ä¸‹è½½ ' + validFiles.length + ' ä¸ªæ–‡ä»¶...');
}

window.onload = function() {
  loadData();
  if (fileList.length === 0) {
    fileList = [{
      id: Date.now(),
      fileName: 'example.js',
      quality: '320k',
      unsupportedSources: [],
      note: 'è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æ–‡ä»¶',
      links: [],
      keyMode: '',
      keyUrl: '',
      keyVariable: '',
      directUrl: '',
      fileContent: null,
      fileSize: 0,
      addedTime: new Date().toLocaleString('zh-CN')
    }];
    saveData();
    renderTable();
  }
  const keyUrlTemplate = document.getElementById('keyUrlTemplate');
  if (keyUrlTemplate) {
    keyUrlTemplate.addEventListener('input', function() {
      const template = this.value.trim();
      const exampleInput = document.getElementById('keyUrlExample');
      if (template && exampleInput) {
        exampleInput.value = template + '123-456-789-abcd-efgh';
      } else if (exampleInput) {
        exampleInput.value = '';
      }
    });
  }
  window.onclick = function(event) {
    const linkModal = document.getElementById('linkModal');
    const keyModal = document.getElementById('keyModal');
    const directUrlModal = document.getElementById('directUrlModal');
    if (event.target === linkModal) {
      closeLinkModal();
    }
    if (event.target === keyModal) {
      closeKeyModal();
    }
    if (event.target === directUrlModal) {
      closeDirectUrlModal();
    }
  };
};
</script>
</body>
</html>