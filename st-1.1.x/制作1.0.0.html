<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>éŸ³æºç®¡ç†ç³»ç»Ÿ - å®Œæ•´ç‰ˆ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 1900px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 { 
      color: #333; 
      margin-bottom: 10px;
      text-align: center;
    }
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 25px;
      font-size: 14px;
    }
    
    .toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s;
    }
    .btn-primary { background: #667eea; color: white; }
    .btn-primary:hover { background: #5568d3; }
    .btn-success { background: #28a745; color: white; }
    .btn-success:hover { background: #218838; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-danger:hover { background: #c82333; }
    .btn-info { background: #17a2b8; color: white; }
    .btn-info:hover { background: #138496; }
    .btn-warning { background: #ffc107; color: #333; }
    .btn-warning:hover { background: #e0a800; }
    
    .filter-bar {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px;
      background: #fff3cd;
      border-radius: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-bar label {
      font-weight: bold;
      margin-right: 5px;
    }
    .filter-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      background: white;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .checkbox-label:hover {
      background: #e3f2fd;
    }
    .checkbox-label input {
      cursor: pointer;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-card {
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 10px;
      text-align: center;
    }
    .stat-number {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .stat-label {
      font-size: 13px;
      opacity: 0.9;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      background: white;
    }
    thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    th {
      padding: 15px 10px;
      text-align: left;
      font-weight: bold;
      white-space: nowrap;
    }
    td {
      padding: 12px 10px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }
    tr:hover {
      background: #f8f9fa;
    }
    
    .file-name {
      font-weight: 500;
      color: #667eea;
      font-family: 'Consolas', monospace;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .file-icon {
      font-size: 18px;
    }
    .file-status {
      font-size: 11px;
      color: #28a745;
      margin-left: 5px;
    }
    .no-file {
      color: #dc3545;
    }
    
    input[type="text"], select, textarea {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      width: 100%;
      font-family: inherit;
    }
    
    textarea {
      min-height: 60px;
      resize: vertical;
    }
    
    .delete-btn, .download-btn, .sort-btn {
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin: 2px;
    }
    .delete-btn {
      background: #dc3545;
    }
    .delete-btn:hover {
      background: #c82333;
    }
    .download-btn {
      background: #28a745;
    }
    .download-btn:hover {
      background: #218838;
    }
    .sort-btn {
      background: #6c757d;
      padding: 4px 8px;
      font-size: 16px;
      line-height: 1;
    }
    .sort-btn:hover {
      background: #5a6268;
    }
    .sort-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .add-row-btn {
      width: 100%;
      padding: 15px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      margin-top: 20px;
      transition: all 0.3s;
    }
    .add-row-btn:hover {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
      font-size: 16px;
    }
    
    .checkbox-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .source-checkbox {
      display: flex;
      align-items: center;
      gap: 3px;
    }
    .source-checkbox input {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }
    .source-checkbox label {
      font-size: 12px;
      cursor: pointer;
      user-select: none;
    }
    
    .search-box {
      padding: 10px 15px;
      border: 2px solid #667eea;
      border-radius: 5px;
      font-size: 14px;
      width: 300px;
    }

    .file-upload-cell {
      position: relative;
    }
    .upload-btn {
      background: #17a2b8;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      border: none;
      display: inline-block;
    }
    .upload-btn:hover {
      background: #138496;
    }
    .file-input {
      display: none;
    }

    /* é“¾æ¥ç›¸å…³æ ·å¼ */
    .note-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .note-text {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      width: 100%;
      min-height: 40px;
    }
    
    .links-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 5px;
    }
    
    .link-tag {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px;
      font-size: 12px;
      text-decoration: none;
      transition: all 0.3s;
      max-width: 200px;
    }
    
    .link-tag:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }
    
    .link-tag-text {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .link-tag-remove {
      background: rgba(255,255,255,0.3);
      border: none;
      color: white;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      font-size: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      flex-shrink: 0;
    }
    
    .link-tag-remove:hover {
      background: rgba(255,255,255,0.5);
    }
    
    .add-link-btn, .add-key-btn, .add-direct-btn {
      background: #17a2b8;
      color: white;
      border: none;
      padding: 5px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      align-self: flex-start;
      margin-right: 5px;
    }
    
    .add-link-btn:hover, .add-key-btn:hover, .add-direct-btn:hover {
      background: #138496;
    }

    .add-key-btn {
      background: #ffc107;
      color: #333;
    }
    
    .add-key-btn:hover {
      background: #e0a800;
    }

    .add-direct-btn {
      background: #28a745;
      color: white;
    }

    .add-direct-btn:hover {
      background: #218838;
    }

    .key-url-display {
      display: inline-block;
      padding: 4px 10px;
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 15px;
      font-size: 11px;
      color: #856404;
      margin-top: 5px;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .direct-url-display {
      display: inline-block;
      padding: 4px 10px;
      background: #d4edda;
      border: 1px solid #28a745;
      border-radius: 15px;
      font-size: 11px;
      color: #155724;
      margin-top: 5px;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .key-url-display .remove-key, .direct-url-display .remove-key {
      margin-left: 8px;
      cursor: pointer;
      color: #dc3545;
      font-weight: bold;
    }

    .key-url-display .remove-key:hover, .direct-url-display .remove-key:hover {
      color: #c82333;
    }

    /* æ’åºæŒ‰é’®ç»„ */
    .sort-buttons {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    /* å¼¹çª—æ ·å¼ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      animation: slideIn 0.3s;
    }
    
    @keyframes slideIn {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #667eea;
    }
    
    .modal-header h2 {
      color: #333;
      margin: 0;
    }
    
    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }
    
    .close:hover {
      color: #000;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }
    
    .form-group input {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group small {
      display: block;
      margin-top: 5px;
      color: #666;
      font-size: 12px;
    }
    
    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 25px;
    }
    
    .btn-modal {
      padding: 10px 25px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .btn-modal-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-modal-primary:hover {
      background: #5568d3;
    }
    
    .btn-modal-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-modal-secondary:hover {
      background: #5a6268;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>ğŸµ éŸ³æºç®¡ç†ç³»ç»Ÿï¼ˆå®Œæ•´ç‰ˆï¼‰</h1>
  <p class="subtitle">âœ¨ æ”¯æŒä¸Šä¼ .jsæ–‡ä»¶ | æ”¯æŒåœ¨çº¿é“¾æ¥ | æ”¯æŒå¯†é’¥ä¸‹è½½ | å¤‡æ³¨æ”¯æŒå¤šé“¾æ¥ | æ‰‹åŠ¨æ’åº</p>
  
  <!-- å·¥å…·æ  -->
  <div class="toolbar">
    <button class="btn btn-success" onclick="addNewRow()">â• æ·»åŠ æ–‡ä»¶</button>
    <button class="btn btn-primary" onclick="exportToJSON()">ğŸ’¾ å¯¼å‡ºæ•°æ®</button>
    <button class="btn btn-warning" onclick="exportHTMLWithFiles()">ğŸ“¦ å¯¼å‡ºå®Œæ•´æŠ¥å‘Š(å«æ–‡ä»¶)</button>
    <button class="btn btn-info" onclick="exportToMarkdown()">ğŸ“ å¯¼å‡ºMarkdown</button>
    <button class="btn btn-success" onclick="downloadAllFiles()">â¬‡ï¸ æ‰“åŒ…ä¸‹è½½æ‰€æœ‰æ–‡ä»¶</button>
    <input type="file" id="importJSON" style="display:none" accept=".json" onchange="importFromJSON(event)">
    <button class="btn btn-primary" onclick="document.getElementById('importJSON').click()">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
    <button class="btn btn-danger" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
    <input type="text" class="search-box" placeholder="ğŸ” æœç´¢æ–‡ä»¶å..." oninput="filterTable()">
  </div>
  
  <!-- ç­›é€‰æ  -->
  <div class="filter-bar">
    <div class="filter-group">
      <label>ğŸ” ç­›é€‰ä¸æ”¯æŒçš„æºï¼š</label>
      <label class="checkbox-label">
        <input type="checkbox" onchange="filterTable()" id="filter-kw"> é…·æˆ‘(KW)
      </label>
      <label class="checkbox-label">
        <input type="checkbox" onchange="filterTable()" id="filter-kg"> é…·ç‹—(KG)
      </label>
      <label class="checkbox-label">
        <input type="checkbox" onchange="filterTable()" id="filter-tx"> è…¾è®¯(TX)
      </label>
      <label class="checkbox-label">
        <input type="checkbox" onchange="filterTable()" id="filter-wy"> ç½‘æ˜“(WY)
      </label>
      <label class="checkbox-label">
        <input type="checkbox" onchange="filterTable()" id="filter-mg"> å’ªå’•(MG)
      </label>
      <button class="btn btn-info" onclick="clearFilters()">æ¸…é™¤ç­›é€‰</button>
    </div>
  </div>
  
  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <div class="stats">
    <div class="stat-card">
      <div class="stat-number" id="totalFiles">0</div>
      <div class="stat-label">æ€»æ–‡ä»¶æ•°</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="uploadedCount">0</div>
      <div class="stat-label">å·²ä¸Šä¼ æ–‡ä»¶</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="flacCount">0</div>
      <div class="stat-label">FLAC/FLAC24éŸ³è´¨</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="fullSupportCount">0</div>
      <div class="stat-label">å…¨å¹³å°æ”¯æŒ</div>
    </div>
  </div>
  
  <!-- ä¸»è¡¨æ ¼ -->
  <div style="overflow-x: auto;">
    <table id="mainTable">
      <thead>
        <tr>
          <th width="80">æ’åº</th>
          <th width="60">åºå·</th>
          <th width="250">æ–‡ä»¶å</th>
          <th width="120">æœ€é«˜éŸ³è´¨</th>
          <th width="300">ä¸æ”¯æŒçš„æº</th>
          <th width="350">å¤‡æ³¨ & é“¾æ¥</th>
          <th width="150">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
      </tbody>
    </table>
  </div>
  
  <button class="add-row-btn" onclick="addNewRow()">â• æ·»åŠ æ–°æ–‡ä»¶</button>
  
</div>

<!-- æ·»åŠ é“¾æ¥å¼¹çª— -->
<div id="linkModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ğŸ”— æ·»åŠ é“¾æ¥</h2>
      <span class="close" onclick="closeLinkModal()">&times;</span>
    </div>
    <div class="form-group">
      <label>é“¾æ¥æ–‡å­—ï¼š</label>
      <input type="text" id="linkText" placeholder="ä¾‹å¦‚: å®˜æ–¹æ–‡æ¡£">
    </div>
    <div class="form-group">
      <label>é“¾æ¥åœ°å€ï¼š</label>
      <input type="text" id="linkUrl" placeholder="ä¾‹å¦‚: https://example.com">
    </div>
    <div class="modal-footer">
      <button class="btn-modal btn-modal-secondary" onclick="closeLinkModal()">å–æ¶ˆ</button>
      <button class="btn-modal btn-modal-primary" onclick="confirmAddLink()">ç¡®å®š</button>
    </div>
  </div>
</div>

<!-- æ·»åŠ å¯†é’¥é“¾æ¥å¼¹çª— -->
<div id="keyModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ğŸ”‘ æ·»åŠ å¯†é’¥é“¾æ¥</h2>
      <span class="close" onclick="closeKeyModal()">&times;</span>
    </div>
    <div class="form-group">
      <label>å¯†é’¥é“¾æ¥æ¨¡æ¿ï¼š</label>
      <input type="text" id="keyUrlTemplate" placeholder="ä¾‹å¦‚: https://api.ikunshare.com/script?key=">
      <small>ğŸ’¡ é“¾æ¥æœ«å°¾ä¸éœ€è¦åŠ å¯†é’¥ï¼Œç”¨æˆ·åœ¨æŠ¥å‘Šä¸­è¾“å…¥å¯†é’¥åä¼šè‡ªåŠ¨æ‹¼æ¥</small>
    </div>
    <div class="form-group">
      <label>ç¤ºä¾‹å®Œæ•´é“¾æ¥ï¼š</label>
      <input type="text" id="keyUrlExample" placeholder="ä¾‹å¦‚: https://api.ikunshare.com/script?key=123-456-789" readonly style="background: #f8f9fa;">
      <small>ğŸ“Œ è¿™åªæ˜¯ç¤ºä¾‹ï¼Œå®é™…ä½¿ç”¨æ—¶ç”¨æˆ·ä¼šè¾“å…¥è‡ªå·±çš„å¯†é’¥</small>
    </div>
    <div class="modal-footer">
      <button class="btn-modal btn-modal-secondary" onclick="closeKeyModal()">å–æ¶ˆ</button>
      <button class="btn-modal btn-modal-primary" onclick="confirmAddKeyUrl()">ç¡®å®š</button>
    </div>
  </div>
</div>

<!-- æ·»åŠ å…è´¹åœ¨çº¿é“¾æ¥å¼¹çª— -->
<div id="directUrlModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ğŸŒ æ·»åŠ å…è´¹åœ¨çº¿é“¾æ¥</h2>
      <span class="close" onclick="closeDirectUrlModal()">&times;</span>
    </div>
    <div class="form-group">
      <label>åœ¨çº¿ä¸‹è½½é“¾æ¥ï¼š</label>
      <input type="text" id="directUrlInput" placeholder="ä¾‹å¦‚: https://cdn.example.com/music.js">
      <small>ğŸ’¡ ç”¨æˆ·ç‚¹å‡»ä¸‹è½½æ—¶å°†ç›´æ¥è®¿é—®æ­¤é“¾æ¥</small>
    </div>
    <div class="form-group">
      <label>ç¤ºä¾‹ï¼š</label>
      <input type="text" value="https://cdn.jsdelivr.net/gh/user/repo/file.js" readonly style="background: #f8f9fa;">
      <small>ğŸ“Œ æ”¯æŒ GitHubã€CDNã€ç›´é“¾ç­‰ä»»ä½•å¯è®¿é—®çš„URL</small>
    </div>
    <div class="modal-footer">
      <button class="btn-modal btn-modal-secondary" onclick="closeDirectUrlModal()">å–æ¶ˆ</button>
      <button class="btn-modal btn-modal-primary" onclick="confirmAddDirectUrl()">ç¡®å®š</button>
    </div>
  </div>
</div>

<script>
// æ•°æ®å­˜å‚¨
let fileList = [];
let currentEditingId = null;

// éŸ³è´¨é€‰é¡¹
const qualityOptions = ['128k', '192k', '230k', '320k', 'flac', 'flac24bit', 'æ‰©å±•éŸ³è´¨', 'å…¶ä»–'];

// æºå¹³å°
const sources = ['kw', 'kg', 'tx', 'wy', 'mg'];
const sourceNames = {
  'kw': 'é…·æˆ‘',
  'kg': 'é…·ç‹—',
  'tx': 'è…¾è®¯',
  'wy': 'ç½‘æ˜“',
  'mg': 'å’ªå’•'
};

// ä»localStorageåŠ è½½æ•°æ®
function loadData() {
  const saved = localStorage.getItem('musicQualityData');
  if (saved) {
    try {
      fileList = JSON.parse(saved);
      renderTable();
      updateStats();
    } catch (e) {
      console.error('åŠ è½½æ•°æ®å¤±è´¥:', e);
      fileList = [];
    }
  }
}

// ä¿å­˜æ•°æ®åˆ°localStorage
function saveData() {
  try {
    localStorage.setItem('musicQualityData', JSON.stringify(fileList));
    updateStats();
  } catch (e) {
    console.error('ä¿å­˜æ•°æ®å¤±è´¥:', e);
    alert('ä¿å­˜å¤±è´¥ï¼Œæ•°æ®å¯èƒ½è¿‡å¤§ï¼');
  }
}

// æ·»åŠ æ–°è¡Œï¼ˆæ·»åŠ åˆ°åº•éƒ¨ï¼‰
function addNewRow() {
  const newFile = {
    id: Date.now(),
    fileName: '',
    quality: '320k',
    unsupportedSources: [],
    note: '',
    links: [],
    keyUrl: '',
    directUrl: '',
    fileContent: null,
    fileSize: 0,
    addedTime: new Date().toLocaleString('zh-CN')
  };
  
  fileList.push(newFile);
  saveData();
  renderTable();
  
  setTimeout(() => {
    const lastInput = document.querySelector('#tableBody tr:last-child input[type="text"]');
    if (lastInput) {
      lastInput.focus();
      lastInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }, 100);
}

// ä¸Šç§»
function moveUp(index) {
  if (index > 0) {
    [fileList[index], fileList[index - 1]] = [fileList[index - 1], fileList[index]];
    saveData();
    renderTable();
  }
}

// ä¸‹ç§»
function moveDown(index) {
  if (index < fileList.length - 1) {
    [fileList[index], fileList[index + 1]] = [fileList[index + 1], fileList[index]];
    saveData();
    renderTable();
  }
}

// ä¸Šä¼ æ–‡ä»¶
function uploadFile(id, event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (!file.name.endsWith('.js')) {
    alert('åªå…è®¸ä¸Šä¼ .jsæ–‡ä»¶ï¼');
    event.target.value = '';
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const fileObj = fileList.find(f => f.id === id);
    if (fileObj) {
      fileObj.fileContent = e.target.result;
      fileObj.fileName = file.name;
      fileObj.fileSize = file.size;
      saveData();
      renderTable();
    }
  };
  reader.readAsDataURL(file);
}

// ä¸‹è½½å•ä¸ªæ–‡ä»¶
function downloadFile(id) {
  const file = fileList.find(f => f.id === id);
  if (!file || !file.fileContent) {
    alert('è¯¥æ–‡ä»¶æœªä¸Šä¼ ï¼');
    return;
  }
  
  const link = document.createElement('a');
  link.href = file.fileContent;
  link.download = file.fileName || 'download.js';
  link.click();
}

// åˆ é™¤è¡Œ
function deleteRow(id) {
  if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
    fileList = fileList.filter(file => file.id !== id);
    saveData();
    renderTable();
  }
}

// æ›´æ–°æ–‡ä»¶å
function updateFileName(id, value) {
  const file = fileList.find(f => f.id === id);
  if (file) {
    file.fileName = value;
    saveData();
  }
}

// æ›´æ–°éŸ³è´¨
function updateQuality(id, value) {
  const file = fileList.find(f => f.id === id);
  if (file) {
    file.quality = value;
    saveData();
    renderTable();
  }
}

// æ›´æ–°ä¸æ”¯æŒçš„æº
function updateUnsupportedSources(id, source, checked) {
  const file = fileList.find(f => f.id === id);
  if (file) {
    if (checked) {
      if (!file.unsupportedSources.includes(source)) {
        file.unsupportedSources.push(source);
      }
    } else {
      file.unsupportedSources = file.unsupportedSources.filter(s => s !== source);
    }
    saveData();
    renderTable();
  }
}

// æ›´æ–°å¤‡æ³¨æ–‡å­—
function updateNote(id, value) {
  const file = fileList.find(f => f.id === id);
  if (file) {
    file.note = value;
    saveData();
  }
}

// æ‰“å¼€æ·»åŠ é“¾æ¥å¼¹çª—
function openLinkModal(id) {
  currentEditingId = id;
  document.getElementById('linkText').value = '';
  document.getElementById('linkUrl').value = '';
  document.getElementById('linkModal').style.display = 'block';
  setTimeout(() => {
    document.getElementById('linkText').focus();
  }, 100);
}

// å…³é—­é“¾æ¥å¼¹çª—
function closeLinkModal() {
  document.getElementById('linkModal').style.display = 'none';
  currentEditingId = null;
}

// ç¡®è®¤æ·»åŠ é“¾æ¥
function confirmAddLink() {
  const text = document.getElementById('linkText').value.trim();
  const url = document.getElementById('linkUrl').value.trim();
  
  if (!text) {
    alert('è¯·è¾“å…¥é“¾æ¥æ–‡å­—ï¼');
    return;
  }
  
  if (!url) {
    alert('è¯·è¾“å…¥é“¾æ¥åœ°å€ï¼');
    return;
  }
  
  let finalUrl = url;
  if (!url.startsWith('http://') && !url.startsWith('https://')) {
    finalUrl = 'https://' + url;
  }
  
  const file = fileList.find(f => f.id === currentEditingId);
  if (file) {
    if (!file.links) {
      file.links = [];
    }
    file.links.push({
      text: text,
      url: finalUrl
    });
    saveData();
    renderTable();
  }
  
  closeLinkModal();
}

// åˆ é™¤é“¾æ¥
function removeLink(fileId, linkIndex) {
  const file = fileList.find(f => f.id === fileId);
  if (file && file.links) {
    file.links.splice(linkIndex, 1);
    saveData();
    renderTable();
  }
}

// æ‰“å¼€æ·»åŠ å¯†é’¥é“¾æ¥å¼¹çª—
function openKeyModal(id) {
  currentEditingId = id;
  const file = fileList.find(f => f.id === id);
  document.getElementById('keyUrlTemplate').value = file?.keyUrl || '';
  document.getElementById('keyUrlExample').value = '';
  document.getElementById('keyModal').style.display = 'block';
  setTimeout(() => {
    document.getElementById('keyUrlTemplate').focus();
  }, 100);
}

// å…³é—­å¯†é’¥é“¾æ¥å¼¹çª—
function closeKeyModal() {
  document.getElementById('keyModal').style.display = 'none';
  currentEditingId = null;
}

// ç¡®è®¤æ·»åŠ å¯†é’¥é“¾æ¥
function confirmAddKeyUrl() {
  const keyUrl = document.getElementById('keyUrlTemplate').value.trim();
  
  if (!keyUrl) {
    if (confirm('é“¾æ¥ä¸ºç©ºï¼Œæ˜¯å¦åˆ é™¤å·²æœ‰çš„å¯†é’¥é“¾æ¥ï¼Ÿ')) {
      const file = fileList.find(f => f.id === currentEditingId);
      if (file) {
        file.keyUrl = '';
        saveData();
        renderTable();
      }
      closeKeyModal();
    }
    return;
  }
  
  if (!keyUrl.startsWith('http://') && !keyUrl.startsWith('https://')) {
    alert('è¯·è¾“å…¥å®Œæ•´çš„URLï¼ˆä»¥http://æˆ–https://å¼€å¤´ï¼‰');
    return;
  }
  
  const file = fileList.find(f => f.id === currentEditingId);
  if (file) {
    file.keyUrl = keyUrl;
    saveData();
    renderTable();
  }
  
  closeKeyModal();
}

// åˆ é™¤å¯†é’¥é“¾æ¥
function removeKeyUrl(fileId) {
  const file = fileList.find(f => f.id === fileId);
  if (file) {
    file.keyUrl = '';
    saveData();
    renderTable();
  }
}

// æ‰“å¼€æ·»åŠ ç›´é“¾å¼¹çª—
function openDirectUrlModal(id) {
  currentEditingId = id;
  const file = fileList.find(f => f.id === id);
  document.getElementById('directUrlInput').value = file?.directUrl || '';
  document.getElementById('directUrlModal').style.display = 'block';
  setTimeout(() => {
    document.getElementById('directUrlInput').focus();
  }, 100);
}

// å…³é—­ç›´é“¾å¼¹çª—
function closeDirectUrlModal() {
  document.getElementById('directUrlModal').style.display = 'none';
  currentEditingId = null;
}

// ç¡®è®¤æ·»åŠ ç›´é“¾
function confirmAddDirectUrl() {
  const directUrl = document.getElementById('directUrlInput').value.trim();
  
  if (!directUrl) {
    if (confirm('é“¾æ¥ä¸ºç©ºï¼Œæ˜¯å¦åˆ é™¤å·²æœ‰çš„åœ¨çº¿é“¾æ¥ï¼Ÿ')) {
      const file = fileList.find(f => f.id === currentEditingId);
      if (file) {
        file.directUrl = '';
        saveData();
        renderTable();
      }
      closeDirectUrlModal();
    }
    return;
  }
  
  if (!directUrl.startsWith('http://') && !directUrl.startsWith('https://')) {
    alert('è¯·è¾“å…¥å®Œæ•´çš„URLï¼ˆä»¥http://æˆ–https://å¼€å¤´ï¼‰');
    return;
  }
  
  const file = fileList.find(f => f.id === currentEditingId);
  if (file) {
    file.directUrl = directUrl;
    saveData();
    renderTable();
  }
  
  closeDirectUrlModal();
}

// åˆ é™¤ç›´é“¾
function removeDirectUrl(fileId) {
  const file = fileList.find(f => f.id === fileId);
  if (file) {
    file.directUrl = '';
    saveData();
    renderTable();
  }
}

// ç›‘å¬å¯†é’¥æ¨¡æ¿è¾“å…¥
document.addEventListener('input', function(e) {
  if (e.target.id === 'keyUrlTemplate') {
    const template = e.target.value.trim();
    const exampleInput = document.getElementById('keyUrlExample');
    if (template && exampleInput) {
      exampleInput.value = template + '123-456-789-abcd-efgh';
    } else if (exampleInput) {
      exampleInput.value = '';
    }
  }
});

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
function formatFileSize(bytes) {
  if (!bytes || bytes === 0) return '';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return ' (' + Math.round(bytes / Math.pow(k, i) * 100) / 100 + sizes[i] + ')';
}

// æ¸²æŸ“è¡¨æ ¼
function renderTable() {
  const tbody = document.getElementById('tableBody');
  
  if (fileList.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="empty-state">æš‚æ— æ•°æ®ï¼Œç‚¹å‡»ä¸Šæ–¹"æ·»åŠ æ–‡ä»¶"æŒ‰é’®å¼€å§‹</td></tr>';
    return;
  }
  
  let html = '';
  let displayIndex = 1;
  
  fileList.forEach((file, index) => {
    const isFiltered = checkFilter(file);
    if (!isFiltered) return;
    
    const hasFile = file.fileContent ? true : false;
    
    // æ¸²æŸ“é“¾æ¥æ ‡ç­¾
    let linksHtml = '';
    if (file.links && file.links.length > 0) {
      linksHtml = '<div class="links-container">';
      file.links.forEach((link, linkIndex) => {
        linksHtml += `
          <a href="${link.url}" target="_blank" class="link-tag" title="${link.url}">
            <span class="link-tag-text">ğŸ”— ${link.text}</span>
            <button class="link-tag-remove" onclick="event.preventDefault(); removeLink(${file.id}, ${linkIndex})">Ã—</button>
          </a>
        `;
      });
      linksHtml += '</div>';
    }

    // æ¸²æŸ“å¯†é’¥é“¾æ¥
    let keyUrlHtml = '';
    if (file.keyUrl) {
      keyUrlHtml = `
        <div class="key-url-display" title="${file.keyUrl}">
          ğŸ”‘ å¯†é’¥é“¾æ¥: ${file.keyUrl}
          <span class="remove-key" onclick="removeKeyUrl(${file.id})">Ã—</span>
        </div>
      `;
    }

    // æ¸²æŸ“å…è´¹ç›´é“¾
    let directUrlHtml = '';
    if (file.directUrl) {
      directUrlHtml = `
        <div class="direct-url-display" title="${file.directUrl}">
          ğŸŒ åœ¨çº¿é“¾æ¥: ${file.directUrl}
          <span class="remove-key" onclick="removeDirectUrl(${file.id})">Ã—</span>
        </div>
      `;
    }
    
    html += `
      <tr>
        <td>
          <div class="sort-buttons">
            <button class="sort-btn" onclick="moveUp(${index})" ${index === 0 ? 'disabled' : ''} title="ä¸Šç§»">â–²</button>
            <button class="sort-btn" onclick="moveDown(${index})" ${index === fileList.length - 1 ? 'disabled' : ''} title="ä¸‹ç§»">â–¼</button>
          </div>
        </td>
        <td style="text-align: center; font-weight: bold; color: #666;">${displayIndex}</td>
        <td class="file-upload-cell">
          <div class="file-name">
            <span class="file-icon">ğŸ“œ</span>
            <div style="flex: 1;">
              <input type="text" 
                     value="${file.fileName}" 
                     onchange="updateFileName(${file.id}, this.value)"
                     placeholder="è¾“å…¥æ–‡ä»¶åæˆ–ä¸Šä¼ æ–‡ä»¶"
                     style="border: ${file.fileName ? '1px solid #ddd' : '2px solid #ffc107'};">
              ${hasFile ? `<span class="file-status">âœ… å·²ä¸Šä¼ ${formatFileSize(file.fileSize)}</span>` : '<span class="file-status no-file">âš ï¸ æœªä¸Šä¼ </span>'}
            </div>
          </div>
        </td>
        <td>
          <select onchange="updateQuality(${file.id}, this.value)" style="width: 100%;">
            ${qualityOptions.map(q => `
              <option value="${q}" ${file.quality === q ? 'selected' : ''}>${q}</option>
            `).join('')}
          </select>
        </td>
        <td>
          <div class="checkbox-group">
            ${sources.map(source => `
              <div class="source-checkbox">
                <input type="checkbox" 
                       id="source-${file.id}-${source}"
                       ${file.unsupportedSources.includes(source) ? 'checked' : ''}
                       onchange="updateUnsupportedSources(${file.id}, '${source}', this.checked)">
                <label for="source-${file.id}-${source}">${sourceNames[source]}</label>
              </div>
            `).join('')}
            ${file.unsupportedSources.length === 0 ? '<span style="color: #28a745; font-size: 11px; font-weight: bold;">âœ“ å…¨æ”¯æŒ</span>' : ''}
          </div>
        </td>
        <td>
          <div class="note-container">
            <textarea 
              class="note-text"
              onchange="updateNote(${file.id}, this.value)"
              placeholder="è¾“å…¥å¤‡æ³¨...">${file.note || ''}</textarea>
            <div>
              <button class="add-link-btn" onclick="openLinkModal(${file.id})">â• æ·»åŠ é“¾æ¥</button>
              <button class="add-direct-btn" onclick="openDirectUrlModal(${file.id})">ğŸŒ åœ¨çº¿é“¾æ¥</button>
              <button class="add-key-btn" onclick="openKeyModal(${file.id})">ğŸ”‘ å¯†é’¥é“¾æ¥</button>
            </div>
            ${linksHtml}
            ${directUrlHtml}
            ${keyUrlHtml}
          </div>
        </td>
        <td>
          <input type="file" id="file-${file.id}" class="file-input" accept=".js" onchange="uploadFile(${file.id}, event)">
          <button class="upload-btn" onclick="document.getElementById('file-${file.id}').click()">
            ${hasFile ? 'ğŸ“¤ é‡ä¼ ' : 'ğŸ“ ä¸Šä¼ '}
          </button>
          ${hasFile ? `<button class="download-btn" onclick="downloadFile(${file.id})">â¬‡ï¸ ä¸‹è½½</button>` : ''}
          <button class="delete-btn" onclick="deleteRow(${file.id})">åˆ é™¤</button>
        </td>
      </tr>
    `;
    displayIndex++;
  });
  
  tbody.innerHTML = html;
}

// æ£€æŸ¥ç­›é€‰æ¡ä»¶
function checkFilter(file) {
  const searchBox = document.querySelector('.search-box');
  if (searchBox && searchBox.value.trim()) {
    const keyword = searchBox.value.toLowerCase();
    if (!file.fileName.toLowerCase().includes(keyword) && 
        !file.note.toLowerCase().includes(keyword)) {
      return false;
    }
  }
  
  const activeFilters = sources.filter(source => 
    document.getElementById(`filter-${source}`)?.checked
  );
  
  if (activeFilters.length > 0) {
    const hasMatch = activeFilters.some(source => 
      file.unsupportedSources.includes(source)
    );
    if (!hasMatch) return false;
  }
  
  return true;
}

// ç­›é€‰è¡¨æ ¼
function filterTable() {
  renderTable();
}

// æ¸…é™¤ç­›é€‰
function clearFilters() {
  sources.forEach(source => {
    const checkbox = document.getElementById(`filter-${source}`);
    if (checkbox) checkbox.checked = false;
  });
  document.querySelector('.search-box').value = '';
  filterTable();
}

// æ›´æ–°ç»Ÿè®¡
function updateStats() {
  const total = fileList.length;
  const uploaded = fileList.filter(f => f.fileContent).length;
  const flacCount = fileList.filter(f => 
    f.quality === 'flac' || f.quality === 'flac24bit'
  ).length;
  const fullSupport = fileList.filter(f => 
    f.unsupportedSources.length === 0
  ).length;
  
  document.getElementById('totalFiles').textContent = total;
  document.getElementById('uploadedCount').textContent = uploaded;
  document.getElementById('flacCount').textContent = flacCount;
  document.getElementById('fullSupportCount').textContent = fullSupport;
}

// æ¸…ç©ºæ‰€æœ‰
function clearAll() {
  if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
    fileList = [];
    saveData();
    renderTable();
  }
}

// å¯¼å‡ºä¸ºJSON
function exportToJSON() {
  const dataStr = JSON.stringify(fileList, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'éŸ³æºæ•°æ®_' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  URL.revokeObjectURL(url);
}

// ä»JSONå¯¼å…¥
function importFromJSON(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const imported = JSON.parse(e.target.result);
      if (confirm('ç¡®å®šè¦å¯¼å…¥æ•°æ®å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼')) {
        fileList = imported;
        saveData();
        renderTable();
        alert('å¯¼å…¥æˆåŠŸï¼');
      }
    } catch (err) {
      alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯\n' + err.message);
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// å¯¼å‡ºä¸ºMarkdown
function exportToMarkdown() {
  let md = '# éŸ³æºç®¡ç†æŠ¥å‘Š\n\n';
  md += 'ç”Ÿæˆæ—¶é—´: ' + new Date().toLocaleString('zh-CN') + '\n\n';
  md += 'æ€»æ–‡ä»¶æ•°: ' + fileList.length + '\n';
  md += 'å·²ä¸Šä¼ æ–‡ä»¶: ' + fileList.filter(f => f.fileContent).length + '\n\n';
  md += '## æ–‡ä»¶åˆ—è¡¨\n\n';
  md += '| åºå· | æ–‡ä»¶å | æœ€é«˜éŸ³è´¨ | ä¸æ”¯æŒçš„æº | å¤‡æ³¨ | é“¾æ¥ |\n';
  md += '|------|--------|----------|------------|------|------|\n';
  
  fileList.forEach((file, index) => {
    const unsupported = file.unsupportedSources.length > 0 
      ? file.unsupportedSources.map(s => sourceNames[s]).join(', ')
      : 'å…¨æ”¯æŒ';
    const hasFile = file.fileContent ? 'âœ…' : 'âš ï¸';
    
    let links = '-';
    if (file.links && file.links.length > 0) {
      links = file.links.map(l => `[${l.text}](${l.url})`).join(' \\| ');
    }
    if (file.directUrl) {
      links += (links === '-' ? '' : ' \\| ') + 'ğŸŒ åœ¨çº¿ä¸‹è½½';
    }
    if (file.keyUrl) {
      links += (links === '-' ? '' : ' \\| ') + 'ğŸ”‘ éœ€è¦å¯†é’¥';
    }
    
    md += '| ' + (index + 1) + ' | ' + hasFile + ' ' + (file.fileName || '(æœªå‘½å)') + ' | ' + file.quality + ' | ' + unsupported + ' | ' + (file.note || '-') + ' | ' + links + ' |\n';
  });
  
  const blob = new Blob([md], { type: 'text/markdown' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'éŸ³æºæŠ¥å‘Š_' + new Date().toISOString().slice(0,10) + '.md';
  a.click();
  URL.revokeObjectURL(url);
}

// å¯¼å‡ºHTMLï¼ˆå¸¦æ–‡ä»¶ä¸‹è½½å’Œå¯†é’¥åŠŸèƒ½ï¼‰
function exportHTMLWithFiles() {
  const filesDataJSON = JSON.stringify(fileList.map(f => ({
    fileName: f.fileName,
    fileContent: f.fileContent,
    quality: f.quality,
    unsupportedSources: f.unsupportedSources,
    note: f.note,
    links: f.links,
    keyUrl: f.keyUrl,
    directUrl: f.directUrl
  })));
  
  let htmlContent = '<!DOCTYPE html>\n';
  htmlContent += '<html>\n<head>\n';
  htmlContent += '<meta charset="UTF-8">\n';
  htmlContent += '<title>éŸ³æºç®¡ç†æŠ¥å‘Šï¼ˆå«æ–‡ä»¶ & å¯†é’¥ä¸‹è½½ï¼‰<\/title>\n';
  htmlContent += '<style>\n';
  htmlContent += 'body{font-family:Microsoft YaHei,Arial,sans-serif;max-width:1400px;margin:20px auto;padding:20px;background:#f5f5f5}';
  htmlContent += 'h1{color:#333;border-bottom:3px solid #667eea;padding-bottom:10px}';
  htmlContent += '.info-box{background:#e3f2fd;padding:15px;border-radius:8px;margin:20px 0}';
  htmlContent += 'table{width:100%;border-collapse:collapse;margin:20px 0;background:white;box-shadow:0 2px 8px rgba(0,0,0,0.1)}';
  htmlContent += 'th{background:#667eea;color:white;padding:12px;text-align:left}';
  htmlContent += 'td{padding:10px;border-bottom:1px solid #ddd;vertical-align:top}';
  htmlContent += 'tr:hover{background:#f8f9fa}';
  htmlContent += '.download-btn{background:#28a745;color:white;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;font-size:12px;text-decoration:none;display:inline-block;margin:2px}';
  htmlContent += '.download-btn:hover{background:#218838}';
  htmlContent += '.no-file{color:#999;font-style:italic}';
  htmlContent += '.download-all-btn{background:#667eea;color:white;padding:12px 24px;border:none;border-radius:6px;cursor:pointer;font-size:16px;font-weight:bold;margin:10px 0}';
  htmlContent += '.download-all-btn:hover{background:#5568d3}';
  htmlContent += '.quality{padding:4px 10px;border-radius:12px;font-size:12px;font-weight:bold;display:inline-block}';
  htmlContent += '.q-flac{background:#007bff;color:white}';
  htmlContent += '.q-flac24bit{background:#6f42c1;color:white}';
  htmlContent += '.q-320k{background:#28a745;color:white}';
  htmlContent += '.q-128k{background:#ffc107;color:#333}';
  htmlContent += '.unsupported{color:#dc3545;font-weight:bold}';
  htmlContent += '.supported{color:#28a745;font-weight:bold}';
  htmlContent += '.link-tag{display:inline-block;margin:3px;padding:4px 10px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border-radius:15px;font-size:11px;text-decoration:none}';
  htmlContent += '.link-tag:hover{opacity:0.8}';
  htmlContent += '.key-input-container{margin-top:10px;padding:10px;background:#fff3cd;border-radius:8px;border:2px solid #ffc107}';
  htmlContent += '.key-input-container label{display:block;margin-bottom:5px;font-weight:bold;color:#856404}';
  htmlContent += '.key-input-group{display:flex;gap:8px;align-items:center}';
  htmlContent += '.key-input{flex:1;padding:8px;border:2px solid #ffc107;border-radius:4px;font-size:13px}';
  htmlContent += '.key-download-btn{background:#ffc107;color:#333;padding:8px 16px;border:none;border-radius:4px;cursor:pointer;font-size:13px;font-weight:bold}';
  htmlContent += '.key-download-btn:hover{background:#e0a800}';
  htmlContent += '\n<\/style>\n<\/head>\n<body>\n';
  
  htmlContent += '<h1>ğŸµ éŸ³æºç®¡ç†æŠ¥å‘Š<\/h1>\n';
  htmlContent += '<div class="info-box">\n';
  htmlContent += '<p><strong>ç”Ÿæˆæ—¶é—´:<\/strong> ' + new Date().toLocaleString('zh-CN') + '<\/p>\n';
  htmlContent += '<p><strong>æ€»æ–‡ä»¶æ•°:<\/strong> ' + fileList.length + '<\/p>\n';
  htmlContent += '<p><strong>å·²ä¸Šä¼ æ–‡ä»¶:<\/strong> ' + fileList.filter(f => f.fileContent).length + '<\/p>\n';
  htmlContent += '<p><strong>åœ¨çº¿é“¾æ¥:<\/strong> ' + fileList.filter(f => f.directUrl).length + '<\/p>\n';
  htmlContent += '<p><strong>ğŸ’¡ æç¤º:<\/strong> éƒ¨åˆ†æ–‡ä»¶æ”¯æŒå¯†é’¥ä¸‹è½½ï¼Œè¯·è¾“å…¥æ‚¨çš„å¯†é’¥åç‚¹å‡»ä¸‹è½½<\/p>\n';
  htmlContent += '<\/div>\n';
  
  htmlContent += '<button class="download-all-btn" onclick="downloadAllFiles()">ğŸ“¦ æ‰“åŒ…ä¸‹è½½æ‰€æœ‰å…è´¹æ–‡ä»¶<\/button>\n';
  
  htmlContent += '<table>\n<thead>\n<tr>\n';
  htmlContent += '<th>åºå·<\/th><th>æ–‡ä»¶å<\/th><th>æœ€é«˜éŸ³è´¨<\/th><th>ä¸æ”¯æŒçš„æº<\/th><th>å¤‡æ³¨ & é“¾æ¥<\/th><th>ä¸‹è½½<\/th>\n';
  htmlContent += '<\/tr>\n<\/thead>\n<tbody>\n';
  
  fileList.forEach((file, index) => {
    const unsupported = file.unsupportedSources.length > 0 
      ? '<span class="unsupported">' + file.unsupportedSources.map(s => sourceNames[s]).join(', ') + '<\/span>'
      : '<span class="supported">å…¨æ”¯æŒ<\/span>';
    
    const qualityClass = file.quality.includes('flac24') ? 'q-flac24bit' : 
                        file.quality === 'flac' ? 'q-flac' :
                        file.quality.includes('320') ? 'q-320k' : 'q-128k';
    
    let fileAction = '';
    
    // ä¼˜å…ˆçº§1: åœ¨çº¿é“¾æ¥
    if (file.directUrl) {
      fileAction += '<a href="' + file.directUrl + '" class="download-btn" download>â¬‡ï¸ åœ¨çº¿ä¸‹è½½<\/a><br>';
    }
    
    // ä¼˜å…ˆçº§2: ä¸Šä¼ çš„æ–‡ä»¶
    if (file.fileContent) {
      fileAction += '<a class="download-btn" onclick="downloadFile(' + index + ')">â¬‡ï¸ æœ¬åœ°ä¸‹è½½<\/a><br>';
    }
    
    // ä¼˜å…ˆçº§3: å¯†é’¥ä¸‹è½½
    if (file.keyUrl) {
      fileAction += '<div class="key-input-container">';
      fileAction += '<label>ğŸ”‘ ä»˜è´¹ç‰ˆä¸‹è½½:<\/label>';
      fileAction += '<div class="key-input-group">';
      fileAction += '<input type="text" class="key-input" id="key-' + index + '" placeholder="è¯·è¾“å…¥æ‚¨çš„å¯†é’¥...">';
      fileAction += '<button class="key-download-btn" onclick="downloadWithKey(' + index + ')">ä¸‹è½½<\/button>';
      fileAction += '<\/div>';
      fileAction += '<\/div>';
    }
    
    if (!file.directUrl && !file.fileContent && !file.keyUrl) {
      fileAction = '<span class="no-file">æœªé…ç½®ä¸‹è½½<\/span>';
    }
    
    let noteAndLinks = (file.note || '-') + '<br>';
    if (file.links && file.links.length > 0) {
      file.links.forEach(link => {
        noteAndLinks += '<a href="' + link.url + '" target="_blank" class="link-tag">ğŸ”— ' + link.text + '<\/a> ';
      });
    }
    
    htmlContent += '<tr>\n';
    htmlContent += '<td>' + (index + 1) + '<\/td>\n';
    htmlContent += '<td>' + (file.fileName || '(æœªå‘½å)') + '<\/td>\n';
    htmlContent += '<td><span class="quality ' + qualityClass + '">' + file.quality + '<\/span><\/td>\n';
    htmlContent += '<td>' + unsupported + '<\/td>\n';
    htmlContent += '<td>' + noteAndLinks + '<\/td>\n';
    htmlContent += '<td>' + fileAction + '<\/td>\n';
    htmlContent += '<\/tr>\n';
  });
  
  htmlContent += '<\/tbody>\n<\/table>\n';
  
  htmlContent += '<script>\n';
  htmlContent += 'var filesData=' + filesDataJSON + ';\n';
  
  // æ™®é€šæ–‡ä»¶ä¸‹è½½
  htmlContent += 'function downloadFile(index){';
  htmlContent += 'var file=filesData[index];';
  htmlContent += 'if(!file.fileContent){alert("è¯¥æ–‡ä»¶æœªä¸Šä¼ !");return;}';
  htmlContent += 'var link=document.createElement("a");';
  htmlContent += 'link.href=file.fileContent;';
  htmlContent += 'link.download=file.fileName||"download.js";';
  htmlContent += 'link.click();';
  htmlContent += '}\n';
  
  // å¯†é’¥ä¸‹è½½
  htmlContent += 'function downloadWithKey(index){';
  htmlContent += 'var file=filesData[index];';
  htmlContent += 'var keyInput=document.getElementById("key-"+index);';
  htmlContent += 'var key=keyInput.value.trim();';
  htmlContent += 'if(!key){alert("è¯·è¾“å…¥å¯†é’¥ï¼");keyInput.focus();return;}';
  htmlContent += 'if(!file.keyUrl){alert("è¯¥æ–‡ä»¶æ²¡æœ‰é…ç½®å¯†é’¥é“¾æ¥ï¼");return;}';
  htmlContent += 'var downloadUrl=file.keyUrl+key;';
  htmlContent += 'var link=document.createElement("a");';
  htmlContent += 'link.href=downloadUrl;';
  htmlContent += 'link.download=file.fileName||"download.js";';
  htmlContent += 'link.click();';
  htmlContent += 'alert("å¼€å§‹ä¸‹è½½ï¼Œå¦‚æœæ²¡æœ‰ååº”è¯·æ£€æŸ¥å¯†é’¥æ˜¯å¦æ­£ç¡®ï¼");';
  htmlContent += '}\n';
  
  // æ‰¹é‡ä¸‹è½½
  htmlContent += 'function downloadAllFiles(){';
  htmlContent += 'var validFiles=filesData.filter(function(f){return f.fileContent||f.directUrl;});';
  htmlContent += 'if(validFiles.length===0){alert("æ²¡æœ‰å¯ä¸‹è½½çš„å…è´¹æ–‡ä»¶!");return;}';
  htmlContent += 'validFiles.forEach(function(file,index){';
  htmlContent += 'setTimeout(function(){';
  htmlContent += 'if(file.directUrl){';
  htmlContent += 'var link=document.createElement("a");';
  htmlContent += 'link.href=file.directUrl;';
  htmlContent += 'link.download=file.fileName||"file_"+index+".js";';
  htmlContent += 'link.click();';
  htmlContent += '}else if(file.fileContent){';
  htmlContent += 'var link=document.createElement("a");';
  htmlContent += 'link.href=file.fileContent;';
  htmlContent += 'link.download=file.fileName||"file_"+index+".js";';
  htmlContent += 'link.click();';
  htmlContent += '}';
  htmlContent += '},index*500);';
  htmlContent += '});';
  htmlContent += 'alert("å¼€å§‹ä¸‹è½½ "+validFiles.length+" ä¸ªå…è´¹æ–‡ä»¶...");';
  htmlContent += '}\n';
  htmlContent += '<\/script>\n';
  
  htmlContent += '<\/body>\n<\/html>';
  
  const blob = new Blob([htmlContent], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'éŸ³æºå®Œæ•´æŠ¥å‘Š_' + new Date().toISOString().slice(0,10) + '.html';
  a.click();
  URL.revokeObjectURL(url);
  
  alert('å¯¼å‡ºæˆåŠŸï¼\n\nğŸŒ åœ¨çº¿é“¾æ¥ï¼šå¯ç›´æ¥ä¸‹è½½\nğŸ“¦ æœ¬åœ°æ–‡ä»¶ï¼šå¯ç›´æ¥ä¸‹è½½\nğŸ”‘ ä»˜è´¹æ–‡ä»¶ï¼šç”¨æˆ·éœ€è¾“å…¥å¯†é’¥ä¸‹è½½');
}

// æ‰“åŒ…ä¸‹è½½æ‰€æœ‰æ–‡ä»¶
function downloadAllFiles() {
  const validFiles = fileList.filter(f => f.fileContent);
  
  if (validFiles.length === 0) {
    alert('æ²¡æœ‰å·²ä¸Šä¼ çš„æ–‡ä»¶ï¼');
    return;
  }
  
  if (!confirm('å°†ä¸‹è½½ ' + validFiles.length + ' ä¸ªæ–‡ä»¶ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
    return;
  }
  
  validFiles.forEach((file, index) => {
    setTimeout(() => {
      const link = document.createElement('a');
      link.href = file.fileContent;
      link.download = file.fileName || 'file_' + index + '.js';
      link.click();
    }, index * 500);
  });
  
  alert('å¼€å§‹ä¸‹è½½ ' + validFiles.length + ' ä¸ªæ–‡ä»¶...');
}

// ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
window.onclick = function(event) {
  const linkModal = document.getElementById('linkModal');
  const keyModal = document.getElementById('keyModal');
  const directUrlModal = document.getElementById('directUrlModal');
  
  if (event.target === linkModal) {
    closeLinkModal();
  }
  if (event.target === keyModal) {
    closeKeyModal();
  }
  if (event.target === directUrlModal) {
    closeDirectUrlModal();
  }
}

// é”®ç›˜äº‹ä»¶
document.addEventListener('keydown', function(event) {
  const linkModal = document.getElementById('linkModal');
  const keyModal = document.getElementById('keyModal');
  const directUrlModal = document.getElementById('directUrlModal');
  
  if (linkModal.style.display === 'block') {
    if (event.key === 'Escape') {
      closeLinkModal();
    } else if (event.key === 'Enter' && event.ctrlKey) {
      confirmAddLink();
    }
  }
  
  if (keyModal.style.display === 'block') {
    if (event.key === 'Escape') {
      closeKeyModal();
    } else if (event.key === 'Enter' && event.ctrlKey) {
      confirmAddKeyUrl();
    }
  }
  
  if (directUrlModal.style.display === 'block') {
    if (event.key === 'Escape') {
      closeDirectUrlModal();
    } else if (event.key === 'Enter' && event.ctrlKey) {
      confirmAddDirectUrl();
    }
  }
});

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
window.onload = function() {
  loadData();
  
  if (fileList.length === 0) {
    fileList = [
      {
        id: Date.now() + 1,
        fileName: 'ikun.js',
        quality: 'flac24bit',
        unsupportedSources: [],
        note: 'iKunéŸ³æº - ä»˜è´¹ç‰ˆæ”¯æŒè¶…æ¸…éŸ³è´¨',
        links: [
          { text: 'å®˜ç½‘', url: 'https://ikunshare.com' }
        ],
        keyUrl: 'https://api.ikunshare.com/script?key=',
        directUrl: '',
        fileContent: null,
        fileSize: 0,
        addedTime: new Date().toLocaleString('zh-CN')
      },
      {
        id: Date.now() + 2,
        fileName: 'music_cdn.js',
        quality: '320k',
        unsupportedSources: [],
        note: 'å…è´¹ç‰ˆ - CDNåŠ é€Ÿ',
        links: [
          { text: 'GitHub', url: 'https://github.com/example' }
        ],
        keyUrl: '',
        directUrl: 'https://cdn.jsdelivr.net/gh/user/repo/music.js',
        fileContent: null,
        fileSize: 0,
        addedTime: new Date().toLocaleString('zh-CN')
      },
      {
        id: Date.now() + 3,
        fileName: 'hires_music.js',
        quality: 'flac',
        unsupportedSources: ['wy'],
        note: 'Hi-ReséŸ³è´¨ - æœ¬åœ°ç‰ˆæœ¬',
        links: [],
        keyUrl: '',
        directUrl: '',
        fileContent: null,
        fileSize: 0,
        addedTime: new Date().toLocaleString('zh-CN')
      },
      {
        id: Date.now() + 4,
        fileName: 'premium.js',
        quality: 'flac24bit',
        unsupportedSources: [],
        note: 'åŒç‰ˆæœ¬ - å…è´¹+ä»˜è´¹',
        links: [
          { text: 'æ–‡æ¡£', url: 'https://docs.example.com' }
        ],
        keyUrl: 'https://api.example.com/download?token=',
        directUrl: 'https://cdn.example.com/premium-free.js',
        fileContent: null,
        fileSize: 0,
        addedTime: new Date().toLocaleString('zh-CN')
      }
    ];
    saveData();
    renderTable();
  }
};
</script>

</body>
</html>